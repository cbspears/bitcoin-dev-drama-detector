<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bitcoin Dev Drama Detector</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Helper functions
        const getDramaLevel = (score) => {
          if (score >= 8) return { label: "CRITICAL", color: "text-red-400", bg: "bg-red-500" };
          if (score >= 6) return { label: "ELEVATED", color: "text-orange-400", bg: "bg-orange-500" };
          if (score >= 4) return { label: "MODERATE", color: "text-yellow-400", bg: "bg-yellow-500" };
          return { label: "CALM", color: "text-green-400", bg: "bg-green-500" };
        };

        const getTrendIcon = (trend) => {
          if (trend === "rising") return "â–²";
          if (trend === "falling") return "â–¼";
          return "â”€";
        };

        const getSourceLabel = (source) => {
          const labels = { mailing_list: "ML", irc: "IRC", github: "GH" };
          return labels[source] || source;
        };

        const formatDate = (dateStr) => {
          const date = new Date(dateStr);
          return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        };

        const HeatIcon = ({ score }) => {
          if (score >= 7) return <span className="text-red-400">ðŸ”¥</span>;
          if (score >= 5) return <span className="text-orange-400">âš¡</span>;
          return <span className="text-gray-500">â—‹</span>;
        };

        function DramaChart({ data }) {
          const chartRef = useRef(null);
          const chartInstance = useRef(null);

          useEffect(() => {
            if (!chartRef.current || !data || data.length === 0) return;

            const ctx = chartRef.current.getContext('2d');

            // Destroy existing chart
            if (chartInstance.current) {
              chartInstance.current.destroy();
            }

            const labels = data.map(d => formatDate(d.date));

            chartInstance.current = new Chart(ctx, {
              type: 'line',
              data: {
                labels: labels,
                datasets: [
                  {
                    label: 'Overall',
                    data: data.map(d => d.overall),
                    borderColor: '#ffffff',
                    backgroundColor: 'rgba(255, 255, 255, 0.1)',
                    tension: 0.4,
                    borderWidth: 2,
                    fill: false
                  },
                  {
                    label: 'Mailing List',
                    data: data.map(d => d.mailing_list),
                    borderColor: '#f97316',
                    backgroundColor: 'rgba(249, 115, 22, 0.1)',
                    tension: 0.4,
                    borderWidth: 1.5,
                    fill: false
                  },
                  {
                    label: 'IRC',
                    data: data.map(d => d.irc),
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.4,
                    borderWidth: 1.5,
                    fill: false
                  },
                  {
                    label: 'GitHub',
                    data: data.map(d => d.github),
                    borderColor: '#22c55e',
                    backgroundColor: 'rgba(34, 197, 94, 0.1)',
                    tension: 0.4,
                    borderWidth: 1.5,
                    fill: false
                  }
                ]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    display: true,
                    labels: {
                      color: '#9ca3af',
                      font: { size: 11 }
                    }
                  },
                  tooltip: {
                    backgroundColor: '#1f2937',
                    borderColor: '#374151',
                    borderWidth: 1,
                    titleColor: '#9ca3af',
                    bodyColor: '#f3f4f6'
                  }
                },
                scales: {
                  y: {
                    beginAtZero: true,
                    max: 10,
                    grid: { color: '#374151' },
                    ticks: { color: '#6b7280', font: { size: 10 } }
                  },
                  x: {
                    grid: { color: '#374151' },
                    ticks: { color: '#6b7280', font: { size: 10 } }
                  }
                }
              }
            });

            return () => {
              if (chartInstance.current) {
                chartInstance.current.destroy();
              }
            };
          }, [data]);

          return <canvas ref={chartRef} height="280"></canvas>;
        }

        function BitcoinDramaDetector() {
          const [dailyScores, setDailyScores] = useState([]);
          const [hotTopics, setHotTopics] = useState([]);
          const [spicyThreads, setSpicyThreads] = useState([]);
          const [keyParticipants, setKeyParticipants] = useState([]);
          const [loading, setLoading] = useState(true);
          const [error, setError] = useState(null);

          const [selectedTopic, setSelectedTopic] = useState(null);
          const [selectedThread, setSelectedThread] = useState(null);
          const [selectedParticipant, setSelectedParticipant] = useState(null);
          const [timeRange, setTimeRange] = useState('30d');

          useEffect(() => {
            async function loadData() {
              try {
                // Load all data files from GitHub
                const today = new Date();
                const dateStr = today.toISOString().split('T')[0];
                const baseUrl = 'https://raw.githubusercontent.com/cbspears/bitcoin-dev-drama-detector/main/data/processed';

                const [topicsRes, threadsRes, participantsRes, dailyScoresRes] = await Promise.all([
                  fetch(`${baseUrl}/hot_topics.json`),
                  fetch(`${baseUrl}/spicy_threads.json`),
                  fetch(`${baseUrl}/key_participants.json`),
                  fetch(`${baseUrl}/daily_scores_${dateStr}.json`).catch(() => null)
                ]);

                const topics = await topicsRes.json();
                const threads = await threadsRes.json();
                const participants = await participantsRes.json();

                setHotTopics(topics.hot_topics || []);
                setSpicyThreads(threads.spicy_threads || []);
                setKeyParticipants(participants.key_participants || []);

                // Load 30 days of historical data (real files when available)
                const scores = [];
                const loadPromises = [];

                for (let i = 29; i >= 0; i--) {
                  const date = new Date(today);
                  date.setDate(date.getDate() - i);
                  const dateStr = date.toISOString().split('T')[0];

                  loadPromises.push(
                    fetch(`${baseUrl}/daily_scores_${dateStr}.json`)
                      .then(res => res.ok ? res.json() : null)
                      .then(data => ({
                        date: dateStr,
                        data: data,
                        index: i
                      }))
                      .catch(() => ({ date: dateStr, data: null, index: i }))
                  );
                }

                // Wait for all historical data attempts
                const historicalResults = await Promise.all(loadPromises);

                // Sort by index to maintain chronological order
                historicalResults.sort((a, b) => b.index - a.index);

                // Build scores array
                for (const result of historicalResults) {
                  if (result.data) {
                    // Real data exists
                    scores.push({
                      date: result.date,
                      overall: result.data.overall || 0,
                      github: result.data.github || 0,
                      mailing_list: result.data.mailing_list || 0,
                      irc: result.data.irc || 0
                    });
                  } else {
                    // No data for this day - use mock data for now
                    scores.push({
                      date: result.date,
                      overall: Math.random() * 3 + 2,
                      github: Math.random() * 2 + 1,
                      mailing_list: Math.random() * 3 + 2,
                      irc: Math.random() * 2 + 1
                    });
                  }
                }

                setDailyScores(scores);

                setLoading(false);
              } catch (err) {
                console.error('Error loading data:', err);
                setError(err.message);
                setLoading(false);
              }
            }
            loadData();
          }, []);

          if (loading) {
            return (
              <div className="min-h-screen bg-gray-950 text-gray-100 flex items-center justify-center font-mono">
                <div className="text-center">
                  <div className="text-2xl mb-2">Loading Drama Data...</div>
                  <div className="text-gray-500">Analyzing Bitcoin developer discussions</div>
                </div>
              </div>
            );
          }

          if (error) {
            return (
              <div className="min-h-screen bg-gray-950 text-gray-100 flex items-center justify-center font-mono">
                <div className="text-center">
                  <div className="text-2xl text-red-400 mb-2">Error Loading Data</div>
                  <div className="text-gray-500">{error}</div>
                </div>
              </div>
            );
          }

          const currentScore = dailyScores[dailyScores.length - 1];
          const previousScore = dailyScores[dailyScores.length - 2];
          const scoreDelta = currentScore ? (currentScore.overall - (previousScore?.overall || 0)) : 0;
          const level = getDramaLevel(currentScore?.overall || 0);

          const avg7d = dailyScores.length >= 7
            ? (dailyScores.slice(-7).reduce((sum, d) => sum + d.overall, 0) / 7).toFixed(1)
            : '0.0';
          const avg30d = dailyScores.length > 0
            ? (dailyScores.reduce((sum, d) => sum + d.overall, 0) / dailyScores.length).toFixed(1)
            : '0.0';

          return (
            <div className="min-h-screen bg-gray-950 text-gray-100 p-4 font-mono">
              {/* Header */}
              <div className="flex items-center justify-between mb-4 flex-wrap gap-2">
                <div className="flex items-center gap-3">
                  <h1 className="text-xl font-bold tracking-tight">BITCOIN DEV DRAMA DETECTOR</h1>
                  <div className="px-3 py-1 bg-green-900/50 border border-green-700 rounded">
                    <span className="text-green-300 text-xs">ðŸŸ¢ LIVE DATA</span>
                  </div>
                  {currentScore?.overall >= 8 && (
                    <div className="flex items-center gap-2 bg-red-900/50 border border-red-700 rounded px-3 py-1 animate-pulse">
                      <span className="text-red-400">âš </span>
                      <span className="text-red-300 text-xs">DRAMA ALERT</span>
                    </div>
                  )}
                </div>
                <div className="flex gap-1">
                  {['30d', '90d', '1y'].map(range => (
                    <button
                      key={range}
                      onClick={() => setTimeRange(range)}
                      className={`px-3 py-1 text-xs rounded ${timeRange === range ? 'bg-orange-600 text-white' : 'bg-gray-800 text-gray-400 hover:bg-gray-700'}`}
                    >
                      {range}
                    </button>
                  ))}
                </div>
              </div>

              {/* Top Row: Chart + Index */}
              <div className="grid grid-cols-1 lg:grid-cols-4 gap-4 mb-4">
                {/* Chart */}
                <div className="lg:col-span-3 border border-gray-800 rounded-lg p-4 bg-gray-900">
                  <DramaChart data={dailyScores} />
                </div>

                {/* Drama Index */}
                <div className="border border-gray-800 rounded-lg p-4 bg-gray-900">
                  <h2 className="text-xs font-bold text-gray-500 mb-3 tracking-wide">DRAMA INDEX</h2>

                  <div className="text-center mb-4">
                    <div className="text-5xl font-bold mb-1">{currentScore?.overall.toFixed(1) || '0.0'}</div>
                    <div className={`text-sm ${level.color} font-medium`}>{level.label}</div>
                    <div className={`text-xs mt-1 ${scoreDelta >= 0 ? 'text-red-400' : 'text-green-400'}`}>
                      {scoreDelta >= 0 ? 'â–²' : 'â–¼'} {Math.abs(scoreDelta).toFixed(1)} from yesterday
                    </div>
                  </div>

                  <div className="w-full h-3 bg-gray-700 rounded-full overflow-hidden mb-4">
                    <div className={`h-full ${level.bg} transition-all duration-500`} style={{ width: `${(currentScore?.overall || 0) * 10}%` }} />
                  </div>

                  <div className="space-y-2 text-sm">
                    <div className="flex justify-between">
                      <span className="text-gray-500">7d avg</span>
                      <span>{avg7d}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-gray-500">30d avg</span>
                      <span>{avg30d}</span>
                    </div>
                  </div>

                  <div className="mt-4 pt-4 border-t border-gray-800 space-y-2">
                    {currentScore && ['mailing_list', 'irc', 'github'].map(source => (
                      <div key={source} className="flex justify-between items-center text-xs">
                        <span className={`${source === 'mailing_list' ? 'text-orange-400' : source === 'irc' ? 'text-blue-400' : 'text-green-400'}`}>
                          {getSourceLabel(source).toUpperCase()}
                        </span>
                        <div className="flex-1 mx-2 h-1.5 bg-gray-700 rounded">
                          <div
                            className={`h-full rounded ${source === 'mailing_list' ? 'bg-orange-500' : source === 'irc' ? 'bg-blue-500' : 'bg-green-500'}`}
                            style={{ width: `${(currentScore[source] || 0) * 10}%` }}
                          />
                        </div>
                        <span className="w-6 text-right">{(currentScore[source] || 0).toFixed(1)}</span>
                      </div>
                    ))}
                  </div>
                </div>
              </div>

              {/* Hot Topics + Source Breakdown */}
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                {/* Hot Topics */}
                <div className="border border-gray-800 rounded-lg p-4 bg-gray-900">
                  <h2 className="text-xs font-bold text-gray-500 mb-3 tracking-wide">HOT TOPICS</h2>
                  <div className="space-y-1">
                    {hotTopics.length > 0 ? hotTopics.map((topic, i) => (
                      <div key={i}>
                        <div
                          onClick={() => setSelectedTopic(selectedTopic === i ? null : i)}
                          className="flex items-center justify-between p-2 rounded cursor-pointer hover:bg-gray-800 transition-colors"
                        >
                          <div className="flex items-center gap-2 flex-1 min-w-0">
                            <HeatIcon score={topic.heat_score} />
                            <span className="truncate text-sm">{topic.topic}</span>
                          </div>
                          <div className="flex items-center gap-2">
                            <span className="text-sm font-bold">{topic.heat_score}</span>
                            <span className={`text-xs ${topic.trend === 'rising' ? 'text-red-400' : topic.trend === 'falling' ? 'text-green-400' : 'text-gray-500'}`}>
                              {getTrendIcon(topic.trend)}
                            </span>
                          </div>
                        </div>
                      </div>
                    )) : (
                      <div className="text-sm text-gray-500 text-center py-4">No hot topics detected</div>
                    )}
                  </div>
                </div>

                {/* Source Breakdown */}
                <div className="border border-gray-800 rounded-lg p-4 bg-gray-900">
                  <h2 className="text-xs font-bold text-gray-500 mb-3 tracking-wide">SOURCE BREAKDOWN</h2>
                  <div className="space-y-4">
                    {currentScore && ['mailing_list', 'irc', 'github'].map(source => (
                      <div key={source}>
                        <div className="flex justify-between text-sm mb-1">
                          <span className={`${source === 'mailing_list' ? 'text-orange-400' : source === 'irc' ? 'text-blue-400' : 'text-green-400'}`}>
                            {source === 'mailing_list' ? 'Mailing List' : source === 'irc' ? 'IRC (#bitcoin-core-dev)' : 'GitHub (bitcoin/bitcoin)'}
                          </span>
                          <span className="font-bold">{(currentScore[source] || 0).toFixed(1)}</span>
                        </div>
                        <div className="w-full h-2.5 bg-gray-700 rounded-full overflow-hidden">
                          <div
                            className={`h-full ${source === 'mailing_list' ? 'bg-orange-500' : source === 'irc' ? 'bg-blue-500' : 'bg-green-500'}`}
                            style={{ width: `${(currentScore[source] || 0) * 10}%` }}
                          />
                        </div>
                        <p className="text-xs text-gray-500 mt-1">
                          {source === 'github' ? 'Relatively calm, routine activity' : 'No recent data'}
                        </p>
                      </div>
                    ))}
                  </div>
                </div>

                {/* Historical Context */}
                <div className="border border-gray-800 rounded-lg p-4 bg-gray-900">
                  <h2 className="text-xs font-bold text-gray-500 mb-3 tracking-wide">HISTORICAL CONTEXT</h2>
                  <div className="space-y-2 text-sm">
                    <div className="flex justify-between">
                      <span className="text-gray-400">Block Size War</span>
                      <span className="text-gray-300">9.8 peak</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-gray-400">SegWit Activation</span>
                      <span className="text-gray-300">8.9 peak</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-gray-400">Taproot Activation</span>
                      <span className="text-gray-300">6.2 peak</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-orange-400">Current</span>
                      <span className="text-orange-400">{currentScore?.overall.toFixed(1)} ({((currentScore?.overall / 9.8) * 100).toFixed(0)}% of peak)</span>
                    </div>
                  </div>
                </div>
              </div>

              {/* Spicy Threads */}
              <div className="border border-gray-800 rounded-lg p-4 mb-4 bg-gray-900">
                <h2 className="text-xs font-bold text-gray-500 mb-3 tracking-wide">SPICY THREADS</h2>
                <div className="space-y-1">
                  {spicyThreads.length > 0 ? spicyThreads.slice(0, 10).map((thread, i) => (
                    <div key={thread.id}>
                      <div
                        onClick={() => setSelectedThread(selectedThread === i ? null : i)}
                        className="flex items-center gap-4 p-2 rounded cursor-pointer hover:bg-gray-800 transition-colors"
                      >
                        <span className={`font-bold w-10 ${thread.drama_score >= 8 ? 'text-red-400' : thread.drama_score >= 6 ? 'text-orange-400' : 'text-yellow-400'}`}>
                          {thread.drama_score}
                        </span>
                        <span className="flex-1 text-sm truncate">{thread.title}</span>
                        <span className="text-xs text-gray-500 w-8">{getSourceLabel(thread.source)}</span>
                        <span className="text-xs text-gray-500 w-16">{formatDate(thread.date)}</span>
                      </div>
                      {selectedThread === i && (
                        <div className="ml-12 p-3 bg-gray-800 rounded border border-gray-700 mb-2">
                          <div className="flex gap-4 text-xs mb-2">
                            <span className="text-green-400">ACK: {thread.ack_count}</span>
                            <span className="text-red-400">NACK: {thread.nack_count}</span>
                          </div>
                          {thread.url && (
                            <a href={thread.url} target="_blank" rel="noopener noreferrer" className="text-xs text-blue-400 hover:underline block mb-2">
                              View on {getSourceLabel(thread.source)} â†’
                            </a>
                          )}
                          <div className="text-xs text-gray-500">
                            Participants: {thread.participants.join(', ')}
                          </div>
                        </div>
                      )}
                    </div>
                  )) : (
                    <div className="text-sm text-gray-500 text-center py-4">No spicy threads detected</div>
                  )}
                </div>
              </div>

              {/* Key Participants */}
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
                <div className="border border-gray-800 rounded-lg p-4 bg-gray-900">
                  <h2 className="text-xs font-bold text-gray-500 mb-3 tracking-wide">ðŸ”¥ KEY CONTRIBUTORS</h2>
                  <div className="space-y-1">
                    {keyParticipants.length > 0 ? keyParticipants.map((p, i) => (
                      <div key={i}>
                        <div
                          onClick={() => setSelectedParticipant(selectedParticipant === i ? null : i)}
                          className="flex items-center justify-between p-2 rounded cursor-pointer hover:bg-gray-800 transition-colors"
                        >
                          <div className="flex items-center gap-2">
                            <span className="text-sm text-gray-300">{p.handle}</span>
                            <span className="text-xs text-gray-600">{p.messages} msgs</span>
                          </div>
                          <div className="flex items-center gap-2">
                            <span className="text-sm font-bold">{p.avg_drama_contribution.toFixed(1)}</span>
                            <HeatIcon score={p.avg_drama_contribution} />
                          </div>
                        </div>
                        {selectedParticipant === i && (
                          <div className="mx-2 p-2 bg-gray-800 rounded border border-gray-700 mb-1">
                            <p className="text-xs text-gray-300 mb-1">{p.stance_summary}</p>
                            <div className="text-xs text-gray-500">
                              Topics: {p.primary_topics?.join(', ') || 'general'}
                            </div>
                          </div>
                        )}
                      </div>
                    )) : (
                      <div className="text-sm text-gray-500 text-center py-4">No participants data</div>
                    )}
                  </div>
                </div>
              </div>

              {/* Footer */}
              <div className="mt-4 text-center text-xs text-gray-600">
                Last updated: {new Date().toLocaleString()} â€¢ Powered by Claude AI â€¢ Built by <a href="https://blockspace.media" className="text-blue-400 hover:underline">Blockspace Media</a>
              </div>
            </div>
          );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<BitcoinDramaDetector />);
    </script>
</body>
</html>
