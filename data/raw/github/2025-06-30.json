{
  "source": "github",
  "repository": "bitcoin/bitcoin",
  "fetched_at": "2026-01-15T19:53:36.101863+00:00",
  "date": "2025-06-30",
  "pull_requests": [
    {
      "number": 32845,
      "title": "rpc, test: Fix JSON parsing errors in unloadwallet and getdescriptoractivity RPCs",
      "body": "Currently, `unloadwallet` RPC call fails with a JSON parsing error when no `wallet_name` argument is provided. This behavior is misleading because the error originates from a low-level JSON type mismatch, rather than clearly indicating that the wallet name or RPC endpoint (`-rpcwallet=...`) is missing. Also, found out that the [issue](https://github.com/bitcoin/bitcoin/pull/13111#issuecomment-398831543) was noticed during its implementation but never addressed.\r\n\r\nIn addition, I've verified all RPC commands calls finding that `getdescriptoractivity` had the same problem, but related to the array input types (blockhashes & descriptors), so I've corrected that RPC as well. For consistency I've added the missing logging info for each test case in `test/functional/rpc_getdescriptoractivity.py` in preparation for the new test.\r\n\r\n**_-Before_**\r\n```\r\n./build/bin/bitcoin-cli -regtest -datadir=/tmp/btc unloadwallet\r\nerror code: -3\r\nerror message:\r\nJSON value of type number is not of expected type string\r\n```\r\n```\r\n./build/bin/bitcoin-cli -regtest -datadir=/tmp/btc getdescriptoractivity\r\nerror code: -3\r\nerror message:\r\nJSON value of type null is not of expected type array\r\n```\r\n```\r\n./build/bin/bitcoin-cli -regtest -datadir=/tmp/btc getdescriptoractivity '[]'\r\nerror code: -3\r\nerror message:\r\nJSON value of type null is not of expected type array\r\n```\r\n**_-After_**\r\n```\r\n./build/bin/bitcoin-cli -regtest -datadir=/tmp/btc unloadwallet\r\nerror code: -8\r\nerror message:\r\nEither the RPC endpoint wallet or the wallet name parameter must be provided\r\n```\r\n```\r\n./build/bin/bitcoin-cli -regtest -datadir=/tmp/btc getdescriptoractivity\r\nerror code: -1\r\nerror message:\r\ngetdescriptoractivity [\"blockhash\",...] [scanobjects,...] ( include_mempool )\r\n\r\nGet spend and receive activity associated with a set of descriptors for a set of blocks. This command pairs well with the `relevant_blocks` output of `scanblocks()`.\r\nThis call may take several minutes. If you encounter timeouts, try specifying no RPC timeout (bitcoin-cli -rpcclienttimeout=0)\r\n\r\nArguments:\r\n1. blockhashes                   (json array, required) The list of blockhashes to examine for activity. Order doesn't matter. Must be along main chain or an error is thrown.\r\n                                 \r\n     [\r\n       \"blockhash\",              (string) A valid blockhash\r\n       ...\r\n     ]\r\n2. scanobjects                   (json array, required) Array of scan objects. Every scan object is either a string descriptor or an object:\r\n     [\r\n       \"descriptor\",             (string) An output descriptor\r\n       {                         (json object) An object with output descriptor and metadata\r\n         \"desc\": \"str\",          (string, required) An output descriptor\r\n         \"range\": n or [n,n],    (numeric or array, optional, default=1000) The range of HD chain indexes to explore (either end or [begin,end])\r\n       },\r\n       ...\r\n     ]\r\n3. include_mempool               (boolean, optional, default=true) Whether to include unconfirmed activity\r\n\r\n...\r\n```\r\n```\r\n./build/bin/bitcoin-cli -regtest -datadir=/tmp/btc getdescriptoractivity '[]'\r\nerror code: -1\r\nerror message:\r\ngetdescriptoractivity [\"blockhash\",...] [scanobjects,...] ( include_mempool )\r\n\r\n...\r\n```",
      "state": "closed",
      "user": "pablomartin4btc",
      "created_at": "2025-06-30T23:51:56Z",
      "updated_at": "2025-07-25T19:46:31Z",
      "comments": 14,
      "url": "https://github.com/bitcoin/bitcoin/pull/32845",
      "labels": [],
      "comment_list": [
        {
          "user": "DrahtBot",
          "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/32845.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [stickies-v](https://github.com/bitcoin/bitcoin/pull/32845#pullrequestreview-3046329114), [furszy](https://github.com/bitcoin/bitcoin/pull/32845#pullrequestreview-3048658400), [achow101](https://github.com/bitcoin/bitcoin/pull/32845#issuecomment-3120080986) |\n| Stale ACK | [maflcko](https://github.com/bitcoin/bitcoin/pull/32845#issuecomment-3051281022), [BrandonOdiwuor](https://github.com/bitcoin/bitcoin/pull/32845#pullrequestreview-3023823917) |\n\nIf your review is incorrectly listed, please react with üëé to this comment and the bot will ignore it on the next update.\n<!--5faf32d7da4f0f540f40219e4f7537a3-->",
          "created_at": "2025-06-30T23:52:00Z"
        },
        {
          "user": "DrahtBot",
          "body": "<!--85328a0da195eb286784d51f73fa0af9-->\nüöß At least one of the CI tasks failed.\n<sub>Task `lint`: https://github.com/bitcoin/bitcoin/runs/45149016067</sub>\n<sub>LLM reason (‚ú® experimental): The CI failure is caused by a trailing whitespace error in the code, detected during the lint check.</sub>\n\n<details><summary>Hints</summary>\n\nTry to run the tests locally, according to the documentation. However, a CI failure may still\nhappen due to a number of reasons, for example:\n\n* Possibly due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\n* A sanitizer issue, which can only be found by compiling with the sanitizer and running the\n  affected test.\n\n* An intermittent issue.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n</details>\n\n",
          "created_at": "2025-07-01T16:32:46Z"
        },
        {
          "user": "pablomartin4btc",
          "body": "<ins>_Updates_</ins>:\r\n- Addressed @stickies-v's feedback correcting the error condition for `getdescriptoractivity`, adding also the empty array case in its corresponding test and updating the PR description in the before & after sections accordingly.",
          "created_at": "2025-07-01T16:39:45Z"
        },
        {
          "user": "pablomartin4btc",
          "body": "<ins>_Updates_</ins>:\r\n- Addressed feedback from @maflcko (co-authored): extended `MaybeArg` to return a `std::optional<std::string>` for use in the `GetWalletNameFromJSONRPCRequest` overload. Also refactored the `migratewallet` handling of `wallet_name` to align with the existing behavior in `unloadwallet`.\r\n- Incorporated @furszy's suggestion (co-authored): added a new template in RPC utils to check whether all provided parameters are null or empty, now used in the `getdescriptoractivity` RPC.",
          "created_at": "2025-07-08T05:18:56Z"
        },
        {
          "user": "DrahtBot",
          "body": "<!--85328a0da195eb286784d51f73fa0af9-->\nüöß At least one of the CI tasks failed.\n<sub>Task `tidy`: https://github.com/bitcoin/bitcoin/runs/45527858084</sub>\n<sub>LLM reason (‚ú® experimental): The CI failure is caused by a clang-tidy error in util.cpp due to an improperly qualified return type.</sub>\n\n<details><summary>Hints</summary>\n\nTry to run the tests locally, according to the documentation. However, a CI failure may still\nhappen due to a number of reasons, for example:\n\n* Possibly due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\n* A sanitizer issue, which can only be found by compiling with the sanitizer and running the\n  affected test.\n\n* An intermittent issue.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n</details>\n\n",
          "created_at": "2025-07-08T06:47:56Z"
        },
        {
          "user": "pablomartin4btc",
          "body": "<ins>_Updates_</ins>\r\n- Addressed @maflcko's feedback:\r\n  - [dropped](https://github.com/bitcoin/bitcoin/pull/32845#discussion_r2191837500) `MaybeArg` extension commit, since a pointer already can hold the null state needed in the validations within the `GetWalletNameFromJSONRPCRequest` overload;\r\n  - removed previously added `AreParamsNullOrEmpty` and replaced it with std::ranges::all_of in the `getdescriptoractivity` RPC fix instead, as [suggested](https://github.com/bitcoin/bitcoin/pull/32845#discussion_r2191846030).\r\n",
          "created_at": "2025-07-08T21:56:39Z"
        },
        {
          "user": "maflcko",
          "body": "review ACK 529d2ce24570aae426ce19e87cb22f124dd09470 üå¶\r\n\r\n<details><summary>Show signature</summary>\r\n\r\nSignature:\r\n\r\n```\r\nuntrusted comment: signature from minisign secret key on empty file; verify via: minisign -Vm \"${path_to_any_empty_file}\" -P RWTRmVTMeKV5noAMqVlsMugDDCyyTSbA3Re5AkUrhvLVln0tSaFWglOw -x \"${path_to_this_whole_four_line_signature_blob}\"\r\nRUTRmVTMeKV5npGrKx1nqXCw5zeVHdtdYURB/KlyA/LMFgpNCs+SkW9a8N95d+U4AP1RJMi+krxU1A3Yux4bpwZNLvVBKy0wLgM=\r\ntrusted comment: review ACK 529d2ce24570aae426ce19e87cb22f124dd09470 üå¶\r\ni0Xj78FXRdB9CQDK5n9I6JUcpJoQazD1SiiJh0xulnWWa6FTENw1vzhnN5u1kMpUxYbtq4Cw1hzp8s8XDz+LDQ==\r\n```\r\n\r\n</details>\r\n",
          "created_at": "2025-07-09T06:21:22Z"
        },
        {
          "user": "DrahtBot",
          "body": "<!--85328a0da195eb286784d51f73fa0af9-->\nüöß At least one of the CI tasks failed.\n<sub>Task `lint`: https://github.com/bitcoin/bitcoin/runs/45769239128</sub>\n<sub>LLM reason (‚ú® experimental): The CI failure is caused by a failing lint check due to trailing whitespace in the test/functional/rpc_getdescriptoractivity.py file.</sub>\n\n<details><summary>Hints</summary>\n\nTry to run the tests locally, according to the documentation. However, a CI failure may still\nhappen due to a number of reasons, for example:\n\n* Possibly due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\n* A sanitizer issue, which can only be found by compiling with the sanitizer and running the\n  affected test.\n\n* An intermittent issue.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n</details>\n\n",
          "created_at": "2025-07-11T02:33:20Z"
        },
        {
          "user": "pablomartin4btc",
          "body": "<ins>_Updates_</ins>\r\n- Addressed @stickies-v's feedback:\r\n  - converted the `GetWalletNameFromJSONRPCRequest` overload to `EnsureUniqueWalletName` as [proposed](https://github.com/bitcoin/bitcoin/pull/32845#discussion_r2197447487) - no changes in logic;\r\n  - [corrected](https://github.com/bitcoin/bitcoin/pull/32845#discussion_r2197391680) the `getdescriptoractivity` fix making both blockhashes and descriptors arrays as mandatory, returning the RPC Help for the command when any of them or both are missing. Updated the use cases in the PR description.\r\n",
          "created_at": "2025-07-11T03:04:12Z"
        },
        {
          "user": "pablomartin4btc",
          "body": "- Fixed functional test `test_no_args_passed()` to avoid CI failure (`multiprocess, i686, DEBUG`) adapting the code to when `CLI` option call is used (`--usecli`).",
          "created_at": "2025-07-11T14:02:04Z"
        },
        {
          "user": "DrahtBot",
          "body": "<!--85328a0da195eb286784d51f73fa0af9-->\nüöß At least one of the CI tasks failed.\n<sub>Task `lint`: https://github.com/bitcoin/bitcoin/runs/46494187141</sub>\n<sub>LLM reason (‚ú® experimental): The CI failure is caused by a trailing newline check failing in the lint step.</sub>\n\n<details><summary>Hints</summary>\n\nTry to run the tests locally, according to the documentation. However, a CI failure may still\nhappen due to a number of reasons, for example:\n\n* Possibly due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\n* A sanitizer issue, which can only be found by compiling with the sanitizer and running the\n  affected test.\n\n* An intermittent issue.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n</details>\n\n",
          "created_at": "2025-07-22T17:05:45Z"
        },
        {
          "user": "pablomartin4btc",
          "body": "<ins>_Updates_</ins>:\r\n- Addressed [feedback](https://github.com/bitcoin/bitcoin/pull/32845#pullrequestreview-3024249604) from @stickies-v:\r\n  - [Updated](https://github.com/bitcoin/bitcoin/pull/32845#discussion_r2204543796) `getdescriptoractivity` test for required params;\r\n  - [Corrected](https://github.com/bitcoin/bitcoin/pull/32845#discussion_r2204560989) variables naming within RPC `getdescriptoractivity`;\r\n  - [Updated](https://github.com/bitcoin/bitcoin/pull/32845#discussion_r2208503121) RPC invalid params error descriptions to be more generic and not depending on the RPC param naming representing the walle name;\r\n  - [Updated](https://github.com/bitcoin/bitcoin/pull/32845#discussion_r2209965857) outdated docstring for `unloadwallet` RPC;\r\n  - [Updated](https://github.com/bitcoin/bitcoin/pull/32845#discussion_r2209990945) `scanobjects` argument description within `getdescriptoractivity` RPC;\r\n  - [Updated](https://github.com/bitcoin/bitcoin/pull/32845#discussion_r2210018576) `getdescriptoractivity` commit message;\r\n  - [Incorporated](https://github.com/bitcoin/bitcoin/pull/32845#discussion_r2210134549) `EnsureUniqueWalletName` unit tests;\r\n  - Added release notes for `unloadwallet` & `getdescriptoractivity` updates.",
          "created_at": "2025-07-22T19:08:26Z"
        },
        {
          "user": "pablomartin4btc",
          "body": "Addressed [feedback](https://github.com/bitcoin/bitcoin/pull/32845#pullrequestreview-3044915254) from @stickies-v.\r\n",
          "created_at": "2025-07-23T02:37:54Z"
        },
        {
          "user": "achow101",
          "body": "ACK c5c1960f9350d6315cadbdc95fface5f85f25806",
          "created_at": "2025-07-25T19:26:52Z"
        }
      ]
    },
    {
      "number": 32844,
      "title": "RPC/txoutproof: Support including (and verifying) proofs of wtxid",
      "body": "Feature requested by @SomberNight for Electrum's Lightning stuff. (Please confirm this does what you need)\r\n\r\nUnfortunately WIP because the wtxid merkle root calculation doesn't match and I don't have time to figure out why not yet (maybe after concept ACK? or if anyone else wants to take a look...)\r\n\r\nMostly backward compatible, but a segwit-enabled proof will verify the generation tx in old versions.",
      "state": "open",
      "user": "luke-jr",
      "created_at": "2025-06-30T23:05:05Z",
      "updated_at": "2025-10-30T18:20:38Z",
      "comments": 5,
      "url": "https://github.com/bitcoin/bitcoin/pull/32844",
      "labels": [
        "Needs rebase"
      ],
      "comment_list": [
        {
          "user": "DrahtBot",
          "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/32844.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Concept ACK | [Sjors](https://github.com/bitcoin/bitcoin/pull/32844#issuecomment-3024957772), [ajtowns](https://github.com/bitcoin/bitcoin/pull/32844#pullrequestreview-3400680165), [fjahr](https://github.com/bitcoin/bitcoin/pull/32844#pullrequestreview-3400931461) |\n\nIf your review is incorrectly listed, please react with üëé to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#33116](https://github.com/bitcoin/bitcoin/pull/33116) (refactor: Convert uint256 to Txid by marcofleon)\n* [#33094](https://github.com/bitcoin/bitcoin/pull/33094) (refactor: unify container presence checks by l0rinc)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n<!--5faf32d7da4f0f540f40219e4f7537a3-->\n### LLM Linter (‚ú® experimental)\n\nPossible typos and grammar issues:\n\n- In RPCResult description: \"If verify_witness is true and the proof invalid\" -> \"If verify_witness is true and the proof is invalid\" [missing ‚Äúis‚Äù makes the sentence ungrammatical]\n\nNo other typos were found.\n\n<sup>drahtbot_id_4_m</sup>\n",
          "created_at": "2025-06-30T23:05:09Z"
        },
        {
          "user": "SomberNight",
          "body": "> Feature requested by @SomberNight for Electrum's Lightning stuff. (Please confirm this does what you need)\r\n\r\nWow, thank you for working on this!  I was meaning to open an issue to ask for this, but did not even get to that yet.\r\n\r\nThe request I would like an electrum server, assuming txindex=1, to be able to serve is:\r\n\r\n`bc.tx.get_merkle_witness(txid)`, (so given just a `txid`,) \r\n\r\nreturn a dict containing:\r\n- `wtxid`\r\n- `block_height`\r\n- `block_hash`\r\n- `pos` (index of tx in block)\r\n- `merkle` or `wmerkle`\r\n  - exactly one of the two\r\n  - `merkle` is the Satoshi-SPV proof, in case there is no witness commitment in the block\r\n  - `wmerkle` is the witness-SPV proof otherwise\r\n- `cb_tx`, the generation/coinbase tx\r\n- `cb_proof`, the Satoshi-SPV proof for the generation tx\r\n\r\nObviously the electrum server can act as middleware and transform the response, assuming the necessary fields are available or obtainable.\r\n\r\nAs far as I can tell, but I haven't tried yet, the RPC response from this PR can be transformed to what I describe above. So the RPC looks to be doing what I need. :)\r\n\r\n---\r\n\r\nI think it is non-trivial, so let me detail how an electrum/light client would then use `bc.tx.get_merkle_witness(txid)`:\r\n- it is assumed client already has a full raw `tx`, and wants to verify whether it has been mined\r\n- client also has full header chain, proof-of-work verified\r\n- client calls `bc.tx.get_merkle_witness(txid)`\r\n- client calculates wtxid of full tx it has, compares it with received `wtxid`\r\n- using `cb_tx`, `cb_proof`, `block_height`, `block_hash`\r\n  - client Satoshi-SPVs the received coinbase tx, against block header merkle_root\r\n- client extracts witness_commitment from `cb_tx`\r\n  1. if there is no witness_commitment,\r\n      - client Satoshi-SPVs the txid, using `merkle`, `block_height`, `block_hash`, `pos`, against block header merkle_root\r\n\t  - now client has an SPV guarantee that block only contains non-segwit txs, and `tx` in particular is also non-segwit (wtxid==txid) and it was mined in this block\r\n  2. if there is a witness_commitment,\r\n      - client must do witness-SPV, even if `tx` seems non-segwit (as e.g. malicious electrum server could have stripped away the witness)\r\n\t  - client does witness-SPV using `wmerkle` and `pos`, against witness_commitment\r\n\t  - client must check that length of `wmerkle` matches length of `cb_proof`. This ensures there are the same number of levels in the wtxid merkle tree and in the txid merkle tree. (the two trees should have the same number of leaves, but this seems hard to check as a light client)  This is intended as some protection against merkle-tree-construction weaknesses (cf. banning of 64 byte transactions and similar).\r\n- now client has an SPV guarantee that `wtxid` was mined in this block\r\n  - or if some check failed, then the client can connect to another server\r\n",
          "created_at": "2025-07-01T00:25:34Z"
        },
        {
          "user": "Sjors",
          "body": "Concept ACK. @SomberNight it's still useful if you open an issue to track the reason you need this, just in case this implementation PR doesn't make.",
          "created_at": "2025-07-01T17:37:54Z"
        },
        {
          "user": "luke-jr",
          "body": "Reworked this to cover @SomberNight 's requirements and address feedback. Test is now passing.",
          "created_at": "2025-07-09T03:53:53Z"
        },
        {
          "user": "DrahtBot",
          "body": "<!--cf906140f33d8803c4a75a2196329ecb-->\nüêô This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
          "created_at": "2025-08-13T20:34:09Z"
        }
      ]
    },
    {
      "number": 32843,
      "title": "doc: invalid block handling followups",
      "body": "Some follow-ups from #31405:\r\n\r\n- make it clearer that all block indexes with a `CBlockIndexWorkComparator` score at least as good as the tip (and no others) are expected in `setBlockIndexCandidates`.\r\nPeople think of `nChainWork` when the term `work` is used and not of the (slightly arbitrary) `CBlockIndexWorkComparator` tiebreaker rules, which makes the current documentation imprecise  ( https://github.com/bitcoin/bitcoin/pull/31405#discussion_r2075937910 )\r\n- add a comment that `nChainWork`, not `CBlockIndexWorkComparator` is used for `m_best_header` (https://github.com/bitcoin/bitcoin/pull/31405#discussion_r2138368441)",
      "state": "open",
      "user": "mzumsande",
      "created_at": "2025-06-30T22:10:44Z",
      "updated_at": "2025-12-16T15:37:06Z",
      "comments": 5,
      "url": "https://github.com/bitcoin/bitcoin/pull/32843",
      "labels": [
        "Validation",
        "Needs rebase"
      ],
      "comment_list": [
        {
          "user": "DrahtBot",
          "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/32843.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Stale ACK | [stratospher](https://github.com/bitcoin/bitcoin/pull/32843#pullrequestreview-3004293734), [ryanofsky](https://github.com/bitcoin/bitcoin/pull/32843#pullrequestreview-3384601373) |\n\nIf your review is incorrectly listed, please copy-paste <code>&lt;!--meta-tag:bot-skip--&gt;</code> into the comment that the bot should ignore.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#30214](https://github.com/bitcoin/bitcoin/pull/30214) (refactor: Improve assumeutxo state representation by ryanofsky)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n<!--5faf32d7da4f0f540f40219e4f7537a3-->",
          "created_at": "2025-06-30T22:10:49Z"
        },
        {
          "user": "stratospher",
          "body": "> In InvalidateBlock, both the block failure flags and m_best_header are kept up to date with each block that is disconnected, so it's not necessary to recalculate them at the end of this function.\r\n\r\nmaybe I'm missing something but even without the `calc_flags_and_header=false` flag, this means that [the condition](https://github.com/bitcoin/bitcoin/blob/a8bff38236ac988f82dcfa85438946cfe0d3afe3/src/validation.cpp#L2074) cannot hit true and `RecalculateBestHeader()` in `InvalidChainFound()` cannot be called right?\r\n\r\n1. `to_mark_failed` essentially tracks the last disconnected block which used to be part of current chain (`m_chain`)\r\n2. the possible values `to_mark_failed` can take are only the values which `invalid_walk_tip` can take ([this line](https://github.com/bitcoin/bitcoin/blob/a8bff38236ac988f82dcfa85438946cfe0d3afe3/src/validation.cpp#L3777)).\r\n3. we have very judiciously set `m_best_header` when `invalid_walk_tip` is invalid using related logic in:\r\n```\r\nbest_header_needs_update{m_chainman.m_best_header->GetAncestor(invalid_walk_tip->nHeight) == invalid_walk_tip}\r\n```\r\n4. so when we call `InvalidChainFound()` on `to_mark_failed`, even without passing the false flag, this condition will be false: (because `to_mark_failed` can only be `invalid_walk_tip` and we already handled that in 3.)\r\n\r\n  ```\r\nif (m_chainman.m_best_header != nullptr && m_chainman.m_best_header->GetAncestor(pindexNew->nHeight) == pindexNew) {\r\n```\r\n",
          "created_at": "2025-07-08T06:38:43Z"
        },
        {
          "user": "mzumsande",
          "body": "> maybe I'm missing something but even without the calc_flags_and_header=false flag, this means that [the condition](https://github.com/bitcoin/bitcoin/blob/a8bff38236ac988f82dcfa85438946cfe0d3afe3/src/validation.cpp#L2074) cannot hit true and RecalculateBestHeader() in InvalidChainFound() cannot be called right?\r\n\r\nYes, that's true, good point! To phrase it in my words, the condition that checks whether `m_best_header` needs update will not be fulfilled, because `m_best_header` was already successfully updated.\r\n\r\nI guess that means we could, instead of `calc_flags_and_header`, just use a bool `calc_flags` (for which we can't do a similar check). Do you think that would be clearer?",
          "created_at": "2025-07-08T19:26:03Z"
        },
        {
          "user": "stratospher",
          "body": "> I guess that means we could, instead of calc_flags_and_header, just use a bool calc_flags (for which we can't do a similar check). Do you think that would be clearer?\r\n\r\nyes sounds good! (whenever you retouch next)\r\n\r\nAh missed the fact that iteration of entire block index is done in `SetBlockFailureFlags()` as well. I originally thought that iteration of entire block index is done only for best header calculation and `calc_flags_and_header` wasn't useful. Hence the confusion.",
          "created_at": "2025-07-09T17:35:03Z"
        },
        {
          "user": "DrahtBot",
          "body": "<!--cf906140f33d8803c4a75a2196329ecb-->\nüêô This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
          "created_at": "2025-12-16T15:37:06Z"
        }
      ]
    },
    {
      "number": 32842,
      "title": "doc: add `/spenttxouts` to REST-interface.md",
      "body": "Seems like adding the `spenttxouts` endpoint to the REST interface description was forgotten in #32540.",
      "state": "closed",
      "user": "theStack",
      "created_at": "2025-06-30T21:29:07Z",
      "updated_at": "2025-07-01T13:57:41Z",
      "comments": 3,
      "url": "https://github.com/bitcoin/bitcoin/pull/32842",
      "labels": [
        "Docs"
      ],
      "comment_list": [
        {
          "user": "DrahtBot",
          "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/32842.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [pablomartin4btc](https://github.com/bitcoin/bitcoin/pull/32842#pullrequestreview-2972854934), [maflcko](https://github.com/bitcoin/bitcoin/pull/32842#issuecomment-3021867622) |\n\nIf your review is incorrectly listed, please react with üëé to this comment and the bot will ignore it on the next update.\n<!--5faf32d7da4f0f540f40219e4f7537a3-->",
          "created_at": "2025-06-30T21:29:12Z"
        },
        {
          "user": "maflcko",
          "body": "lgtm ACK dd99cedc0bfe7d7eee0f543bb27dab005c426c66",
          "created_at": "2025-07-01T05:40:23Z"
        },
        {
          "user": "romanz",
          "body": "Thanks!",
          "created_at": "2025-07-01T13:57:41Z"
        }
      ]
    },
    {
      "number": 32841,
      "title": "feature_taproot: sample tx version border values more",
      "body": "Currently if the version 3 is selected for an otherwise standard spender, the test will fail. It's unlikely but possible, so change the test to update expectations and sample more aggressively on border values to instigate failures much quicker in the future if another version is made standard.",
      "state": "closed",
      "user": "instagibbs",
      "created_at": "2025-06-30T21:03:33Z",
      "updated_at": "2025-07-03T11:17:41Z",
      "comments": 3,
      "url": "https://github.com/bitcoin/bitcoin/pull/32841",
      "labels": [],
      "comment_list": [
        {
          "user": "DrahtBot",
          "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/32841.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [darosior](https://github.com/bitcoin/bitcoin/pull/32841#pullrequestreview-2978437124), [maflcko](https://github.com/bitcoin/bitcoin/pull/32841#issuecomment-3027265968) |\n\nIf your review is incorrectly listed, please react with üëé to this comment and the bot will ignore it on the next update.\n<!--5faf32d7da4f0f540f40219e4f7537a3-->",
          "created_at": "2025-06-30T21:03:37Z"
        },
        {
          "user": "maflcko",
          "body": "lgtm ACK 4be81e9746e9e18923386d6f4945a33885fd98a7\r\n\r\nAlso tested the failure on current master.",
          "created_at": "2025-07-02T10:08:53Z"
        },
        {
          "user": "fanquake",
          "body": "Backported to 29.x in #32863.",
          "created_at": "2025-07-03T11:17:41Z"
        }
      ]
    },
    {
      "number": 32840,
      "title": "test: Enhance GetTxSigOpCost tests for coinbase transactions",
      "body": "Added assertions to the GetTxSigOpCost test cases to verify that the witness of a coinbase transaction is not considered in the signature operation cost calculations.\r\n\r\nUsing spendingTx.vin[0].prevout.SetNull() we create a coinbase transaction that evaluates to true for IsCoinbase(). Doing this to transactions (spendingTx in this case) that evaluate to a non-zero sigop output, we more concretely test that the witness of a coinbase transaction is not taken into account for SigOp maths.\r\n\r\n------\r\n\r\nIn my experimentation in mining software (mostly Stratum v2) I encountered the SigOps budget and began exploring the considerations as it applies to coinbase transactions. It was unclear how commitment-type addresses for coinbase were handled compared to bare script when it came to SigOp calculation. Upon further investigation, I saw that the test suite could have added vectors that clearly demonstrate that the witness for a coinbase transaction is not considered for `GetTransactionSigOpCost`. \r\n\r\nAdding these tests makes it more clear for someone in the future how SigOp maths work while exploring the intersection of SigOps and coinbase transactions.",
      "state": "closed",
      "user": "average-gary",
      "created_at": "2025-06-30T19:04:18Z",
      "updated_at": "2026-01-12T15:29:41Z",
      "comments": 6,
      "url": "https://github.com/bitcoin/bitcoin/pull/32840",
      "labels": [
        "Tests"
      ],
      "comment_list": [
        {
          "user": "DrahtBot",
          "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/32840.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\nA summary of reviews will appear here.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#34124](https://github.com/bitcoin/bitcoin/pull/34124) (refactor: make `CCoinsView` a purely virtual abstract base class by l0rinc)\n* [#32729](https://github.com/bitcoin/bitcoin/pull/32729) (test,refactor: extract script template helpers & widen sigop count coverage by l0rinc)\n* [#32317](https://github.com/bitcoin/bitcoin/pull/32317) (kernel: Separate UTXO set access from validation functions by sedited)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n<!--5faf32d7da4f0f540f40219e4f7537a3-->",
          "created_at": "2025-06-30T19:04:22Z"
        },
        {
          "user": "DrahtBot",
          "body": "<!--85328a0da195eb286784d51f73fa0af9-->\nüöß At least one of the CI tasks failed.\n<sub>Task `lint`: https://github.com/bitcoin/bitcoin/runs/45076576501</sub>\n<sub>LLM reason (‚ú® experimental): Lint check failed due to presence of trailing whitespace in source files.</sub>\n\n<details><summary>Hints</summary>\n\nTry to run the tests locally, according to the documentation. However, a CI failure may still\nhappen due to a number of reasons, for example:\n\n* Possibly due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\n* A sanitizer issue, which can only be found by compiling with the sanitizer and running the\n  affected test.\n\n* An intermittent issue.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n</details>\n\n",
          "created_at": "2025-06-30T19:11:29Z"
        },
        {
          "user": "Sammie05",
          "body": "Thanks for adding these assertions!\r\nI like how you explicitly test that coinbase witnesses don‚Äôt contribute to SigOp cost.\r\nMakes it clearer for future maintainers.\r\nLGTM üëç",
          "created_at": "2025-07-13T03:04:24Z"
        },
        {
          "user": "average-gary",
          "body": "@l0rinc I applied your patch in commits that I hope are focused enough and made you co-author. Thank you. \r\n\r\nI'll find some time to review the rest of the comments and address as needed after this patch.\r\n\r\nI also rebased onto 513a0da2e0c89d4833aeeb9f799cf43548d6441f",
          "created_at": "2025-11-07T16:52:23Z"
        },
        {
          "user": "l0rinc",
          "body": "Thanks @average-gary.\r\nWould it be possible to group the commits so that they're telling a story, so that the commit messages explain the \"why\", not the \"what\". The \"what\" is already in the code. The commit messages seem LLM generated, they don't add a lot of value this way.\r\n\r\nThe first commit still adds a test that claims we're testing the witness when in fact it's empty: [`a4376ab` (#32840)](https://github.com/bitcoin/bitcoin/pull/32840/commits/a4376abd72aae5c0ea158db66440618cb1abfe5a#r2492179386)\r\nThe second commit adds dead code, only used in later commit - not a clean separation of features.\r\nThe third does random refactors - we can group these in a cleanup commit, preferably after the test cases are already split.\r\n\r\nI would make the test split the first commit, containing the smallest change that can allow us to untangle them, with the minimum helpers since we're already uindenting all lines, we shouldn't do anything else that isn't strictly necessary for the separation.\r\nThe second commit could do the cleanup, refactor only, low risk - BOOST helpers,  suffix removals, useless comments, brace inits, for loops, etc. We can even split the cleanup, but after the tests are separated this should be easy to review.\r\nAfter cleanups, the very last commit could be the one you're suggesting, done in clean environment for clarity and ease of review.\r\n\r\nLet me know if there's any way I can help.",
          "created_at": "2025-11-07T17:09:04Z"
        },
        {
          "user": "average-gary",
          "body": "Apologies for the delay. I am not confident I'll be circling back to this PR any time soon, feel free to close it.",
          "created_at": "2026-01-12T15:24:07Z"
        }
      ]
    },
    {
      "number": 32837,
      "title": "depends: fix libevent `_WIN32_WINNT` usage",
      "body": "Starting with version 13.x, the mingw headers will define the value of\r\n`NTDDI_VERSION`, based on the value of `_WIN32_WINNT`, if that version is <\r\nWindows 10. Given that libevent was undefining our `_WIN32_WINNT`, and\r\nredefining it to a value < Windows 10 (`0x0501`), `NTDDI_VERSION` was also\r\nbeing defined to that value, leading to functions not being exposed in\r\nthe mingw-w64 headers; see here: https://github.com/mingw-w64/mingw-w64/blob/9c2668ef77e75ea4d8a6c7d100b14643269caec3/mingw-w64-headers/include/iphlpapi.h#L36-L41.\r\n\r\nImports a commit from usptream ([a14ff91254f40cf36e0fee199e26fb11260fab49](https://github.com/libevent/libevent/commit/a14ff91254f40cf36e0fee199e26fb11260fab49)).\r\n\r\nFixes #32707.",
      "state": "closed",
      "user": "fanquake",
      "created_at": "2025-06-30T16:47:03Z",
      "updated_at": "2025-07-25T07:52:43Z",
      "comments": 8,
      "url": "https://github.com/bitcoin/bitcoin/pull/32837",
      "labels": [
        "Windows",
        "Build system"
      ],
      "comment_list": [
        {
          "user": "DrahtBot",
          "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/32837.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [willcl-ark](https://github.com/bitcoin/bitcoin/pull/32837#pullrequestreview-3024686388) |\n| User requested bot ignore | [hebasto](https://github.com/bitcoin/bitcoin/pull/32837#issuecomment-3027626421) |\n\nIf your review is incorrectly listed, please react with üëé to this comment and the bot will ignore it on the next update.\n<!--5faf32d7da4f0f540f40219e4f7537a3-->\n### LLM Linter (‚ú® experimental)\n\nPossible typos and grammar issues:\n\n- defintions -> definitions [spelling error in ‚Äúmove _WIN32_WINNT defintions before first #include‚Äù]\n\n<sup>drahtbot_id_4_m</sup>\n",
          "created_at": "2025-06-30T16:47:08Z"
        },
        {
          "user": "hebasto",
          "body": "> Imports a commit from usptream ([a14ff91254f40cf36e0fee199e26fb11260fab49](https://github.com/libevent/libevent/commit/a14ff91254f40cf36e0fee199e26fb11260fab49)).\r\n> \r\n> Fixes #32707.\r\n\r\nAny idea why the issue manifests only with mingw-w64 13.x?",
          "created_at": "2025-06-30T16:53:18Z"
        },
        {
          "user": "fanquake",
          "body": "> Any idea why the issue manifests only with mingw-w64 13.x?\r\n\r\nIt's due to this change: https://github.com/mingw-w64/mingw-w64/commit/6cfc1fd2ca2fdbbb8d6570084970bea2ef100d2e. The headers have started defining `NTDDI_VERSION` based on the value of `_WIN32_WINNT` (if the version was < Windows 10). Given that libevent was undefining our `_WIN32_WINNT`, and then redefining it to a value < Windows 10 (`0x0501`), `NTDDI_VERSION` is also defined to that value, which was leading to functions not being exposed in the Windows headers, due to this logic: https://github.com/mingw-w64/mingw-w64/blob/9c2668ef77e75ea4d8a6c7d100b14643269caec3/mingw-w64-headers/include/iphlpapi.h#L36-L41. I've updated that commit message.",
          "created_at": "2025-07-01T09:10:58Z"
        },
        {
          "user": "hebasto",
          "body": "> ACK [524dd98](https://github.com/bitcoin/bitcoin/commit/524dd98cb1cfa3a7917b94e13a91827842e7aba8), tested on macOS 15.5 (x64) using Homebrew's mingw-w64 13.0.0.\r\n\r\nRetracting my ACK basing on non-reproducibilty of the Windows builds.",
          "created_at": "2025-07-02T12:06:41Z"
        },
        {
          "user": "fanquake",
          "body": "The cross-arch non-determinism here is in `bitcoin-qt.exe`.\r\nx86_64\r\n```bash\r\n55c49e31615341a1f8e72cd4c7193a3052843a2a21cecaa42d1c374faf4e1600  bitcoin-5565d7d610dd/bin/bitcoin-cli.exe\r\nc91ca56fd76dfddf120d1f92f692eff99f4f4e7ff64f2c486b44ce08c4ef930c  bitcoin-5565d7d610dd/bin/bitcoin-qt.exe\r\n7ddc376534a0811e5c6dd3a49cfffafef1c23be9e76f1e5586bfdbba25a2dbe5  bitcoin-5565d7d610dd/bin/bitcoin-tx.exe\r\n38cd1c4bd75862ff5a58052027d006140761cb4162ec59eb90b0ed4e9e0ddc0e  bitcoin-5565d7d610dd/bin/bitcoin-util.exe\r\n3ce997da61258e96793d0621c3faf0e9804b71a37e418e2f9ff1be02dc9f00c0  bitcoin-5565d7d610dd/bin/bitcoin-wallet.exe\r\n18e555a68d4491f10fe52cb1e32381d36a20246282ec9baabb4becf19cdc07f1  bitcoin-5565d7d610dd/bin/bitcoin.exe\r\n700724e344df1f6dd553ac0258112438bf570ee95269db78cc32c1b930954772  bitcoin-5565d7d610dd/bin/bitcoind.exe\r\nfa93df2a3aa75e357ee2928eb33bbd2e57079c28bcc75f4ce6f2dcfef6c6045a  bitcoin-5565d7d610dd/bin/test_bitcoin.exe\r\n```\r\naarch64:\r\n```bash\r\n55c49e31615341a1f8e72cd4c7193a3052843a2a21cecaa42d1c374faf4e1600  bitcoin-5565d7d610dd/bin/bitcoin-cli.exe\r\nc155f96fa9ec20f677d8b4d6abe03732c4b37811328e32ae97dfb47176ab7386  bitcoin-5565d7d610dd/bin/bitcoin-qt.exe\r\n7ddc376534a0811e5c6dd3a49cfffafef1c23be9e76f1e5586bfdbba25a2dbe5  bitcoin-5565d7d610dd/bin/bitcoin-tx.exe\r\n38cd1c4bd75862ff5a58052027d006140761cb4162ec59eb90b0ed4e9e0ddc0e  bitcoin-5565d7d610dd/bin/bitcoin-util.exe\r\n3ce997da61258e96793d0621c3faf0e9804b71a37e418e2f9ff1be02dc9f00c0  bitcoin-5565d7d610dd/bin/bitcoin-wallet.exe\r\n18e555a68d4491f10fe52cb1e32381d36a20246282ec9baabb4becf19cdc07f1  bitcoin-5565d7d610dd/bin/bitcoin.exe\r\n700724e344df1f6dd553ac0258112438bf570ee95269db78cc32c1b930954772  bitcoin-5565d7d610dd/bin/bitcoind.exe\r\nfa93df2a3aa75e357ee2928eb33bbd2e57079c28bcc75f4ce6f2dcfef6c6045a  bitcoin-5565d7d610dd/bin/test_bitcoin.exe\r\n```\r\n\r\n```diff\r\n--- a.txt\r\n+++ b.txt\r\n@@ -1,9 +1,9 @@\r\n \r\n-bitcoin-qt.exe_x86_64_unstripped:\tfile format coff-x86-64\r\n+bitcoin-qt.exe_aarch64_unstripped:\tfile format coff-x86-64\r\n \r\n Disassembly of section .text:\r\n \r\n 0000000140b1b070 <_ZN11WalletModel18prepareTransactionER22WalletModelTransactionRKN6wallet12CCoinControlE>:\r\n 140b1b070: f3 0f 1e fa                 \tendbr64\r\n 140b1b074: 41 57                       \tpushq\t%r15\r\n 140b1b076: 41 56                       \tpushq\t%r14\r\n@@ -607,15 +607,15 @@\r\n 140b1bb7d: b8 ff ff ff ff              \tmovl\t$0xffffffff, %eax       # imm = 0xFFFFFFFF\r\n 140b1bb82: e9 1f fb ff ff              \tjmp\t0x140b1b6a6 <_ZN11WalletModel18prepareTransactionER22WalletModelTransactionRKN6wallet12CCoinControlE+0x636>\r\n 140b1bb87: 89 56 1c                    \tmovl\t%edx, 0x1c(%rsi)\r\n 140b1bb8a: 4c 01 fa                    \taddq\t%r15, %rdx\r\n 140b1bb8d: 49 89 d0                    \tmovq\t%rdx, %r8\r\n 140b1bb90: 31 c0                       \txorl\t%eax, %eax\r\n 140b1bb92: 4d 29 f8                    \tsubq\t%r15, %r8\r\n-140b1bb95: 4c 39 fa                    \tcmpq\t%r15, %rdx\r\n+140b1bb95: 49 39 d7                    \tcmpq\t%rdx, %r15\r\n 140b1bb98: 0f 84 68 fc ff ff           \tje\t0x140b1b806 <_ZN11WalletModel18prepareTransactionER22WalletModelTransactionRKN6wallet12CCoinControlE+0x796>\r\n 140b1bb9e: 66 90                       \tnop\r\n 140b1bba0: 41 0f b6 14 07              \tmovzbl\t(%r15,%rax), %edx\r\n 140b1bba5: 88 14 01                    \tmovb\t%dl, (%rcx,%rax)\r\n 140b1bba8: 48 83 c0 01                 \taddq\t$0x1, %rax\r\n 140b1bbac: 49 39 c0                    \tcmpq\t%rax, %r8\r\n 140b1bbaf: 75 ef                       \tjne\t0x140b1bba0 <_ZN11WalletModel18prepareTransactionER22WalletModelTransactionRKN6wallet12CCoinControlE+0xb30>\r\n```",
          "created_at": "2025-07-07T13:53:54Z"
        },
        {
          "user": "fanquake",
          "body": "The non-determinism issue is not being introduced with this change, it's already present in master, see #32923. Given that, It'd be good to move ahead here, so we can finished up the backports for `29.1`.",
          "created_at": "2025-07-08T13:46:40Z"
        },
        {
          "user": "fanquake",
          "body": "Guix Build (aarch64):\r\n```bash\r\n54f1ec86a1e595a5529f115a333c5f6cf575ff35f0b87ed501f36f83e28d9063  guix-build-f5647c6c5ae8/output/aarch64-linux-gnu/SHA256SUMS.part\r\ne9db7e23661bac03b87e38dfc974d27b72ce8d684d9cff7e7105c735b8bab7af  guix-build-f5647c6c5ae8/output/aarch64-linux-gnu/bitcoin-f5647c6c5ae8-aarch64-linux-gnu-debug.tar.gz\r\n55c5b8685af798bbe36db8d1bc6a4fa90a10f83c68c8793d08512af4d7a9e326  guix-build-f5647c6c5ae8/output/aarch64-linux-gnu/bitcoin-f5647c6c5ae8-aarch64-linux-gnu.tar.gz\r\nc67cf3ebc35ff3e2dacca1b1a940f9fd3d1b55de3fd985b7a5c362565fbb114d  guix-build-f5647c6c5ae8/output/arm-linux-gnueabihf/SHA256SUMS.part\r\nd1c7195f66b0a22a5cf3c41cc0203c9fea045b34238f4988fc03dbf34a240242  guix-build-f5647c6c5ae8/output/arm-linux-gnueabihf/bitcoin-f5647c6c5ae8-arm-linux-gnueabihf-debug.tar.gz\r\n453f71389c26e9b8ee9971e53b27621134935c0e8e0f44fe3eafd7117a8ef41a  guix-build-f5647c6c5ae8/output/arm-linux-gnueabihf/bitcoin-f5647c6c5ae8-arm-linux-gnueabihf.tar.gz\r\n87d04837acdba4f2a43215779b0e9172c5ee1bc4c5f6677147124acf5e2c38b2  guix-build-f5647c6c5ae8/output/arm64-apple-darwin/SHA256SUMS.part\r\n2f65166134840d76855fc6a5f03e8dedffc37428acf7dab616822ee35edc4f8b  guix-build-f5647c6c5ae8/output/arm64-apple-darwin/bitcoin-f5647c6c5ae8-arm64-apple-darwin-codesigning.tar.gz\r\n2273b9031af887053e39d5b89c60dccb8c6b71bf434b6bf770649917c1884e9f  guix-build-f5647c6c5ae8/output/arm64-apple-darwin/bitcoin-f5647c6c5ae8-arm64-apple-darwin-unsigned.tar.gz\r\n1dd279acda12afba9db96e2bfbadafc9e209866c0af68d58952dafd869298adb  guix-build-f5647c6c5ae8/output/arm64-apple-darwin/bitcoin-f5647c6c5ae8-arm64-apple-darwin-unsigned.zip\r\n71847e8121e14afe0ef221b40faa9b07d5ea948b5ab2082cb4d4e449e74eb87b  guix-build-f5647c6c5ae8/output/dist-archive/bitcoin-f5647c6c5ae8.tar.gz\r\naa17c8ef873b22f0ef5c97ba6b94d4e3205b397de0e2444d43126ce9829d1a69  guix-build-f5647c6c5ae8/output/powerpc64-linux-gnu/SHA256SUMS.part\r\n622b169f98d867806b5b4bda82a47d7e90d7611d1220e9409ec043362c04375b  guix-build-f5647c6c5ae8/output/powerpc64-linux-gnu/bitcoin-f5647c6c5ae8-powerpc64-linux-gnu-debug.tar.gz\r\n25865e532f1070886cae4327f78d4e1f7925ea5de0017ca44f0fff208b66d680  guix-build-f5647c6c5ae8/output/powerpc64-linux-gnu/bitcoin-f5647c6c5ae8-powerpc64-linux-gnu.tar.gz\r\n42e7f57e4803d6807870d9903629cf6f2c3f80672852fc6d22965881b0c3ce69  guix-build-f5647c6c5ae8/output/riscv64-linux-gnu/SHA256SUMS.part\r\nf1885fbe5248efbc8df46619f3378da2ba5bf23a7ffc8df80cae99cd17111650  guix-build-f5647c6c5ae8/output/riscv64-linux-gnu/bitcoin-f5647c6c5ae8-riscv64-linux-gnu-debug.tar.gz\r\n9087334d13e84b4df0dcdb172735ec8366a7851a29bd6709865a05b1326b1178  guix-build-f5647c6c5ae8/output/riscv64-linux-gnu/bitcoin-f5647c6c5ae8-riscv64-linux-gnu.tar.gz\r\nc911d60603c6497b751d389dc9ae3abb2ffd6527d0a981078ddd97754e3067b1  guix-build-f5647c6c5ae8/output/x86_64-apple-darwin/SHA256SUMS.part\r\n0c461f78d286ee02022774bca271cd11f0e95c6100bafd5b7a1800183c5574d8  guix-build-f5647c6c5ae8/output/x86_64-apple-darwin/bitcoin-f5647c6c5ae8-x86_64-apple-darwin-codesigning.tar.gz\r\n0dc0942b7c02f4642974c9a401c71dd92a60d0ee62907ef0ec0a92c89af0bec6  guix-build-f5647c6c5ae8/output/x86_64-apple-darwin/bitcoin-f5647c6c5ae8-x86_64-apple-darwin-unsigned.tar.gz\r\ndea1d4a048be0acf1bb1e33ea79c93ac03a802c67927a08652298f866e55d540  guix-build-f5647c6c5ae8/output/x86_64-apple-darwin/bitcoin-f5647c6c5ae8-x86_64-apple-darwin-unsigned.zip\r\n191627792b6a90e8c7bcec2be499949fe82640e951c1a2afca80adb7226972ba  guix-build-f5647c6c5ae8/output/x86_64-linux-gnu/SHA256SUMS.part\r\n5db03252938e5bf517904f0b3e0a26c6259f9689360bfd6f42f1ebf7ec37b14c  guix-build-f5647c6c5ae8/output/x86_64-linux-gnu/bitcoin-f5647c6c5ae8-x86_64-linux-gnu-debug.tar.gz\r\n83905c62a8a970cac67a6785c8cd266a7ef87f00855acba87d039e2dcd84d520  guix-build-f5647c6c5ae8/output/x86_64-linux-gnu/bitcoin-f5647c6c5ae8-x86_64-linux-gnu.tar.gz\r\n8b6e0679ba6cfcb8062e3e2ab0680a786b95dd6f886aacab9aeedb6df318a68f  guix-build-f5647c6c5ae8/output/x86_64-w64-mingw32/SHA256SUMS.part\r\nf3a3aff82c6b5e3469823e7b6dad0a46a4856ab5531f17d9261c04a09a45bd77  guix-build-f5647c6c5ae8/output/x86_64-w64-mingw32/bitcoin-f5647c6c5ae8-win64-codesigning.tar.gz\r\n0d1ffc9c16c0f91ae6d6a55f0ec7ca5b43b6a8081696893ce5598788e9d13f29  guix-build-f5647c6c5ae8/output/x86_64-w64-mingw32/bitcoin-f5647c6c5ae8-win64-debug.zip\r\n4f76fe9da2902ad2dfa49aacb939a4b07154178cc750da3ef7f021891a1ff794  guix-build-f5647c6c5ae8/output/x86_64-w64-mingw32/bitcoin-f5647c6c5ae8-win64-setup-unsigned.exe\r\neab0bdcbd71c88863aa37d271c75a404e4f624b2b7b110626d636c7b93fbcc42  guix-build-f5647c6c5ae8/output/x86_64-w64-mingw32/bitcoin-f5647c6c5ae8-win64-unsigned.zip\r\n```",
          "created_at": "2025-07-11T10:33:35Z"
        },
        {
          "user": "fanquake",
          "body": "Backported to 29.x in #32863.",
          "created_at": "2025-07-16T12:52:35Z"
        }
      ]
    },
    {
      "number": 32835,
      "title": "test: fix feature_init.py intermittencies",
      "body": "Aims to solve #32600. Found it while working on #26966 (this was really annoying there).\r\n\r\nThis ensures the node is index-synced before perturbing files.\r\nIf the index sync gets interrupted before it starts, the database could be empty,\r\nmaking any following perturbation ineffective (which explains why the node\r\ndoes not abort during startup in the #32600 logs).\r\n\r\nAlso, the first commit avoids initializing components not under test.\r\nThis reduces log flooding, which helped in understanding the issue.\r\n\r\nPatch to reproduce the issue on master using `feature_init.py` (this simulates\r\na node shutting down before the index starts syncing):\r\n```\r\ndiff --git a/src/index/base.cpp b/src/index/base.cpp\r\n--- a/src/index/base.cpp\t(revision 1e03052c3fefb188f047e72548f2c6b0cc019e50)\r\n+++ b/src/index/base.cpp\t(date 1751293306725)\r\n@@ -185,6 +185,7 @@\r\n void BaseIndex::Sync()\r\n {\r\n     const CBlockIndex* pindex = m_best_block_index.load();\r\n+    m_interrupt();\r\n     if (!m_synced) {\r\n         std::chrono::steady_clock::time_point last_log_time{0s};\r\n         std::chrono::steady_clock::time_point last_locator_write_time{0s};\r\n```\r\n",
      "state": "closed",
      "user": "furszy",
      "created_at": "2025-06-30T14:41:08Z",
      "updated_at": "2025-07-08T00:34:40Z",
      "comments": 9,
      "url": "https://github.com/bitcoin/bitcoin/pull/32835",
      "labels": [
        "Tests"
      ],
      "comment_list": [
        {
          "user": "DrahtBot",
          "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/32835.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [hodlinator](https://github.com/bitcoin/bitcoin/pull/32835#pullrequestreview-2993615431), [maflcko](https://github.com/bitcoin/bitcoin/pull/32835#issuecomment-3045335544), [achow101](https://github.com/bitcoin/bitcoin/pull/32835#issuecomment-3046915670) |\n| Concept ACK | [theStack](https://github.com/bitcoin/bitcoin/pull/32835#issuecomment-3032665076) |\n| Approach ACK | [TheCharlatan](https://github.com/bitcoin/bitcoin/pull/32835#issuecomment-3019500162) |\n\nIf your review is incorrectly listed, please react with üëé to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#32427](https://github.com/bitcoin/bitcoin/pull/32427) ((RFC) kernel: Replace leveldb-based BlockTreeDB with flat-file based store by TheCharlatan)\n* [#30469](https://github.com/bitcoin/bitcoin/pull/30469) (index: Fix coinstats overflow by fjahr)\n* [#26966](https://github.com/bitcoin/bitcoin/pull/26966) (index: initial sync speedup, parallelize process by furszy)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n<!--5faf32d7da4f0f540f40219e4f7537a3-->",
          "created_at": "2025-06-30T14:41:14Z"
        },
        {
          "user": "sedited",
          "body": "Approach ACK",
          "created_at": "2025-06-30T14:58:37Z"
        },
        {
          "user": "DrahtBot",
          "body": "<!--85328a0da195eb286784d51f73fa0af9-->\nüöß At least one of the CI tasks failed.\n<sub>Task `lint`: https://github.com/bitcoin/bitcoin/runs/45063074304</sub>\n<sub>LLM reason (‚ú® experimental): Lint check failed due to a Python code style error identified by ruff.</sub>\n\n<details><summary>Hints</summary>\n\nTry to run the tests locally, according to the documentation. However, a CI failure may still\nhappen due to a number of reasons, for example:\n\n* Possibly due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\n* A sanitizer issue, which can only be found by compiling with the sanitizer and running the\n  affected test.\n\n* An intermittent issue.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n</details>\n\n",
          "created_at": "2025-06-30T15:44:23Z"
        },
        {
          "user": "fanquake",
          "body": "cc @hodlinator ",
          "created_at": "2025-07-02T12:39:39Z"
        },
        {
          "user": "hodlinator",
          "body": "Concept ACK e36e0b1aebe437c090ff897d27bbec0a7c5a100a\r\n\r\n**Concept**: Theory for intermittent failure in #32600 makes sense, better to wait for all indexes before shutting down.\r\n\r\n**Testing**: Successfully tested with the suggested diff modifying `BaseIndex::Sync()` to prevent syncing.\r\n\r\n**Approach**: Left some nits, but most important thing I found was a comment that was probably accidentally removed.",
          "created_at": "2025-07-02T20:33:20Z"
        },
        {
          "user": "furszy",
          "body": "Updated per feedback. Thanks @hodlinator",
          "created_at": "2025-07-03T00:00:57Z"
        },
        {
          "user": "theStack",
          "body": "Concept ACK",
          "created_at": "2025-07-03T15:19:12Z"
        },
        {
          "user": "maflcko",
          "body": "lgtm ACK 4207d9bf823bea9f94b484ebf3c9274ca781b245 üçÑ\r\n\r\n<details><summary>Show signature</summary>\r\n\r\nSignature:\r\n\r\n```\r\nuntrusted comment: signature from minisign secret key on empty file; verify via: minisign -Vm \"${path_to_any_empty_file}\" -P RWTRmVTMeKV5noAMqVlsMugDDCyyTSbA3Re5AkUrhvLVln0tSaFWglOw -x \"${path_to_this_whole_four_line_signature_blob}\"\r\nRUTRmVTMeKV5npGrKx1nqXCw5zeVHdtdYURB/KlyA/LMFgpNCs+SkW9a8N95d+U4AP1RJMi+krxU1A3Yux4bpwZNLvVBKy0wLgM=\r\ntrusted comment: lgtm ACK 4207d9bf823bea9f94b484ebf3c9274ca781b245 üçÑ\r\n2EXDV5heWoQfQZkpGwQh96nSo8LQOg6o+F9Pz8zWpupTdDL71GjRRQw5M7JI1Td094wyEHaiN9RTI4W/Cj9MBQ==\r\n```\r\n\r\n</details>\r\n\r\n",
          "created_at": "2025-07-07T14:04:41Z"
        },
        {
          "user": "achow101",
          "body": "ACK 4207d9bf823bea9f94b484ebf3c9274ca781b245",
          "created_at": "2025-07-08T00:09:31Z"
        }
      ]
    },
    {
      "number": 32834,
      "title": "test: Use msg_generic in p2p_ping.py",
      "body": "It seems odd to derive `msg_pong_corrupt` from `msg_pong`, but then overwrite the serialize method, when one can just directly use `msg_generic` to pass the raw bytes to send over the wire.\r\n\r\nFix that by using `msg_generic`. This also serves as a regression test against the fix in commit 33480573cbd8d03aefbde100e51f827a2f7de7f7.\r\n\r\n(Can be tested by reverting that commit to observe a failure)",
      "state": "closed",
      "user": "maflcko",
      "created_at": "2025-06-30T12:54:26Z",
      "updated_at": "2025-06-30T15:39:26Z",
      "comments": 1,
      "url": "https://github.com/bitcoin/bitcoin/pull/32834",
      "labels": [
        "Tests"
      ],
      "comment_list": [
        {
          "user": "DrahtBot",
          "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/32834.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [dergoegge](https://github.com/bitcoin/bitcoin/pull/32834#pullrequestreview-2971157730), [theStack](https://github.com/bitcoin/bitcoin/pull/32834#pullrequestreview-2971207941) |\n\nIf your review is incorrectly listed, please react with üëé to this comment and the bot will ignore it on the next update.\n<!--5faf32d7da4f0f540f40219e4f7537a3-->",
          "created_at": "2025-06-30T12:54:32Z"
        }
      ]
    },
    {
      "number": 32833,
      "title": "test: Add `msgtype` to `msg_generic` slots",
      "body": "`msg_generic` can't be used unless `msgtype` is listed in `__slots__`\r\n\r\nExample from a [custom test](https://github.com/dergoegge/bitcoin/blob/6329ce979f63b396aa036a1ad39798bb83fa4ade/test/functional/p2p_bug28676.py):\r\n\r\n```\r\n2025-06-30T10:14:55.418000Z TestFramework (INFO): PRNG seed is: 3137163719543762151\r\n2025-06-30T10:14:55.418000Z TestFramework (INFO): Initializing test directory /tmp/nix-shell-110135-0/bitcoin_func_test_7lmiemmp\r\n2025-06-30T10:14:55.675000Z TestFramework (INFO): Setting up connections & mining some blocks...\r\n2025-06-30T10:14:56.511000Z TestFramework (ERROR): Unexpected exception caught during testing\r\nTraceback (most recent call last):\r\n  File \"/home/dergoegge/workspace/bitcoin/worktrees/master/test/functional/test_framework/test_framework.py\", line 189, in main\r\n    self.run_test()\r\n  File \"/home/dergoegge/workspace/bitcoin/worktrees/master/./build/test/functional/p2p_bug28676.py\", line 46, in run_test\r\n    self.connections[0].send_without_ping(msg_generic(b\"block\", bytes.fromhex(\"0500000006226e46111a0b59caaf126043eb5bbf28c34f3a5e332a1fc7b2b73cf188910f06b816712ffab8c59299a6abb58ccefa1995a1368ca4348782ef268cbc9bacacdbe5494dffff7f200200000001010000000001010000000000000000000000000000000000000000000000000000000000000000ffffffff075105ffffffff00ffffffff0200f90295000000002200204ae81572f06e1b88fd5ced7a1a000945432e83e1551e6f721ee9c00b8cc332600000000000000000266a24aa21a9ede2f61c3f71d1defd3fa999dfa36953755c690689799962b48bebd836974e8cf90120000000000000000000000000000000000000000000000000000000000000000000000000\")))\r\n  File \"/home/dergoegge/workspace/bitcoin/worktrees/master/test/functional/test_framework/messages.py\", line 1386, in __init__\r\n    self.msgtype = msgtype\r\nAttributeError: 'msg_generic' object has no attribute 'msgtype'\r\n```",
      "state": "closed",
      "user": "dergoegge",
      "created_at": "2025-06-30T10:17:49Z",
      "updated_at": "2025-06-30T12:57:08Z",
      "comments": 5,
      "url": "https://github.com/bitcoin/bitcoin/pull/32833",
      "labels": [
        "Tests"
      ],
      "comment_list": [
        {
          "user": "DrahtBot",
          "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/32833.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [maflcko](https://github.com/bitcoin/bitcoin/pull/32833#issuecomment-3018612787), [theStack](https://github.com/bitcoin/bitcoin/pull/32833#pullrequestreview-2970865694) |\n\nIf your review is incorrectly listed, please react with üëé to this comment and the bot will ignore it on the next update.\n<!--5faf32d7da4f0f540f40219e4f7537a3-->",
          "created_at": "2025-06-30T10:17:55Z"
        },
        {
          "user": "maflcko",
          "body": "lgtm ACK 7dc43ea503a2c145ffd4fe14b794300bfc2bcdee\r\n\r\nCould add a small smoke test, maybe in `./test/functional/p2p_ping.py`, but seems fine either way",
          "created_at": "2025-06-30T10:23:54Z"
        },
        {
          "user": "dergoegge",
          "body": "> Could add a small smoke test, maybe in ./test/functional/p2p_ping.py, but seems fine either way\r\n\r\nNot gonna do it here, but if someone wants to do it in a follow up, I can review",
          "created_at": "2025-06-30T12:11:52Z"
        },
        {
          "user": "fanquake",
          "body": "Backported to `29.x` in #32810.",
          "created_at": "2025-06-30T12:30:05Z"
        },
        {
          "user": "maflcko",
          "body": "Done in https://github.com/bitcoin/bitcoin/pull/32834",
          "created_at": "2025-06-30T12:57:08Z"
        }
      ]
    }
  ],
  "issues": [
    {
      "number": 32838,
      "title": "Shallow invalid forks + ActivateBestChainStep result in overly aggressive mempool filtering",
      "body": "### Is there an existing issue for this?\n\n- [x] I have searched the existing issues\n\n### Current behaviour\n\nUpon reorgs, the mempool has its transactions filtered near the end of every call of `ActivateBestChainStep` via  `MaybeUpdateMempoolForReorg` : https://github.com/bitcoin/bitcoin/blob/a763497b1d6661bc5a7b8943d8f04a4459fd6827/src/validation.cpp#L3403\n\nIf the fork being activated is actually invalid this can happen:\n\n1. Chain at height `T`, with transaction in mempool which relies on height T or higher for lock validity (nsequence f.e.)\n2. Alternative chain to height `T+1`, forking at `T-1` is encountered.\n3. `ActivateBestChainStep` fires once, rolling back to height `T-1`, then stopping when it attempts to validate the invalid block fork at height `T`.\n4. Since `fBlocksDisconnected` is true, `MaybeUpdateMempoolForReorg` is called at height `T-1`\n5. Transaction is filtered due to non-final locks at height `T-1`, and function returns\n6. Next `ActivateBestChainStep` is called, but with an empty disconnect pool, getting back to height `T` with original chain tip at step (1)\n\nI think this can also happen if a valid reorg is longer than 32 blocks: https://github.com/bitcoin/bitcoin/blob/a763497b1d6661bc5a7b8943d8f04a4459fd6827/src/validation.cpp#L3360\n\n### Expected behaviour\n\nIdeally, the disconnectpool would not be re-applied until the known reorg is complete.\n\n### Steps to reproduce\n\nAn example causing this was found during debugging a related fuzzing crash: https://github.com/bitcoin/bitcoin/pull/28676#issuecomment-3018572194\n\n### Relevant log output\n\n_No response_\n\n### How did you obtain Bitcoin Core\n\nCompiled from source\n\n### What version of Bitcoin Core are you using?\n\nhttps://github.com/dergoegge/bitcoin/commit/6329ce979f63b396aa036a1ad39798bb83fa4ade\n\n### Operating system and version\n\nUbuntu\n\n### Machine specifications\n\n_No response_",
      "state": "open",
      "user": "instagibbs",
      "created_at": "2025-06-30T17:05:42Z",
      "updated_at": "2026-01-15T09:07:23Z",
      "comments": 3,
      "url": "https://github.com/bitcoin/bitcoin/issues/32838",
      "labels": [
        "Mempool"
      ],
      "comment_list": [
        {
          "user": "instagibbs",
          "body": "cc @dergoegge",
          "created_at": "2025-06-30T17:06:01Z"
        },
        {
          "user": "mzumsande",
          "body": "Mabe we could create a `DisconnectedBlockTransactions` pool in `ActivateBestChain()` that is passed to each `ActivateBestChainStep()` instead of having a separate one in each `ActivateBestChainStep()` call, and then only call `MaybeUpdateMempoolForReorg` after `ABC` has made enough progress. We'd have to deal with blocks from multiple separate disconnections within one pool then (meaning duplicates/ possbile conflicts, because we could go into multiple forks, try to connect blocks, fail at some point along the way, disconnect those blocks again and so on) This might complicate things a bit. \n\nObviously someone has to create invalid blocks with valid PoW to trigger this (losing at least one block reward), which is costly.",
          "created_at": "2025-06-30T18:27:18Z"
        },
        {
          "user": "sdaftuar",
          "body": "I discovered a related, but separate issue -- if we reorg to a lower-height chain, then I believe it's possible (likely?) for a mempool transaction with an unconfirmed parent (and which doesn't have BIP68 disabled) to be evicted from the mempool, even if the transaction is valid and would be reaccepted if immediately resubmitted.\n\nMy understanding is that this can happen due to the special heights we store for transactions with mempool dependencies (\"tip height + 1\") -- we can use a cached value that was generated when the chain was longer and so on a lower height chain, we'll filter the tx. ",
          "created_at": "2025-11-28T20:18:40Z"
        }
      ]
    },
    {
      "number": 32836,
      "title": ".",
      "body": "",
      "state": "closed",
      "user": "Ciornenichii",
      "created_at": "2025-06-30T15:10:40Z",
      "updated_at": "2025-06-30T15:13:01Z",
      "comments": 0,
      "url": "https://github.com/bitcoin/bitcoin/issues/32836",
      "labels": []
    },
    {
      "number": 32832,
      "title": "[IBD] Raspberry Pi: 90% CPU time for 1.5% of block processing",
      "body": "There are numerous reports about how slow syncing on cheaper nodes (e.g. Raspberry Pi) is, a few recent ones from different platforms:\n\n* https://github.com/bitcoin/bitcoin/issues/32455#issuecomment-2977222246\n> I'm running a Raspberry Pi 5 with 8GB of RAM and a 4TB SSD on RPi's Debian Lite Bookworm. This is a fresh install of v29 and after more than two weeks I'm only at blockheight of 829564 of 901531.\n\n* https://stacker.news/items/978269\n> IBD now, I am sitting at 7 days and only 78% synced. The progress has whittled down to only ~1-2% per day. At this rate I think it will take me another 2-3 weeks to finish initial sync. [...]\nI'm running bitcoin core 29.0 on 64bit Raspberry Pi OS (debian bookworm)\n\n* https://bitcoin.stackexchange.com/questions/125178/first-synchronized-has-been-running-for-7-days-and-is-at-82\n> have a raspberry pi 5 and the sync has been running for over a week and is only at 82%\n\n* https://www.reddit.com/r/getumbrel/comments/1chqna1/bitcoin_node_too_slow_to_sync\n> i have setup a raspberry pi 5 with umbrel and installed the bitcoin node and it is downloading the blockchain for more then 1 and half week. Its very very slow when it reached 91%.\n\n* https://forums.raspberrypi.com/viewtopic.php?t=380689\n> I have been chipping away since Thanksgiving trying to just get in sync with the blockchain. \n\n* https://community.umbrel.com/t/extremely-slow-initial-blockchain-sync-1-a-day/2777\n> download is VERY slow on my setup, like 1% a day\n\n* https://x.com/notgrubles/status/1952375546748477596\n> Something happened in the past 24 months that makes syncing on typical hard drives impossibly slow.\n\n* https://x.com/epic_curious/status/1728459624943079672\n> Every time I sync a full node on certain Thinkpads, there‚Äôs a distinct step-function change in CPU usage.\n\n-----\n\nAs part of https://github.com/bitcoin/bitcoin/pull/32043 I'm measuring IBD and `-reindex` performance regularly.\nDisplaying the resulting stack as flames (where the call graph of the methods is represented as the callee at the bottom and the final method at the top, deduplicating the parent methods, resulting in multiple similar leaves based on the call paths) indicates which areas of the code take most time:\n\nOn high-end devices we see that multithreaded script validation is a minor part of IBD (partially because of more threads, but the total is also a lot less dominant):\n<img width=\"1000\" alt=\"Image\" src=\"https://github.com/user-attachments/assets/36f4edd6-6e7b-4ccf-a331-70c65025b370\" />\n<details>\n<summary>source SVG</summary>\n\n![Image](https://github.com/user-attachments/assets/0f0722e4-b9e4-4599-9cd3-0934fdc7846d)\n</details>\n\nRecently I got access to several lower-end Raspberry Pi 4 devices. IBD took surprisingly long indeed, and the resulting flame graphs are quite surprising:\n<img width=\"1000\" alt=\"Image\" src=\"https://github.com/user-attachments/assets/c2bb6db4-988a-42cc-88bd-9552e461cfdb\" />\n<details>\n<summary>source SVG</summary>\n\n![Image](https://github.com/user-attachments/assets/adfe2ee4-6175-4bab-995b-253c036af636)\n</details>\n\nEven the hidden `ConnectTip` looks quite different...\n![Image](https://github.com/user-attachments/assets/3a89073e-b6fd-438a-83d9-3bcedc4aba35)\neven though it seems we do have SHANI optimizations that I first suspected as a possible culprit:\n![Image](https://github.com/user-attachments/assets/f6530615-1bf1-4254-8896-adb5814dc2ba)\n\n(I'll add the details of the server later, but currently my Pi servers are frozen, they're very sensitive creatures)\n\n-----\n\nDoing an inverse flame to show the *own* time (where the final methods are at the top and their different callers are below, deduplicating the final methods, resulting in duplicated parents) is also very revealing:\n\nHetzner I7/i9 server:\n<img width=\"1000\" alt=\"Image\" src=\"https://github.com/user-attachments/assets/3c862c25-5d97-448e-8335-fd0ec5aa5044\" />\n\nCorresponding to:\n```python\n=== Top 20 functions by self-time ===\n24,367,833,683,883 (12.53%) Lloop1_30\n16,614,495,487,954 ( 8.54%) secp256k1_fe_mul_inner\n9,671,690,320,529 ( 4.97%) std::_Hashtable<COutPoint, std::pair<COutPoint const, CCoinsCacheEntry>, Pool...\n8,048,128,525,665 ( 4.14%) Lloop2_30\n7,479,154,097,547 ( 3.85%) secp256k1_gej_double\n4,875,602,514,443 ( 2.51%) SipHashUint256Extra\n4,848,058,903,029 ( 2.49%) leveldb::(anonymous namespace)::BloomFilterPolicy::CreateFilter\n4,794,743,071,310 ( 2.47%) __memcmp_avx2_movbe\n4,683,317,778,516 ( 2.41%) __memmove_avx_unaligned_erms\n4,469,407,701,360 ( 2.30%) _int_malloc\n3,409,056,546,109 ( 1.75%) CSHA256::Write\n3,135,255,483,667 ( 1.61%) leveldb::SkipList<char const*, leveldb::MemTable::KeyComparator>::FindGreater...\n2,957,747,949,622 ( 1.52%) secp256k1_fe_sqrt\n2,473,661,676,032 ( 1.27%) leveldb::BlockBuilder::Add\n2,432,229,937,337 ( 1.25%) AutoFile::write_buffer\n2,309,378,132,280 ( 1.19%) _int_free\n2,272,582,522,437 ( 1.17%) malloc\n2,140,700,000,760 ( 1.10%) leveldb::MemTable::KeyComparator::operator\n2,088,998,156,937 ( 1.07%) AutoFile::detail_fread\n2,033,602,002,215 ( 1.05%) leveldb::InternalKeyComparator::Compare\n```\n\nPi - showing very heavy signature validation:\n<img width=\"1000\" alt=\"Image\" src=\"https://github.com/user-attachments/assets/d9df5521-29c6-4635-aab7-44eefd627edb\" />\n\nI.e. almost 90% of the time is spent in signature validation even though only 1.5% of the blocks had them ((900000-[886157](https://mempool.space/block/00000000000000000001b658dd1120e82e66d2790811f89ede9742ada3ed6d77))/900000=1.5%)\n```python\n=== Top 20 functions by self-time ===\n45,200,219,094,553 (49.07%) secp256k1_fe_mul_inner\n17,059,129,066,358 (18.52%) secp256k1_gej_double\n4,958,246,221,561 ( 5.38%) secp256k1_fe_sqrt\n4,537,566,553,791 ( 4.93%) secp256k1_gej_add_ge_var\n2,679,543,872,014 ( 2.91%) secp256k1_fe_sqr_inner\n1,776,534,490,509 ( 1.93%) CSHA256::Write\n1,423,064,476,505 ( 1.54%) secp256k1_ecmult_strauss_wnaf.constprop.0\n1,406,501,260,817 ( 1.53%) sha256_arm_shani::Transform\n1,160,517,562,371 ( 1.26%) __memcpy_generic\n1,087,798,904,524 ( 1.18%) secp256k1_ge_from_storage\n967,511,395,459 ( 1.05%) secp256k1_gej_add_zinv_var\n837,850,817,824 ( 0.91%) secp256k1_modinv64_var\n613,159,858,561 ( 0.67%) cfree@GLIBC_2.17\n490,119,900,000 ( 0.53%) secp256k1_ecmult_wnaf.constprop.0.isra.0\n474,344,476,011 ( 0.51%) uint256 SignatureHash<CTransaction>\n462,336,566,142 ( 0.50%) SignatureCache::Get\n455,625,547,742 ( 0.49%) GetScriptOp\n393,204,249,970 ( 0.43%) MurmurHash3\n387,212,664,603 ( 0.42%) CRollingBloomFilter::insert\n375,980,794,732 ( 0.41%) secp256k1_modinv64_update_de_62.isra.0\n```\n\n(it's possible I ran the two measurements with slightly different configs since it took weeks to convince the Pi not to overheat or OOM in the middle of measurements. I think the findings are still enough to continue the investigation)\n\n---\n\nZooming in the signature verification doesn't immediately reveal any obvious reason for the huge performance difference:\n\nHetzner:\n<img width=\"1000\" alt=\"Image\" src=\"https://github.com/user-attachments/assets/d20a3c91-cc1d-41a5-b98c-2a7c1b923272\" />\n\nPi:\n<img width=\"1000\" alt=\"Image\" src=\"https://github.com/user-attachments/assets/f0e8d31d-a117-4b59-992f-b5df6acd506d\" />\n\n----\n\nI'll investigate whether there's any room for obvious optimizations for Pi in https://github.com/bitcoin-core/secp256k1 - any other questions or suggestions are welcome.\n",
      "state": "open",
      "user": "l0rinc",
      "created_at": "2025-06-30T09:37:24Z",
      "updated_at": "2025-09-13T01:42:38Z",
      "comments": 9,
      "url": "https://github.com/bitcoin/bitcoin/issues/32832",
      "labels": [
        "Resource usage"
      ],
      "comment_list": [
        {
          "user": "maflcko",
          "body": "> ((900000-[886157](https://mempool.space/block/00000000000000000001b658dd1120e82e66d2790811f89ede9742ada3ed6d77))/900000=1.5%)\n\nCould clarify in the title or in the text that this is for blocks after assumevalid?",
          "created_at": "2025-06-30T10:35:50Z"
        },
        {
          "user": "l0rinc",
          "body": "> Could clarify in the title or in the text that this is for blocks after assumevalid?\n\nDid I miscalculate it? Since the benchmark was running until 900k blocks of which only 13843 blocks needed script validation (unless I ran into https://github.com/bitcoin/bitcoin/issues/31494), isn't that 13843/900000=0.0153811111 i.e. 1.5% of the blocks had any script validation, yet almost 90% of the time was spent there?",
          "created_at": "2025-06-30T13:26:59Z"
        },
        {
          "user": "Raimo33",
          "body": "I think I found the root cause, not tested, just speculating:\n\nNew Raspberry devices (Pi 3, Pi 4, etc.) are 64-bit CPUs. They can also be setup to run in 32bit mode, but I assume both the above benchmarks and issues used them in the default 64bit mode.\n\nthe incriminated functions: `secp256k1_fe_mul_inner` and `secp256k1_fe_sqr_inner` are notably the most expensive operations of libsecp256k1...\n\nlibsecp256k1 has various versions of these functions, compiled selectively based on the target architecture. Specifically:\n\n32bit x86 -> `field_10x26_impl.h`: unoptimized, baseline, not really useful (most 32bit machines are arm)\n32bit arm -> `field_10x26_impl_arm.s`: optimized assembly path, useful in older Raspberry devices (Pi 1, Pi 2)\n\n**64bit x86/arm** -> `field_5x52_impl.h`: this is our case study.\n\nOn 64bit archs, `field_5x52_impl.h` will use 128bit integers (`secp256k1_uint128`) regardless of whether 128bit registers are supported or not. While most modern machines support 128bit registers natively, with `uint128_t` being an actual available type, Raspberry Pi doesn't have them. Therefore 64x64 bit multiplications, which happen 30+ times per single  `secp256k1_fe_mul_inner` call and 20+ times in `secp256k1_fe_sqr_inner`, have to be emulated using 64bit registers. **I believe this is the main bottleneck!**\n\nemulating 128bit multiplications with 64bit registers can be [2-5x slower](https://chatgpt.com/s/dr_68bf461e06d481919ae1f938190dcdb9), or maybe more, seeing the width difference of the flamegraph stacks between Pi and i7. Furthermore, it's not only multiplication. inside `secp256k1_fe_mul_inner` and  `secp256k1_fe_sqr_inner` there are plenty of shifts, accumulations, additions... \n\nI wouldn't be surprised if the 32bit version Pi would perform better than the 64bit one, just because of the specific assembly implementation (`field_10x26_impl_arm.s`) that would be compiled rather than the emulated 128bit functions.\n\n> * https://x.com/notgrubles/status/1952375546748477596\n> \n> > Something happened in the past 24 months that makes syncing on typical hard drives impossibly slow.\n\nThis user confirms he was using a machine without native 128bit registers",
          "created_at": "2025-09-08T21:01:56Z"
        },
        {
          "user": "l0rinc",
          "body": "Thanks for the hint. I'm planning on investigating in more detail, but I have noticed my intuitions were off often, I try not to speculate anymore, it's why it would help if we could back these by any concrete measurements before we attempt a fix.",
          "created_at": "2025-09-08T21:10:37Z"
        },
        {
          "user": "sipa",
          "body": "Is this before or after the assumevalid point? If before, the secp256k1 operations won't even be used.\n\nAnd if you are on a 64-bit ARM system, you absolutely want to use the 64-bit secp256k1 field implementations. They perform 4x fewer multiplications than the 32-bit ones. The asm optimizations compensate somewhat for that by better pipelining, but (1) can't overcome the fact that you just need far more arithmetic operations on 32-bit, and (2) the asm optimizations aren't even enabled by default in Bitcoin Core builds.",
          "created_at": "2025-09-08T21:15:21Z"
        },
        {
          "user": "Raimo33",
          "body": "> the asm optimizations aren't even enabled by default in Bitcoin Core builds.\n\nIs there a specific reason for this?",
          "created_at": "2025-09-08T21:16:26Z"
        },
        {
          "user": "sipa",
          "body": "Historically, because they were new and unreviewed, and after that I guess we forgot about them (sorry, @laanwj ...).",
          "created_at": "2025-09-08T21:19:00Z"
        },
        {
          "user": "Raimo33",
          "body": "@l0rinc if I were you I would setup a simple benchmark to test how many cycles it takes to execute a single 64x64->128 multiplication. and compare that with your i7.",
          "created_at": "2025-09-08T21:19:36Z"
        },
        {
          "user": "sipa",
          "body": "Or run the libsecp256k1 benchmarks on both to see how fast signature verification is on both systems.",
          "created_at": "2025-09-08T21:21:03Z"
        }
      ]
    }
  ],
  "summary": {
    "pull_requests": 10,
    "issues": 3
  }
}