{
  "source": "github",
  "repository": "bitcoin/bitcoin",
  "fetched_at": "2026-01-15T19:48:24.068333+00:00",
  "date": "2025-06-06",
  "pull_requests": [
    {
      "number": 32696,
      "title": "doc: make `-DWITH_ZMQ=ON` explicit on `build-unix.md`",
      "body": "ZMQ support is not built by default on Linux, and the docs don't make that clear. This PR makes it explicit that the `-DWITH_ZMQ=ON` flag is required to build with ZMQ support on `build-unix.md`.",
      "state": "closed",
      "user": "luisschwab",
      "created_at": "2025-06-06T22:44:36Z",
      "updated_at": "2025-11-21T23:37:02Z",
      "comments": 3,
      "url": "https://github.com/bitcoin/bitcoin/pull/32696",
      "labels": [
        "Docs"
      ],
      "comment_list": [
        {
          "user": "DrahtBot",
          "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/32696.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [maflcko](https://github.com/bitcoin/bitcoin/pull/32696#issuecomment-2951916899) |\n\nIf your review is incorrectly listed, please react with üëé to this comment and the bot will ignore it on the next update.\n<!--5faf32d7da4f0f540f40219e4f7537a3-->\n### LLM Linter (‚ú® experimental)\n\nPossible typos and grammar issues:\n\n- ‚Äúrequire the following dependency.‚Äù -> ‚Äúrequire the following dependency:‚Äù [uses a period where a colon is needed to introduce the list]\n\n<sup>drahtbot_id_4_m</sup>\n",
          "created_at": "2025-06-06T22:44:39Z"
        },
        {
          "user": "maflcko",
          "body": "lgtm ACK 32d4e92b9ac81858d754487bfec2fef6bed13a57",
          "created_at": "2025-06-07T05:59:52Z"
        },
        {
          "user": "fanquake",
          "body": "Backported to 29.x in #32589.",
          "created_at": "2025-06-10T16:29:04Z"
        }
      ]
    },
    {
      "number": 32694,
      "title": "index: move disk read lookups to base class",
      "body": "Combining common refactors from #24230 and #26966, aiming to move both efforts forward while reducing their size and review burden.\r\n\r\nBroadly, #24230 focuses on enabling indexes to run in a separate process, and #26966 aims to parallelize the indexes initial synchronization process. A shared prerequisite for both is ensuring that only the base index class interacts with the node‚Äôs chain internals - child index classes should instead operate solely through chain events.\r\n\r\nThis PR moves disk read lookups from child index classes to the base index class. It also includes a few documentation improvements and a test-only code cleanup.",
      "state": "closed",
      "user": "furszy",
      "created_at": "2025-06-06T20:38:40Z",
      "updated_at": "2025-06-13T00:10:23Z",
      "comments": 5,
      "url": "https://github.com/bitcoin/bitcoin/pull/32694",
      "labels": [
        "UTXO Db and Indexes"
      ],
      "comment_list": [
        {
          "user": "DrahtBot",
          "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/32694.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [TheCharlatan](https://github.com/bitcoin/bitcoin/pull/32694#pullrequestreview-2916104805), [maflcko](https://github.com/bitcoin/bitcoin/pull/32694#issuecomment-2961892641), [davidgumberg](https://github.com/bitcoin/bitcoin/pull/32694#pullrequestreview-2918273444), [mzumsande](https://github.com/bitcoin/bitcoin/pull/32694#pullrequestreview-2922594958), [achow101](https://github.com/bitcoin/bitcoin/pull/32694#issuecomment-2968366815) |\n| Stale ACK | [ryanofsky](https://github.com/bitcoin/bitcoin/pull/32694#pullrequestreview-2913210912) |\n\nIf your review is incorrectly listed, please react with üëé to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#30469](https://github.com/bitcoin/bitcoin/pull/30469) (index: Fix coinstats overflow and introduce index versioning by fjahr)\n* [#29307](https://github.com/bitcoin/bitcoin/pull/29307) (util: explicitly close all AutoFiles that have been written by vasild)\n* [#26966](https://github.com/bitcoin/bitcoin/pull/26966) (index: initial sync speedup, parallelize process by furszy)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n<!--5faf32d7da4f0f540f40219e4f7537a3-->",
          "created_at": "2025-06-06T20:38:42Z"
        },
        {
          "user": "furszy",
          "body": "Thanks for the review ryanofsky and TheCharlatan!\r\nUpdated per feedback.\r\n\r\n> Can you double-check the commit message of https://github.com/bitcoin/bitcoin/commit/50696f07784b5dcf04a398f7592dead4dde6d2e9. I think there is a word too much in the first and second sentence.\r\n\r\nDone.",
          "created_at": "2025-06-10T17:02:20Z"
        },
        {
          "user": "maflcko",
          "body": "review ACK 029ba1a21d570f7db6c4366ec9a30a381b56d6fb üë°\r\n\r\n<details><summary>Show signature</summary>\r\n\r\nSignature:\r\n\r\n```\r\nuntrusted comment: signature from minisign secret key on empty file; verify via: minisign -Vm \"${path_to_any_empty_file}\" -P RWTRmVTMeKV5noAMqVlsMugDDCyyTSbA3Re5AkUrhvLVln0tSaFWglOw -x \"${path_to_this_whole_four_line_signature_blob}\"\r\nRUTRmVTMeKV5npGrKx1nqXCw5zeVHdtdYURB/KlyA/LMFgpNCs+SkW9a8N95d+U4AP1RJMi+krxU1A3Yux4bpwZNLvVBKy0wLgM=\r\ntrusted comment: review ACK 029ba1a21d570f7db6c4366ec9a30a381b56d6fb üë°\r\nOQ13TwEEQORasoU+qCZ+jMGAPXKnsCJhTt8atkoWt5nRWhCn9ueXFilV6W5B9iknOUBhP6B2nDQJXduuKa0nAA==\r\n```\r\n\r\n</details>\r\n\r\n",
          "created_at": "2025-06-11T09:23:43Z"
        },
        {
          "user": "furszy",
          "body": "Will try to not touch the code while we are all happy with the current state. Moving #26966 and #24230 forward after ~3 years sounds good enough to me :)",
          "created_at": "2025-06-12T18:21:09Z"
        },
        {
          "user": "achow101",
          "body": "ACK 029ba1a21d570f7db6c4366ec9a30a381b56d6fb",
          "created_at": "2025-06-12T22:51:15Z"
        }
      ]
    },
    {
      "number": 32693,
      "title": "depends: fix cmake compatibility error for freetype",
      "body": "## Problem\r\n\r\nWhile doing a depends build with CMake 4.0.1, I got the following error:\r\n\r\n```\r\nExtracting freetype...\r\n/root/bitcoin/depends/sources/freetype-2.11.0.tar.xz: OK\r\nPreprocessing freetype...\r\nConfiguring freetype...\r\nCMake Error at CMakeLists.txt:100 (cmake_minimum_required):\r\n  Compatibility with CMake < 3.5 has been removed from CMake.\r\n\r\n  Update the VERSION argument <min> value.  Or, use the <min>...<max> syntax\r\n  to tell CMake that the project requires at least <min> but has been updated\r\n  to work with policies introduced by <max> or earlier.\r\n\r\n  Or, add -DCMAKE_POLICY_VERSION_MINIMUM=3.5 to try configuring anyway.\r\n\r\n\r\n-- Configuring incomplete, errors occurred!\r\nmake: *** [funcs.mk:343: /root/bitcoin/depends/x86_64-pc-linux-gnu/.freetype_stamp_configured] Error 1\r\nmake: Leaving directory '/root/bitcoin/depends'\r\n```\r\n\r\n.. which led me to https://cmake.org/cmake/help/latest/release/4.0.html#deprecated-and-removed-features, which states compatibility with CMake versions less than 3.5 has been removed in 4.0.\r\n\r\n## Fix\r\nBased on the suggestion from the error message (and from reading the CMake docs), I added `-DCMAKE_POLICY_VERSION_MINIMUM=3.22`. I picked `3.22` (as opposed to 3.5) since that is the minimum version of CMake we specify in `doc/dependencies.md`. Would be nice if there was a way to pipe the min version in as a variable (since presumably we'd want to update this to be in lock step with the minimum CMake version of the whole project), but I couldn't think of a simple way to do this. Open to suggestions on a more robust way to do this if this is deemed too brittle.",
      "state": "closed",
      "user": "josibake",
      "created_at": "2025-06-06T15:08:05Z",
      "updated_at": "2025-06-13T14:40:34Z",
      "comments": 17,
      "url": "https://github.com/bitcoin/bitcoin/pull/32693",
      "labels": [
        "Build system"
      ],
      "comment_list": [
        {
          "user": "DrahtBot",
          "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/32693.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [fanquake](https://github.com/bitcoin/bitcoin/pull/32693#pullrequestreview-2924223744), [hebasto](https://github.com/bitcoin/bitcoin/pull/32693#pullrequestreview-2924440981) |\n\nIf your review is incorrectly listed, please react with üëé to this comment and the bot will ignore it on the next update.\n<!--5faf32d7da4f0f540f40219e4f7537a3-->\n### LLM Linter (‚ú® experimental)\n\nPossible typos and grammar issues:\n\n- C_VISBILITY_PRESET -> C_VISIBILITY_PRESET [misspelled ‚Äúvisibility‚Äù in the property name]\n\n<sup>drahtbot_id_4_m</sup>\n",
          "created_at": "2025-06-06T15:08:08Z"
        },
        {
          "user": "DrahtBot",
          "body": "<!--9cd9c72976c961c55c7acef8f6ba82cd-->\n### Guix builds (on x86_64) [untrusted test-only build, possibly unsafe, not for production use]\n\n| File | commit ae024137bda9fe189f4e7ccf26dbaffd44cbbeb6<br>(master) | commit 188b73aecd432466adcb3c1211730cd02061cbde<br>(pull/32693/merge) |\n|--|--|--|\n| *-aarch64-linux-gnu-debug.tar.gz | [`25cf5734a41df134...`](https://drahtbot.space/guix/monotree/ae024137bda9fe189f4e7ccf26dbaffd44cbbeb6/bitcoin-ae024137bda9-aarch64-linux-gnu-debug.tar.gz) | [`4a1abb69e39ab27e...`](https://drahtbot.space/guix/monotree/188b73aecd432466adcb3c1211730cd02061cbde/bitcoin-188b73aecd43-aarch64-linux-gnu-debug.tar.gz) |\n| *-aarch64-linux-gnu.tar.gz | [`67b9872876dfb99f...`](https://drahtbot.space/guix/monotree/ae024137bda9fe189f4e7ccf26dbaffd44cbbeb6/bitcoin-ae024137bda9-aarch64-linux-gnu.tar.gz) | [`adcd5bfa492a722f...`](https://drahtbot.space/guix/monotree/188b73aecd432466adcb3c1211730cd02061cbde/bitcoin-188b73aecd43-aarch64-linux-gnu.tar.gz) |\n| *-arm-linux-gnueabihf-debug.tar.gz | [`a71d38f4fa1f4691...`](https://drahtbot.space/guix/monotree/ae024137bda9fe189f4e7ccf26dbaffd44cbbeb6/bitcoin-ae024137bda9-arm-linux-gnueabihf-debug.tar.gz) | [`b194f1510da68972...`](https://drahtbot.space/guix/monotree/188b73aecd432466adcb3c1211730cd02061cbde/bitcoin-188b73aecd43-arm-linux-gnueabihf-debug.tar.gz) |\n| *-arm-linux-gnueabihf.tar.gz | [`e1c84ad85292abca...`](https://drahtbot.space/guix/monotree/ae024137bda9fe189f4e7ccf26dbaffd44cbbeb6/bitcoin-ae024137bda9-arm-linux-gnueabihf.tar.gz) | [`06baa5c1fbcc6bb7...`](https://drahtbot.space/guix/monotree/188b73aecd432466adcb3c1211730cd02061cbde/bitcoin-188b73aecd43-arm-linux-gnueabihf.tar.gz) |\n| *-arm64-apple-darwin-codesigning.tar.gz | [`756e07833433b926...`](https://drahtbot.space/guix/monotree/ae024137bda9fe189f4e7ccf26dbaffd44cbbeb6/bitcoin-ae024137bda9-arm64-apple-darwin-codesigning.tar.gz) | [`e4ea8cf298372555...`](https://drahtbot.space/guix/monotree/188b73aecd432466adcb3c1211730cd02061cbde/bitcoin-188b73aecd43-arm64-apple-darwin-codesigning.tar.gz) |\n| *-arm64-apple-darwin-unsigned.tar.gz | [`da2dfaaeb791c566...`](https://drahtbot.space/guix/monotree/ae024137bda9fe189f4e7ccf26dbaffd44cbbeb6/bitcoin-ae024137bda9-arm64-apple-darwin-unsigned.tar.gz) | [`a52576d002e10366...`](https://drahtbot.space/guix/monotree/188b73aecd432466adcb3c1211730cd02061cbde/bitcoin-188b73aecd43-arm64-apple-darwin-unsigned.tar.gz) |\n| *-arm64-apple-darwin-unsigned.zip | [`e69b447507f4cf53...`](https://drahtbot.space/guix/monotree/ae024137bda9fe189f4e7ccf26dbaffd44cbbeb6/bitcoin-ae024137bda9-arm64-apple-darwin-unsigned.zip) | [`1e6afeaf3e449724...`](https://drahtbot.space/guix/monotree/188b73aecd432466adcb3c1211730cd02061cbde/bitcoin-188b73aecd43-arm64-apple-darwin-unsigned.zip) |\n| *-powerpc64-linux-gnu-debug.tar.gz | [`6d4b699702cee8d9...`](https://drahtbot.space/guix/monotree/ae024137bda9fe189f4e7ccf26dbaffd44cbbeb6/bitcoin-ae024137bda9-powerpc64-linux-gnu-debug.tar.gz) | [`6848a64fcb246c7b...`](https://drahtbot.space/guix/monotree/188b73aecd432466adcb3c1211730cd02061cbde/bitcoin-188b73aecd43-powerpc64-linux-gnu-debug.tar.gz) |\n| *-powerpc64-linux-gnu.tar.gz | [`a7edb180a6fe25b5...`](https://drahtbot.space/guix/monotree/ae024137bda9fe189f4e7ccf26dbaffd44cbbeb6/bitcoin-ae024137bda9-powerpc64-linux-gnu.tar.gz) | [`6771dedaf2d746b4...`](https://drahtbot.space/guix/monotree/188b73aecd432466adcb3c1211730cd02061cbde/bitcoin-188b73aecd43-powerpc64-linux-gnu.tar.gz) |\n| *-riscv64-linux-gnu-debug.tar.gz | [`15a418e53ac1c1fe...`](https://drahtbot.space/guix/monotree/ae024137bda9fe189f4e7ccf26dbaffd44cbbeb6/bitcoin-ae024137bda9-riscv64-linux-gnu-debug.tar.gz) | [`90cc5a838559a8c3...`](https://drahtbot.space/guix/monotree/188b73aecd432466adcb3c1211730cd02061cbde/bitcoin-188b73aecd43-riscv64-linux-gnu-debug.tar.gz) |\n| *-riscv64-linux-gnu.tar.gz | [`f52790b6da2d787f...`](https://drahtbot.space/guix/monotree/ae024137bda9fe189f4e7ccf26dbaffd44cbbeb6/bitcoin-ae024137bda9-riscv64-linux-gnu.tar.gz) | [`d43aa7f902d5f80d...`](https://drahtbot.space/guix/monotree/188b73aecd432466adcb3c1211730cd02061cbde/bitcoin-188b73aecd43-riscv64-linux-gnu.tar.gz) |\n| *-x86_64-apple-darwin-codesigning.tar.gz | [`a19e91fffa07940c...`](https://drahtbot.space/guix/monotree/ae024137bda9fe189f4e7ccf26dbaffd44cbbeb6/bitcoin-ae024137bda9-x86_64-apple-darwin-codesigning.tar.gz) | [`563d2773d3772ba2...`](https://drahtbot.space/guix/monotree/188b73aecd432466adcb3c1211730cd02061cbde/bitcoin-188b73aecd43-x86_64-apple-darwin-codesigning.tar.gz) |\n| *-x86_64-apple-darwin-unsigned.tar.gz | [`915c1995eb4a40c3...`](https://drahtbot.space/guix/monotree/ae024137bda9fe189f4e7ccf26dbaffd44cbbeb6/bitcoin-ae024137bda9-x86_64-apple-darwin-unsigned.tar.gz) | [`e33a38fdac3e8916...`](https://drahtbot.space/guix/monotree/188b73aecd432466adcb3c1211730cd02061cbde/bitcoin-188b73aecd43-x86_64-apple-darwin-unsigned.tar.gz) |\n| *-x86_64-apple-darwin-unsigned.zip | [`1b9dd52b0d94e0c8...`](https://drahtbot.space/guix/monotree/ae024137bda9fe189f4e7ccf26dbaffd44cbbeb6/bitcoin-ae024137bda9-x86_64-apple-darwin-unsigned.zip) | [`678c03e118da785a...`](https://drahtbot.space/guix/monotree/188b73aecd432466adcb3c1211730cd02061cbde/bitcoin-188b73aecd43-x86_64-apple-darwin-unsigned.zip) |\n| *-x86_64-linux-gnu-debug.tar.gz | [`07ef4da1afc210d7...`](https://drahtbot.space/guix/monotree/ae024137bda9fe189f4e7ccf26dbaffd44cbbeb6/bitcoin-ae024137bda9-x86_64-linux-gnu-debug.tar.gz) | [`08dc054e6398d83d...`](https://drahtbot.space/guix/monotree/188b73aecd432466adcb3c1211730cd02061cbde/bitcoin-188b73aecd43-x86_64-linux-gnu-debug.tar.gz) |\n| *-x86_64-linux-gnu.tar.gz | [`c8f9d52b7d0b37d7...`](https://drahtbot.space/guix/monotree/ae024137bda9fe189f4e7ccf26dbaffd44cbbeb6/bitcoin-ae024137bda9-x86_64-linux-gnu.tar.gz) | [`83bea6eb5185662d...`](https://drahtbot.space/guix/monotree/188b73aecd432466adcb3c1211730cd02061cbde/bitcoin-188b73aecd43-x86_64-linux-gnu.tar.gz) |\n| *.tar.gz | [`2474c9a44c349557...`](https://drahtbot.space/guix/monotree/ae024137bda9fe189f4e7ccf26dbaffd44cbbeb6/bitcoin-ae024137bda9.tar.gz) | [`6e25913e3c0bbc92...`](https://drahtbot.space/guix/monotree/188b73aecd432466adcb3c1211730cd02061cbde/bitcoin-188b73aecd43.tar.gz) |\n| SHA256SUMS.part | [`c44769c38787eaee...`](https://drahtbot.space/guix/monotree/ae024137bda9fe189f4e7ccf26dbaffd44cbbeb6/SHA256SUMS.part) | [`6889bf13fde93de5...`](https://drahtbot.space/guix/monotree/188b73aecd432466adcb3c1211730cd02061cbde/SHA256SUMS.part) |\n| guix_build.log | [`4c2bd3a45d8f630a...`](https://drahtbot.space/guix/monotree/ae024137bda9fe189f4e7ccf26dbaffd44cbbeb6/guix_build.log) | [`fe2df1bf3498566e...`](https://drahtbot.space/guix/monotree/188b73aecd432466adcb3c1211730cd02061cbde/guix_build.log) |\n| guix_build.log.diff |  | [`16387b018c4ca4d1...`](https://drahtbot.space/guix/monotree/188b73aecd432466adcb3c1211730cd02061cbde/guix_build.log.diff) |\n\n",
          "created_at": "2025-06-07T04:13:52Z"
        },
        {
          "user": "willcl-ark",
          "body": "Another approach might be to bump freetype itself to 2.12.1 where `cmake` version has been bumped from 2.5 to 3.0: https://gitlab.freedesktop.org/freetype/freetype/-/blob/VER-2-12-1/CMakeLists.txt?ref_type=tags#L111\r\n\r\nThis appears to be available on most platforms: https://repology.org/project/freetype/versions although I did not fully cross-reference against all our supported platforms. It is available on CentOS, but is not available on Debian 11 bullseye nor Ubuntu 22.04.\r\n\r\nBumping to this version appears to result in a warning, rather than an error:\r\n\r\n```\r\nFetching freetype-2.12.1.tar.xz from https://download.savannah.gnu.org/releases/freetype\r\n  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current\r\n                                 Dload  Upload   Total   Spent    Left  Speed\r\n  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0\r\n100 2413k  100 2413k    0     0  1277k      0  0:00:01  0:00:01 --:--:-- 2364k\r\n/home/will/src/core/bitcoin/depends/work/download/freetype-2.12.1/freetype-2.12.1.tar.xz.temp: OK\r\nExtracting freetype...\r\n/home/will/.local/state/guix-builds/depends-sources-cache/freetype-2.12.1.tar.xz: OK\r\nPreprocessing freetype...\r\nConfiguring freetype...\r\nCMake Deprecation Warning at CMakeLists.txt:111 (cmake_minimum_required):\r\n  Compatibility with CMake < 3.10 will be removed from a future version of\r\n  CMake.\r\n\r\n  Update the VERSION argument <min> value.  Or, use the <min>...<max> syntax\r\n  to tell CMake that the project requires at least <min> but has been updated\r\n  to work with policies introduced by <max> or earlier.\r\n```\r\n\r\n<details>\r\n<summary>Rough patch</summary>\r\n\r\n```diff\r\ndiff --git a/depends/packages/freetype.mk b/depends/packages/freetype.mk\r\nindex fef0beaa7b4..62a7b916be1 100644\r\n--- a/depends/packages/freetype.mk\r\n+++ b/depends/packages/freetype.mk\r\n@@ -1,8 +1,8 @@\r\n package=freetype\r\n-$(package)_version=2.11.0\r\n+$(package)_version=2.12.1\r\n $(package)_download_path=https://download.savannah.gnu.org/releases/$(package)\r\n $(package)_file_name=$(package)-$($(package)_version).tar.xz\r\n-$(package)_sha256_hash=8bee39bd3968c4804b70614a0a3ad597299ad0e824bc8aad5ce8aaf48067bde7\r\n+$(package)_sha256_hash=4766f20157cc4cf0cd292f80bf917f92d1c439b243ac3018debf6b9140c41a7f\r\n $(package)_build_subdir=build\r\n \r\n define $(package)_set_vars\r\n```\r\n\r\n</details>",
          "created_at": "2025-06-10T14:08:13Z"
        },
        {
          "user": "maflcko",
          "body": "> This appears to be available on most platforms:\r\n\r\nDepends  uses static linking, even for the GUI, so I don't think package versions shipped by distros are relevant here? If they were, the previous freetype version in depends would have caused issues on quite a few distros?\r\n\r\nEdit: Wrong, see below.",
          "created_at": "2025-06-10T14:24:15Z"
        },
        {
          "user": "fanquake",
          "body": "> Depends uses static linking, even for the GUI,\r\n\r\nFreetype (and the majority of the GUI deps) aren't statically linked. See here: https://github.com/bitcoin/bitcoin/blob/fe39050a66c73e82a8e5f7371dd9e3d70f5a1482/contrib/guix/symbol-check.py#L108-L127\r\n\r\nDiscrepancy amongst the versions used, is already causing issues, see #29977, however it's hard to know if anyone is using the affected systems, given no users seem to have complained about the GUI not working.",
          "created_at": "2025-06-10T14:31:30Z"
        },
        {
          "user": "willcl-ark",
          "body": "Outside of being statically-linked or not, it would seem surprising to me to build with (a) newer version(s) from depends than is generally available on the platforms we support. If we for example used a new feature from the version in depends this would presumably break building on some (older/slower to update) platforms.\r\n\r\nI'd always assumed we ~ (if not strictly) updated depends in line with which versions are available on our supported platforms.",
          "created_at": "2025-06-10T14:56:38Z"
        },
        {
          "user": "fanquake",
          "body": ">  it would seem surprising to me to build with (a) newer version(s) from depends than is generally available on the platforms we support. \r\n\r\nThis is why everything non-GUI from depends is statically linked, so that the runtime versions, don't matter.",
          "created_at": "2025-06-10T15:06:34Z"
        },
        {
          "user": "josibake",
          "body": "> Another approach might be to bump freetype itself to 2.12.1\r\n\r\nI had considered this, but this felt like a more invasive change. The goal here is simply to un-break the depends build for newer versions of CMake. Whether or not to bump the version of freetype in depends can then be evaluated as its own change, with its own motivation. ",
          "created_at": "2025-06-11T11:27:42Z"
        },
        {
          "user": "willcl-ark",
          "body": "Sure, but then to me that begs the question: \"For what reason did `cmake` introduce this policy?\"\r\n\r\nHaving built with the policy disabled the practical answer appears to be \"not much/nothing\", but I don't know enough about `cmake` to know why the policy really exists in the first place.",
          "created_at": "2025-06-11T11:37:24Z"
        },
        {
          "user": "ryanofsky",
          "body": "> but I don't know enough about `cmake` to know why the policy really exists in the first place.\r\n\r\nCmake just uses policies to be able to implement bugfixes and feature improvements in new cmake versions while providing a way to be backwards compatible with old versions, and attempting to be backwards compatible by default if a project does not explicitly enable recent policies. There is a long debate about which policy version is best to set in https://github.com/bitcoin-core/libmultiprocess/pull/163 if you are curious.\r\n\r\n",
          "created_at": "2025-06-11T12:55:30Z"
        },
        {
          "user": "josibake",
          "body": "> Sure, but then to me that begs the question: \"For what reason did cmake introduce this policy?\"\r\n\r\nI'm not sure what you mean by \".. introduce this policy.\" My understanding is that CMake is (regularly?) setting a deprecation warning for compatibility with older versions as new versions come out and then eventually the warnings become failures. Since freetype has a `min_required_version` of 2.8, trying to build with version 4 is now failing.\r\n\r\nBut in our case, our users would have been building with `3.22` or higher already, since thats the minimum supported version in our project. ~~So setting `CMAKE_MIN_POLICY_VERSION=3.22` _shouldn't_ be changing any behaviour, rather its more precise and explicit as to what is already happening today.~~\r\n\r\nBased on that, setting `CMAKE_MIN_POLICY_VERSION` to be the same as the our `min_version_required` seems to be the correct solution. Granted, this is informed only by my own reading of the CMake docs and the discussion in https://github.com/bitcoin-core/libmultiprocess/pull/163, so very possible I'm still misunderstanding something.\r\n\r\nEDIT: this could change behaviour in that previously, the policy defaults would be set to whatever the `min_required_version` is, whereas with a `min_policy_version`, the policies may be different if a newer version of CMake uses a new default.",
          "created_at": "2025-06-11T15:24:50Z"
        },
        {
          "user": "fanquake",
          "body": "Note that whatever is chosen, also needs to be backported, to fix CMake `4.x` compat on the `29.x` and `28.x` branches.\r\n\r\nPassing a compat option seems fine, and I think it's unlikely have adverse side effects, given that this is basically a dummy lib to link Qt against, and then throw away. I'd also be fine with a patch that bumps the minimum, we could just match the last upstream change: https://gitlab.freedesktop.org/freetype/freetype/-/merge_requests/352/diffs, and drop it whenever Freetype is next bumped (don't really want a bump to solve this, given it needs to be backported).",
          "created_at": "2025-06-12T09:36:46Z"
        },
        {
          "user": "josibake",
          "body": "Updated to add a patch per @hebasto 's [suggestion](https://github.com/bitcoin/bitcoin/pull/32693#discussion_r2140453692).",
          "created_at": "2025-06-12T10:34:34Z"
        },
        {
          "user": "fanquake",
          "body": "Guix Build:\r\n```bash\r\n96d5182898d13bbe5ee972df791c7fba7a4c3927c6fd224eba20e8d99fbf5173  guix-build-d7c37906e7b1/output/aarch64-linux-gnu/SHA256SUMS.part\r\n88d39050979a7441601f371a81e80fbe43035ff564d03dbca5de1fe61d9f6876  guix-build-d7c37906e7b1/output/aarch64-linux-gnu/bitcoin-d7c37906e7b1-aarch64-linux-gnu-debug.tar.gz\r\n20f78def7e6b24c1901b67ec1d694d315da1c3db45ff616b3ffff36046f785e6  guix-build-d7c37906e7b1/output/aarch64-linux-gnu/bitcoin-d7c37906e7b1-aarch64-linux-gnu.tar.gz\r\n1dafb25aa1ea1a8948e022aba7e6e97de4c16811751e963fe811d4a14de81715  guix-build-d7c37906e7b1/output/arm-linux-gnueabihf/SHA256SUMS.part\r\n82f6d2bf288f7a8d63f6fbd65d68c25af1767b5f5679934545e63e49e6944685  guix-build-d7c37906e7b1/output/arm-linux-gnueabihf/bitcoin-d7c37906e7b1-arm-linux-gnueabihf-debug.tar.gz\r\n910bd74934951cc7eae3b9a6ff8383954be17deb2898e9a4252384477baad1b8  guix-build-d7c37906e7b1/output/arm-linux-gnueabihf/bitcoin-d7c37906e7b1-arm-linux-gnueabihf.tar.gz\r\n517a215049ce7dcebbba93726636d6024866fb940fdf58e760a261953ce1e432  guix-build-d7c37906e7b1/output/arm64-apple-darwin/SHA256SUMS.part\r\n616d69ee6127607fd7003adfeb5bf556f1958b433387eac1284152f50a21726b  guix-build-d7c37906e7b1/output/arm64-apple-darwin/bitcoin-d7c37906e7b1-arm64-apple-darwin-codesigning.tar.gz\r\nf48d151805aa2652c851b64765e9e9697e6ab15c53f1c9ab061bebf2b219e3b0  guix-build-d7c37906e7b1/output/arm64-apple-darwin/bitcoin-d7c37906e7b1-arm64-apple-darwin-unsigned.tar.gz\r\ne851ecd77064bf3600609cd0a7cddbe8ee866e47167a90e2b0bc14b73bb723e7  guix-build-d7c37906e7b1/output/arm64-apple-darwin/bitcoin-d7c37906e7b1-arm64-apple-darwin-unsigned.zip\r\n6865a20bfed34b2bece49866570d4244649b890c0c6e515aa2a76320ee460a8e  guix-build-d7c37906e7b1/output/dist-archive/bitcoin-d7c37906e7b1.tar.gz\r\n653d18cb26d1142d0880dd966a7a994d97d4973b26599897fc251810a29021f3  guix-build-d7c37906e7b1/output/powerpc64-linux-gnu/SHA256SUMS.part\r\ndc1ca74bd929d708651df48656523e76f40dd9a38e8921825dbe0166f707e6e9  guix-build-d7c37906e7b1/output/powerpc64-linux-gnu/bitcoin-d7c37906e7b1-powerpc64-linux-gnu-debug.tar.gz\r\nec0c5a0bf04199dc801827b8619ecdf6ab335e0fcbb35235f8e7f23532b2a609  guix-build-d7c37906e7b1/output/powerpc64-linux-gnu/bitcoin-d7c37906e7b1-powerpc64-linux-gnu.tar.gz\r\ne3f7c7bd97f64b147a9a04a87a725b6232b2917c07a5b024aa5cd64349a5c283  guix-build-d7c37906e7b1/output/riscv64-linux-gnu/SHA256SUMS.part\r\nf38b986e738db12260c51287253a97b448aa2e78b6dbfcf1fbc9a8709374fbe5  guix-build-d7c37906e7b1/output/riscv64-linux-gnu/bitcoin-d7c37906e7b1-riscv64-linux-gnu-debug.tar.gz\r\n1c6e1eed6e853452fd4042c09775860f4cb4c82ebef8b740eabcae48e77712bc  guix-build-d7c37906e7b1/output/riscv64-linux-gnu/bitcoin-d7c37906e7b1-riscv64-linux-gnu.tar.gz\r\na0555a2693a6d4f1e21a8ca0727f2f2f40e3f4aa85e6ee577a3074cdbfbadad5  guix-build-d7c37906e7b1/output/x86_64-apple-darwin/SHA256SUMS.part\r\n337e82322a171120a5e4912f5c3dadbf7c5b90c8b638b962c351c23d60e8f27d  guix-build-d7c37906e7b1/output/x86_64-apple-darwin/bitcoin-d7c37906e7b1-x86_64-apple-darwin-codesigning.tar.gz\r\n9377c9776f769a08c3f6e98f029bc728b1e3c9b724ca7720c36195b587d9f489  guix-build-d7c37906e7b1/output/x86_64-apple-darwin/bitcoin-d7c37906e7b1-x86_64-apple-darwin-unsigned.tar.gz\r\n759c6092dcdbe6b23e42afe4699a9003ecb06073542de76ec34e8e6b61cc3a9c  guix-build-d7c37906e7b1/output/x86_64-apple-darwin/bitcoin-d7c37906e7b1-x86_64-apple-darwin-unsigned.zip\r\nd83ed73cf6716d3e8467d625d3788526cdd2d93af38510b7275a0dc07a61a335  guix-build-d7c37906e7b1/output/x86_64-linux-gnu/SHA256SUMS.part\r\ne3ee49b029eb53068993afbe6d20434dd7fc93fb9cca1ab3db7dbb28ab1dcc8d  guix-build-d7c37906e7b1/output/x86_64-linux-gnu/bitcoin-d7c37906e7b1-x86_64-linux-gnu-debug.tar.gz\r\na15bc74d38fc410d7b859f91f2c7d13c7a1f744dd969f8b34c03b7a8fd35ffc0  guix-build-d7c37906e7b1/output/x86_64-linux-gnu/bitcoin-d7c37906e7b1-x86_64-linux-gnu.tar.gz\r\nd83f3a1f918d1aec12b1f2350ae39f1b77fd1a23c738ecbc6e246ecf2f8e133c  guix-build-d7c37906e7b1/output/x86_64-w64-mingw32/SHA256SUMS.part\r\n369c923d929a17db100fdfbb0f29141396026c0b5b753502f6c7ec91612b0b2d  guix-build-d7c37906e7b1/output/x86_64-w64-mingw32/bitcoin-d7c37906e7b1-win64-codesigning.tar.gz\r\nc1d27fed25fa0146935797a4f8a7c4897edc7d07a92e267d4caa0d09ccc0471f  guix-build-d7c37906e7b1/output/x86_64-w64-mingw32/bitcoin-d7c37906e7b1-win64-debug.zip\r\n5ce011e7b2df273d5de077167d7deffe81e503c13656e5c36b3b7a72c5ffd91b  guix-build-d7c37906e7b1/output/x86_64-w64-mingw32/bitcoin-d7c37906e7b1-win64-setup-unsigned.exe\r\n198371f220de666705e26e0a9573e5600c5821a3841212282c6ef116d0cded62  guix-build-d7c37906e7b1/output/x86_64-w64-mingw32/bitcoin-d7c37906e7b1-win64-unsigned.zip\r\n```",
          "created_at": "2025-06-12T17:00:50Z"
        },
        {
          "user": "fanquake",
          "body": "Backported to 29.x in #32589.",
          "created_at": "2025-06-13T11:31:13Z"
        },
        {
          "user": "fanquake",
          "body": "Backported to `28.x` in #32735.",
          "created_at": "2025-06-13T11:34:04Z"
        },
        {
          "user": "josibake",
          "body": "post merge guix build:\r\n\r\n```shell\r\n# find guix-build-$(git rev-parse --short=12 HEAD)/output/ -type f -print0 | env LC_ALL=C sort -z | xargs -r0 sha256sum\r\n96d5182898d13bbe5ee972df791c7fba7a4c3927c6fd224eba20e8d99fbf5173  guix-build-d7c37906e7b1/output/aarch64-linux-gnu/SHA256SUMS.part\r\n88d39050979a7441601f371a81e80fbe43035ff564d03dbca5de1fe61d9f6876  guix-build-d7c37906e7b1/output/aarch64-linux-gnu/bitcoin-d7c37906e7b1-aarch64-linux-gnu-debug.tar.gz\r\n20f78def7e6b24c1901b67ec1d694d315da1c3db45ff616b3ffff36046f785e6  guix-build-d7c37906e7b1/output/aarch64-linux-gnu/bitcoin-d7c37906e7b1-aarch64-linux-gnu.tar.gz\r\n1dafb25aa1ea1a8948e022aba7e6e97de4c16811751e963fe811d4a14de81715  guix-build-d7c37906e7b1/output/arm-linux-gnueabihf/SHA256SUMS.part\r\n82f6d2bf288f7a8d63f6fbd65d68c25af1767b5f5679934545e63e49e6944685  guix-build-d7c37906e7b1/output/arm-linux-gnueabihf/bitcoin-d7c37906e7b1-arm-linux-gnueabihf-debug.tar.gz\r\n910bd74934951cc7eae3b9a6ff8383954be17deb2898e9a4252384477baad1b8  guix-build-d7c37906e7b1/output/arm-linux-gnueabihf/bitcoin-d7c37906e7b1-arm-linux-gnueabihf.tar.gz\r\n517a215049ce7dcebbba93726636d6024866fb940fdf58e760a261953ce1e432  guix-build-d7c37906e7b1/output/arm64-apple-darwin/SHA256SUMS.part\r\n616d69ee6127607fd7003adfeb5bf556f1958b433387eac1284152f50a21726b  guix-build-d7c37906e7b1/output/arm64-apple-darwin/bitcoin-d7c37906e7b1-arm64-apple-darwin-codesigning.tar.gz\r\nf48d151805aa2652c851b64765e9e9697e6ab15c53f1c9ab061bebf2b219e3b0  guix-build-d7c37906e7b1/output/arm64-apple-darwin/bitcoin-d7c37906e7b1-arm64-apple-darwin-unsigned.tar.gz\r\ne851ecd77064bf3600609cd0a7cddbe8ee866e47167a90e2b0bc14b73bb723e7  guix-build-d7c37906e7b1/output/arm64-apple-darwin/bitcoin-d7c37906e7b1-arm64-apple-darwin-unsigned.zip\r\n6865a20bfed34b2bece49866570d4244649b890c0c6e515aa2a76320ee460a8e  guix-build-d7c37906e7b1/output/dist-archive/bitcoin-d7c37906e7b1.tar.gz\r\n653d18cb26d1142d0880dd966a7a994d97d4973b26599897fc251810a29021f3  guix-build-d7c37906e7b1/output/powerpc64-linux-gnu/SHA256SUMS.part\r\ndc1ca74bd929d708651df48656523e76f40dd9a38e8921825dbe0166f707e6e9  guix-build-d7c37906e7b1/output/powerpc64-linux-gnu/bitcoin-d7c37906e7b1-powerpc64-linux-gnu-debug.tar.gz\r\nec0c5a0bf04199dc801827b8619ecdf6ab335e0fcbb35235f8e7f23532b2a609  guix-build-d7c37906e7b1/output/powerpc64-linux-gnu/bitcoin-d7c37906e7b1-powerpc64-linux-gnu.tar.gz\r\ne3f7c7bd97f64b147a9a04a87a725b6232b2917c07a5b024aa5cd64349a5c283  guix-build-d7c37906e7b1/output/riscv64-linux-gnu/SHA256SUMS.part\r\nf38b986e738db12260c51287253a97b448aa2e78b6dbfcf1fbc9a8709374fbe5  guix-build-d7c37906e7b1/output/riscv64-linux-gnu/bitcoin-d7c37906e7b1-riscv64-linux-gnu-debug.tar.gz\r\n1c6e1eed6e853452fd4042c09775860f4cb4c82ebef8b740eabcae48e77712bc  guix-build-d7c37906e7b1/output/riscv64-linux-gnu/bitcoin-d7c37906e7b1-riscv64-linux-gnu.tar.gz\r\na0555a2693a6d4f1e21a8ca0727f2f2f40e3f4aa85e6ee577a3074cdbfbadad5  guix-build-d7c37906e7b1/output/x86_64-apple-darwin/SHA256SUMS.part\r\n337e82322a171120a5e4912f5c3dadbf7c5b90c8b638b962c351c23d60e8f27d  guix-build-d7c37906e7b1/output/x86_64-apple-darwin/bitcoin-d7c37906e7b1-x86_64-apple-darwin-codesigning.tar.gz\r\n9377c9776f769a08c3f6e98f029bc728b1e3c9b724ca7720c36195b587d9f489  guix-build-d7c37906e7b1/output/x86_64-apple-darwin/bitcoin-d7c37906e7b1-x86_64-apple-darwin-unsigned.tar.gz\r\n759c6092dcdbe6b23e42afe4699a9003ecb06073542de76ec34e8e6b61cc3a9c  guix-build-d7c37906e7b1/output/x86_64-apple-darwin/bitcoin-d7c37906e7b1-x86_64-apple-darwin-unsigned.zip\r\nd83ed73cf6716d3e8467d625d3788526cdd2d93af38510b7275a0dc07a61a335  guix-build-d7c37906e7b1/output/x86_64-linux-gnu/SHA256SUMS.part\r\ne3ee49b029eb53068993afbe6d20434dd7fc93fb9cca1ab3db7dbb28ab1dcc8d  guix-build-d7c37906e7b1/output/x86_64-linux-gnu/bitcoin-d7c37906e7b1-x86_64-linux-gnu-debug.tar.gz\r\na15bc74d38fc410d7b859f91f2c7d13c7a1f744dd969f8b34c03b7a8fd35ffc0  guix-build-d7c37906e7b1/output/x86_64-linux-gnu/bitcoin-d7c37906e7b1-x86_64-linux-gnu.tar.gz\r\nd83f3a1f918d1aec12b1f2350ae39f1b77fd1a23c738ecbc6e246ecf2f8e133c  guix-build-d7c37906e7b1/output/x86_64-w64-mingw32/SHA256SUMS.part\r\n369c923d929a17db100fdfbb0f29141396026c0b5b753502f6c7ec91612b0b2d  guix-build-d7c37906e7b1/output/x86_64-w64-mingw32/bitcoin-d7c37906e7b1-win64-codesigning.tar.gz\r\nc1d27fed25fa0146935797a4f8a7c4897edc7d07a92e267d4caa0d09ccc0471f  guix-build-d7c37906e7b1/output/x86_64-w64-mingw32/bitcoin-d7c37906e7b1-win64-debug.zip\r\n5ce011e7b2df273d5de077167d7deffe81e503c13656e5c36b3b7a72c5ffd91b  guix-build-d7c37906e7b1/output/x86_64-w64-mingw32/bitcoin-d7c37906e7b1-win64-setup-unsigned.exe\r\n198371f220de666705e26e0a9573e5600c5821a3841212282c6ef116d0cded62  guix-build-d7c37906e7b1/output/x86_64-w64-mingw32/bitcoin-d7c37906e7b1-win64-unsigned.zip\r\n```",
          "created_at": "2025-06-13T12:20:52Z"
        }
      ]
    },
    {
      "number": 32692,
      "title": "checkqueue: set MAX_SCRIPTCHECK_THREADS to nCores - 1",
      "body": "A fixed MAX_SCRIPTCHECK_THREADS value is not flexible for users to leverage their cpu resources, and a value large than nCores - 1 doesn't make sense since it only adds some context switch overhead. Set it to nCores - 1. Assumption: A user who sets the number of script verification workers is aware of how this affects the system performance, otherwise he/she leaves it as default (which is 0)",
      "state": "closed",
      "user": "HowHsu",
      "created_at": "2025-06-06T13:53:48Z",
      "updated_at": "2025-10-29T23:51:59Z",
      "comments": 18,
      "url": "https://github.com/bitcoin/bitcoin/pull/32692",
      "labels": [
        "Needs Benchmark"
      ],
      "comment_list": [
        {
          "user": "DrahtBot",
          "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/32692.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\nA summary of reviews will appear here.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nNo conflicts as of last run.\n<!--5faf32d7da4f0f540f40219e4f7537a3-->",
          "created_at": "2025-06-06T13:53:52Z"
        },
        {
          "user": "sipa",
          "body": "I think up to `nCores` makes sense, and we need to be sure that that value is an actual reflection of hardware concurrency on all platforms. It may be worth benchmarking to see if there is actually a gain above certain values still (because thread contention will start to become more and more noticeable, which may at some point overtake the gains from more parallellism).",
          "created_at": "2025-06-06T13:58:48Z"
        },
        {
          "user": "DrahtBot",
          "body": "<!--85328a0da195eb286784d51f73fa0af9-->\nüöß At least one of the CI tasks failed.\n<sub>Task `no wallet, libbitcoinkernel`: https://github.com/bitcoin/bitcoin/runs/43620218125</sub>\n<sub>LLM reason (‚ú® experimental): Linker error due to undefined reference to `GetNumCores()` causing build failure.</sub>\n\n<details><summary>Hints</summary>\n\nTry to run the tests locally, according to the documentation. However, a CI failure may still\nhappen due to a number of reasons, for example:\n\n* Possibly due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\n* A sanitizer issue, which can only be found by compiling with the sanitizer and running the\n  affected test.\n\n* An intermittent issue.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n</details>\n\n",
          "created_at": "2025-06-06T14:42:07Z"
        },
        {
          "user": "HowHsu",
          "body": "> I think up to `nCores` makes sense, and we need to be sure that that value is an actual reflection of hardware concurrency on all platforms. It may be worth benchmarking to see if there is actually a gain above certain values still (because thread contention will start to become more and more noticeable, which may at some point overtake the gains from more parallellism).\r\n\r\nThere is a master worker, plus `nCores-1` normal workers, so setting it to `nCores` actually allows `nCores+1` worker threads.\r\nI now think maybe it should even be smaller than `nCores-1`, since there may be some important bitcoind threads running (as a newbie, I can't point them out clearly). \r\nAbout thread contention, I assume users know how many and which cores are idle enough to run these workers and they will bind workers to them(for example, use taskset on linux). Maybe more workers bring more lock contention, that's a issue to be investigated.\r\n\r\n> be sure that that value is an actual reflection of hardware concurrency on all platforms\r\n\r\nI'll look into it.\r\n",
          "created_at": "2025-06-06T15:55:15Z"
        },
        {
          "user": "sipa",
          "body": "> There is a master worker, plus nCores-1 normal workers, so setting it to nCores actually allows nCores+1 worker threads.\r\n\r\nThat is incorrect. With `-par=N`, there is 1 master plus `N-1` workers, which both perform script validation work, but the master only joins the other threads when it is done with other work. If you have N perfectly parallel cores, and nothing else running on your machine, `par=N` is expected, so the software should allow up to that, if there is no reason to assume that this would result in degraded performance.\r\n\r\n> About thread contention, I assume users know which cores are idle enough to run these workers and they will bind workers to them(for example, use taskset on linux).\r\n\r\nThread contention is the overhead *inside bitcoind* caused by coordination between the threads, and is unrelated to what the hardware provides or how loaded it is. The reason for the existing limit of 15 is because benchmarks showed that even on an otherwise unloaded machine with more cores than that, adding more script validation threads was net slower after about that many. That benchmark dates from 2013, so there is no reason to assume it still holds, as both hardware and typical blockchain script usage has changed significantly, as well as other parts of the codebase. But it would still be worth investigating if there isn't just some number above which it makes no sense.\r\n",
          "created_at": "2025-06-06T16:04:03Z"
        },
        {
          "user": "HowHsu",
          "body": "> > There is a master worker, plus nCores-1 normal workers, so setting it to nCores actually allows nCores+1 worker threads.\r\n> \r\n> That is incorrect. With `-par=N`, there is 1 master plus `N-1` workers, which both perform script validation work, but the master only joins the other threads when it is done with other work. If you have N perfectly parallel cores, and nothing else running on your machine, `par=N` is expected, so the software should allow up to that, if there is no reason to assume that this would result in degraded performance.\r\n> \r\n\r\nFrom the code I read from checkqueue.h ( https://raw.githubusercontent.com/bitcoin/bitcoin/refs/heads/master/src/checkqueue.h#:~:text=std%3A%3Aoptional%3CR%3E%20Complete()%20EXCLUSIVE_LOCKS_REQUIRED(!m_mutex) ) I think `par=N` means N workers, plus one master worker which is actually the main bitcoind thread itself. And I run benchmark in ben/connectblock.cpp to debug it, shows the same thing.\r\n\r\n> > About thread contention, I assume users know which cores are idle enough to run these workers and they will bind workers to them(for example, use taskset on linux).\r\n> \r\n> Thread contention is the overhead _inside bitcoind_ caused by coordination between the threads, and is unrelated to what the hardware provides or how loaded it is. The reason for the existing limit of 15 is because benchmarks showed that even on an otherwise unloaded machine with more cores than that, adding more script validation threads was net slower after about that many. That benchmark dates from 2013, so there is no reason to assume it still holds, as both hardware and typical blockchain script usage has changed significantly, as well as other parts of the codebase. But it would still be worth investigating if there isn't just some number above which it makes no sense.\r\n\r\nI'll try to find a machine which has enough cpu resource to test it.\r\n\r\n",
          "created_at": "2025-06-06T16:31:12Z"
        },
        {
          "user": "sipa",
          "body": "> I think par=N means N workers, plus one master worker which is actually the main bitcoind thread itself.\r\n\r\nThat's not correct. The number of worker threads is one less than the argument to `-par`: https://github.com/bitcoin/bitcoin/blob/v29.0/src/node/chainstatemanager_args.cpp#L62.",
          "created_at": "2025-06-06T16:33:48Z"
        },
        {
          "user": "HowHsu",
          "body": "> > I think par=N means N workers, plus one master worker which is actually the main bitcoind thread itself.\r\n> \r\n> That's not correct. The number of worker threads is one less than the argument to `-par`: https://github.com/bitcoin/bitcoin/blob/v29.0/src/node/chainstatemanager_args.cpp#L62.\r\n\r\nI see, sorry for missing this part, but `MAX_SCRIPTCHECK_THREADS` is to limit `opt.worker_threads_num`, so it still should be `nCores-1`",
          "created_at": "2025-06-06T16:40:52Z"
        },
        {
          "user": "sipa",
          "body": "@HowHsu I am so sorry! You are right.",
          "created_at": "2025-06-06T16:42:22Z"
        },
        {
          "user": "HowHsu",
          "body": "Hi Sipa,\r\n\r\n>   The reason for the existing limit of 15 is because benchmarks showed that even on an otherwise unloaded machine with more cores than that, adding more script validation threads was net slower after about that many. \r\n\r\nAny doc about this test?\r\n\r\n> That benchmark dates from 2013\r\n\r\nIs the benchmark you mentioned /bench/connectblock.cpp\r\n\r\nI've done some investigation, and found the bottleneck may be the ECC calculation itself, not lock contension or something else.\r\nI did some test on my Intel i5-13600KFÔºà13th GenÔºâPC which has 6 P-cores and 8 E-cores (6 * 2 + 8 = 20 logical cores) with `./bench/connectblock.cpp`, the producer adds tasks to the queue fast, lock contention is low from perf report. But the TPS doesn't go higher after thread_num=14 or 15, which is equal to the number of physical cores.\r\nFrom internet, I learned that ECC computation highly uses  ALU„ÄÅFPU etc. and logical cpu threads on one core shares these stuff, which means ECC cannot get benefit from SMT. So I guess a user can set MAX_SCRIPTCHECK_THREADS to `nPhysicalCores - 1`, but still needs more research. Unfortunately I don't have a test environment with a bunch of CPUs (Would be super great if someone can do this test on a machine with different number of physical cores)",
          "created_at": "2025-06-08T13:50:38Z"
        },
        {
          "user": "HowHsu",
          "body": "I'm going to close this one since I found that under the current scriptcheck queue implementation, cores >=14 or 15 may degrade the performance.",
          "created_at": "2025-06-22T15:18:47Z"
        },
        {
          "user": "luke-jr",
          "body": "Maybe this is something best solved by runtime benchmarking? (Or perhaps just at startup, since early blocks may not give us the parallelization we need for it)",
          "created_at": "2025-06-24T19:27:26Z"
        },
        {
          "user": "HowHsu",
          "body": "I post a new scriptcheck pool implementation #32791 with atomic variables rather than mutex to reduce thread sync contention. That achieves very good performance improvement. But the idea is based on that `the adding period is very short compared to the script verification period`, so it has to be with PR #31132. @sipa and others, welcome to take a look.",
          "created_at": "2025-06-29T13:32:29Z"
        },
        {
          "user": "HowHsu",
          "body": "> Maybe this is something best solved by runtime benchmarking? (Or perhaps just at startup, since early blocks may not give us the parallelization we need for it)\r\n\r\nI think we can do it so, binary search the best worker thread number with bencharking on some standard test data.",
          "created_at": "2025-06-29T13:38:44Z"
        },
        {
          "user": "maflcko",
          "body": "Maybe turn into draft while CI is red and this is still a WIP?",
          "created_at": "2025-07-03T07:32:18Z"
        },
        {
          "user": "achow101",
          "body": "Are you still working on this?",
          "created_at": "2025-10-22T15:26:57Z"
        },
        {
          "user": "HowHsu",
          "body": "> Are you still working on this?\r\n\r\nNo",
          "created_at": "2025-10-23T09:33:46Z"
        },
        {
          "user": "fjahr",
          "body": "> The reason for the existing limit of 15 is because benchmarks showed that even on an otherwise unloaded machine with more cores than that, adding more script validation threads was net slower after about that many. That benchmark dates from 2013, so there is no reason to assume it still holds, as both hardware and typical blockchain script usage has changed significantly, as well as other parts of the codebase. But it would still be worth investigating if there isn't just some number above which it makes no sense.\r\n\r\nI also checked this using the `ConnectBlock` benchmark as well as #33740 plus modifying `MAX_SCRIPTCHECK_THREADS` of course. The assumption still appears to hold based on these results. ~~If anything, based on my results (which I reran several times) we could potentially reduce `MAX_SCRIPTCHECK_THREADS` to 13.~~ EDIT: After some time I started to see the best results with 14 and 15, so maybe this was nothing.\r\n\r\n```\r\n$ build/bin/bench_bitcoin -filter=ConnectBlockAllSchnorr -min-time=1000 -scale-threads\r\nRunning benchmarks with worker threads from 1 to 32\r\n\r\n|            ns/block |             block/s |    err% |     total | benchmark\r\n|--------------------:|--------------------:|--------:|----------:|:----------\r\n|       43,184,145.50 |               23.16 |    0.1% |      0.99 | `ConnectBlockAllSchnorr_1_threads`\r\n|       29,091,010.25 |               34.37 |    0.4% |      1.10 | `ConnectBlockAllSchnorr_2_threads`\r\n|       22,236,218.75 |               44.97 |    0.1% |      1.09 | `ConnectBlockAllSchnorr_3_threads`\r\n|       17,901,305.67 |               55.86 |    0.3% |      1.09 | `ConnectBlockAllSchnorr_4_threads`\r\n|       15,134,386.86 |               66.07 |    0.2% |      1.08 | `ConnectBlockAllSchnorr_5_threads`\r\n|       13,131,000.00 |               76.16 |    0.1% |      1.08 | `ConnectBlockAllSchnorr_6_threads`\r\n|       11,635,203.67 |               85.95 |    0.1% |      1.07 | `ConnectBlockAllSchnorr_7_threads`\r\n|       10,472,699.00 |               95.49 |    0.1% |      1.07 | `ConnectBlockAllSchnorr_8_threads`\r\n|        9,571,375.00 |              104.48 |    0.1% |      1.08 | `ConnectBlockAllSchnorr_9_threads`\r\n|        9,643,621.18 |              103.70 |    0.7% |      1.09 | `ConnectBlockAllSchnorr_10_threads`\r\n|        9,545,537.50 |              104.76 |    0.6% |      1.09 | `ConnectBlockAllSchnorr_11_threads`\r\n|        9,536,983.30 |              104.85 |    0.8% |      1.07 | `ConnectBlockAllSchnorr_12_threads`\r\n|        9,313,783.30 |              107.37 |    0.7% |      1.08 | `ConnectBlockAllSchnorr_13_threads`\r\n|        9,630,087.50 |              103.84 |    1.8% |      1.09 | `ConnectBlockAllSchnorr_14_threads`\r\n|        9,893,344.73 |              101.08 |    1.5% |      1.10 | `ConnectBlockAllSchnorr_15_threads`\r\n|        9,840,655.36 |              101.62 |    1.3% |      1.12 | `ConnectBlockAllSchnorr_16_threads`\r\n|        9,914,708.27 |              100.86 |    3.3% |      1.07 | `ConnectBlockAllSchnorr_17_threads`\r\n|       10,038,008.40 |               99.62 |    1.0% |      1.09 | `ConnectBlockAllSchnorr_18_threads`\r\n|       10,126,620.90 |               98.75 |    1.0% |      1.09 | `ConnectBlockAllSchnorr_19_threads`\r\n|       10,279,966.60 |               97.28 |    2.2% |      1.12 | `ConnectBlockAllSchnorr_20_threads`\r\n|       10,334,737.50 |               96.76 |    1.8% |      1.10 | `ConnectBlockAllSchnorr_21_threads`\r\n|       10,016,070.80 |               99.84 |    3.2% |      1.12 | `ConnectBlockAllSchnorr_22_threads`\r\n|       10,447,277.78 |               95.72 |    1.5% |      1.08 | `ConnectBlockAllSchnorr_23_threads`\r\n|       10,244,954.55 |               97.61 |    1.4% |      1.12 | `ConnectBlockAllSchnorr_24_threads`\r\n|        9,975,325.73 |              100.25 |    1.4% |      1.09 | `ConnectBlockAllSchnorr_25_threads`\r\n|       10,181,458.30 |               98.22 |    1.1% |      1.11 | `ConnectBlockAllSchnorr_26_threads`\r\n|       10,263,129.20 |               97.44 |    0.8% |      1.10 | `ConnectBlockAllSchnorr_27_threads`\r\n|       10,168,634.33 |               98.34 |    1.0% |      1.02 | `ConnectBlockAllSchnorr_28_threads`\r\n|        9,781,129.20 |              102.24 |    1.9% |      1.11 | `ConnectBlockAllSchnorr_29_threads`\r\n|       10,461,203.12 |               95.59 |    4.9% |      1.00 | `ConnectBlockAllSchnorr_30_threads`\r\n|       10,292,564.89 |               97.16 |    2.0% |      0.99 | `ConnectBlockAllSchnorr_31_threads`\r\n|       10,371,725.00 |               96.42 |    0.6% |      1.11 | `ConnectBlockAllSchnorr_32_threads`\r\n```",
          "created_at": "2025-10-29T23:42:20Z"
        }
      ]
    },
    {
      "number": 32690,
      "title": "depends: fix multiprocess build on OpenBSD (apply capnp patch, correct SHA256SUM command)",
      "body": "This PR fixes the multiprocess depends build for OpenBSD by applying upstream patch https://github.com/capnproto/capnproto/pull/2308 and switching the SHA256SUM command to output hash sums in the expected format (the default is BSD format [1], but we need GNU format [2], see commit message for details). Note that the hashing issue is only prevailing for packages defining the `$(package)_local_dir` variable (introduced in 5d105fb8c3ffa39c3e716c3147ee74795b129113, part of #31741), where the following line of the `fetch_local_dir_sha256` function leads to the wrong output:\r\nhttps://github.com/bitcoin/bitcoin/blob/ae024137bda9fe189f4e7ccf26dbaffd44cbbeb6/depends/funcs.mk#L57\r\n\r\nThe first commit can be replaced with a simple capnp version bump once this is available in a release.\r\n\r\nTested on OpenBSD 7.7 (x86_64) via\r\n```\r\n$ gmake -C depends MULTIPROCESS=1 NO_BOOST=1 NO_LIBEVENT=1 NO_QT=1 NO_QR=1 NO_WALLET=1 NO_ZMQ=1 NO_USDT=1\r\n```\r\n\r\n[1] example output: `SHA256 (/home/thestack/.vimrc) = 6ba69d100e8c5ca0488ded6293d4e5f740a6a5d5ace96cbcf0599c18d27389e4`\r\n[2] example output: `6ba69d100e8c5ca0488ded6293d4e5f740a6a5d5ace96cbcf0599c18d27389e4 /home/thestack/.vimrc`",
      "state": "closed",
      "user": "theStack",
      "created_at": "2025-06-06T00:21:59Z",
      "updated_at": "2025-06-19T09:44:48Z",
      "comments": 7,
      "url": "https://github.com/bitcoin/bitcoin/pull/32690",
      "labels": [
        "Build system"
      ],
      "comment_list": [
        {
          "user": "DrahtBot",
          "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/32690.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [Sjors](https://github.com/bitcoin/bitcoin/pull/32690#issuecomment-2949660658), [hebasto](https://github.com/bitcoin/bitcoin/pull/32690#pullrequestreview-2905521389), [fanquake](https://github.com/bitcoin/bitcoin/pull/32690#pullrequestreview-2917633804) |\n\nIf your review is incorrectly listed, please react with üëé to this comment and the bot will ignore it on the next update.\n<!--5faf32d7da4f0f540f40219e4f7537a3-->\n### LLM Linter (‚ú® experimental)\n\nPossible typos and grammar issues:\n\n- may also solves -> may also solve [correct verb form]\n\n<sup>drahtbot_id_4_m</sup>\n",
          "created_at": "2025-06-06T00:22:01Z"
        },
        {
          "user": "Sjors",
          "body": "I tested this on top of #31802 on a VM running OpenBSD 7.7 (dropping `NO_IPC` for OpenBSB).\r\n\r\nWithout the patch I get a bunch of errors like:\r\n\r\n```\r\n[  2%] Building CXX object src/kj/CMakeFiles/kj.dir/cidr.c++.o\r\n/root/src/bitcoin/depends/work/build/aarch64-unknown-openbsd7.7/native_capnp/1.1.0-f5dbdc0b2f0/src/kj/cidr.c++:116:71: error: member access into incomplete type 'const struct sockaddr_in6'\r\n        otherBits = reinterpret_cast<const struct sockaddr_in6*>(addr)->sin6_addr.s6_addr;\r\n```\r\n\r\nWith the patch the build still fails:\r\n\r\n```\r\ngmake -C depends NO_QT=1 NO_QR=1 NO_ZMQ=1 NO_USDT=1\r\n...\r\n[ 95%] Linking CXX executable capnp\r\nld: warning: parser.c++(parser.c++.o:(kj::Maybe<decltype(apply(instance<capnp::compiler::CapnpParser::CapnpParser(capnp::Orphanage, capnp::compiler::ErrorReporter&)::'lambda38'(capnp::compiler::(anonymous namespace)::Located<capnp::Text::Reader>&&, kj::Maybe<capnp::Orphan<capnp::compiler::LocatedInteger>>&&, capnp::compiler::(anonymous namespace)::Located<kj::Array<kj::Maybe<capnp::compiler::(anonymous namespace)::Located<capnp::Text::Reader>>>>&&, capnp::Orphan<capnp::compiler::Expression>&&, kj::Array<capnp::Orphan<capnp::compiler::Declaration::AnnotationApplication>>&&)&>(), instance<kj::parse::OutputType_<decltype(instance<kj::parse::Sequence_<kj::parse::TransformOrReject_<kj::parse::TransformOrReject_<kj::parse::Any_ const&, capnp::compiler::(anonymous namespace)::MatchTokenType<capnp::Text::Reader, (capnp::compiler::Token::Which)0, &capnp::compiler::Token::Reader::getIdentifier() const>> const&, capnp::compiler::(anonymous namespace)::ExactString>, kj::parse::TransformOrReject_<kj::parse::Any_ const&, capnp::compiler::(anonymous namespace)::MatchTokenType<capnp::Text::Reader, (capnp::compiler::Token::Which)0, &capnp::compiler::Token::Reader::getIdentifier() const>> const&, kj::parse::Optional_<kj::parse::ParserRef<kj::parse::IteratorInput<capnp::compiler::Token::Reader, capnp::_::IndexingIterator<capnp::List<capnp::compiler::Token, (capnp::Kind)3>::Reader const, capnp::compiler::Token::Reader>>, capnp::Orphan<capnp::compiler::LocatedInteger>>&>, kj::parse::Transform_<kj::parse::TransformOrReject_<kj::parse::Any_ const&, capnp::compiler::(anonymous namespace)::MatchTokenType<capnp::List<capnp::List<capnp::compiler::Token, (capnp::Kind)3>, (capnp::Kind)6>::Reader, (capnp::compiler::Token::Which)5, &capnp::compiler::Token::Reader::getParenthesizedList() const>> const&, capnp::compiler::(anonymous namespace)::ParseListItems<kj::parse::OneOf_<kj::parse::TransformOrReject_<kj::parse::Any_ const&, capnp::compiler::(anonymous namespace)::MatchTokenType<capnp::Text::Reader, (capnp::compiler::Token::Which)0, &capnp::compiler::Token::Reader::getIdentifier() const>> const&, kj::parse::TransformWithLocation_<kj::parse::TransformOrReject_<kj::parse::TransformOrReject_<kj::parse::Any_ const&, capnp::compiler::(anonymous namespace)::MatchTokenType<capnp::Text::Reader, (capnp::compiler::Token::Which)4, &capnp::compiler::Token::Reader::getOperator() const>> const&, capnp::compiler::(anonymous namespace)::ExactString>, capnp::compiler::CapnpParser::CapnpParser(capnp::Orphanage, capnp::compiler::ErrorReporter&)::'lambda37'(kj::parse::Span<capnp::_::IndexingIterator<capnp::List<capnp::compiler::Token, (capnp::Kind)3>::Reader const, capnp::compiler::Token::Reader>>)>>&>>, kj::parse::TransformOrReject_<kj::parse::TransformOrReject_<kj::parse::Any_ const&, capnp::compiler::(anonymous namespace)::MatchTokenType<capnp::Text::Reader, (capnp::compiler::Token::Which)4, &capnp::compiler::Token::Reader::getOperator() const>> const&, capnp::compiler::(anonymous namespace)::ExactString>, kj::parse::ParserRef<kj::parse::IteratorInput<capnp::compiler::Token::Reader, capnp::_::IndexingIterator<capnp::List<capnp::compiler::Token, (capnp::Kind)3>::Reader const, capnp::compiler::Token::Reader>>, capnp::Orphan<capnp::compiler::Expression>>&, kj::parse::Many_<kj::parse::ParserRef<kj::parse::IteratorInput<capnp::compiler::Token::Reader, capnp::_::IndexingIterator<capnp::List<capnp::compiler::Token, (capnp::Kind)3>::Reader const, capnp::compiler::Token::Reader>>, capnp::Orphan<capnp::compiler::Declaration::AnnotationApplication>>&, false>>&>()(instance<kj::parse::IteratorInput<capnp::compiler::Token::Reader, capnp::_::IndexingIterator<capnp::List<capnp::compiler::Token, (capnp::Kind)3>::Reader const, capnp::compiler::Token::Reader>>&>()))>::Type&&>()))> kj::parse::Transform_<kj::parse::Sequence_<kj::parse::TransformOrReject_<kj::parse::TransformOrReject_<kj::parse::Any_ const&, capnp::compiler::(anonymous namespace)::MatchTokenType<capnp::Text::Reader, (capnp::compiler::Token::Which)0, &capnp::compiler::Token::Reader::getIdentifier() const>> const&, capnp::compiler::(anonymous namespace)::ExactString>, kj::parse::TransformOrReject_<kj::parse::Any_ const&, capnp::compiler::(anonymous namespace)::MatchTokenType<capnp::Text::Reader, (capnp::compiler::Token::Which)0, &capnp::compiler::Token::Reader::getIdentifier() const>> const&, kj::parse::Optional_<kj::parse::ParserRef<kj::parse::IteratorInput<capnp::compiler::Token::Reader, capnp::_::IndexingIterator<capnp::List<capnp::compiler::Token, (capnp::Kind)3>::Reader const, capnp::compiler::Token::Reader>>, capnp::Orphan<capnp::compiler::LocatedInteger>>&>, kj::parse::Transform_<kj::parse::TransformOrReject_<kj::parse::Any_ const&, capnp::compiler::(anonymous namespace)::MatchTokenType<capnp::List<capnp::List<capnp::compiler::Token, (capnp::Kind)3>, (capnp::Kind)6>::Reader, (capnp::compiler::Token::Which)5, &capnp::compiler::Token::Reader::getParenthesizedList() const>> const&, capnp::compiler::(anonymous namespace)::ParseListItems<kj::parse::OneOf_<kj::parse::TransformOrReject_<kj::parse::Any_ const&, capnp::compiler::(anonymous namespace)::MatchTokenType<capnp::Text::Reader, (capnp::compiler::Token::Which)0, &capnp::compiler::Token::Reader::getIdentifier() const>> const&, kj::parse::TransformWithLocation_<kj::parse::TransformOrReject_<kj::parse::TransformOrReject_<kj::parse::Any_ const&, capnp::compiler::(anonymous namespace)::MatchTokenType<capnp::Text::Reader, (capnp::compiler::Token::Which)4, &capnp::compiler::Token::Reader::getOperator() const>> const&, capnp::compiler::(anonymous namespace)::ExactString>, capnp::compiler::CapnpParser::CapnpParser(capnp::Orphanage, capnp::compiler::ErrorReporter&)::'lambda37'(kj::parse::Span<capnp::_::IndexingIterator<capnp::List<capnp::compiler::Token, (capnp::Kind)3>::Reader const, capnp::compiler::Token::Reader>>)>>&>>, kj::parse::TransformOrReject_<kj::parse::TransformOrReject_<kj::parse::Any_ const&, capnp::compiler::(anonymous namespace)::MatchTokenType<capnp::Text::Reader, (capnp::compiler::Token::Which)4, &capnp::compiler::Token::Reader::getOperator() const>> const&, capnp::compiler::(anonymous namespace)::ExactString>, kj::parse::ParserRef<kj::parse::IteratorInput<capnp::compiler::Token::Reader, capnp::_::IndexingIterator<capnp::List<capnp::compiler::Token, (capnp::Kind)3>::Reader const, capnp::compiler::Token::Reader>>, capnp::Orphan<capnp::compiler::Expression>>&, kj::parse::Many_<kj::parse::ParserRef<kj::parse::IteratorInput<capnp::compiler::Token::Reader, capnp::_::IndexingIterator<capnp::List<capnp::compiler::Token, (capnp::Kind)3>::Reader const, capnp::compiler::Token::Reader>>, capnp::Orphan<capnp::compiler::Declaration::AnnotationApplication>>&, false>>, capnp::compiler::CapnpParser::CapnpParser(capnp::Orphanage, capnp::compiler::ErrorReporter&)::'lambda38'(capnp::compiler::(anonymous namespace)::Located<capnp::Text::Reader>&&, kj::Maybe<capnp::Orphan<capnp::compiler::LocatedInteger>>&&, capnp::compiler::(anonymous namespace)::Located<kj::Array<kj::Maybe<capnp::compiler::(anonymous namespace)::Located<capnp::Text::Reader>>>>&&, capnp::Orphan<capnp::compiler::Expression>&&, kj::Array<capnp::Orphan<capnp::compiler::Declaration::AnnotationApplication>>&&)>::operator()<kj::parse::IteratorInput<capnp::compiler::Token::Reader, capnp::_::IndexingIterator<capnp::List<capnp::compiler::Token, (capnp::Kind)3>::Reader const, capnp::compiler::Token::Reader>>>(kj::parse::IteratorInput<capnp::compiler::Token::Reader, capnp::_::IndexingIterator<capnp::List<capnp::compiler::Token, (capnp::Kind)3>::Reader const, capnp::compiler::Token::Reader>>&) const) in archive libcapnpc.a): warning: strcpy() is almost always misused, please use strlcpy()\r\nld: error: undefined symbol: std::__throw_bad_array_new_length()\r\n>>> referenced by module-loader.c++\r\n>>>               CMakeFiles/capnp_tool.dir/compiler/module-loader.c++.o:(capnp::compiler::ModuleLoader::Impl::loadModule(kj::ReadableDirectory const&, kj::PathPtr))\r\n>>> referenced by compiler.c++\r\n>>>               compiler.c++.o:(std::_Hashtable<capnp::compiler::Compiler::Node*, std::pair<capnp::compiler::Compiler::Node* const, unsigned int>, std::allocator<std::pair<capnp::compiler::Compiler::Node* const, unsigned int>>, std::__detail::_Select1st, std::equal_to<capnp::compiler::Compiler::Node*>, std::hash<capnp::compiler::Compiler::Node*>, std::__detail::_Mod_range_hashing, std::__detail::_Default_ranged_hash, std::__detail::_Prime_rehash_policy, std::__detail::_Hashtable_traits<false, false, true>>::_M_rehash(unsigned long, unsigned long const&)) in archive libcapnpc.a\r\n>>> referenced by compiler.c++\r\n>>>               compiler.c++.o:(std::_Hashtable<capnp::compiler::Module*, std::pair<capnp::compiler::Module* const, kj::Own<capnp::compiler::Compiler::CompiledModule, std::nullptr_t>>, std::allocator<std::pair<capnp::compiler::Module* const, kj::Own<capnp::compiler::Compiler::CompiledModule, std::nullptr_t>>>, std::__detail::_Select1st, std::equal_to<capnp::compiler::Module*>, std::hash<capnp::compiler::Module*>, std::__detail::_Mod_range_hashing, std::__detail::_Default_ranged_hash, std::__detail::_Prime_rehash_policy, std::__detail::_Hashtable_traits<false, false, true>>::_M_rehash(unsigned long, unsigned long const&)) in archive libcapnpc.a\r\n>>> referenced 2 more times\r\ncollect2: error: ld returned 1 exit status\r\ngmake[3]: *** [src/capnp/CMakeFiles/capnp_tool.dir/build.make:122: src/capnp/capnp] Error 1\r\ngmake[2]: *** [CMakeFiles/Makefile2:480: src/capnp/CMakeFiles/capnp_tool.dir/all] Error 2\r\ngmake[1]: *** [Makefile:136: all] Error 2\r\ngmake[1]: Leaving directory '/home/sjors/src/bitcoin/depends/work/build/aarch64-unknown-openbsd7.7/capnp/1.1.0-adf16ebd094'\r\ngmake: *** [funcs.mk:342: /home/sjors/src/bitcoin/depends/work/build/aarch64-unknown-openbsd7.7/capnp/1.1.0-adf16ebd094/./.stamp_built] Error 2\r\ngmake: Leaving directory '/home/sjors/src/bitcoin/depends'\r\n```\r\n\r\n(this also happens with just this PR at 8713e8060d504f561fed705b4aa5af7b96c36e75)\r\n\r\nThough maybe there's something wrong with my VM? https://github.com/bitcoin/bitcoin/issues/32691 In particular, I symlinked `egcc` and `eg++` to `/usr/local/bin/g{cc,++}`.",
          "created_at": "2025-06-06T09:04:25Z"
        },
        {
          "user": "Sjors",
          "body": "ACK 8713e8060d504f561fed705b4aa5af7b96c36e75\r\n\r\nSwitched to an x86_64 based VM and it builds fine. I also ran the Bitcoin Core test suite.\r\n\r\nCan you add a note to the OpenBSD instruction in `depends/README.md` to also install `cmake`?\r\n\r\n",
          "created_at": "2025-06-06T15:41:23Z"
        },
        {
          "user": "theStack",
          "body": "> Why [8713e80](https://github.com/bitcoin/bitcoin/commit/8713e8060d504f561fed705b4aa5af7b96c36e75) is necessary for libmultiprocess, but not for other packages?\r\n\r\nThe libmultiprocess package is the only one which sets the [`$(package)_local_dir`](https://github.com/bitcoin/bitcoin/blob/ae024137bda9fe189f4e7ccf26dbaffd44cbbeb6/depends/packages/native_libmultiprocess.mk#L2) variable, causing execution of the [`fetch_local_dir_sha256` shell script](https://github.com/bitcoin/bitcoin/blob/ae024137bda9fe189f4e7ccf26dbaffd44cbbeb6/depends/funcs.mk#L46-L58) where the hash is extracted from the file manually, expecting the hash in the first row (=GNU format):\r\nhttps://github.com/bitcoin/bitcoin/blob/ae024137bda9fe189f4e7ccf26dbaffd44cbbeb6/depends/funcs.mk#L57\r\n\r\nAnother instance where we do this manual extraction is in the calculation of `$(1)_all_file_checksums`:\r\nhttps://github.com/bitcoin/bitcoin/blob/ae024137bda9fe189f4e7ccf26dbaffd44cbbeb6/depends/funcs.mk#L62\r\n\r\nBut this variable is only a temporary for calculating `$(1)_recipe_hash`, which is done by feeding the hashing tool from stdin, where the output is as expected [1]:\r\nhttps://github.com/bitcoin/bitcoin/blob/ae024137bda9fe189f4e7ccf26dbaffd44cbbeb6/depends/funcs.mk#L69\r\n\r\nSo this was unnoticed, but the recipe hash calculation was not entirely correct, so I'd suggest to backport this commit.\r\n\r\nNote that instances where a hash list is verified via `-c` are not affected, as this options accepts both the BSD and the GNU formats. Also, if the input to the hashing command is piped in (i.e. coming from stdin), the output is also in the expected format even without specifying `-r`.\r\n\r\n[1] e.g.\r\n```\r\n$ echo \"foobar\" | sha256\r\naec070645fe53ee3b3763059376134f058cc337247c978add178b6ccdfb0019f\r\n```",
          "created_at": "2025-06-06T15:48:48Z"
        },
        {
          "user": "theStack",
          "body": "@Sjors:\r\n> Can you add a note to the OpenBSD instruction in `depends/README.md` to also install `cmake`?\r\n\r\nSeems like material for a different PR, considering this affects other BSDs as well, and at first glance it seems there are even other packages missing, like e.g. `curl` (which AFAIR, is also not part of OpenBSD's base system). Will open a follow-up later.",
          "created_at": "2025-06-06T15:57:10Z"
        },
        {
          "user": "fanquake",
          "body": "Backported to 29.x in #32690.",
          "created_at": "2025-06-11T16:25:15Z"
        },
        {
          "user": "fanquake",
          "body": "> Backported to 29.x in https://github.com/bitcoin/bitcoin/pull/32690.\r\n\r\nNote that this became a partial backport, just 8713e8060d504f561fed705b4aa5af7b96c36e75.",
          "created_at": "2025-06-19T09:44:48Z"
        }
      ]
    }
  ],
  "issues": [
    {
      "number": 32695,
      "title": ".",
      "body": "",
      "state": "closed",
      "user": "harryvik990",
      "created_at": "2025-06-06T22:40:05Z",
      "updated_at": "2025-06-06T23:34:57Z",
      "comments": 0,
      "url": "https://github.com/bitcoin/bitcoin/issues/32695",
      "labels": []
    },
    {
      "number": 32691,
      "title": "depends: OpenBSD (aarch64) needs gcc (instruction) for libevent",
      "body": "### Current behaviour\n\nThe current depends instructions for OpenBSD do not mention `gcc`, which is required to build libevent.\n\nA simple `pkg_add gcc` doesn't cut it either, because that only installs `egcc`: https://unix.stackexchange.com/questions/554752/no-gcc-executable-after-pkg-add-gcc-on-openbsd\n\n### Expected behaviour\n\nExplain what the user needs to do to build depends (or change depends).\n\nA simple symlink seems to do the trick, but I'm not if it's appropriate:\n\n```\nln -s /usr/local/bin/egcc /usr/local/bin/gcc\n```\n\n### Steps to reproduce\n\nFresh OpenBSD installation. Clone repo on master.\n\n```\ngmake -C depends NO_QT=1 NO_QR=1 NO_ZMQ=1 NO_USDT=1\n\ngmake: Entering directory '/home/sjors/src/bitcoin/depends'\nConfiguring libevent...\nCMake Deprecation Warning at CMakeLists.txt:22 (cmake_minimum_required):\n  Compatibility with CMake < 3.10 will be removed from a future version of\n  CMake.\n\n  Update the VERSION argument <min> value.  Or, use the <min>...<max> syntax\n  to tell CMake that the project requires at least <min> but has been updated\n  to work with policies introduced by <max> or earlier.\n\n\nCMake Error at /usr/local/share/cmake/Modules/CMakeDetermineCCompiler.cmake:49 (message):\n  Could not find compiler set in environment variable CC:\n\n  gcc.\nCall Stack (most recent call first):\n  CMakeLists.txt:47 (project)\n\n\nCMake Error: CMAKE_C_COMPILER not set, after EnableLanguage\n-- Configuring incomplete, errors occurred!\ngmake: *** [funcs.mk:343: /home/sjors/src/bitcoin/depends/aarch64-unknown-openbsd7.7/.libevent_stamp_configured] Error 1\ngmake: Leaving directory '/home/sjors/src/bitcoin/depends'\n```\n\n### Relevant log output\n\n_No response_\n\n### How did you obtain Bitcoin Core\n\nCompiled from source\n\n### What version of Bitcoin Core are you using?\n\nmaster\n\n### Operating system and version\n\nOpenBSD 7.7\n\n### Machine specifications\n\nVM inside UTM, host machine is M4 macOS 15.5",
      "state": "closed",
      "user": "Sjors",
      "created_at": "2025-06-06T08:09:38Z",
      "updated_at": "2025-07-03T10:00:50Z",
      "comments": 13,
      "url": "https://github.com/bitcoin/bitcoin/issues/32691",
      "labels": [
        "Build system"
      ],
      "comment_list": [
        {
          "user": "hebasto",
          "body": "I'm not sure. The following seems [working](https://github.com/hebasto/bitcoin-core-nightly/blob/2973f9d010f6581a7663d5cea4246ee7f6dc4070/.github/workflows/openbsd.yml#L104):\n```yml\n          prepare: pkg_add bash curl gmake gtar-- cmake git ccache python py3-zmq\n```",
          "created_at": "2025-06-06T08:19:16Z"
        },
        {
          "user": "maflcko",
          "body": "> I'm not sure. The following seems [working](https://github.com/hebasto/bitcoin-core-nightly/blob/2973f9d010f6581a7663d5cea4246ee7f6dc4070/.github/workflows/openbsd.yml#L104):\n\nThis was tested on x86:\n\n```\nto: /home/runner/work/bitcoin-core-nightly/bitcoin-core-nightly/depends/x86_64-unknown-openbsd7.7\n```\n\nHowever this issue happens on aarch64:\n\n```\ngmake: *** [funcs.mk:343: /home/sjors/src/bitcoin/depends/aarch64-unknown-openbsd7.7\n```\n\nDoes UTM allow to spin up an x86_64 openbsd for testing?",
          "created_at": "2025-06-06T09:19:13Z"
        },
        {
          "user": "Sjors",
          "body": "@maflcko I can choose between Virtualize and Emulate, the latter being a bit slower, but might avoid this issue. I'll try. \n\nUpdate: unfortunately the installer just ends up in a boot loop",
          "created_at": "2025-06-06T09:25:49Z"
        },
        {
          "user": "Sjors",
          "body": "I tried again using a Hetzner VM running OpenBSD 7.7 amd64 (to install, just pick any distro, mount OpenBSD from their list of ISO images and reboot into the installer - get an IPv4 address unless you enjoy pain).\n\ngcc/g++ are not present by default, nor after `pkg_add bash gmake gtar`\n\nInitially the libevent installer fails because `cmake` isn't installed (also missing from the instruction, but the error is clear enough so it shouldn't confuse anyone).\n\nOnce cmake is install the depends build succeeds, so it doesn't seem to need gcc on this configuration.\n ",
          "created_at": "2025-06-06T13:21:22Z"
        },
        {
          "user": "Sjors",
          "body": "I spun up an equivalent aarch64 VM. I installed `bash gmake gtar` and `cmake` (and `git` to clone the repo). Ran into the same error as with UTM.\n\nSo it seems to be an arm thing?",
          "created_at": "2025-06-06T13:37:39Z"
        },
        {
          "user": "hebasto",
          "body": "> I spun up an equivalent aarch64 VM. I installed `bash gmake gtar` and `cmake` (and `git` to clone the repo). Ran into the same error as with UTM.\n> \n> So it seems to be an arm thing?\n\nSeems like a bug in CMake's `CMakeDetermineCCompiler` module.",
          "created_at": "2025-06-06T15:17:46Z"
        },
        {
          "user": "hebasto",
          "body": "@Sjors \n\nWhat are outputs of the `printenv` and `which cc` commands on your OpenBSD aarch64?",
          "created_at": "2025-06-06T15:22:40Z"
        },
        {
          "user": "Sjors",
          "body": "```\n_=/usr/bin/printenv\nLOGNAME=root\nPWD=/root\nHOME=/root\nSSH_TTY=/dev/ttyp0\nMAIL=/var/mail/root\nSSH_CLIENT=******** 10013 22\nPATH=/sbin:/usr/sbin:/bin:/usr/bin:/usr/X11R6/bin:/usr/local/sbin:/usr/local/bin\nTERM=xterm-256color\nSHELL=/bin/ksh\nSSH_CONNECTION=*************\nUSER=root\n```\n\n```\nwhich cc\n/usr/bin/cc\n```\n\n\nAnd for the regular user that I used for compiling:\n\n```\n_=/usr/bin/printenv\nLOGNAME=sjors\nPWD=/home/sjors\nHOME=/home/sjors\nSSH_TTY=/dev/ttyp0\nMAIL=/var/mail/sjors\nSSH_CLIENT=*************\nPATH=/home/sjors/bin:/bin:/sbin:/usr/bin:/usr/sbin:/usr/X11R6/bin:/usr/local/bin:/usr/local/sbin\nTERM=xterm-256color\nSHELL=/bin/ksh\nSSH_CONNECTION= ****************\nUSER=sjors\n```\n\n",
          "created_at": "2025-06-06T15:27:01Z"
        },
        {
          "user": "hebasto",
          "body": "@Sjors \n\nCould you please execute the following `CMakeLists.txt` on your machine:\n```cmake\ncmake_minimum_required(VERSION 3.31)\nproject(openbsd_cc C)\n```\nand submit a bug report to https://gitlab.kitware.com/cmake/cmake?",
          "created_at": "2025-06-06T15:35:52Z"
        },
        {
          "user": "Sjors",
          "body": "```\n$ cmake -B build\n-- The C compiler identification is Clang 16.0.6\n-- Detecting C compiler ABI info\n-- Detecting C compiler ABI info - done\n-- Check for working C compiler: /usr/bin/cc - skipped\n-- Detecting C compile features\n-- Detecting C compile features - done\n-- Configuring done (1.5s)\n-- Generating done (0.0s)\n-- Build files have been written to: /home/sjors/src/debug/build\n```\n\nThe output is identical to that on x86 machine, so I'm not sure what the bug is?",
          "created_at": "2025-06-06T15:58:28Z"
        },
        {
          "user": "hebasto",
          "body": "This [patch](https://github.com/hebasto/bitcoin/commit/dfc6ea0f8a27c945a60c6ea0eb63e04b665d29ac) seems working.\n\ncc @theStack ",
          "created_at": "2025-06-06T17:01:39Z"
        },
        {
          "user": "Sjors",
          "body": "@hebasto I cherry-picked your patch on top of master @ e2174378aa8a339c7be8b4e91311513ed520a16d and indeed libevent now builds fine.\n\nIt also works on top of #32690 (I also ran the unit and functional test suite).\n\nCan you open a PR with it?",
          "created_at": "2025-06-09T11:49:20Z"
        },
        {
          "user": "hebasto",
          "body": "> Can you open a PR with it?\n\nSure :)\n\nhttps://github.com/bitcoin/bitcoin/pull/32716.",
          "created_at": "2025-06-10T14:03:29Z"
        }
      ]
    }
  ],
  "summary": {
    "pull_requests": 5,
    "issues": 2
  }
}