{
  "source": "github",
  "repository": "bitcoin/bitcoin",
  "fetched_at": "2026-01-15T19:40:16.983978+00:00",
  "date": "2025-05-10",
  "pull_requests": [
    {
      "number": 32468,
      "title": "rpc: generateblock to allow multiple outputs",
      "body": "## Generatetomany\r\n\r\nFirst approach was to create a `generatetomany` rpc call. That approach can be seen here https://github.com/polespinasa/bitcoin/pull/3\r\n\r\n## Generateblock\r\nModifies `generateblock` to allow a user to set multiple outputs in the coinbase transaction. If an empty set is provided, the block will be empty. If no set of transactions is provided, the block will mine the mempool. If a set of transactions is provided only that set of txs will be mined.\r\n\r\n```\r\n$./bitcoin-cli -rpcport=18443 generateblock bcrt1qw6qkj8wtw5hraxwxjp08m4aymkntms3yhqyacj\r\n{\r\n  \"hash\": \"7359a3ed7af0f18f4016e6cb29193bd787a2452c584781135c585d5204b9ec5b\"\r\n}\r\n\r\n$ ./bitcoin-cli -rpcport=18443 generateblock '[\"bcrt1qal6p633hvwz2yp5mav0qy7u2az8gkn2xywnj6v\", \"bcrt1qvr3qgyhw6y0e0zj97v0j5yc40xtpea4wqj0g43\"]'\r\n{\r\n  \"hash\": \"6db028454b26d6667dd6df45be2772844121fb44f86433f6bbfbafa429974684\"\r\n}\r\n\r\n$ ./bitcoin-cli -rpcport=18443 generateblock '[\"bcrt1qal6p633hvwz2yp5mav0qy7u2az8gkn2xywnj6v\", \"bcrt1qvr3qgyhw6y0e0zj97v0j5yc40xtpea4wqj0g43\"]' []\r\n\r\n{\r\n  \"hash\": \"33e2ddc52546ddb0edf28bef5b295ee8fbd487b8aca19c97018467e2477877df\"\r\n}\r\n\r\n```\r\n\r\n### Motivation\r\nhttps://x.com/SuperTestnet/status/1921220086645342550\r\n\r\nCitating @supertestnet \r\n> When mining a block on regtest, the command \"generatetoaddress\" is available if you want to send the entire coinbase to 1 address. Let's add generatetomany in case you want to split up the coinbase among multiple addresses, similar to how the \"sendtoaddress\" and \"sendmany\" commands both exist and let you send money to (1) one address or (2) multiple addresses. The generatetomany command would be particularly useful for simulating protocols that send money to multiple recipients directly from a coinbase, as several pools do now, like ocean and braidpool.\r\n\r\n### Notes\r\n- ~Needs release note~\r\n- ~Changes on `generateblock` are not backwards compatible as now it takes an array of outputs instead a single output. This should not be critical as it is a test RPC.~ ",
      "state": "open",
      "user": "polespinasa",
      "created_at": "2025-05-10T17:34:29Z",
      "updated_at": "2026-01-14T01:09:02Z",
      "comments": 37,
      "url": "https://github.com/bitcoin/bitcoin/pull/32468",
      "labels": [
        "RPC/REST/ZMQ"
      ]
    },
    {
      "number": 32467,
      "title": "checkqueue: make the queue non-optional for CCheckQueueControl and drop legacy locking macro usage",
      "body": "As part of an effort to cleanup our threading primitives and add safe `SharedMutex`/`SharedLock` impls, I'd like to get rid of the last of our legacy `ENTER_CRITICAL_SECTION`/`LEAVE_CRITICAL_SECTION` usage. This, along with a follow-up [after fixing REVERSE_LOCK](https://github.com/bitcoin/bitcoin/pull/32465) will allow us to do that.\r\n\r\nThis replaces the old macros with an RAII lock, while simplifying `CCheckQueueControl`. It now requires a `CCheckQueue`, and optionality is handled externally. In the case of validation, it is wrapped in a `std::optional`.\r\n\r\nIt also adds an `LOCK_ARGS` macro for `UniqueLock` initialization which may be helpful elsewhere.",
      "state": "closed",
      "user": "theuni",
      "created_at": "2025-05-10T01:12:16Z",
      "updated_at": "2025-05-22T21:51:14Z",
      "comments": 8,
      "url": "https://github.com/bitcoin/bitcoin/pull/32467",
      "labels": [
        "Validation"
      ],
      "comment_list": [
        {
          "user": "DrahtBot",
          "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/32467.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [fjahr](https://github.com/bitcoin/bitcoin/pull/32467#issuecomment-2895776416), [ryanofsky](https://github.com/bitcoin/bitcoin/pull/32467#pullrequestreview-2858731450), [TheCharlatan](https://github.com/bitcoin/bitcoin/pull/32467#pullrequestreview-2860315670) |\n| Approach ACK | [hebasto](https://github.com/bitcoin/bitcoin/pull/32467#pullrequestreview-2854708043) |\n\nIf your review is incorrectly listed, please react with ðŸ‘Ž to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#32575](https://github.com/bitcoin/bitcoin/pull/32575) (refactor: Split multithreaded case out of CheckInputScripts by fjahr)\n* [#32317](https://github.com/bitcoin/bitcoin/pull/32317) (kernel: Separate UTXO set access from validation functions by TheCharlatan)\n* [#32080](https://github.com/bitcoin/bitcoin/pull/32080) (OP_CHECKCONTRACTVERIFY by bigspider)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n<!--5faf32d7da4f0f540f40219e4f7537a3-->",
          "created_at": "2025-05-10T01:12:19Z"
        },
        {
          "user": "fjahr",
          "body": "Concept ACK",
          "created_at": "2025-05-10T15:38:43Z"
        },
        {
          "user": "fjahr",
          "body": "Code review ACK 5aca850c205a20a0f198827f9797fb8053f2b3dd",
          "created_at": "2025-05-12T20:17:08Z"
        },
        {
          "user": "theuni",
          "body": "Updated to address @TheCharlatan's nit.",
          "created_at": "2025-05-13T20:53:55Z"
        },
        {
          "user": "fjahr",
          "body": "re-ACK da5d55227e6aead8a9fbb85e967801cfcd4283ce",
          "created_at": "2025-05-14T09:14:37Z"
        },
        {
          "user": "theuni",
          "body": "Updated to resolve @ryanofsky's comments. I added a new comment to (hopefully) clarify the `CheckInputScripts` calling.",
          "created_at": "2025-05-19T22:12:22Z"
        },
        {
          "user": "fjahr",
          "body": "re-ACK fd290730f530a8b76a9607392f49830697cdd7c5\r\n\r\nCI failure looks unrelated.",
          "created_at": "2025-05-20T20:38:59Z"
        },
        {
          "user": "davidgumberg",
          "body": "post-merge crACK https://github.com/bitcoin/bitcoin/commit/fd290730f530a8b76a9607392f49830697cdd7c5",
          "created_at": "2025-05-22T21:30:23Z"
        }
      ]
    },
    {
      "number": 32466,
      "title": "threading: drop CSemaphore in favor of c++20 std::counting_semaphore",
      "body": "This is relatively simple, but done in a bunch of commits to enable scripted diffs.\r\n\r\nI wanted to add a semaphore in a branch I've been working on, but it was unclear if I should use `std::counting_semaphore` or stick with our old `CSemaphore`. I couldn't decide, so I just decided to remove all doubt and get rid of ours :)\r\n\r\nThis replaces our old `CSemaphore` with `std::counting_semaphore` everywhere we used it. `CSemaphoreGrant` is still there as an RAII wrapper, but is now called `CountingSemaphoreGrant` and `BinarySemaphoreGrant` to match. Those have been moved out of `sync.h` to their own file.",
      "state": "closed",
      "user": "theuni",
      "created_at": "2025-05-10T01:00:48Z",
      "updated_at": "2025-05-20T19:21:00Z",
      "comments": 6,
      "url": "https://github.com/bitcoin/bitcoin/pull/32466",
      "labels": [
        "Utils/log/libs"
      ],
      "comment_list": [
        {
          "user": "DrahtBot",
          "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/32466.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [purpleKarrot](https://github.com/bitcoin/bitcoin/pull/32466#issuecomment-2869668262), [TheCharlatan](https://github.com/bitcoin/bitcoin/pull/32466#pullrequestreview-2832753782), [hebasto](https://github.com/bitcoin/bitcoin/pull/32466#pullrequestreview-2854910068), [achow101](https://github.com/bitcoin/bitcoin/pull/32466#issuecomment-2895509210) |\n\nIf your review is incorrectly listed, please react with ðŸ‘Ž to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#32394](https://github.com/bitcoin/bitcoin/pull/32394) (net: make m_nodes_mutex non-recursive by vasild)\n* [#32065](https://github.com/bitcoin/bitcoin/pull/32065) (i2p: make a time gap between creating transient sessions and using them by vasild)\n* [#32015](https://github.com/bitcoin/bitcoin/pull/32015) (net: replace manual reference counting of CNode with shared_ptr by vasild)\n* [#30988](https://github.com/bitcoin/bitcoin/pull/30988) (Split CConnman by vasild)\n* [#29415](https://github.com/bitcoin/bitcoin/pull/29415) (Broadcast own transactions only via short-lived Tor or I2P connections by vasild)\n* [#28584](https://github.com/bitcoin/bitcoin/pull/28584) (Fuzz: extend CConnman tests by vasild)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n<!--5faf32d7da4f0f540f40219e4f7537a3-->",
          "created_at": "2025-05-10T01:00:51Z"
        },
        {
          "user": "DrahtBot",
          "body": "<!--85328a0da195eb286784d51f73fa0af9-->\nðŸš§ At least one of the CI tasks failed.\n<sub>Task `lint`: https://github.com/bitcoin/bitcoin/runs/41976150929</sub>\n<sub>LLM reason (âœ¨ experimental): The CI failure is caused by a linting error related to a missing include guard in `src/semaphore_grant.h`.\n</sub>\n\n<details><summary>Hints</summary>\n\nTry to run the tests locally, according to the documentation. However, a CI failure may still\nhappen due to a number of reasons, for example:\n\n* Possibly due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\n* A sanitizer issue, which can only be found by compiling with the sanitizer and running the\n  affected test.\n\n* An intermittent issue.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n</details>\n\n",
          "created_at": "2025-05-10T02:45:36Z"
        },
        {
          "user": "purpleKarrot",
          "body": "When looking at the new file alone, I see several oportunities for improvement: Drop the `f` prefix, use default member initializers, use `std::exchange`. But when looking at the individual commits, I see that this is just moving existing code around, so it makes sense to do defer additional cleanup to a separate PR.\r\n\r\nThe code would have been easier to review if the last commit was not part of this PR, but it looks good.\r\n\r\nACK 6f7052a7b96f058568af9aed2f014ae7a25e0f68",
          "created_at": "2025-05-11T10:08:36Z"
        },
        {
          "user": "theuni",
          "body": "> When looking at the new file alone, I see several oportunities for improvement: Drop the `f` prefix, use default member initializers, use `std::exchange`. But when looking at the individual commits, I see that this is just moving existing code around, so it makes sense to do defer additional cleanup to a separate PR.\r\n\r\nIndeed. I have some follow-up work that introduces a `GrantableSemaphore` and rewrites `CountingSemaphoreGrant` to be correct-by-construction (where a successfully created grant guarantees that a slot is held as it does not allow releasing or transfer). I considered closing this PR in favor of just moving straight to that, but I think it makes sense to modernize as a first step, then debate the semantics of those changes next.",
          "created_at": "2025-05-15T15:14:10Z"
        },
        {
          "user": "hebasto",
          "body": "Concept ACK.",
          "created_at": "2025-05-20T16:11:24Z"
        },
        {
          "user": "achow101",
          "body": "ACK 6f7052a7b96f058568af9aed2f014ae7a25e0f68",
          "created_at": "2025-05-20T19:03:17Z"
        }
      ]
    },
    {
      "number": 32465,
      "title": "thread-safety: fix annotations with REVERSE_LOCK",
      "body": "This is one of several PRs to cleanup/modernize our threading primitives.\r\n\r\nWhile replacing the old critical section locks in the mining code with a `REVERSE_LOCK`, I noticed that our thread-safety annotations weren't hooked up to it. This PR gets `REVERSE_LOCK` working properly.\r\n\r\nFirstly it modernizes the attributes as-recommended by the [clang docs](https://clang.llvm.org/docs/ThreadSafetyAnalysis.html) (ctrl+f for `USE_LOCK_STYLE_THREAD_SAFETY_ATTRIBUTES`). There's a subtle difference between the old `unlock_function` and new `release_capability`, where our `reverse_lock` only works with the latter. I believe this is an upstream bug. I've [reported and attempted a fix here](https://github.com/llvm/llvm-project/pull/139343), but either way it makes sense to me to modernize.\r\n\r\nThe second adds a missing annotation pointed out by a fixed `REVERSE_LOCK`. Because clang's thread-safety annotations aren't passed through a reference to `UniqueLock` as one may assume (see [here](https://clang.llvm.org/docs/ThreadSafetyAnalysis.html#no-alias-analysis) for more details), `cs_main` has to be listed explicitly as a requirement.\r\n\r\nThe last commit actually fixes the `reverse_lock` by making it a `SCOPED_LOCK` and using the pattern [found in a clang test](https://github.com/llvm/llvm-project/blob/main/clang/test/SemaCXX/warn-thread-safety-analysis.cpp#L3126). Though the docs don't describe how to accomplish it, the functionality was added [in this commit](https://github.com/llvm/llvm-project/commit/6a68efc959bd1024506bf661a9e155de8a8440da). Due to aliasing issues (see link above), in order to work correctly, the original mutex has to be passed along with the lock, so all existing `REVERSE_LOCK`s have been updated. To ensure that the mutexes actually match, a runtime assertion is added.",
      "state": "closed",
      "user": "theuni",
      "created_at": "2025-05-10T00:49:47Z",
      "updated_at": "2025-06-17T18:12:52Z",
      "comments": 15,
      "url": "https://github.com/bitcoin/bitcoin/pull/32465",
      "labels": [
        "Tests",
        "Utils/log/libs"
      ],
      "comment_list": [
        {
          "user": "DrahtBot",
          "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/32465.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [ryanofsky](https://github.com/bitcoin/bitcoin/pull/32465#pullrequestreview-2935365143), [TheCharlatan](https://github.com/bitcoin/bitcoin/pull/32465#pullrequestreview-2935732117), [fjahr](https://github.com/bitcoin/bitcoin/pull/32465#issuecomment-2981154130), [davidgumberg](https://github.com/bitcoin/bitcoin/pull/32465#issuecomment-2981218670) |\n| Concept ACK | [hebasto](https://github.com/bitcoin/bitcoin/pull/32465#issuecomment-2868610302), [achow101](https://github.com/bitcoin/bitcoin/pull/32465#issuecomment-2932543075) |\n\nIf your review is incorrectly listed, please react with ðŸ‘Ž to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#32592](https://github.com/bitcoin/bitcoin/pull/32592) (threading: remove ancient CRITICAL_SECTION macros by theuni)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n<!--5faf32d7da4f0f540f40219e4f7537a3-->",
          "created_at": "2025-05-10T00:49:49Z"
        },
        {
          "user": "hebasto",
          "body": "Concept ACK.",
          "created_at": "2025-05-10T07:43:53Z"
        },
        {
          "user": "davidgumberg",
          "body": "crACK 96a341d4064132292621af404de908f01fbe3e2f\r\n\r\n`src/node/interfaces.cpp`'s `FillBlock()` is incorrectly annotated, and no warning is emitted, cherry-picking the commits that fix `reverse_lock`'s annotations, the thread safety analyzer complains as it should about `FillBlock()`:\r\n\r\n```bash\r\n$ git checkout --detach master && git cherry-pick 0065b9673db5da2994b0b07c1d50ebfb19af39d0^..96a341d4064132292621af404de908f01fbe3e2f\r\n$ CC=clang CXX=clang++ cmake -B build && cmake --build build -j $(nproc)\r\n# [...]\r\n/bitcoin/src/node/interfaces.cpp:446:9: warning: releasing mutex 'cs_main' that was not held [-Wthread-safety-analysis]\r\n  446 |         REVERSE_LOCK(lock, cs_main);\r\n      |         ^\r\n/bitcoin/src/sync.h:251:82: note: expanded from macro 'REVERSE_LOCK'\r\n  251 | #define REVERSE_LOCK(g, cs) typename std::decay<decltype(g)>::type::reverse_lock UNIQUE_NAME(revlock)(g, cs, #g, __FILE__, __LINE__)\r\n```\r\n\r\nTested that without 832c57a53410870471a52647ce107454de3bc69c's change to `UNLOCK_FUNCTION()` thread safety analysis also fails.\r\n",
          "created_at": "2025-05-28T21:06:10Z"
        },
        {
          "user": "theuni",
          "body": "> I think those arguments are pretty compelling, and think maybe the ideal thing would be to close this PR (to avoid confusing different approaches) and open a new PR dropping `REVERSE_LOCK` entirely and replacing with it lock/unlock calls, or perhaps with a `WITH_UNLOCK()` macro that runs a fragment of code with `unlock()` before and `lock()` after, and does not relock when an exception is thrown, and does not make an unsafe `lock()` call inside a destructor.\r\n\r\nHmm.\r\n\r\nFor context, my primary motivation here is preparing for the follow-up commits that will actually remove the `lock`/`unlock` methods completely, in order to force the exception-safe RAII wrappers. See these two commits: https://github.com/theuni/bitcoin/commit/d4b09184ae8ce38862a758423653f606e8b96045 and https://github.com/theuni/bitcoin/commit/1f2a9afdb302dd3f1686fe3461b9d7918a6b1859. My logic there was that there's basically no good reason why lock/unlock shouldn't be called together in the same scope, and any attempt to do so is almost guaranteed to be either a bad design or a bug.\r\n\r\nFor even more context, this is in preparation for adding a SharedMutex (std::shared_mutex/shared_lock wrappers with proper thread-safety annotations). Much of that work involves copying our current implementations, so I wanted them cleaned/tightened up as much as possible first.\r\n\r\nPoint taken about dtor exceptions and unwinding, but yeah, I think in practice if we're throwing in a `lock()` while unwinding, things have already gone sideways.\r\n\r\nImo the `REVERSE_LOCK` pattern clearly demonstrates intent and, together with bare `lock()`/`unlock()` removal, makes it impossible to do crazy things. For example, it's not possible to reverse or re-lock a `reverse_lock`, so one level deep is as far as you can go before having to re-architect your code to be more reasonable.\r\n\r\nSo maybe before deciding what to do here, I should ask what you think of the two commits above? If you're not onboard with removing bare `lock`/`unlock` functionality as a follow-up, this PR becomes much less interesting.",
          "created_at": "2025-05-30T20:18:10Z"
        },
        {
          "user": "fjahr",
          "body": "utACK 96a341d4064132292621af404de908f01fbe3e2f",
          "created_at": "2025-05-31T10:09:51Z"
        },
        {
          "user": "achow101",
          "body": "Concept ACK\r\n\r\n> preparing for the follow-up commits that will actually remove the lock/unlock methods completely, in order to force the exception-safe RAII wrappers.\r\n\r\nI think that's a good idea.",
          "created_at": "2025-06-02T21:23:49Z"
        },
        {
          "user": "davidgumberg",
          "body": "Concept ACK on dropping non-RAII locks/unlocks. Maybe this can be done without reverse locks, e.g. a (maybe dumb) approach at replacing REVERSE_LOCK with LOCK*'s: https://github.com/davidgumberg/bitcoin/commit/fde4e277550095ade852ebbe09bf2f0c7533a42e",
          "created_at": "2025-06-03T08:02:23Z"
        },
        {
          "user": "ryanofsky",
          "body": "re: theuni https://github.com/bitcoin/bitcoin/pull/32465#issuecomment-2923398293\r\n\r\n> For context, my primary motivation here is preparing for the follow-up commits that will actually remove the `lock`/`unlock` methods completely, in order to force the exception-safe RAII wrappers. See these two commits: [theuni@d4b0918](https://github.com/theuni/bitcoin/commit/d4b09184ae8ce38862a758423653f606e8b96045) and [theuni@1f2a9af](https://github.com/theuni/bitcoin/commit/1f2a9afdb302dd3f1686fe3461b9d7918a6b1859).\r\n\r\nYeah I think I'd disagree with this approach and I don't think it makes sense to remove the unlock + lock methods for the reasons davidgumberg quoted in https://github.com/bitcoin/bitcoin/pull/32465#discussion_r2112707324. RAII locking is great and makes sense. RAII unlocking seems dangerous and inferior to static verification provided by the thread annotations.\r\n\r\nTemporary unlocking can be useful when performing slow operations, and sometimes necessary when dealing with condition variables and external notifications, so the C++ library provides manual unlock/lock methods, but does not provide an automatic unlocking+relocking class for good reasons.\r\n\r\n> My logic there was that there's basically no good reason why lock/unlock shouldn't be called together in the same scope, and any attempt to do so is almost guaranteed to be either a bad design or a bug.\r\n\r\nThis is true for lock+unlock, but not for unlock+relock. If you acquire a lock and perform an operation, and the operation fails, part of the cleanup afterward should be to release the lock, and it makes sense to enforce this. But if you temporarily release a lock to perform an operation and the operation fails, it usually will not make sense to reacquire the lock as part of cleanup, and this should probably not even be the default behavior, let alone something strictly enforced by an API.\r\n \r\n> For even more context, this is in preparation for adding a SharedMutex (std::shared_mutex/shared_lock wrappers with proper thread-safety annotations). Much of that work involves copying our current implementations, so I wanted them cleaned/tightened up as much as possible first.\r\n\r\nThat makes sense. If you think this PR helps with that, I don't think this change is worse than the status quo. I just think it would be better if we eliminated REVERSE_LOCK entirely and replaced it with manual unlock+lock calls or a WITH_UNLOCK macro that unlocked before performing an operation, and relocked afterwards when the operation does not throw an exception.\r\n\r\nSince implementing that would touch all the same lines of code that this PR touches, it would be nice to make that change instead of this change to reduce churn. But it also seems fine if we think it is good to improve REVERSE_LOCK now in this PR and then remove it later in a future PR.\r\n\r\n> Point taken about dtor exceptions and unwinding, but yeah, I think in practice if we're throwing in a `lock()` while unwinding, things have already gone sideways.\r\n\r\nI think the point about having a call that throws in a destructor is a small part of the argument. The bigger point is that it does not make sense to relock in the error case to begin with. In the error case, even when the relock call succeeds, it will usually be pointless and unnecessary because it will be immediately followed by another unlock call as the stack unwinds\r\n\r\nAlso, I'd reject the the idea that if a lock call fails it means there has been some catastrophic failure. We are using pretty basic locks, but more generally locks can support things like deadlock detection and timeouts so a good locking API will closely resemble the C++ standard API with a locking RAII class and manual lock and unlock methods. There will not be a funky unlocking RAII class that makes a lock call in the destructor because it's not really a good idea.\r\n\r\nre: davidgumberg https://github.com/bitcoin/bitcoin/pull/32465#issuecomment-2934027032\r\n\r\n> Concept ACK on dropping non-RAII locks/unlocks. Maybe this can be done without reverse locks, e.g. a (maybe dumb) approach at replacing REVERSE_LOCK with LOCK*'s: [davidgumberg@fde4e27](https://github.com/davidgumberg/bitcoin/commit/fde4e277550095ade852ebbe09bf2f0c7533a42e)\r\n\r\nIMO that commit is a good demonstration of why it would be good to replace REVERSE_LOCK with manual unlock() + lock() calls or with a WITH_UNLOCK macro that makes them automatically.\r\n\r\nFor example there would be no need to restructure `ValidationSignalsImpl::Iterate`. We could simply replace `{ REVERSE_LOCK(lock); f(); }` with `{ lock.unlock(); f(); lock.lock(); }` or `WITH_UNLOCK(lock, f());`",
          "created_at": "2025-06-03T12:45:09Z"
        },
        {
          "user": "ryanofsky",
          "body": "To be clear, I all think the changes in this PR are improvements, even the last commit annotating REVERSE_LOCK, so I'd be happy to merge see this PR merged.\r\n\r\nI'm just saying the last commit changing and annotating REVERSE_LOCK could be unnecessary if we decide to remove it later, and think we should remove it for reasons discussed above.",
          "created_at": "2025-06-03T16:49:44Z"
        },
        {
          "user": "theuni",
          "body": "> To be clear, I all think the changes in this PR are improvements, even the last commit annotating REVERSE_LOCK, so I'd be happy to merge see this PR merged.\r\n> \r\n> I'm just saying the last commit changing and annotating REVERSE_LOCK could be unnecessary if we decide to remove it later, and think we should remove it for reasons discussed above.\r\n\r\nUnderstood, and points taken.\r\n\r\nCurrently playing around with your `WITH_UNLOCK` idea to see what that looks like. I'll report back.",
          "created_at": "2025-06-04T18:25:12Z"
        },
        {
          "user": "theuni",
          "body": "Dropped the unrelated commit which \"fixed\" the missing param. Turns out it was actually being passed correctly.\r\n\r\nI've played around with a few different approaches to this, and they all seem to have one issue or another, mostly revolving around getting the annotations correct.\r\n\r\nI understand @ryanofsky's and @davidgumberg's points about the reverse_lock paradigm in general and loosely agree, though the potentially throwing dtor doesn't bother me that much.\r\n\r\nI'm a bit burned out on trying to get a `WITH_REVERSE_LOCK` macro hooked up and doing the right thing in all cases with the annotations and (future) `SharedMutex`, so I'll likely be walking away from this for a while.\r\n\r\nAs it's a strict improvement over what we currently have, I don't see any harm in merging this, with the understanding that `REVERSE_LOCK` may go away entirely in the future. But in the meantime imo it makes sense to me to get this in to at least fix the false negatives.",
          "created_at": "2025-06-16T18:22:49Z"
        },
        {
          "user": "fjahr",
          "body": "re-ACK a201a99f8cf5ee5af0cd83cb2e1821e455d6eca7",
          "created_at": "2025-06-17T17:09:21Z"
        },
        {
          "user": "davidgumberg",
          "body": "reACK https://github.com/bitcoin/bitcoin/commit/a201a99f8cf5ee5af0cd83cb2e1821e455d6eca7",
          "created_at": "2025-06-17T17:33:53Z"
        },
        {
          "user": "theuni",
          "body": "@ryanofsky Agreed about the cs message. I just pushed a commit to address that, but since this PR just got a bunch of fresh ACKS, I'm going to remove it for the sake of easier merge. As you mentioned, it can go in as a follow-up.",
          "created_at": "2025-06-17T17:52:14Z"
        },
        {
          "user": "theuni",
          "body": "Ok, done. Those last pushes can be ignored. ACKs on a201a99 are still fresh.",
          "created_at": "2025-06-17T17:53:40Z"
        }
      ]
    }
  ],
  "issues": [],
  "summary": {
    "pull_requests": 4,
    "issues": 0
  }
}