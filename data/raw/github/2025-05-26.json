{
  "source": "github",
  "repository": "bitcoin/bitcoin",
  "fetched_at": "2026-01-15T19:45:50.049773+00:00",
  "date": "2025-05-26",
  "pull_requests": [
    {
      "number": 32620,
      "title": "wallet: Fix wallet interface detection of encrypted wallets",
      "body": "The GUI uses `WalletLoader::isEncrypted()` to detect whether a wallet file is encrypted so that it knows whether to prompt for a passphrase when migrating a legacy wallet. However, legacy wallets need to be opened with `options.require_format = BERKELEY_RO`. Since this wasn't being provided, following #28710, encrypted legacy wallets could not be migrated.\r\n\r\nThis fixes the issue by detecting when a wallet file is for a legacy wallet, and re-attempting with `options.require_format = BERKELEY_RO` in that case.\r\n\r\nDepends on #32449 for `DatabaseStatus::FAILED_LEGACY_DISABLED`",
      "state": "closed",
      "user": "achow101",
      "created_at": "2025-05-26T22:06:35Z",
      "updated_at": "2025-06-17T20:33:48Z",
      "comments": 3,
      "url": "https://github.com/bitcoin/bitcoin/pull/32620",
      "labels": [
        "GUI",
        "Wallet"
      ],
      "comment_list": [
        {
          "user": "DrahtBot",
          "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/32620.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [furszy](https://github.com/bitcoin/bitcoin/pull/32620#pullrequestreview-2900562541), [pablomartin4btc](https://github.com/bitcoin/bitcoin/pull/32620#pullrequestreview-2911854866), [w0xlt](https://github.com/bitcoin/bitcoin/pull/32620#pullrequestreview-2918300791), [davidgumberg](https://github.com/bitcoin/bitcoin/pull/32620#issuecomment-2964564699), [rkrux](https://github.com/bitcoin/bitcoin/pull/32620#pullrequestreview-2920415710) |\n\nIf your review is incorrectly listed, please react with üëé to this comment and the bot will ignore it on the next update.\n<!--5faf32d7da4f0f540f40219e4f7537a3-->",
          "created_at": "2025-05-26T22:06:38Z"
        },
        {
          "user": "achow101",
          "body": "Ready for review now.",
          "created_at": "2025-06-04T23:51:35Z"
        },
        {
          "user": "davidgumberg",
          "body": "Tested ACK https://github.com/bitcoin/bitcoin/commit/130a922980778b293b22169d5e5649afde3ba33b\r\n\r\nCreated a legacy wallet on v29.0 as follows:\r\n\r\n```bash\r\ngit checkout v29.0\r\ncmake -B build -DWITH_BDB=ON && cmake --build build -j $(nproc)\r\n./build/bin/bitcoind -signet -daemonwait -deprecatedrpc=create_bdb\r\n./build/bin/bitcoin-cli -signet -named createwallet wallet_name=encrypted_legacy descriptors=false passphrase=\"encrypted_legacy\"\r\n```\r\n\r\nand tested similarly to @pablomartin4btc:\r\n\r\n<details>\r\n\r\n<summary>\r\n\r\nWhen migrating the legacy wallet in `bitcoin-qt` by going to `File->Migrate Wallet` I am prompted with whether  or not I want to migrate my wallet.\r\n</summary>\r\n\r\n![Screenshot From 2025-06-11 16-32-28](https://github.com/user-attachments/assets/9d3e3eae-513a-473c-a8ac-5598adf2e436)\r\n\r\n</details>\r\n\r\n<details>\r\n\r\n<summary>\r\n\r\nAfter clicking `Yes` on master (5757de4ddd37), I see a dialog informing me that wallet decryption failed because my password was incorrect.\r\n\r\n</summary>\r\n\r\n![Screenshot From 2025-06-11 16-32-15](https://github.com/user-attachments/assets/63309e7d-017f-4740-9c96-a8dba28383e5).\r\n\r\n</details>\r\n<details>\r\n\r\n<summary>\r\n\r\nOn this branch's https://github.com/bitcoin/bitcoin/commit/130a922980778b293b22169d5e5649afde3ba33b, after clicking `Yes`, I am prompted for my passphrase, and migration succeeds!\r\n</summary>\r\n\r\n![Screenshot From 2025-06-11 16-33-00](https://github.com/user-attachments/assets/8b2336ad-508f-4e44-8111-bd31852714a2)\r\n\r\n\r\n</details>\r\n\r\n",
          "created_at": "2025-06-11T23:50:20Z"
        }
      ]
    },
    {
      "number": 32619,
      "title": "wallet, rpc, gui: List legacy wallets with a message about migration",
      "body": "A new field `warnings` is added for each wallet in `listwalletdir`. If a legacy wallet is detected, the warning will contain a message that the wallet is a legacy wallet and will need to be migrated before it can be loaded.\r\n\r\nIn the GUI, the \"Open Wallet\" menu is changed to show legacy wallets greyed out with \"(needs migration)\" appended to their name to indicate to the user that the legacy wallet will need to be migrated.",
      "state": "closed",
      "user": "achow101",
      "created_at": "2025-05-26T20:27:50Z",
      "updated_at": "2025-05-30T10:17:45Z",
      "comments": 3,
      "url": "https://github.com/bitcoin/bitcoin/pull/32619",
      "labels": [],
      "comment_list": [
        {
          "user": "DrahtBot",
          "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/32619.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [maflcko](https://github.com/bitcoin/bitcoin/pull/32619#issuecomment-2911221570), [furszy](https://github.com/bitcoin/bitcoin/pull/32619#pullrequestreview-2869966132), [w0xlt](https://github.com/bitcoin/bitcoin/pull/32619#pullrequestreview-2872880040), [adyshimony](https://github.com/bitcoin/bitcoin/pull/32619#issuecomment-2914132965) |\n\nIf your review is incorrectly listed, please react with üëé to this comment and the bot will ignore it on the next update.\n<!--5faf32d7da4f0f540f40219e4f7537a3-->",
          "created_at": "2025-05-26T20:27:53Z"
        },
        {
          "user": "maflcko",
          "body": "lgtm ACK f3a444c45fb4bf4e51d53ebf1cf4c2631ded481c",
          "created_at": "2025-05-27T06:09:02Z"
        },
        {
          "user": "adyshimony",
          "body": "Test ACK [f3a444c](https://github.com/bitcoin/bitcoin/pull/32619/commits/f3a444c45fb4bf4e51d53ebf1cf4c2631ded481c)\r\n\r\n<details><summary>Details</summary>\r\n<p>\r\n\r\n\r\n\r\nlistwalletdir:\r\n\r\n```\r\nbitcoin-cli listwalletdir\r\n{\r\n  \"wallets\": [\r\n    {\r\n      \"name\": \"legacy_0.15_ver\",\r\n      \"warnings\": [\r\n        \"This wallet is a legacy wallet and will need to be migrated with migratewallet before it can be loaded\"\r\n      ]\r\n    },\r\n    {\r\n      \"name\": \"test_32597_wallet\",\r\n      \"warnings\": [\r\n      ]\r\n    }\r\n  ]\r\n}\r\n\r\n\r\n```\r\n\r\nQT \"Open Wallet\" menu:\r\n\r\n![image](https://github.com/user-attachments/assets/553fc868-d257-49a8-a0a4-cbb6b9c5f609)\r\n\r\n\r\n![image](https://github.com/user-attachments/assets/601d8d96-789b-42ff-a59a-4b7bbe558075)\r\n\r\n\r\n\r\n</p>\r\n</details> \r\n",
          "created_at": "2025-05-27T21:38:41Z"
        }
      ]
    },
    {
      "number": 32618,
      "title": "wallet: Remove ISMINE_WATCHONLY and watchonly from RPCs",
      "body": "Descriptor wallets do not use the watchonly behavior as it is not possible to mix watchonly and non-watchonly in a descriptor wallet. With legacy wallets now removed, all of the watchonly handling and reporting code is no longer needed. This PR removes watchonly options and results from the RPCs and the handling of watchonly things from the wallet's internals.\r\n\r\nWith all of the watchonly things removed, ISMINE_WATCH_ONLY is removed as well.\r\n\r\nSplit from #32523\r\n\r\nDepends on #32594 for tests that are easier to read",
      "state": "closed",
      "user": "achow101",
      "created_at": "2025-05-26T19:33:21Z",
      "updated_at": "2025-07-07T20:29:06Z",
      "comments": 8,
      "url": "https://github.com/bitcoin/bitcoin/pull/32618",
      "labels": [
        "Wallet"
      ],
      "comment_list": [
        {
          "user": "DrahtBot",
          "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/32618.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [Eunovo](https://github.com/bitcoin/bitcoin/pull/32618#issuecomment-3026599126), [maflcko](https://github.com/bitcoin/bitcoin/pull/32618#issuecomment-3026946485), [furszy](https://github.com/bitcoin/bitcoin/pull/32618#pullrequestreview-2980491758), [rkrux](https://github.com/bitcoin/bitcoin/pull/32618#pullrequestreview-2981864736) |\n| Stale ACK | [BrandonOdiwuor](https://github.com/bitcoin/bitcoin/pull/32618#pullrequestreview-2974133938) |\n\nIf your review is incorrectly listed, please react with üëé to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#32857](https://github.com/bitcoin/bitcoin/pull/32857) (wallet: allow skipping script paths by Sjors)\n* [#30972](https://github.com/bitcoin/bitcoin/pull/30972) (Wallet: \"listreceivedby*\" fix by BrandonOdiwuor)\n* [#27865](https://github.com/bitcoin/bitcoin/pull/27865) (wallet: Track no-longer-spendable TXOs separately by achow101)\n* [#25269](https://github.com/bitcoin/bitcoin/pull/25269) (wallet: re-activate  \"AmountWithFeeExceedsBalance\" error by furszy)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n<!--5faf32d7da4f0f540f40219e4f7537a3-->\n### LLM Linter (‚ú® experimental)\n\nPossible typos and grammar issues:\n\n- In coincontrol.h: ‚Äúwhile requires all selected inputs be used‚Äù -> ‚Äúwhile requiring all selected inputs be used‚Äù [corrects the gerund for grammatical parallelism]\n\nNo other typos were found.\n\n<sup>drahtbot_id_4_m</sup>\n",
          "created_at": "2025-05-26T19:33:24Z"
        },
        {
          "user": "achow101",
          "body": "Ready for review",
          "created_at": "2025-06-14T00:56:36Z"
        },
        {
          "user": "maflcko",
          "body": "thx for the test\r\n\r\nreview ACK 003a3cdb29dcc1e3e1a53f8227de73389071fbd1 üìù\r\n\r\n<details><summary>Show signature</summary>\r\n\r\nSignature:\r\n\r\n```\r\nuntrusted comment: signature from minisign secret key on empty file; verify via: minisign -Vm \"${path_to_any_empty_file}\" -P RWTRmVTMeKV5noAMqVlsMugDDCyyTSbA3Re5AkUrhvLVln0tSaFWglOw -x \"${path_to_this_whole_four_line_signature_blob}\"\r\nRUTRmVTMeKV5npGrKx1nqXCw5zeVHdtdYURB/KlyA/LMFgpNCs+SkW9a8N95d+U4AP1RJMi+krxU1A3Yux4bpwZNLvVBKy0wLgM=\r\ntrusted comment: review ACK 003a3cdb29dcc1e3e1a53f8227de73389071fbd1 üìù\r\nW/H75G0Njq3xUMblb1LYeqKLIsDTB7AbxYK6n8ESm5k84ss0X35FSu3GEVPcDpVGWOancqnM5G43AeA9J97pCw==\r\n```\r\n\r\n</details>\r\n",
          "created_at": "2025-06-24T15:55:09Z"
        },
        {
          "user": "Eunovo",
          "body": "Consider cleaning up `wallet_balance.py` too, like this:\r\n```diff\r\ndiff --git a/test/functional/wallet_balance.py b/test/functional/wallet_balance.py\r\nindex 4efc0169eb..ac0374c3fa 100755\r\n--- a/test/functional/wallet_balance.py\r\n+++ b/test/functional/wallet_balance.py\r\n@@ -80,9 +80,9 @@ class WalletTest(BitcoinTestFramework):\r\n         assert_equal(self.nodes[0].getbalance(\"*\"), 50)\r\n         assert_equal(self.nodes[0].getbalance(\"*\", 1), 50)\r\n         assert_equal(self.nodes[0].getbalance(minconf=1), 50)\r\n-        assert_equal(self.nodes[0].getbalance(minconf=0, include_watchonly=True), 50)\r\n-        assert_equal(self.nodes[0].getbalance(\"*\", 1, True), 50)\r\n-        assert_equal(self.nodes[1].getbalance(minconf=0, include_watchonly=True), 50)\r\n+        assert_equal(self.nodes[0].getbalance(minconf=0), 50)\r\n+        assert_equal(self.nodes[0].getbalance(\"*\", 1), 50)\r\n+        assert_equal(self.nodes[1].getbalance(minconf=0), 50)\r\n \r\n         # Send 40 BTC from 0 to 1 and 60 BTC from 1 to 0.\r\n         txs = create_transactions(self.nodes[0], self.nodes[1].getnewaddress(), 40, [Decimal('0.01')])\r\n@@ -142,14 +142,10 @@ class WalletTest(BitcoinTestFramework):\r\n             # getbalances\r\n             expected_balances_0 = {'mine':      {'immature':          Decimal('0E-8'),\r\n                                                  'trusted':           Decimal('9.99'),  # change from node 0's send\r\n-                                                 'untrusted_pending': Decimal('60.0')},\r\n-                                   'watchonly': {'immature':          Decimal('5000'),\r\n-                                                 'trusted':           Decimal('50.0'),\r\n-                                                 'untrusted_pending': Decimal('0E-8')}}\r\n+                                                 'untrusted_pending': Decimal('60.0')}}\r\n             expected_balances_1 = {'mine':      {'immature':          Decimal('0E-8'),\r\n                                                  'trusted':           Decimal('0E-8'),  # node 1's send had an unsafe input\r\n                                                  'untrusted_pending': Decimal('30.0') - fee_node_1}}  # Doesn't include output of node 0's send since it was spent\r\n-            del expected_balances_0[\"watchonly\"]\r\n             balances_0 = self.nodes[0].getbalances()\r\n             balances_1 = self.nodes[1].getbalances()\r\n             # remove lastprocessedblock keys (they will be tested later)\r\n```",
          "created_at": "2025-07-01T09:26:10Z"
        },
        {
          "user": "Eunovo",
          "body": "Here is a diff removing `include_watchonly=True` from other functional tests, except `wallet_migration.py`\r\n```diff\r\ndiff --git a/test/functional/wallet_importprunedfunds.py b/test/functional/wallet_importprunedfunds.py\r\nindex cb052e4511..d45be4aa18 100755\r\n--- a/test/functional/wallet_importprunedfunds.py\r\n+++ b/test/functional/wallet_importprunedfunds.py\r\n@@ -89,7 +89,7 @@ class ImportPrunedFundsTest(BitcoinTestFramework):\r\n         wwatch = self.nodes[1].get_wallet_rpc('wwatch')\r\n         wwatch.importdescriptors([{\"desc\": self.nodes[0].getaddressinfo(address2)[\"desc\"], \"timestamp\": \"now\"}])\r\n         wwatch.importprunedfunds(rawtransaction=rawtxn2, txoutproof=proof2)\r\n-        assert [tx for tx in wwatch.listtransactions(include_watchonly=True) if tx['txid'] == txnid2]\r\n+        assert [tx for tx in wwatch.listtransactions() if tx['txid'] == txnid2]\r\n \r\n         # Import with private key with no rescan\r\n         w1 = self.nodes[1].get_wallet_rpc(self.default_wallet_name)\r\n@@ -109,13 +109,13 @@ class ImportPrunedFundsTest(BitcoinTestFramework):\r\n \r\n         # Remove transactions\r\n         assert_raises_rpc_error(-4, f'Transaction {txnid1} does not belong to this wallet', w1.removeprunedfunds, txnid1)\r\n-        assert not [tx for tx in w1.listtransactions(include_watchonly=True) if tx['txid'] == txnid1]\r\n+        assert not [tx for tx in w1.listtransactions() if tx['txid'] == txnid1]\r\n \r\n         wwatch.removeprunedfunds(txnid2)\r\n-        assert not [tx for tx in wwatch.listtransactions(include_watchonly=True) if tx['txid'] == txnid2]\r\n+        assert not [tx for tx in wwatch.listtransactions() if tx['txid'] == txnid2]\r\n \r\n         w1.removeprunedfunds(txnid3)\r\n-        assert not [tx for tx in w1.listtransactions(include_watchonly=True) if tx['txid'] == txnid3]\r\n+        assert not [tx for tx in w1.listtransactions() if tx['txid'] == txnid3]\r\n \r\n         # Check various RPC parameter validation errors\r\n         assert_raises_rpc_error(-22, \"TX decode failed\", w1.importprunedfunds, b'invalid tx'.hex(), proof1)\r\ndiff --git a/test/functional/wallet_listreceivedby.py b/test/functional/wallet_listreceivedby.py\r\nindex d6219af17c..91dc1a9528 100755\r\n--- a/test/functional/wallet_listreceivedby.py\r\n+++ b/test/functional/wallet_listreceivedby.py\r\n@@ -27,7 +27,7 @@ class ReceivedByTest(BitcoinTestFramework):\r\n \r\n     def run_test(self):\r\n         # save the number of coinbase reward addresses so far\r\n-        num_cb_reward_addresses = len(self.nodes[1].listreceivedbyaddress(minconf=0, include_empty=True, include_watchonly=True))\r\n+        num_cb_reward_addresses = len(self.nodes[1].listreceivedbyaddress(minconf=0, include_empty=True))\r\n \r\n         self.log.info(\"listreceivedbyaddress Test\")\r\n \r\n@@ -67,7 +67,7 @@ class ReceivedByTest(BitcoinTestFramework):\r\n         # Test Address filtering\r\n         # Only on addr\r\n         expected = {\"address\": addr, \"label\": \"\", \"amount\": Decimal(\"0.1\"), \"confirmations\": 10, \"txids\": [txid, ]}\r\n-        res = self.nodes[1].listreceivedbyaddress(minconf=0, include_empty=True, include_watchonly=True, address_filter=addr)\r\n+        res = self.nodes[1].listreceivedbyaddress(minconf=0, include_empty=True, address_filter=addr)\r\n         assert_array_result(res, {\"address\": addr}, expected)\r\n         assert_equal(len(res), 1)\r\n         # Test for regression on CLI calls with address string (#14173)\r\n@@ -75,7 +75,7 @@ class ReceivedByTest(BitcoinTestFramework):\r\n         assert_array_result(cli_res, {\"address\": addr}, expected)\r\n         assert_equal(len(cli_res), 1)\r\n         # Error on invalid address\r\n-        assert_raises_rpc_error(-4, \"address_filter parameter was invalid\", self.nodes[1].listreceivedbyaddress, minconf=0, include_empty=True, include_watchonl\r\ny=True, address_filter=\"bamboozling\")\r\n+        assert_raises_rpc_error(-4, \"address_filter parameter was invalid\", self.nodes[1].listreceivedbyaddress, minconf=0, include_empty=True, address_filter=\"\r\nbamboozling\")\r\n         # Another address receive money\r\n         res = self.nodes[1].listreceivedbyaddress(0, True, True)\r\n         assert_equal(len(res), 2 + num_cb_reward_addresses)  # Right now 2 entries\r\n```",
          "created_at": "2025-07-01T09:35:44Z"
        },
        {
          "user": "achow101",
          "body": "Removed the `include_watchonly=True`.",
          "created_at": "2025-07-01T18:27:03Z"
        },
        {
          "user": "Eunovo",
          "body": "ACK https://github.com/bitcoin/bitcoin/pull/32618/commits/b1a8ac07e91dd1d305fcbc16ea931d60e46c0055",
          "created_at": "2025-07-02T06:20:00Z"
        },
        {
          "user": "maflcko",
          "body": "re-ACK b1a8ac07e91dd1d305fcbc16ea931d60e46c0055 üåà\r\n\r\n<details><summary>Show signature</summary>\r\n\r\nSignature:\r\n\r\n```\r\nuntrusted comment: signature from minisign secret key on empty file; verify via: minisign -Vm \"${path_to_any_empty_file}\" -P RWTRmVTMeKV5noAMqVlsMugDDCyyTSbA3Re5AkUrhvLVln0tSaFWglOw -x \"${path_to_this_whole_four_line_signature_blob}\"\r\nRUTRmVTMeKV5npGrKx1nqXCw5zeVHdtdYURB/KlyA/LMFgpNCs+SkW9a8N95d+U4AP1RJMi+krxU1A3Yux4bpwZNLvVBKy0wLgM=\r\ntrusted comment: re-ACK b1a8ac07e91dd1d305fcbc16ea931d60e46c0055 üåà\r\ntZimYRLhaIkbxWPb9bFw84mEs8fM0kMiwUZjFXeBP0hYZUEFy8jrAvayLEjmA/01c/AUJfMl9Ob/d0yijdVmAw==\r\n```\r\n\r\n</details>\r\n",
          "created_at": "2025-07-02T08:29:30Z"
        }
      ]
    },
    {
      "number": 32617,
      "title": "[Draft/POC] Add secp256k1-based HPKE (Hybrid Public Key Encryption) For Payjoin v2",
      "body": "This PR introduces an implementation of Hybrid Public Key Encryption (HPKE) using a secp256k1-based Diffie-Hellman KEM (per RFC 9180 and \"secp256k1-based DHKEM for HPKE\" specification). It provides the core cryptographic component needed to enable the Payjoin v2 protocol.\r\n\r\nThis is an exploratory PR intended to kickstart discussion on adding Payjoin v2 support to Bitcoin Core ‚Äì feedback and reviews are very welcome.\r\n\r\nPayjoin v2 makes use of a protocol called Oblivious HTTP (OHTTP) to strip client-identifying metadata from the request. This protocol use a binary-encoded HTTP message encapsulated through HPKE.\r\n\r\nThe core implementation is contained in the new files `src/dhkem_secp256k1.h` and `src/dhkem_secp256k1.cpp`:\r\n\r\n* Full HPKE Modes: All four HPKE modes are supported ‚Äì `Base`, `PSK`, `Auth`, and `AuthPSK`.\r\n* Secp256k1 DHKEM: Uses secp256k1 for Diffie-Hellman key exchange. The `Encap()` and `Decap()` functions perform the base mode KEM (ephemeral ECDH using the receiver‚Äôs public key), while `AuthEncap()` and `AuthDecap()` extend this to authenticated mode (including the sender‚Äôs static key in the shared secret derivation). Internally, the shared secret is derived as specified by HPKE using HKDF (SHA256) extraction and expansion.\r\n* Key Schedule & Nonce Derivation: After KEM, the implementation runs the HPKE key schedule to derive the `encryption key`, `base nonce`, and `exporter secret`. It follows RFC 9180 ¬ß7.1, hashing the `info` and `psk_id` contexts and deriving the AEAD key and nonce. Per-message nonces are computed by XOR-ing the base nonce with a message sequence number as specified in RFC 9180 ¬ß5.2.\r\n* AEAD Encryption (ChaCha20-Poly1305): The HPKE context uses `ChaCha20-Poly1305` as the authenticated encryption scheme. The code provides `Seal()` and `Open()` functions to encrypt and decrypt data using the derived context key and a given nonce. It uses Bitcoin Core‚Äôs existing ChaCha20Poly1305 implementation.\r\n\r\nThe test file validates all the functions mentioned above: Encapsulation/Decapsulation, Encryption/Decryption, Nonce and Key Schedule Logic. This uses the PDK (Payjoin Dev Kit) test vectors. The tests also show how to use the HPKE functions.\r\n\r\nThis implementation only uses HKDF-SHA256 as Key Derivation Functions and ChaCha20-Poly1305 as AEAD, since these already exist in the Bitcoin Core codebase. It does not support other KDFs (such as HKDF-SHA384 and HKDF-SHA512) or other AEADs (such as AES-128-GCM and AES-256-GCM).\r\n\r\nTo run the tests:\r\n`build/bin/test_bitcoin --log_level=all --run_test=dhkem_secp256k1_tests`",
      "state": "open",
      "user": "w0xlt",
      "created_at": "2025-05-26T08:04:22Z",
      "updated_at": "2026-01-14T16:38:09Z",
      "comments": 10,
      "url": "https://github.com/bitcoin/bitcoin/pull/32617",
      "labels": [],
      "comment_list": [
        {
          "user": "DrahtBot",
          "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/32617.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\nA summary of reviews will appear here.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#28690](https://github.com/bitcoin/bitcoin/pull/28690) (build: Introduce internal kernel library by sedited)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n<!--5faf32d7da4f0f540f40219e4f7537a3-->\n### LLM Linter (‚ú® experimental)\n\nPossible typos and grammar issues:\n\n- draft-wahby-cfrg-hpke-kem-secp256k1-01^2 -> draft-wahby-cfrg-hpke-kem-secp256k1-01 [remove stray superscript] [the caret+number looks like a footnote marker and breaks the name]\n- (skE * pkR)^17 -> (skE * pkR) [remove stray superscript] [the caret+number after the expression is an unclear footnote marker]\n- \"HKDF-Extract & Expand(dh, \"shared secret\")^18.\" -> \"HKDF-Extract & Expand(dh, \\\"shared secret\\\").\" [remove stray superscript]\n\n<sup>drahtbot_id_5_m</sup>\n",
          "created_at": "2025-05-26T08:04:47Z"
        },
        {
          "user": "DrahtBot",
          "body": "<!--85328a0da195eb286784d51f73fa0af9-->\nüöß At least one of the CI tasks failed.\n<sub>Task `lint`: https://github.com/bitcoin/bitcoin/runs/42885844689</sub>\n<sub>LLM reason (‚ú® experimental): The CI failure is due to a lint check raising an error over missing include guards in the header file.</sub>\n\n<details><summary>Hints</summary>\n\nTry to run the tests locally, according to the documentation. However, a CI failure may still\nhappen due to a number of reasons, for example:\n\n* Possibly due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\n* A sanitizer issue, which can only be found by compiling with the sanitizer and running the\n  affected test.\n\n* An intermittent issue.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n</details>\n\n",
          "created_at": "2025-05-26T09:34:24Z"
        },
        {
          "user": "1440000bytes",
          "body": "If [`rust-payjoin`](https://github.com/payjoin/rust-payjoin/tree/master/payjoin-cli) already works with bitcoin core wallet, why do we need to add anything in bitcoin core for payjoin?\r\n\r\n",
          "created_at": "2025-05-26T11:42:00Z"
        },
        {
          "user": "DanGould",
          "body": "The main reason for the Bitcoin Core wallet to support payjoin directly is to reduce the number of necessary dependencies for those already using the core wallet. In particular rust-payjoin requires TLS (which is optional for the protocol) and rust implementations of cryptographic primatives that core could avoid with a bespoke implementation.",
          "created_at": "2025-05-26T19:13:53Z"
        },
        {
          "user": "theStack",
          "body": "Fore more context to reviewers, could add a link to [BIP 77](https://github.com/bitcoin/bips/blob/master/bip-0077.md) in the PR description, particularly to the cryptography part: https://github.com/bitcoin/bips/blob/master/bip-0077.md#secp256k1-hybrid-public-key-encryption\r\n\r\n> Full HPKE Modes: All four HPKE modes are supported ‚Äì Base, PSK, Auth, and AuthPSK.\r\n\r\nDo we need all of the four modes for Payjoin v2 support? Didn't look in-depth yet, but at least BIP77 contains only the two modes \"Base\" and \"Auth\" explicitly (and no mentions of \"PSK\"):\r\nhttps://github.com/bitcoin/bips/blob/72af87fc72999e3f0a26a06e6e0a7f3134236337/bip-0077.md?plain=1#L286-L287\r\nhttps://github.com/bitcoin/bips/blob/72af87fc72999e3f0a26a06e6e0a7f3134236337/bip-0077.md?plain=1#L376-L378",
          "created_at": "2025-06-03T15:19:41Z"
        },
        {
          "user": "w0xlt",
          "body": "> at least BIP77 contains only the two modes \"Base\" and \"Auth\" explicitly (and no mentions of \"PSK\"):\r\n\r\nGood catch. I still need to verify whether `PSK` is used by OHTTP in the Payjoin v2 protocol, but since the https://github.com/payjoin/bitcoin-hpke project used by PDK implements and has test vectors for `PSK`, I added the `PSK` and `AuthPSK` modes here as well.",
          "created_at": "2025-06-04T18:33:45Z"
        },
        {
          "user": "nothingmuch",
          "body": "> Good catch. I still need to verify whether `PSK` is used by OHTTP in the Payjoin v2 protocol,\r\n\r\nI can confirm that neither BIP 77 nor the rust-payjoin implementations depend on the PSK functionality. There are ideas for future extensions that might make use of that, but they are only ideas at this point and would not be a part of BIP 77 itself.",
          "created_at": "2025-06-09T17:50:00Z"
        },
        {
          "user": "achow101",
          "body": "Are you still working on this?",
          "created_at": "2025-10-22T15:04:55Z"
        },
        {
          "user": "w0xlt",
          "body": "PSK functionality removed.\r\nThanks for the suggestion @theStack and @nothingmuch ",
          "created_at": "2025-10-24T07:11:05Z"
        },
        {
          "user": "fanquake",
          "body": "It seems a bit premature to be doing code review or merging anything here, until some discussion has played out in #33684 in regards to approach, and implementation details (can you link to it from the PR description). There still seem to be high-level questions that need answering/agreement on.",
          "created_at": "2025-10-30T10:03:38Z"
        }
      ]
    }
  ],
  "issues": [],
  "summary": {
    "pull_requests": 4,
    "issues": 0
  }
}