{
  "source": "github",
  "repository": "bitcoin/bitcoin",
  "fetched_at": "2026-01-15T19:14:17.004130+00:00",
  "date": "2025-02-03",
  "pull_requests": [
    {
      "number": 31792,
      "title": "Double check all block rules in `ConnectBlock`, not only `CheckBlock`",
      "body": "We currently only sanity check `CheckBlock()` in `ConnectBlock()`. Not running the rest of the block\r\nchecks makes it hard to reason about upgrade edge cases if we were to introduce new consensus rules\r\n(which would necessarily be context-dependent checks). For instance a timewarp fix or a BIP34\r\nsupplementation.\r\n\r\nThis is fine to do as the expensive check in `ContextualCheckBlock()` is cached since\r\n1ec6bbeb8d27d31647d1433ccb87b362f6d81f90 and the future-timestamp check is split out of\r\n`ContextualCheckBlockHeader()` beforehand.",
      "state": "closed",
      "user": "darosior",
      "created_at": "2025-02-03T20:12:44Z",
      "updated_at": "2025-02-12T14:48:33Z",
      "comments": 19,
      "url": "https://github.com/bitcoin/bitcoin/pull/31792",
      "labels": [],
      "comment_list": [
        {
          "user": "DrahtBot",
          "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/31792.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Concept ACK | [TheCharlatan](https://github.com/bitcoin/bitcoin/pull/31792#pullrequestreview-2592504179) |\n| Approach NACK | [l0rinc](https://github.com/bitcoin/bitcoin/pull/31792#issuecomment-2653664441) |\n\nIf your review is incorrectly listed, please react with üëé to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#31714](https://github.com/bitcoin/bitcoin/pull/31714) (validation: Do less work in NeedsRedownload by mzumsande)\n* [#31564](https://github.com/bitcoin/bitcoin/pull/31564) (Add checkblock RPC and checkBlock() to Mining interface by Sjors)\n* [#31250](https://github.com/bitcoin/bitcoin/pull/31250) (wallet: Disable creating and loading legacy wallets by achow101)\n* [#30595](https://github.com/bitcoin/bitcoin/pull/30595) (kernel: Introduce initial C header API by TheCharlatan)\n* [#29641](https://github.com/bitcoin/bitcoin/pull/29641) (scripted-diff: Use LogInfo over LogPrintf [WIP, NOMERGE, DRAFT] by maflcko)\n* [#28710](https://github.com/bitcoin/bitcoin/pull/28710) (Remove the legacy wallet and BDB dependency by achow101)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
          "created_at": "2025-02-03T20:12:47Z"
        },
        {
          "user": "ajtowns",
          "body": "I think what you're doing here is:\r\n\r\n * redoing the contextual checks in ConnectBlock\r\n * currently, this could result in errors on startup if we accepted a block with timestamp T, but then our clock went backwards and is now set to a time prior to T-2 hours\r\n * so to avoid that, we move the T+2h check out of the contextual checks into its own special function, and call that from the appropriate places\r\n * once we redo contextual checks in ConnectBlock, `verifychain` rpc can detect contexual errors, so check that it does (should also check `-reindex-chainstate` sees them too?)\r\n\r\nI think it would be better to just add declarations for the functions rather than shuffling the code around, and I would have separated the commits a bit differently, more like https://github.com/ajtowns/bitcoin/commits/202502-pr31792/ (except with explanations in the commit messages)\r\n\r\nI'm not sure what the behaviour is now vs with this patch in the situation where you're node has followed a high work chain that is no longer valid under a newer version's rules. I think so long as the block that violates the rule is more than 6 blocks behind the tip, that both will just continue following the invalid chain until you manually -reindex. Will running verifychain with this PR just cause your node to crash rather than to reorg? It might be good to replace this comment:\r\n\r\n```c++\r\n    // NOTE: We don't currently (re-)invoke ContextualCheckBlock() or\r\n    // ContextualCheckBlockHeader() here. This means that if we add a new\r\n    // consensus rule that is enforced in one of those two functions, then we\r\n    // may have let in a block that violates the rule prior to updating the\r\n    // software, and we would NOT be enforcing the rule here. Fully solving\r\n    // upgrade from one software version to the next after a consensus rule\r\n    // change is potentially tricky and issue-specific (see NeedsRedownload()\r\n    // for one approach that was used for BIP 141 deployment).\r\n```\r\n\r\nwith the actual post-this-PR upgrade-behaviour, rather than just deleting it?",
          "created_at": "2025-02-04T15:27:16Z"
        },
        {
          "user": "willcl-ark",
          "body": "I seem to have a problem running IBD with this change @ dd2714ed13eea3591162dbade8132ff517ca5509, which I have not investigated yet:\r\n\r\n<details>\r\n<summary>tail debug.log</summary>\r\n\r\n```log\r\n<snip>\r\n2025-02-04T19:38:24Z init message: Verifying blocks‚Ä¶\r\n2025-02-04T19:38:24Z Block index and chainstate loaded\r\n2025-02-04T19:38:24Z Setting NODE_NETWORK on non-prune mode\r\n2025-02-04T19:38:24Z initload thread start\r\n2025-02-04T19:38:24Z [bench]   - Load block from disk: 0.05ms\r\n2025-02-04T19:38:24Z [validation] BlockChecked: block hash=000000000019d6689c085ae165831e934ff763ae46a2a6c172b3f1b60a8ce26f state=Valid\r\n2025-02-04T19:38:24Z [bench]   - Connect total: 0.05ms [0.00s (0.05ms/blk)]\r\n2025-02-04T19:38:24Z [bench]   - Flush: 0.02ms [0.00s (0.02ms/blk)]\r\n2025-02-04T19:38:24Z [bench]   - Writing chainstate: 0.01ms [0.00s (0.01ms/blk)]\r\n2025-02-04T19:38:24Z [validation] Enqueuing MempoolTransactionsRemovedForBlock: block height=0 txs removed=0\r\n2025-02-04T19:38:24Z UpdateTip: new best=000000000019d6689c085ae165831e934ff763ae46a2a6c172b3f1b60a8ce26f height=0 version=0x00000001 log2_work=32.000022 tx=1 date='2009-01-03T18:15:05Z' progress=0.000000 cache=0.3MiB(0txo)\r\n2025-02-04T19:38:24Z [bench]   - Connect postprocess: 0.06ms [0.00s (0.06ms/blk)]\r\n2025-02-04T19:38:24Z [bench] - Connect block: 0.19ms [0.00s (0.19ms/blk)]\r\n2025-02-04T19:38:24Z [validation] Enqueuing BlockConnected: block hash=000000000019d6689c085ae165831e934ff763ae46a2a6c172b3f1b60a8ce26f block height=0\r\n2025-02-04T19:38:24Z [validation] Enqueuing UpdatedBlockTip: new block hash=000000000019d6689c085ae165831e934ff763ae46a2a6c172b3f1b60a8ce26f fork block hash=null (in IBD=true)\r\n2025-02-04T19:38:24Z [validation] ActiveTipChange: new block hash=000000000019d6689c085ae165831e934ff763ae46a2a6c172b3f1b60a8ce26f block height=0\r\n2025-02-04T19:38:24Z [validation] MempoolTransactionsRemovedForBlock: block height=0 txs removed=0\r\n2025-02-04T19:38:24Z block tree size = 1\r\n2025-02-04T19:38:24Z nBestHeight = 0\r\n2025-02-04T19:38:24Z [validation] BlockConnected: block hash=000000000019d6689c085ae165831e934ff763ae46a2a6c172b3f1b60a8ce26f block height=0\r\n2025-02-04T19:38:24Z init message: Starting network threads‚Ä¶\r\n2025-02-04T19:38:24Z Failed to open mempool file. Continuing anyway.\r\n2025-02-04T19:38:24Z initload thread exit\r\n2025-02-04T19:38:24Z DNS seeding disabled\r\n2025-02-04T19:38:24Z net thread start\r\n2025-02-04T19:38:24Z init message: Done loading\r\n2025-02-04T19:38:24Z addcon thread start\r\n2025-02-04T19:38:24Z msghand thread start\r\n2025-02-04T19:38:24Z opencon thread start\r\n2025-02-04T19:38:24Z [validation] UpdatedBlockTip: new block hash=000000000019d6689c085ae165831e934ff763ae46a2a6c172b3f1b60a8ce26f fork block hash=null (in IBD=true)\r\n2025-02-04T19:38:24Z New manual v2 peer connected: version: 70016, blocks=882316, peer=0\r\n2025-02-04T19:38:24Z Pre-synchronizing blockheaders, height: 2000 (~0.24%)\r\n2025-02-04T19:38:25Z Pre-synchronizing blockheaders, height: 18000 (~2.14%)\r\n\r\n<snip>\r\n\r\n2025-02-04T19:38:43Z [validation] Saw new header hash=00000000000000000002f0aba7c60667df80ee657873bfa22e5dba80f13fafcb height=859992\r\n2025-02-04T19:38:43Z [validation] Saw new header hash=00000000000000000002e66a5fe60350d7a5900c797dde1ac989e36de05e2cf3 height=859993\r\n2025-02-04T19:38:43Z [validation] Saw new header hash=0000000000000000000220ed045522462a2a96bc3e3898364f19dad67fe842a8 height=859994\r\n2025-02-04T19:38:43Z [validation] Saw new header hash=0000000000000000000124d178d6056cf493873ba3a865eb2a4fc64e2e9b2ccb height=859995\r\n2025-02-04T19:38:43Z [validation] Saw new header hash=00000000000000000000bc91fb6007041636f724770df4d16184af479102c69e height=859996\r\n2025-02-04T19:38:43Z [validation] Saw new header hash=000000000000000000028c2e4e0e6e83da708aabf189b252e5f8f62cbd090053 height=859997\r\n2025-02-04T19:38:43Z [validation] Saw new header hash=00000000000000000000de531aab72aa763d8f1dea92efdb47c96ea5d209b8ef height=859998\r\n2025-02-04T19:38:43Z [validation] Saw new header hash=0000000000000000000196a7111c7aa3368af5a803a81c7bfb32860100dfd9c7 height=859999\r\n2025-02-04T19:38:43Z [validation] Saw new header hash=0000000000000000000095dd5c0c8e176a6498eb335c491b96df1a1ae178bfbd height=860000\r\n2025-02-04T19:38:43Z Synchronizing blockheaders, height: 860000 (~97.51%)\r\n2025-02-04T19:31:58Z [bench]   - Using cached block\r\n2025-02-04T19:31:58Z [bench]   - Load block from disk: 0.01ms\r\n2025-02-04T19:31:58Z ERROR: ContextualCheckBlockHeader: forked chain older than last checkpoint (height 1)\r\n2025-02-04T19:31:58Z [error] ConnectBlock: Consensus::ContextualCheckBlockHeader: bad-fork-prior-to-checkpoint\r\n2025-02-04T19:31:58Z [validation] BlockChecked: block hash=00000000839a8e6886ab5951d76f411475428afc90947ee320161bbf18eb6048 state=bad-fork-prior-to-checkpoint\r\n2025-02-04T19:31:58Z InvalidChainFound: invalid block=00000000839a8e6886ab5951d76f411475428afc90947ee320161bbf18eb6048  height=1  log2_work=33.000022  date=2009-01-09T02:54:25Z\r\n2025-02-04T19:31:58Z InvalidChainFound:  current best=000000000019d6689c085ae165831e934ff763ae46a2a6c172b3f1b60a8ce26f  height=0  log2_work=32.000022  date=2009-01-03T18:15:05Z\r\n2025-02-04T19:31:58Z [error] ConnectTip: ConnectBlock 00000000839a8e6886ab5951d76f411475428afc90947ee320161bbf18eb6048 failed, bad-fork-prior-to-checkpoint\r\n2025-02-04T19:31:58Z InvalidChainFound: invalid block=00000000839a8e6886ab5951d76f411475428afc90947ee320161bbf18eb6048  height=1  log2_work=33.000022  date=2009-01-09T02:54:25Z\r\n2025-02-04T19:31:58Z InvalidChainFound:  current best=000000000019d6689c085ae165831e934ff763ae46a2a6c172b3f1b60a8ce26f  height=0  log2_work=32.000022  date=2009-01-03T18:15:05Z\r\n2025-02-04T19:31:58Z [validation] ActiveTipChange: new block hash=000000000019d6689c085ae165831e934ff763ae46a2a6c172b3f1b60a8ce26f block height=0\r\n2025-02-04T19:31:58Z Warning: not punishing manually connected peer 0!\r\n2025-02-04T19:31:58Z [validation] AcceptBlockHeader: block 000000006a625f06636b8bb6ac7b960a8d03705d1ace08b1a19da3fdcc99ddbd is marked invalid\r\n2025-02-04T19:31:58Z [validation] BlockChecked: block hash=000000006a625f06636b8bb6ac7b960a8d03705d1ace08b1a19da3fdcc99ddbd state=duplicate-invalid\r\n2025-02-04T19:31:58Z [error] ProcessNewBlock: AcceptBlock FAILED (duplicate-invalid)\r\n2025-02-04T19:31:58Z Warning: not punishing manually connected peer 0!\r\n2025-02-04T19:31:58Z [validation] AcceptBlockHeader: block 0000000082b5015589a3fdf2d4baff403e6f0be035a5d9742c1cae6295464449 is marked invalid\r\n2025-02-04T19:31:58Z [validation] BlockChecked: block hash=0000000082b5015589a3fdf2d4baff403e6f0be035a5d9742c1cae6295464449 state=duplicate-invalid\r\n2025-02-04T19:31:58Z [error] ProcessNewBlock: AcceptBlock FAILED (duplicate-invalid)\r\n2025-02-04T19:31:58Z Warning: not punishing manually connected peer 0!\r\n2025-02-04T19:31:58Z [validation] AcceptBlockHeader: block 000000004ebadb55ee9096c9a2f8880e09da59c0d68b1c228da88e48844a1485 is marked invalid\r\n2025-02-04T19:31:58Z [validation] BlockChecked: block hash=000000004ebadb55ee9096c9a2f8880e09da59c0d68b1c228da88e48844a1485 state=duplicate-invalid\r\n2025-02-04T19:31:58Z [error] ProcessNewBlock: AcceptBlock FAILED (duplicate-invalid)\r\n2025-02-04T19:31:58Z Warning: not punishing manually connected peer 0!\r\n2025-02-04T19:31:58Z [validation] AcceptBlockHeader: block 000000009b7262315dbf071787ad3656097b892abffd1f95a1a022f896f533fc is marked invalid\r\n2025-02-04T19:31:58Z [validation] BlockChecked: block hash=000000009b7262315dbf071787ad3656097b892abffd1f95a1a022f896f533fc state=duplicate-invalid\r\n2025-02-04T19:31:58Z [error] ProcessNewBlock: AcceptBlock FAILED (duplicate-invalid)\r\n2025-02-04T19:31:58Z Warning: not punishing manually connected peer 0!\r\n2025-02-04T19:31:58Z [validation] AcceptBlockHeader: block 000000003031a0e73735690c5a1ff2a4be82553b2a12b776fbd3a215dc8f778d is marked invalid\r\n2025-02-04T19:31:58Z [validation] BlockChecked: block hash=000000003031a0e73735690c5a1ff2a4be82553b2a12b776fbd3a215dc8f778d state=duplicate-invalid\r\n2025-02-04T19:31:58Z [error] ProcessNewBlock: AcceptBlock FAILED (duplicate-invalid)\r\n2025-02-04T19:31:58Z Warning: not punishing manually connected peer 0!\r\n2025-02-04T19:31:58Z [validation] AcceptBlockHeader: block 0000000071966c2b1d065fd446b1e485b2c9d9594acd2007ccbd5441cfc89444 is marked invalid\r\n2025-02-04T19:31:58Z [validation] BlockChecked: block hash=0000000071966c2b1d065fd446b1e485b2c9d9594acd2007ccbd5441cfc89444 state=duplicate-invalid\r\n2025-02-04T19:31:58Z [error] ProcessNewBlock: AcceptBlock FAILED (duplicate-invalid)\r\n2025-02-04T19:31:58Z Warning: not punishing manually connected peer 0!\r\n2025-02-04T19:31:58Z [validation] AcceptBlockHeader: block 00000000408c48f847aa786c2268fc3e6ec2af68e8468a34a28c61b7f1de0dc6 is marked invalid\r\n2025-02-04T19:31:58Z [validation] BlockChecked: block hash=00000000408c48f847aa786c2268fc3e6ec2af68e8468a34a28c61b7f1de0dc6 state=duplicate-invalid\r\n2025-02-04T19:31:58Z [error] ProcessNewBlock: AcceptBlock FAILED (duplicate-invalid)\r\n2025-02-04T19:31:58Z Warning: not punishing manually connected peer 0!\r\n2025-02-04T19:31:58Z [validation] AcceptBlockHeader: block 000000008d9dc510f23c2657fc4f67bea30078cc05a90eb89e84cc475c080805 is marked invalid\r\n2025-02-04T19:31:58Z [validation] BlockChecked: block hash=000000008d9dc510f23c2657fc4f67bea30078cc05a90eb89e84cc475c080805 state=duplicate-invalid\r\n2025-02-04T19:31:58Z [error] ProcessNewBlock: AcceptBlock FAILED (duplicate-invalid)\r\n2025-02-04T19:31:58Z Warning: not punishing manually connected peer 0!\r\n2025-02-04T19:31:58Z [validation] AcceptBlockHeader: block 000000002c05cc2e78923c34df87fd108b22221ac6076c18f3ade378a4d915e9 is marked invalid\r\n2025-02-04T19:31:58Z [validation] BlockChecked: block hash=000000002c05cc2e78923c34df87fd108b22221ac6076c18f3ade378a4d915e9 state=duplicate-invalid\r\n2025-02-04T19:31:58Z [error] ProcessNewBlock: AcceptBlock FAILED (duplicate-invalid)\r\n2025-02-04T19:31:58Z Warning: not punishing manually connected peer 0!\r\n2025-02-04T19:31:58Z [validation] AcceptBlockHeader: block 0000000097be56d606cdd9c54b04d4747e957d3608abe69198c661f2add73073 is marked invalid\r\n2025-02-04T19:31:58Z [validation] BlockChecked: block hash=0000000097be56d606cdd9c54b04d4747e957d3608abe69198c661f2add73073 state=duplicate-invalid\r\n2025-02-04T19:31:58Z [error] ProcessNewBlock: AcceptBlock FAILED (duplicate-invalid)\r\n2025-02-04T19:31:58Z Warning: not punishing manually connected peer 0!\r\n2025-02-04T19:31:58Z [validation] AcceptBlockHeader: block 0000000027c2488e2510d1acf4369787784fa20ee084c258b58d9fbd43802b5e is marked invalid\r\n2025-02-04T19:31:58Z [validation] BlockChecked: block hash=0000000027c2488e2510d1acf4369787784fa20ee084c258b58d9fbd43802b5e state=duplicate-invalid\r\n2025-02-04T19:31:58Z [error] ProcessNewBlock: AcceptBlock FAILED (duplicate-invalid)\r\n2025-02-04T19:31:58Z Warning: not punishing manually connected peer 0!\r\n2025-02-04T19:31:58Z [validation] AcceptBlockHeader: block 000000005c51de2031a895adc145ee2242e919a01c6d61fb222a54a54b4d3089 is marked invalid\r\n2025-02-04T19:31:58Z [validation] BlockChecked: block hash=000000005c51de2031a895adc145ee2242e919a01c6d61fb222a54a54b4d3089 state=duplicate-invalid\r\n2025-02-04T19:31:58Z [error] ProcessNewBlock: AcceptBlock FAILED (duplicate-invalid)\r\n2025-02-04T19:31:58Z Warning: not punishing manually connected peer 0!\r\n2025-02-04T19:31:58Z [validation] AcceptBlockHeader: block 0000000080f17a0c5a67f663a9bc9969eb37e81666d9321125f0e293656f8a37 is marked invalid\r\n2025-02-04T19:31:58Z [validation] BlockChecked: block hash=0000000080f17a0c5a67f663a9bc9969eb37e81666d9321125f0e293656f8a37 state=duplicate-invalid\r\n2025-02-04T19:31:58Z [error] ProcessNewBlock: AcceptBlock FAILED (duplicate-invalid)\r\n2025-02-04T19:31:58Z Warning: not punishing manually connected peer 0!\r\n2025-02-04T19:31:58Z [validation] AcceptBlockHeader: block 00000000b3322c8c3ef7d2cf6da009a776e6a99ee65ec5a32f3f345712238473 is marked invalid\r\n2025-02-04T19:31:58Z [validation] BlockChecked: block hash=00000000b3322c8c3ef7d2cf6da009a776e6a99ee65ec5a32f3f345712238473 state=duplicate-invalid\r\n2025-02-04T19:31:58Z [error] ProcessNewBlock: AcceptBlock FAILED (duplicate-invalid)\r\n2025-02-04T19:31:58Z Warning: not punishing manually connected peer 0!\r\n2025-02-04T19:31:58Z [validation] AcceptBlockHeader: block 00000000174a25bb399b009cc8deff1c4b3ea84df7e93affaaf60dc3416cc4f5 is marked invalid\r\n2025-02-04T19:31:58Z [validation] BlockChecked: block hash=00000000174a25bb399b009cc8deff1c4b3ea84df7e93affaaf60dc3416cc4f5 state=duplicate-invalid\r\n2025-02-04T19:31:58Z [error] ProcessNewBlock: AcceptBlock FAILED (duplicate-invalid)\r\n2025-02-04T19:31:58Z Warning: not punishing manually connected peer 0!\r\n2025-02-04T19:31:58Z [validation] header 00000000000000000001b3fc0c62b55c57a0d46b4069100ab041af9c345a1059 has prev block invalid: 0000000000000000000095dd5c0c8e176a6498eb335c491b96df1a1ae178bfbd\r\n2025-02-04T19:31:58Z Warning: not punishing manually connected peer 0!\r\n^C2025-02-04T19:32:03Z Shutdown: In progress...\r\n2025-02-04T19:32:03Z opencon thread exit\r\n2025-02-04T19:32:03Z addcon thread exit\r\n2025-02-04T19:32:03Z net thread exit\r\n2025-02-04T19:32:03Z msghand thread exit\r\n2025-02-04T19:32:03Z scheduler thread exit\r\n2025-02-04T19:32:03Z Writing 0 mempool transactions to file...\r\n2025-02-04T19:32:03Z Writing 0 unbroadcast transactions to file.\r\n2025-02-04T19:32:03Z Dumped mempool: 0.000s to copy, 0.006s to dump, 27 bytes dumped to file\r\n2025-02-04T19:32:03Z Flushed fee estimates to fee_estimates.dat.\r\n2025-02-04T19:32:03Z [bench] FlushStateToDisk: write block and undo data to disk started\r\n2025-02-04T19:32:03Z [bench] FlushStateToDisk: write block and undo data to disk completed (16.65ms)\r\n2025-02-04T19:32:03Z [bench] FlushStateToDisk: write block index to disk started\r\n2025-02-04T19:32:05Z [bench] FlushStateToDisk: write block index to disk completed (1348.48ms)\r\n2025-02-04T19:32:05Z [bench] FlushStateToDisk: write coins cache to disk (0 coins, 256KiB) started\r\n2025-02-04T19:32:05Z [bench] FlushStateToDisk: write coins cache to disk (0 coins, 256KiB) completed (0.03ms)\r\n2025-02-04T19:32:05Z [validation] Enqueuing ChainStateFlushed: block hash=000000000019d6689c085ae165831e934ff763ae46a2a6c172b3f1b60a8ce26f\r\n2025-02-04T19:32:05Z [validation] ChainStateFlushed: block hash=000000000019d6689c085ae165831e934ff763ae46a2a6c172b3f1b60a8ce26f\r\n2025-02-04T19:32:05Z [bench] FlushStateToDisk: write block and undo data to disk started\r\n2025-02-04T19:32:05Z [bench] FlushStateToDisk: write block and undo data to disk completed (27.61ms)\r\n2025-02-04T19:32:05Z [bench] FlushStateToDisk: write block index to disk started\r\n2025-02-04T19:32:05Z [bench] FlushStateToDisk: write block index to disk completed (5.74ms)\r\n2025-02-04T19:32:05Z [bench] FlushStateToDisk: write coins cache to disk (0 coins, 256KiB) started\r\n2025-02-04T19:32:05Z [bench] FlushStateToDisk: write coins cache to disk (0 coins, 256KiB) completed (0.03ms)\r\n2025-02-04T19:32:05Z [validation] Enqueuing ChainStateFlushed: block hash=000000000019d6689c085ae165831e934ff763ae46a2a6c172b3f1b60a8ce26f\r\n2025-02-04T19:32:05Z Shutdown: done\r\n```\r\n\r\n</details>\r\n\r\nI connected to a single manual peer which is why `Warning: not punishing manually connected peer 0!` appears. With a selection of network peers I observed an endless header presync->sync->presync loop.",
          "created_at": "2025-02-04T19:42:16Z"
        },
        {
          "user": "DrahtBot",
          "body": "`feature_unsupported_utxo_db.py` fails (times out)",
          "created_at": "2025-02-04T23:05:11Z"
        },
        {
          "user": "darosior",
          "body": "> I seem to have a problem running IBD with this change @ [dd2714e](https://github.com/bitcoin/bitcoin/commit/dd2714ed13eea3591162dbade8132ff517ca5509), which I have not investigated yet:\r\n\r\nThis is because we'd now perform the checkpoints check twice, but it'd fail the second time since a checkpoint with a higher height would already be in the index. Instead of introducing more complexity there i rebased on top of #31649.\r\n\r\n> `feature_unsupported_utxo_db.py` fails (times out)\r\n\r\nThis was failing in the final restart of the node, because the upgraded node is now checking all consensus rules (including Segwit which is always active on testnet) and was tripping on a `bad-witness-nonce-size` since the block was created by the unupgraded node.",
          "created_at": "2025-02-05T04:13:22Z"
        },
        {
          "user": "darosior",
          "body": "> * (should also check `-reindex-chainstate` sees them too?)\r\n\r\nI tried to add a functional test for this but our test framework assumes an RPC interface is always available, and this error would happen before it is. This would make the test code really clunky, plus `verifychain` tests the same already and `feature_unsupported_utxo_db.py` implicitly tests this (not setting `-testactivationheight=segwit@2` with `-rescan-chainstate` would trigger a ConnectBlock error).\r\n\r\n> I think it would be better to just add declarations for the functions rather than shuffling the code around, and I would have separated the commits a bit differently\r\n\r\nI have now re-arranged the commits as you suggested (essentially just splitting the first commit in two), and used forward declarations instead of moving the function definitions. I also added more details to the commit, notably Martin's point that this change would probably have an impact on IBD.\r\n\r\n> It might be good to replace this comment [...] with the actual post-this-PR upgrade-behaviour, rather than just deleting it?\r\n\r\nI couldn't come up with any useful comment to replace it with. The original comment is a warning about the surprising original behavior. Now that the surprising behavior is removed, it makes sense to just delete the warning and not replace it with \"this does what you'd expect\"?\r\n\r\n---\r\n\r\nI started an IBD on top of this branch. EDIT: IBD completed successfully.",
          "created_at": "2025-02-05T20:21:29Z"
        },
        {
          "user": "ajtowns",
          "body": "> > It might be good to replace this comment [...] with the actual post-this-PR upgrade-behaviour, rather than just deleting it?\r\n> \r\n> I couldn't come up with any useful comment to replace it with. The original comment is a warning about the surprising original behavior. Now that the surprising behavior is removed, it makes sense to just delete the warning and not replace it with \"this does what you'd expect\"?\r\n\r\nI guess it's not obvious to me what you should expect here.\r\n\r\nI believe the current high-level behaviour with the PR is:\r\n\r\n * Running normally will continue from the current tip as if it were valid, even if it strictly isn't, you'll reorg to a valid chain automatically if it ever has more work. If you run invalidateblock on the first invalid block, you'll reorg back to that point and continue on to a valid chain, if one exists.\r\n * Running with -checklevel=4 will detect errors within the last 6 blocks (-checkblocks), and cause startup failure\r\n * Running with -reindex will detect errors anywhere, and leave you at the last valid block\r\n * Running with -reindex-chainstate will leave you stuck in an infinite loop revalidating an invalid tip?\r\n\r\nAs far as the low-level behaviour goes, eg, it's not clear to me why `TestBlockValidity()` needs to duplicate the checks (previously, it would have made some sense in order to ensure CheckBlock errors are reported prior to ContextualCheckBlock errors, but it seems less useful now).\r\n\r\nI guess it might make more sense to add a docstring for ConnectBlock that it (re)validates the block its connecting (and to what degree it does so), and move the \"Check it again in case a previous version\" comment to VerifyDB saying that this will catch errors in the examined blocks, and that invalidateblock, a -reindex or special handling like for segwit is necessary if you want to force a reorg onto an valid chain?",
          "created_at": "2025-02-06T05:05:21Z"
        },
        {
          "user": "Sjors",
          "body": "Can you mention in the PR description that this builds on #31649? That also helps prevent review comments on the checkpoint change from being spread between two pull requests.\r\n\r\nThe first two `[refactor]` commits 0dad68ec06af4c53bf4a3cd6c266e8cb8fe5ef55 and 9655edaec317f0e8aa14ff7feab68ec668a86076 look correct to me.\r\n\r\nAlthough the `CheckHeaderNotFuture` is now performed earlier than before, it's cheap enough that this doesn't seem dangerous. The tests that it moves ahead of are similarly cheap.\r\n\r\nTechnically 9655edaec317f0e8aa14ff7feab68ec668a86076 should update this comment in `ConnectBlock()`:\r\n\r\n```cpp\r\n// Also, currently the rule against blocks more than 2 hours in the future\r\n// is enforced in ContextualCheckBlockHeader(); we wouldn't want to\r\n```\r\n\r\nBut you're already doing that in the next commit. It might just be confusing to update the comment twice.\r\n\r\nWill review the actual change of this PR later.",
          "created_at": "2025-02-06T09:15:24Z"
        },
        {
          "user": "Sjors",
          "body": "Some historical context. The 2 hour future check used to be in `CheckBlockHeader`, but was moved in #8068 (Compact Blocks) in order to \"prevent yet more includes and the crazy-looking GetAdjustedTime call from within the GetBlock stuff.\": https://github.com/bitcoin/bitcoin/pull/8068/files#r66835690\r\n\r\n> In order to avoid checking the merkle tree twice (which is incredibly expensive), I had to call CheckBlock, which required three #includes (including main.h) to blockencodings.cpp, despite them being really unrelated.",
          "created_at": "2025-02-06T13:31:49Z"
        },
        {
          "user": "mzumsande",
          "body": "> Running with -reindex-chainstate will leave you stuck in an infinite loop revalidating an invalid tip?\r\n\r\nI wouldn't expect that. `ConnectTip()` will call `InvalidBlockFound()` which should mark the block index as failed,  and we won't revalidate / instead will stay at the last valid block - same scenario as if it failed the script checks. \r\n\r\nI can see the infinite loop happening only if a previously admitted block fails with `BLOCK_MUTATED` during connection, but mutation rules shouldn't be affected by any of the currently discussed softforks?! ",
          "created_at": "2025-02-06T15:58:00Z"
        },
        {
          "user": "ajtowns",
          "body": "> > Running with -reindex-chainstate will leave you stuck in an infinite loop revalidating an invalid tip?\r\n> \r\n> I wouldn't expect that. `ConnectTip()` will call `InvalidBlockFound()` which should mark the block index as failed, and we won't revalidate / instead will stay at the last valid block - same scenario as if it failed the script checks.\r\n> \r\n> I can see the infinite loop happening only if a previously admitted block fails with `BLOCK_MUTATED` during connection, but mutation rules shouldn't be affected by any of the currently discussed softforks?!\r\n\r\nAh, that's fair: I'm testing by mining some blocks then changing the segwit activation, so it's getting a \"CheckWitnessMalleation\" failure, because the blocks are marked as having been witness-verified.",
          "created_at": "2025-02-06T16:08:38Z"
        },
        {
          "user": "mzumsande",
          "body": "Given that this will likely make IBD a bit slower due to repeated checks, I think there should be more tangible benefits than just simpler reasoning about edge cases - or maybe it would be good to explain these edge cases a bit more to be able to judge how relevant they are.\r\n\r\nOnce we are synced to the tip, block acception and connection typically happen right after each other in `ProcessNewBlock()`, so I can only think of of rather far-fetched scenarios for the repeated checks to become relevant out of IBD:\r\nE.g. Bitcoind could be shutting down right after `AcceptBlock()` but before `ActivateBestChain()` finished, and then restart with different consensus rules under which the accepted block is invalid - this doesn't sound  very likely to happen in practice due to timing-issues - and even if did, it should resolve itself quickly when more blocks arrive and we reorg out of the invalid chain.\r\n\r\nAre there more realistic scenarios in which the double check would improve behavior compared to master?",
          "created_at": "2025-02-06T18:24:03Z"
        },
        {
          "user": "darosior",
          "body": "This becomes a bit likelier in IBD, but i agree. As i [said yesterday on IRC](https://bitcoin-irc.chaincode.com/bitcoin-core-dev/2025-02-05#1738786490-1738786524;) i am not sure this change is worth doing especially since we can never really solve the issue of a non-upgraded node having accepted invalid blocks short of re-connecting the whole chain when upgrading.",
          "created_at": "2025-02-06T18:33:44Z"
        },
        {
          "user": "darosior",
          "body": "I'll try to bug @sdaftuar, who introduced this comment, to see if we are missing something.",
          "created_at": "2025-02-06T18:34:49Z"
        },
        {
          "user": "Sjors",
          "body": "> short of re-connecting the whole chain when upgrading\r\n\r\nAs a generic method for all soft forks, it's the only way. And it's a potential pain, especially because for some reason unwinding is much slower than IBD (last time I tried). And doesn't work on a too-far-pruned node.\r\n\r\nBut for specific soft-forks there may be quicker ways. E.g. it's easy to scan the headers for timewarp violations. Checking coinbases for the new proposed BIP34 rule is only possible for non-pruned blocks, but would be quick (well, maybe not on a spinning disk without `-txindex`).\r\n\r\nThe new proposed sigops check on the other hand probably just requires an unwind. It would still be good to log a warning that we didn't retroactively check the new rule, and suggest using the RPC method to check if they want (with the caveat that it's slow and won't work on a too-far-pruned node).",
          "created_at": "2025-02-06T18:55:18Z"
        },
        {
          "user": "l0rinc",
          "body": "Given that this seemed like a change that would affect IBD, I ran a few reindex-chainstates and a few full IBDs to check for regressions.\r\nThe reindexes are usually very stable so I only ran 2 iterations of before and after, comparing a full reindex-chainstate until 880k against master.\r\n\r\n<details>\r\n<summary>reindex details</summary>\r\n\r\n```bash\r\nc59cbba518 update comment on MinimumChainWork check\r\nece9ac177d qa: sanity check ConnectBlock now checks all rules\r\n\r\nCOMMITS=\"c59cbba518fc8835b9b26040dd9974ae3cddedfa ece9ac177d701da3a4fdb548453d9d87cc4eba49\"; \\\r\nSTOP_HEIGHT=880000; DBCACHE=10000; \\\r\nC_COMPILER=gcc; CXX_COMPILER=g++; \\\r\nhyperfine \\\r\n--export-json \"/mnt/my_storage/rdx-${COMMITS/ /-}-${STOP_HEIGHT}-${DBCACHE}-${C_COMPILER}.json\" \\\r\n--runs 2 \\\r\n--parameter-list COMMIT ${COMMITS/ /,} \\\r\n--prepare \"killall bitcoind; rm -f /mnt/my_storage/BitcoinData/debug.log; git checkout {COMMIT}; git clean -fxd; git reset --hard; cmake -B build -DCMAKE_BUILD_TYPE=Release -DENABLE_WALLET=OFF -DCMAKE_C_COMPILER=$C_COMPILER -DCMAKE_CXX_COMPILER=$CXX_COMPILER && cmake --build build -j$(nproc) --target bitcoind && ./build/src/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=$STOP_HEIGHT -dbcache=10000 -printtoconsole=0 || true\" \\\r\n--cleanup \"cp /mnt/my_storage/BitcoinData/debug.log /mnt/my_storage/logs/debug-{COMMIT}-$(date +%s).log || true\" \\\r\n\"COMPILER=$C_COMPILER COMMIT={COMMIT} ./build/src/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=$STOP_HEIGHT -dbcache=$DBCACHE -printtoconsole=0 -reindex-chainstate -connect=0\"\r\n\r\nBenchmark 1: COMPILER=gcc COMMIT=c59cbba518fc8835b9b26040dd9974ae3cddedfa ./build/src/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=880000 -dbcache=10000 -printtoconsole=0 -reindex-chainstate -connect=0\r\n  Time (mean ¬± œÉ):     25451.781 s ¬± 34.971 s    [User: 38952.582 s, System: 869.341 s]\r\n  Range (min ‚Ä¶ max):   25427.053 s ‚Ä¶ 25476.510 s    2 runs\r\n\r\nBenchmark 2: COMPILER=gcc COMMIT=ece9ac177d701da3a4fdb548453d9d87cc4eba49 ./build/src/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=880000 -dbcache=10000 -printtoconsole=0 -reindex-chainstate -connect=0\r\n  Time (mean ¬± œÉ):     25707.027 s ¬± 53.363 s    [User: 39183.014 s, System: 869.561 s]\r\n  Range (min ‚Ä¶ max):   25669.293 s ‚Ä¶ 25744.760 s    2 runs\r\n\r\nSummary\r\n  COMPILER=gcc COMMIT=c59cbba518fc8835b9b26040dd9974ae3cddedfa ./build/src/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=880000 -dbcache=10000 -printtoconsole=0 -reindex-chainstate -connect=0 ran\r\n    1.01 ¬± 0.00 times faster than COMPILER=gcc COMMIT=ece9ac177d701da3a4fdb548453d9d87cc4eba49 ./build/src/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=880000 -dbcache=10000 -printtoconsole=0 -reindex-chainstate -connect=0\r\n```\r\n\r\n</details>\r\n\r\nthis results in a 1% slowdown - which is unfortunate, but I personally could live with that.\r\n\r\n-----\r\n\r\nThe full IBD however resulted in a bigger diff (which is more volatile so I ran each 3 times to get meaningful results):\r\n\r\n<details>\r\n<summary>IBD details</summary>\r\n\r\n```bash\r\nc59cbba518 update comment on MinimumChainWork check\r\nece9ac177d qa: sanity check ConnectBlock now checks all rules\r\n\r\nCOMMITS=\"c59cbba518fc8835b9b26040dd9974ae3cddedfa ece9ac177d701da3a4fdb548453d9d87cc4eba49\"; \\\r\nSTOP_HEIGHT=880000; DBCACHE=10000; \\\r\nC_COMPILER=gcc; CXX_COMPILER=g++; \\\r\nhyperfine \\\r\n--export-json \"/mnt/my_storage/ibd-${COMMITS/ /-}-${STOP_HEIGHT}-${DBCACHE}-${C_COMPILER}.json\" \\\r\n--runs 3 \\\r\n--parameter-list COMMIT ${COMMITS/ /,} \\\r\n--prepare \"killall bitcoind; rm -rf /mnt/my_storage/BitcoinData/*; git checkout {COMMIT}; git clean -fxd; git reset --hard; cmake -B build -DCMAKE_BUILD_TYPE=Release -DENABLE_WALLET=OFF -DCMAKE_C_COMPILER=$C_COMPILER -DCMAKE_CXX_COMPILER=$CXX_COMPILER && cmake --build build -j$(nproc) --target bitcoind && ./build/src/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=1 -printtoconsole=0 || true\" \\\r\n--cleanup \"cp /mnt/my_storage/BitcoinData/debug.log /mnt/my_storage/logs/debug-{COMMIT}-$(date +%s).log || true\" \\\r\n\"COMPILER=$C_COMPILER COMMIT={COMMIT} ./build/src/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=$STOP_HEIGHT -dbcache=$DBCACHE -printtoconsole=0\"\r\nBenchmark 1: COMPILER=gcc COMMIT=c59cbba518fc8835b9b26040dd9974ae3cddedfa ./build/src/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=880000 -dbcache=10000 -printtoconsole=0\r\n  Time (mean ¬± œÉ):     35311.267 s ¬± 32.492 s    [User: 58346.765 s, System: 2046.013 s]\r\n  Range (min ‚Ä¶ max):   35275.243 s ‚Ä¶ 35338.360 s    3 runs\r\n\r\nBenchmark 2: COMPILER=gcc COMMIT=ece9ac177d701da3a4fdb548453d9d87cc4eba49 ./build/src/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=880000 -dbcache=10000 -printtoconsole=0\r\n  Time (mean ¬± œÉ):     36975.379 s ¬± 964.756 s    [User: 59059.701 s, System: 2312.492 s]\r\n  Range (min ‚Ä¶ max):   36213.629 s ‚Ä¶ 38060.212 s    3 runs\r\n\r\nSummary\r\n  COMPILER=gcc COMMIT=c59cbba518fc8835b9b26040dd9974ae3cddedfa ./build/src/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=880000 -dbcache=10000 -printtoconsole=0 ran\r\n    1.05 ¬± 0.03 times faster than COMPILER=gcc COMMIT=ece9ac177d701da3a4fdb548453d9d87cc4eba49 ./build/src/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=880000 -dbcache=10000 -printtoconsole=0\r\n```\r\n\r\n</details>\r\n\r\n\r\nSo on average it's **~4.7%** slower and in the best case it was **~2.6%** slower. I'm measuring the same again on a different server in reverse order to make sure this is representative, but this is a significant slowdown that I'd like us to eliminate - let me know how I can help, but until we do, it's an Approach NACK from my part.",
          "created_at": "2025-02-12T13:07:36Z"
        },
        {
          "user": "darosior",
          "body": "Thanks, it's helpful to have numbers. I don't think a 3-4% IBD slowdown should necessarily be a deal breaker, but as discussed above i do not think this change is useful enough to be worth it.",
          "created_at": "2025-02-12T14:40:12Z"
        },
        {
          "user": "darosior",
          "body": "> I'll try to bug `@`sdaftuar, who introduced this comment, to see if we are missing something.\r\n\r\nHad a quick chat about this with Suhas and a couple others at Chaincode. My takeaway from the discussion is that if we wanted this we should probably go all the way to actually re-validate past connected blocks that were not fully validated, not only those received but not yet connected. Also there is no reason to see this comment as a blocker to introduce new consensus rules (depending on the nature of the rule of course) when we have historically never supported this edge case.",
          "created_at": "2025-02-12T14:46:14Z"
        },
        {
          "user": "darosior",
          "body": "I'll have a look at whether it's worth storing flags representing what rules have been checked against a block in the index, to enable re-validating past connected blocks against new rules when upgrading. In the meantime, this can be closed as i do not think it is worth doing on its own.",
          "created_at": "2025-02-12T14:48:31Z"
        }
      ]
    },
    {
      "number": 31790,
      "title": ".",
      "body": "### Changes\n\n1. **File:** `/test/lint/README.md`\n    - Fixed `LIEF` to `LEAF, LIFE` (Line 48)\n1. **File:** `/doc/build-osx.md`\n    - Fixed `useable` to `usable` (Line 74)\n1. **File:** `/doc/psbt.md`\n    - Fixed `Asend` to `Ascend, As end` (Line 137)\n\n### Purpose\n\n- Enhanced the clarity and professionalism of the documentation.\n- Fixed minor grammatical issues for better understanding.",
      "state": "closed",
      "user": "petryshkaCODE",
      "created_at": "2025-02-03T18:45:28Z",
      "updated_at": "2025-02-03T18:56:31Z",
      "comments": 1,
      "url": "https://github.com/bitcoin/bitcoin/pull/31790",
      "labels": [],
      "comment_list": [
        {
          "user": "DrahtBot",
          "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/31790.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\nA summary of reviews will appear here.\n",
          "created_at": "2025-02-03T18:45:32Z"
        }
      ]
    },
    {
      "number": 31789,
      "title": ".",
      "body": "### Changes\n\n1. **File:** `/test/lint/README.md`\n    - Fixed `lief` to `leaf, life` (Line 48)\n1. **File:** `/contrib/guix/INSTALL.md`\n    - Fixed `debbugs` to `debugs, bedbugs` (Line 761)\n1. **File:** `/doc/psbt.md`\n    - Fixed `Asend` to `Ascend, As end` (Line 132)\n1. **File:** `/doc/tracing.md`\n    - Fixed `stap` to `step, stop` (Line 379)\n\n### Purpose\n\n- Improved documentation accuracy by fixing typographical errors.\n- Ensured better readability and consistency.",
      "state": "closed",
      "user": "Hack666r",
      "created_at": "2025-02-03T18:45:12Z",
      "updated_at": "2025-02-03T18:55:15Z",
      "comments": 1,
      "url": "https://github.com/bitcoin/bitcoin/pull/31789",
      "labels": [],
      "comment_list": [
        {
          "user": "DrahtBot",
          "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/31789.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\nA summary of reviews will appear here.\n",
          "created_at": "2025-02-03T18:45:16Z"
        }
      ]
    },
    {
      "number": 31788,
      "title": ".",
      "body": "### Changes\n\n1. **File:** `/contrib/guix/INSTALL.md`\n    - Fixed `debbugs` to `debugs, bedbugs` (Line 761)\n1. **File:** `/doc/psbt.md`\n    - Fixed `Asend` to `Ascend, As end` (Line 129)\n1. **File:** `/doc/tracing.md`\n    - Fixed `stap` to `step, stop` (Line 378)\n\n### Purpose\n\n- EImproved the documentation's clarity and professional tone.\n- Corrected small grammatical errors to enhance comprehension.",
      "state": "closed",
      "user": "MonkeyKing44",
      "created_at": "2025-02-03T18:02:36Z",
      "updated_at": "2025-02-03T18:57:18Z",
      "comments": 1,
      "url": "https://github.com/bitcoin/bitcoin/pull/31788",
      "labels": [],
      "comment_list": [
        {
          "user": "DrahtBot",
          "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/31788.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\nA summary of reviews will appear here.\n",
          "created_at": "2025-02-03T18:02:40Z"
        }
      ]
    },
    {
      "number": 31787,
      "title": "ci: run in worktrees",
      "body": "Fixes: #30028\r\n\r\n- Run CI in worktrees by mounting the .git root target into the container\r\n- Run the linter in worktrees by mounting the .git root target into the container\r\n\r\nAFAIK mounting the git root should not present any additional security issues, as this would already be mounted (in RO mode) when not using a worktree.",
      "state": "closed",
      "user": "willcl-ark",
      "created_at": "2025-02-03T16:11:03Z",
      "updated_at": "2025-06-17T18:32:39Z",
      "comments": 9,
      "url": "https://github.com/bitcoin/bitcoin/pull/31787",
      "labels": [
        "Tests",
        "Needs rebase"
      ],
      "comment_list": [
        {
          "user": "DrahtBot",
          "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/31787.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\nA summary of reviews will appear here.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#31948](https://github.com/bitcoin/bitcoin/pull/31948) (ci: [lint] Use Cirrus dockerfile cache by maflcko)\n* [#31349](https://github.com/bitcoin/bitcoin/pull/31349) (ci: detect outbound internet traffic generated while running tests by vasild)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
          "created_at": "2025-02-03T16:11:06Z"
        },
        {
          "user": "fanquake",
          "body": "Is this still meant to be a draft?",
          "created_at": "2025-02-20T19:16:50Z"
        },
        {
          "user": "maflcko",
          "body": "For reference, I can't review this, because I don't know if all the bash refactors/behavior changes here are correct and best practise, or if they could fail (and when) on error or on ancient versions of bash used in macOS. ",
          "created_at": "2025-02-20T19:28:10Z"
        },
        {
          "user": "DrahtBot",
          "body": "<!--cf906140f33d8803c4a75a2196329ecb-->\nüêô This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
          "created_at": "2025-03-18T05:05:31Z"
        },
        {
          "user": "willcl-ark",
          "body": "@maflcko thinking more on this after the merge of #31948 my opinion is that we should close this PR, the associated issue (#30028), and, if any action should be take it would be to document that linting in a worktree is possible by running the linter outside of a container? e.g.:\r\n\r\n```bash\r\n# install required python dependencies\r\nbash -c '( cd ./test/lint/test_runner/ && cargo fmt && cargo clippy && RUST_BACKTRACE=1 cargo run )'\r\n```\r\n\r\nThis change feels like it adds a lot of complexity, for little benefit (and I can't think of a simpler way to achieve the functionality desired).\r\n\r\nWhat do you think?",
          "created_at": "2025-03-19T10:45:52Z"
        },
        {
          "user": "maflcko",
          "body": "For the lint task, the docker wrapper is nice, because it takes care of installing all the exact versions: https://github.com/bitcoin/bitcoin/blob/e568c1dd134e0318c46113cb7dfc23b40e2829e8/ci/lint/04_install.sh#L49-L65\r\n\r\nHowever, given the limited feedback, I wonder if anyone cares about running the linters in a worktree.\r\n\r\nFor the \"real\" CI tasks, at least on person complained on IRC IIRC, so at least there seems to be some demand.",
          "created_at": "2025-03-19T16:34:50Z"
        },
        {
          "user": "DrahtBot",
          "body": "<!--13523179cfe9479db18ec6c5d236f789-->\n‚åõ There hasn't been much activity lately and the patch still needs rebase. What is the status here?\n\n* Is it still relevant? ‚û°Ô∏è Please solve the conflicts to make it ready for review and to ensure the CI passes.\n* Is it no longer relevant? ‚û°Ô∏è Please close.\n* Did the author lose interest or time to work on this? ‚û°Ô∏è Please close it and mark it 'Up for grabs' with the label, so that it can be picked up in the future.\n",
          "created_at": "2025-06-16T00:04:20Z"
        },
        {
          "user": "willcl-ark",
          "body": "Closing due to lack of interest.",
          "created_at": "2025-06-16T08:36:44Z"
        },
        {
          "user": "maflcko",
          "body": "Looks like this was closed, so I opened a trivial line-neutral +4-4 fix in https://github.com/bitcoin/bitcoin/pull/32767\r\n\r\n(Missing lint and tidy support, but this can be done in a follow-up, if needed)",
          "created_at": "2025-06-17T18:32:39Z"
        }
      ]
    },
    {
      "number": 31785,
      "title": "Have createNewBlock() wait for tip, make rpc handle shutdown during long poll and wait methods",
      "body": "This PR prevents Mining interface methods from sometimes crashing when called during startup before a tip is connected. It also makes other improvements like making more RPC methods usable from the GUI. Specifically this PR:\r\n\r\n- Adds an `Assume` check to disallow passing negative timeout values to `Mining::waitTipChanged`\r\n- Makes `waitfornewblock`, `waitforblock` and `waitforblockheight` RPC methods usable from the GUI when `-server=1` is not set.\r\n- Changes `Mining::waitTipChanged` to return `optional<BlockRef>` instead of `BlockRef` and return `nullopt` instead of crashing if there is a timeout or if the node is shut down before a tip is connected.\r\n- Changes `Mining::waitTipChanged` to not time out before a tip is connected, so it is convenient and safe to call during startup, and only returns `nullopt` on early shutdowns.\r\n- Changes `Mining::createNewBlock` to block and wait for a tip to be connected if it is called on startup instead of crashing. Also documents that it will return null on early shutdowns.\r\n\r\nThis allows `waitNext()` (added in https://github.com/bitcoin/bitcoin/pull/31283) to safely assume `TipBlock()` isn't `null`, not even during a scenario of early shutdown.\r\n\r\nFinally this PR clarifies long poll behaviour, mostly by adding code comments, but also through an early `break`.",
      "state": "closed",
      "user": "Sjors",
      "created_at": "2025-02-03T14:56:59Z",
      "updated_at": "2025-04-14T21:40:20Z",
      "comments": 28,
      "url": "https://github.com/bitcoin/bitcoin/pull/31785",
      "labels": []
    },
    {
      "number": 31784,
      "title": "test: added additional coverage to waitforblock and waitforblockheight rpc's",
      "body": "Similar to https://github.com/bitcoin/bitcoin/pull/31746\r\n\r\nThis adds test coverage to the `waitforblock` and `waitforblockheight` rpc's by adding a test to assert we get an rpc error if we include a negative timeout",
      "state": "closed",
      "user": "kevkevinpal",
      "created_at": "2025-02-03T14:11:37Z",
      "updated_at": "2025-02-05T10:38:06Z",
      "comments": 2,
      "url": "https://github.com/bitcoin/bitcoin/pull/31784",
      "labels": [
        "Tests"
      ],
      "comment_list": [
        {
          "user": "DrahtBot",
          "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/31784.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [Prabhat1308](https://github.com/bitcoin/bitcoin/pull/31784#pullrequestreview-2591018801), [Sjors](https://github.com/bitcoin/bitcoin/pull/31784#issuecomment-2633729812), [brunoerg](https://github.com/bitcoin/bitcoin/pull/31784#pullrequestreview-2593526316), [BrandonOdiwuor](https://github.com/bitcoin/bitcoin/pull/31784#pullrequestreview-2594718854) |\n\nIf your review is incorrectly listed, please react with üëé to this comment and the bot will ignore it on the next update.\n",
          "created_at": "2025-02-03T14:11:40Z"
        },
        {
          "user": "Sjors",
          "body": "utACK 7e0db87d4fff996c086f6e86b62338c98ef30c55",
          "created_at": "2025-02-04T12:15:05Z"
        }
      ]
    }
  ],
  "issues": [
    {
      "number": 31791,
      "title": ".",
      "body": "### Is there an existing issue for this?\n\n- [x] I have searched the existing issues\n\n### Current behaviour\n\nstatic void RescanWallet(CWallet& wallet, const WalletRescanReserver& reserver, int64_t time_begin = TIMESTAMP_MIN, bool update = true)\n{\n    int64_t scanned_time = wallet.RescanFromTime(time_begin, reserver, update);\n    if (wallet.IsAbortingRescan()) {\n        throw JSONRPCError(RPC_MISC_ERROR, \"Rescan aborted by user.\");\n    } else if (scanned_time > time_begin) {\n        throw JSONRPCError(RPC_WALLET_ERROR, \"Rescan was unable to fully rescan the blockchain. Some transactions may be missing.\");\n    }\n}\n\n### Expected behaviour\n\nstatic void RescanWallet(CWallet& wallet, const WalletRescanReserver& reserver, int64_t time_begin = TIMESTAMP_MIN, bool update = true)\n{\n    if (!reserver.isReserved()) {\n        throw JSONRPCError(RPC_WALLET_ERROR, \"Rescan reservation failed. Wallet is currently rescanning or reservation was not acquired.\");\n    }\n    int64_t scanned_time = wallet.RescanFromTime(time_begin, reserver, update);\n    if (wallet.IsAbortingRescan()) {\n        throw JSONRPCError(RPC_MISC_ERROR, \"Rescan aborted by user.\");\n    } else if (scanned_time > time_begin) {\n        throw JSONRPCError(RPC_WALLET_ERROR, \"Rescan was unable to fully rescan the blockchain. Some transactions may be missing.\");\n    }\n}\n\n### Steps to reproduce\n\nNone\n\n### Relevant log output\n\nNone\n\n### How did you obtain Bitcoin Core\n\nCompiled from source\n\n### What version of Bitcoin Core are you using?\n\nCurrent\n\n### Operating system and version\n\nUbuntu 22.04\n\n### Machine specifications\n\nnone",
      "state": "closed",
      "user": "BartzZin",
      "created_at": "2025-02-03T20:03:21Z",
      "updated_at": "2025-02-05T13:29:16Z",
      "comments": 2,
      "url": "https://github.com/bitcoin/bitcoin/issues/31791",
      "labels": [],
      "comment_list": [
        {
          "user": "pinheadmz",
          "body": "@BartzZin Can you please rewrite the \"current behavior\" and \"expected behavior\" fields in your issue in English so we can understand what you are experiencing? Otherwise this issue may be closed as off-topic.",
          "created_at": "2025-02-03T20:51:04Z"
        },
        {
          "user": "maflcko",
          "body": "ai slop",
          "created_at": "2025-02-04T07:39:55Z"
        }
      ]
    }
  ],
  "summary": {
    "pull_requests": 7,
    "issues": 1
  }
}