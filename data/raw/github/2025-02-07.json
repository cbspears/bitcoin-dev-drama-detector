{
  "source": "github",
  "repository": "bitcoin/bitcoin",
  "fetched_at": "2026-01-15T19:15:37.889614+00:00",
  "date": "2025-02-07",
  "pull_requests": [
    {
      "number": 31823,
      "title": "tests: Add witness commitment if we have a witness transaction in `FullBlockTest.update_block()`",
      "body": "This is useful for test cases where we want to test logic invalid blocks that contain witness transactions. If we don't add the witness commitment as per [BIP141](https://github.com/bitcoin/bips/blob/master/bip-0141.mediawiki#user-content-Commitment_structure), blocks will be rejected with the error [`Block mutated`](https://github.com/bitcoin/bitcoin/blob/fb0ada982a73687520c43b8fde480fa5d456f3e1/src/validation.cpp#L4180).\r\n\r\nThis change was needed in https://github.com/ajtowns/bitcoin/pull/13 which is a soft fork proposal to disallow 64 byte transactions. We want to test that 64 byte transactions serialized without the witness are invalid. If we do not have this change, we cannot directly test the logic that rejects 64 byte transactions.\r\n\r\nI decided to PR this upstream as many soft fork proposals may not see the light of day, but this functionality seems strictly additive to the test framework.",
      "state": "closed",
      "user": "Christewart",
      "created_at": "2025-02-07T18:05:39Z",
      "updated_at": "2025-12-09T16:11:22Z",
      "comments": 9,
      "url": "https://github.com/bitcoin/bitcoin/pull/31823",
      "labels": [
        "Tests"
      ],
      "comment_list": [
        {
          "user": "DrahtBot",
          "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/31823.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [theStack](https://github.com/bitcoin/bitcoin/pull/31823#pullrequestreview-3467369575), [sedited](https://github.com/bitcoin/bitcoin/pull/31823#pullrequestreview-3471932363), [glozow](https://github.com/bitcoin/bitcoin/pull/31823#pullrequestreview-3558321172) |\n| Stale ACK | [kevkevinpal](https://github.com/bitcoin/bitcoin/pull/31823#issuecomment-3348355115) |\n\nIf your review is incorrectly listed, please copy-paste <code>&lt;!--meta-tag:bot-skip--&gt;</code> into the comment that the bot should ignore.\n<!--5faf32d7da4f0f540f40219e4f7537a3-->",
          "created_at": "2025-02-07T18:05:43Z"
        },
        {
          "user": "Christewart",
          "body": "\r\n> 1. Is there any test case that can be covered in the current implementation that needs this change to be implemented?\r\n\r\nThere is not currently. This short coming in the test framework was discovered while working on test cases for disallowing 64 byte transactions in the bitcoin blockchain. This python test case would not fail correctly if this change wasn't added to the test framework: https://github.com/ajtowns/bitcoin/pull/13/files#diff-d390e9e12bfa34a462fdff9f1894d7dc3edb45c26cf55df486d92864a3052fafR139\r\n\r\n>     2. Wouldn't it be better to create a new test file like `feature_<soft_fork>.py` to test the consensus changes made in a new soft fork, following the convention(`feature_segwit`,`feature_taproot`,etc)?\r\n\r\nThis PR is not proposing a soft fork. This PR makes the `update_block` function [BIP141](https://github.com/bitcoin/bips/blob/master/bip-0141.mediawiki#user-content-Commitment_structure) compliant. \r\n\r\n> Also, why disallow 64 byte transactions?\r\n\r\nHere are some resources on why 64 byte transactions are problematic.\r\n\r\n- https://github.com/Christewart/bips/blob/2024-12-20-64bytetxs/bip-XXXX.mediawiki\r\n- https://bitslog.com/2018/06/09/leaf-node-weakness-in-bitcoin-merkle-tree-design/\r\n- https://delvingbitcoin.org/t/great-consensus-cleanup-revival/710/41?u=chris_stewart_5\r\n- https://github.com/Christewart/bips/blob/2024-12-20-64bytetxs/bip-XXXX/2-BitcoinMerkle.pdf\r\n\r\n",
          "created_at": "2025-02-09T18:15:57Z"
        },
        {
          "user": "kevkevinpal",
          "body": "ACK 6109bc529e234b464d406495bb9644254ca7fc9e",
          "created_at": "2025-02-27T17:36:03Z"
        },
        {
          "user": "kevkevinpal",
          "body": "The CI failure looks unrelated to your change",
          "created_at": "2025-02-27T17:44:56Z"
        },
        {
          "user": "Christewart",
          "body": "> The CI failure looks unrelated to your change\r\n\r\nMaybe the gods (AKA bitcoin core maintainers üëº üìø ) will restart the build for me :pray: üòÑ ",
          "created_at": "2025-02-27T18:08:02Z"
        },
        {
          "user": "kevkevinpal",
          "body": "reACK [9ab4e3f](https://github.com/bitcoin/bitcoin/pull/31823/commits/9ab4e3fe7e24b02faa48265f49eea0dc059436c9)",
          "created_at": "2025-04-11T21:49:28Z"
        },
        {
          "user": "kevkevinpal",
          "body": "reACK [43c2613](https://github.com/bitcoin/bitcoin/pull/31823/commits/43c2613305697255d294d9dd02f1cd19246913c9)",
          "created_at": "2025-09-29T18:13:20Z"
        },
        {
          "user": "theStack",
          "body": "Concept ACK, happy to re-review after rebase",
          "created_at": "2025-11-13T15:00:01Z"
        },
        {
          "user": "Christewart",
          "body": "I think this is good for merge? ",
          "created_at": "2025-11-19T21:07:33Z"
        }
      ]
    },
    {
      "number": 31822,
      "title": "fixing-link-Update dependencies.md",
      "body": "old link :\r\nhttps://www.oracle.com/technetwork/database/database-technologies/berkeleydb/downloads/index.html\r\n\r\nnew link :\r\nhttps://www.oracle.com/database/technologies/related/berkeleydb-downloads.html\r\n\r\nhope it was helpful\r\n",
      "state": "closed",
      "user": "dedyshkaPexto",
      "created_at": "2025-02-07T17:13:42Z",
      "updated_at": "2025-02-08T15:26:35Z",
      "comments": 4,
      "url": "https://github.com/bitcoin/bitcoin/pull/31822",
      "labels": [],
      "comment_list": [
        {
          "user": "DrahtBot",
          "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/31822.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\nA summary of reviews will appear here.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#31634](https://github.com/bitcoin/bitcoin/pull/31634) (doc: Improve dependencies documentation by NicolaLS)\n* [#28710](https://github.com/bitcoin/bitcoin/pull/28710) (Remove the legacy wallet and BDB dependency by achow101)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
          "created_at": "2025-02-07T17:13:45Z"
        },
        {
          "user": "l0rinc",
          "body": "The old link successfully redirects me to the new one, what's the purpose of changing it?",
          "created_at": "2025-02-07T18:26:16Z"
        },
        {
          "user": "dedyshkaPexto",
          "body": "> The old link successfully redirects me to the new one, what's the purpose of changing it?\r\n\r\nview of the new link. The old one also still redirects.",
          "created_at": "2025-02-07T18:41:01Z"
        },
        {
          "user": "maflcko",
          "body": "I wouldn't mind the change and would be happy to review it, but given the two conflicts https://github.com/bitcoin/bitcoin/pull/31822#issuecomment-2643522687 (one which also rewords the file, and another one which removes BDB and the line changed in this pull request anyway), I'll be closing this for now. Thanks.",
          "created_at": "2025-02-08T15:26:35Z"
        }
      ]
    },
    {
      "number": 31820,
      "title": "build: consistently use `CLIENT_NAME` in libbitcoinkernel.pc.in",
      "body": "Follows up from when the `pc.in` was added.",
      "state": "closed",
      "user": "fanquake",
      "created_at": "2025-02-07T16:15:46Z",
      "updated_at": "2025-02-10T10:01:00Z",
      "comments": 2,
      "url": "https://github.com/bitcoin/bitcoin/pull/31820",
      "labels": [
        "Build system"
      ],
      "comment_list": [
        {
          "user": "DrahtBot",
          "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/31820.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [stickies-v](https://github.com/bitcoin/bitcoin/pull/31820#pullrequestreview-2602342964), [theuni](https://github.com/bitcoin/bitcoin/pull/31820#pullrequestreview-2602359582), [hebasto](https://github.com/bitcoin/bitcoin/pull/31820#pullrequestreview-2602880373), [davidgumberg](https://github.com/bitcoin/bitcoin/pull/31820#issuecomment-2644549805) |\n| Concept ACK | [luke-jr](https://github.com/bitcoin/bitcoin/pull/31820#pullrequestreview-2603255184) |\n\nIf your review is incorrectly listed, please react with üëé to this comment and the bot will ignore it on the next update.\n",
          "created_at": "2025-02-07T16:15:50Z"
        },
        {
          "user": "davidgumberg",
          "body": "utACK https://github.com/bitcoin/bitcoin/pull/31820/commits/f5b9a2f68c95182b139e8a3447b4b5888ecb4f9f",
          "created_at": "2025-02-08T06:53:44Z"
        }
      ]
    },
    {
      "number": 31819,
      "title": "doc: swap CPPFLAGS for APPEND_CPPFLAGS",
      "body": "`APPEND_CPPFLAGS` will be understood by our CMake, whereas `CPPFLAGS` will not. Attempting what is currently documented will just give:\r\n```bash\r\nCMake Warning:\r\n  Ignoring extra path from command line:\r\n\r\n   \"CPPFLAGS=-DDEBUG_LOCKCONTENTION\"\r\n```",
      "state": "closed",
      "user": "fanquake",
      "created_at": "2025-02-07T16:09:50Z",
      "updated_at": "2025-02-10T14:56:26Z",
      "comments": 7,
      "url": "https://github.com/bitcoin/bitcoin/pull/31819",
      "labels": [
        "Docs"
      ],
      "comment_list": [
        {
          "user": "DrahtBot",
          "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/31819.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [hebasto](https://github.com/bitcoin/bitcoin/pull/31819#pullrequestreview-2602176228), [fjahr](https://github.com/bitcoin/bitcoin/pull/31819#issuecomment-2645930017) |\n\nIf your review is incorrectly listed, please react with üëé to this comment and the bot will ignore it on the next update.\n",
          "created_at": "2025-02-07T16:09:53Z"
        },
        {
          "user": "purpleKarrot",
          "body": "Where can I read about the decision to chose `CPPFLAGS` and `APPEND_CPPFLAGS`? I think those names are unfortunate and may cause confusion with cmake's default handling of the `CXXFLAGS` environment variable.",
          "created_at": "2025-02-07T17:08:39Z"
        },
        {
          "user": "theuni",
          "body": "@purpleKarrot It's an artifact of a few things:\r\n- The migration from autotools to CMake. autotools made CPPFLAGS a first-class citizen whereas CMake expects users to just pass them in as CXXFLAGS.  `APPEND_CPPFLAGS` could probably be rolled into `APPEND_CXXFLAGS`, we just maintain the split because it can be a helpful distinction.\r\n- In many cases `CXXFLAGS` or `CMAKE_CXX_FLAGS` or `CMAKE_CXX_FLAGS_BUILDTYPE` will work, but not always. CMake provides no way to _append_ CXXFLAGS, only to prepend or replace. This is really annoying. Mostly because setting things where position matters (like `-Ofoo` or `-UBAR -DBAR=2`) is impossible with the built-in vars. Hence our `APPEND` variables.",
          "created_at": "2025-02-07T18:03:35Z"
        },
        {
          "user": "purpleKarrot",
          "body": "> CMake provides no way to append `CXXFLAGS`, ...\r\n\r\nNot sure I understand. On the first run, CMake initializes `CMAKE_CXX_FLAGS` by prepending `CMAKE_CXX_FLAGS_INIT` with the environment variable `CXXFLAGS`. See: https://cmake.org/cmake/help/latest/variable/CMAKE_LANG_FLAGS_INIT.html\r\n\r\nIn other words, `CMAKE_CXX_FLAGS_INIT`  is appended to `CXXFLAGS`. But you say it provides no way to append to `CXXFLAGS`?",
          "created_at": "2025-02-07T18:26:38Z"
        },
        {
          "user": "theuni",
          "body": "I didn't mean CXXFLAGS the env var, I meant CXXFLAGS the concept (as-in, what ultimately gets passed to the compiler). There are just some things that either we set internally or that CMake sets that are impossible for the user to override without affecting something else (by using a None build type for example).`-Ox` is one of them. \r\n\r\nSo we provide these vars with guaranteed append semantics.",
          "created_at": "2025-02-07T18:36:19Z"
        },
        {
          "user": "theuni",
          "body": "Btw, if your argument is \"`CXXFLAGS=-DDEBUG_LOCKCONTENTION` would work for the sake of this PR\", I agree with you there.",
          "created_at": "2025-02-07T18:38:35Z"
        },
        {
          "user": "fjahr",
          "body": "ACK ea687d202934ee9aa26912cda21993da219cd418\r\n\r\nJust used `APPEND_CPPFLAGS` yesterday for some debugging, so it works :)",
          "created_at": "2025-02-08T20:28:11Z"
        }
      ]
    },
    {
      "number": 31818,
      "title": "guix: remove test-security/symbol-check scripts",
      "body": "These scripts are becoming more of nuisance, than a value-add; particularly since we've been building releases using Guix. Adding new (release bin) tests can be harder, because it requires constructing a failing test, which is becoming less easy, e.g trying to disable a feature or protection that has been built into the compiler/toolchain by default.\r\n\r\nIn the pre-Guix days, these were valuable to sanity-check the environment, because we were pulling that pre-built from Ubuntu, with little control. At this point, it's less clear what these scripts are (sanity) checking.\r\n\r\nNote that these also weren't completely ported to CMake (#31698), see also #31715 which contains other fixes that would be needed for these test-tests, to accomodate future changes.",
      "state": "closed",
      "user": "fanquake",
      "created_at": "2025-02-07T15:57:54Z",
      "updated_at": "2025-02-12T08:48:07Z",
      "comments": 3,
      "url": "https://github.com/bitcoin/bitcoin/pull/31818",
      "labels": [
        "Build system"
      ],
      "comment_list": [
        {
          "user": "DrahtBot",
          "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/31818.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [hebasto](https://github.com/bitcoin/bitcoin/pull/31818#pullrequestreview-2605659512), [theuni](https://github.com/bitcoin/bitcoin/pull/31818#pullrequestreview-2609339794) |\n\nIf your review is incorrectly listed, please react with üëé to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#31375](https://github.com/bitcoin/bitcoin/pull/31375) (multiprocess: Add bitcoin wrapper executable by ryanofsky)\n* [#31233](https://github.com/bitcoin/bitcoin/pull/31233) (cmake: Improve robustness and usability by hebasto)\n* [#25573](https://github.com/bitcoin/bitcoin/pull/25573) ([POC] guix: produce a fully `-static-pie` bitcoind by fanquake)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
          "created_at": "2025-02-07T15:57:58Z"
        },
        {
          "user": "hebasto",
          "body": "> In the pre-Guix days, these were valuable to sanity-check the environment, because we were pulling that pre-built from Ubuntu, with little control. At this point, it's less clear what these scripts are (sanity) checking.\r\n\r\nConcept ACK.",
          "created_at": "2025-02-08T09:49:17Z"
        },
        {
          "user": "fanquake",
          "body": "Guix Build:\r\n```bash\r\n4756d1c55efefe2dd3429d93060555617bb00709772a3c13638aab8c8dd9af2c  guix-build-76c090145e9b/output/aarch64-linux-gnu/SHA256SUMS.part\r\nf9fe3c2cb751060366eae0070a1c91897ac49c74bfc53baafca65cb17413ce7e  guix-build-76c090145e9b/output/aarch64-linux-gnu/bitcoin-76c090145e9b-aarch64-linux-gnu-debug.tar.gz\r\n6532576a94838e11f8aa98b037f116af32b71eb6f446f67ffc451207b442fd36  guix-build-76c090145e9b/output/aarch64-linux-gnu/bitcoin-76c090145e9b-aarch64-linux-gnu.tar.gz\r\n7ed8370d29955a041662726611b1abb30b04d801423ea01384c1dead672babbc  guix-build-76c090145e9b/output/arm-linux-gnueabihf/SHA256SUMS.part\r\n05b9cb483ce1a9a6f9afcc1e6c118f083c6d80ef433c98546e5e8b3999f30ba5  guix-build-76c090145e9b/output/arm-linux-gnueabihf/bitcoin-76c090145e9b-arm-linux-gnueabihf-debug.tar.gz\r\n14100353e83fdd2a11c97e1698a40ce922749e6bf7408a3355cbbdd8a77d8da3  guix-build-76c090145e9b/output/arm-linux-gnueabihf/bitcoin-76c090145e9b-arm-linux-gnueabihf.tar.gz\r\ncef111a5974a021ac289ab3baa4396eb3fac98bba9f35cb39c1aab15958dce07  guix-build-76c090145e9b/output/arm64-apple-darwin/SHA256SUMS.part\r\n161d392e1b912aedec2aaede226e467f52ef16f34cb81f35b5fee7f819c97853  guix-build-76c090145e9b/output/arm64-apple-darwin/bitcoin-76c090145e9b-arm64-apple-darwin-unsigned.tar.gz\r\n14e3da7a5f5ad1638bf76ca74ef9e2152a94a01eb9dffca5874a3ddd4d31d516  guix-build-76c090145e9b/output/arm64-apple-darwin/bitcoin-76c090145e9b-arm64-apple-darwin-unsigned.zip\r\nff1e39a9197fddf841cad699e02c4e24f7e6c0b4be45e8cda4671cfc6b14c33e  guix-build-76c090145e9b/output/arm64-apple-darwin/bitcoin-76c090145e9b-arm64-apple-darwin.tar.gz\r\n50e9bf5d0c2bba3d7f6c64d59acad0fe58c923ec642e243c7e54e271ab2917c4  guix-build-76c090145e9b/output/dist-archive/bitcoin-76c090145e9b.tar.gz\r\ne7bc473f2f96773ab6d735de0c1bc9602031e48b39b4737d9468302d291b2f42  guix-build-76c090145e9b/output/powerpc64-linux-gnu/SHA256SUMS.part\r\n023e557e2194f95c2b3ff086075509f88795c0dacf8506977840ef0c82755a79  guix-build-76c090145e9b/output/powerpc64-linux-gnu/bitcoin-76c090145e9b-powerpc64-linux-gnu-debug.tar.gz\r\nd0b31c8c28354c1a483dce53ba62e944d1be0fbca8affe22c64f967b8ffeabbc  guix-build-76c090145e9b/output/powerpc64-linux-gnu/bitcoin-76c090145e9b-powerpc64-linux-gnu.tar.gz\r\n83b965eeb5439cc342ed0516743ded9535ced3e06e10c885ab7b927fc1e7a477  guix-build-76c090145e9b/output/riscv64-linux-gnu/SHA256SUMS.part\r\n4245a858ba84132dfb739d2a561f022cc34b82072223946e38beba30fdd1276b  guix-build-76c090145e9b/output/riscv64-linux-gnu/bitcoin-76c090145e9b-riscv64-linux-gnu-debug.tar.gz\r\n67bce1c84bc34e614f0229f65d2bdc8bd4bbdf56b544feab2ed9599e8590445c  guix-build-76c090145e9b/output/riscv64-linux-gnu/bitcoin-76c090145e9b-riscv64-linux-gnu.tar.gz\r\ne003f73f82f43bd17f900d7a21c79eed93d9be0a05159e52c6313cc02e88bc7d  guix-build-76c090145e9b/output/x86_64-apple-darwin/SHA256SUMS.part\r\nd8cf117c0898741ce54e6071c72140d0b79f0fe3597634b906682a8b047082f1  guix-build-76c090145e9b/output/x86_64-apple-darwin/bitcoin-76c090145e9b-x86_64-apple-darwin-unsigned.tar.gz\r\n62f3b5b6d5998d2f15a5033dd4bac7599fe4856ecc8a4add2ca72e43e965a9d3  guix-build-76c090145e9b/output/x86_64-apple-darwin/bitcoin-76c090145e9b-x86_64-apple-darwin-unsigned.zip\r\n9122d98568a8adf6f9e858abbf33583753ae755f50cefe8304c03fab4e209e47  guix-build-76c090145e9b/output/x86_64-apple-darwin/bitcoin-76c090145e9b-x86_64-apple-darwin.tar.gz\r\ne2bf85dceb5c9dd011c591622de8522d8f2d77fdc6d43f9d1b22e5be424e9111  guix-build-76c090145e9b/output/x86_64-linux-gnu/SHA256SUMS.part\r\nf25aee6fd65608f462a4b04c30d6bb1bbca8a6d1b049e2cb097af61d260f36c6  guix-build-76c090145e9b/output/x86_64-linux-gnu/bitcoin-76c090145e9b-x86_64-linux-gnu-debug.tar.gz\r\n5b0aa62d9491a31ba680508f5643ae4ccdfa307e761a2301fafd9e6fc026e51a  guix-build-76c090145e9b/output/x86_64-linux-gnu/bitcoin-76c090145e9b-x86_64-linux-gnu.tar.gz\r\n01b1fc7b38d2fefbefe759cbdaff9eb867f14d7096317b0260c8d4fc0a36d8f4  guix-build-76c090145e9b/output/x86_64-w64-mingw32/SHA256SUMS.part\r\n0f1ac6fc5689f0301574dcc7fab292e56ad78b71b9e69804195ec383d10c71c6  guix-build-76c090145e9b/output/x86_64-w64-mingw32/bitcoin-76c090145e9b-win64-debug.zip\r\n93d745a62df3e1c9adde3e94e97573b52ab0254da509740ff3a5b4b45418632e  guix-build-76c090145e9b/output/x86_64-w64-mingw32/bitcoin-76c090145e9b-win64-setup-unsigned.exe\r\n232992d3704e484f24f91d519bea388759237662aa5b5f2415dd2c534270aab3  guix-build-76c090145e9b/output/x86_64-w64-mingw32/bitcoin-76c090145e9b-win64-unsigned.tar.gz\r\n9f792ab8b9182e769f65fd70111ae7d57ca719bd2440f6e3b80554bb2c57a91c  guix-build-76c090145e9b/output/x86_64-w64-mingw32/bitcoin-76c090145e9b-win64.zip\r\n```",
          "created_at": "2025-02-11T09:46:22Z"
        }
      ]
    },
    {
      "number": 31815,
      "title": "multiprocess: Lock CapnpProtocol::m_loop with mutex",
      "body": "This change is intended to fix intermittent failures in `ipc_tests` unit test and `rpc_misc.py` functional tests that happen on mac os, which sometimes fail with error `terminating due to uncaught exception of type std::__1::system_error: mutex lock failed: Invalid argument` as reported https://github.com/chaincodelabs/libmultiprocess/issues/154\r\n\r\nThis error could happen when [`m_loop.reset();`](https://github.com/bitcoin/bitcoin/blob/81eb6cc2c609b2fb3af53a53749e6162fecb34e2/src/ipc/capnp/protocol.cpp#L92) in `CapnpProtocol::startLoop` executes before the [`m_loop->removeClient(lock);`](https://github.com/bitcoin/bitcoin/blob/81eb6cc2c609b2fb3af53a53749e6162fecb34e2/src/ipc/capnp/protocol.cpp#L46) method returns in the `~CapnpProtocol` destructor , causing an failure to reacquire the `EventLoop::m_mutex` inside the [`EventLoop::removeClient`](https://github.com/chaincodelabs/libmultiprocess/blob/9558ceb0d47ac1f62f88d29ec55f8f3099e32b20/src/mp/proxy.cpp#L240-L251) method, and the [\"mutex lock failed\"](https://github.com/llvm/llvm-project/blob/f5c4f271abe757ae49ca97475b7b77de56d24f69/libcxx/src/mutex.cpp#L31) exception to be thrown.\r\n\r\nFix this error by adding a new mutex to guard the `CapnpProtocol::m_loop` variable and making sure [`m_loop.reset();`](https://github.com/bitcoin/bitcoin/blob/81eb6cc2c609b2fb3af53a53749e6162fecb34e2/src/ipc/capnp/protocol.cpp#L92) cannot be called until after [`m_loop->removeClient(lock);`](https://github.com/bitcoin/bitcoin/blob/81eb6cc2c609b2fb3af53a53749e6162fecb34e2/src/ipc/capnp/protocol.cpp#L46) returns.\r\n\r\n---\r\n\r\nThis PR is part of the [process separation project](https://github.com/bitcoin/bitcoin/issues/28722).",
      "state": "closed",
      "user": "ryanofsky",
      "created_at": "2025-02-07T11:55:35Z",
      "updated_at": "2025-02-10T08:28:23Z",
      "comments": 5,
      "url": "https://github.com/bitcoin/bitcoin/pull/31815",
      "labels": [
        "interfaces"
      ],
      "comment_list": [
        {
          "user": "DrahtBot",
          "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/31815.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\nA summary of reviews will appear here.\n",
          "created_at": "2025-02-07T11:55:39Z"
        },
        {
          "user": "ryanofsky",
          "body": "So far as of baea320be01eb68ff7ba47d0ca0e00b64366a880 it seems like this change does not solve the problem it was supposed to fix. \r\n\r\nThere is a new \"libc++abi: terminating due to uncaught exception of type std::__1::system_error: mutex lock failed: Invalid argument\" failure https://github.com/bitcoin/bitcoin/actions/runs/13206947916/job/36872233303?pr=30975#step:7:2433 in 553a7e2f66649590864604ed187bf5bf2e796297 which includes a cherry-picked version of this fix.\r\n",
          "created_at": "2025-02-07T20:16:59Z"
        },
        {
          "user": "Sjors",
          "body": "This might have a bug somewhere, in #30975:\r\n\r\n```\r\ntest/ipc_tests.cpp:11: Entering test suite \"ipc_tests\"\r\ntest/ipc_tests.cpp:12: Entering test case \"ipc_tests\"\r\nlibc++abi: terminating due to uncaught exception of type std::__1::system_error: mutex lock failed: Invalid argument\r\n2025-02-07T19:59:17.387846Z [unknown] [test/util/random.cpp:48] [SeedRandomStateForTest] Setting random seed for current tests to RANDOM_CTX_SEED=32db8d22914609b5d53f87f6947ca780fea50790b141c9ccc134e7a13f971121\r\n2025-02-07T19:59:17.388318Z [test] [init/common.cpp:153] [LogPackageVersion] Bitcoin Core version v28.99.0-553a7e2f6664-dirty (release build)\r\n2025-02-07T19:59:17.388468Z [test] [kernel/context.cpp:20] [operator()] Using the 'arm_shani(1way,2way)' SHA256 implementation\r\n2025-02-07T19:59:17.397870Z [test] [test/ipc_test.cpp:60] [operator()] LOG0: {IpcPipeTest-24701/b-test-58682} IPC client first request from current thread, constructing waiter\r\n2025-02-07T19:59:17.398037Z [unknown] [test/ipc_test.cpp:60] [operator()] LOG0: {IpcPipeTest-24701/b-test-58682} IPC client send FooInterface.add$Params (a = 1, b = 2)\r\n2025-02-07T19:59:17.398114Z [unknown] [test/ipc_test.cpp:60] [operator()] LOG0: {IpcPipeTest-24701/58689} IPC server recv request  #1 FooInterface.add$Params (a = 1, b = 2)\r\n2025-02-07T19:59:17.398144Z [unknown] [test/ipc_test.cpp:60] [operator()] LOG0: {IpcPipeTest-24701/58689} IPC server send response #1 FooInterface.add$Results (result = 3)\r\n2025-02-07T19:59:17.398166Z [unknown] [test/ipc_test.cpp:60] [operator()] LOG0: {IpcPipeTest-24701/b-test-58682} IPC client recv FooInterface.add$Results (result = 3)\r\n2025-02-07T19:59:17.398206Z [unknown] [test/ipc_test.cpp:60] [operator()] LOG0: {IpcPipeTest-24701/b-test-58682} IPC client send FooInterface.passOutPoint$Params (arg = \"d\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\310\\\\000\\\\000\\\\000\")\r\n2025-02-07T19:59:17.398231Z [unknown] [test/ipc_test.cpp:60] [operator()] LOG0: {IpcPipeTest-24701/58689} IPC server recv request  #2 FooInterface.passOutPoint$Params (arg = \"d\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\310\\\\000\\\\000\\\\000\")\r\n2025-02-07T19:59:17.398244Z [unknown] [test/ipc_test.cpp:60] [operator()] LOG0: {IpcPipeTest-24701/58689} IPC server send response #2 FooInterface.passOutPoint$Results (result = \"d\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\310\\\\000\\\\000\\\\000\")\r\n2025-02-07T19:59:17.398262Z [unknown] [test/ipc_test.cpp:60] [operator()] LOG0: {IpcPipeTest-24701/b-test-58682} IPC client recv FooInterface.passOutPoint$Results (result = \"d\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\310\\\\000\\\\000\\\\000\")\r\n2025-02-07T19:59:17.398306Z [unknown] [test/ipc_test.cpp:60] [operator()] LOG0: {IpcPipeTest-24701/b-test-58682} IPC client send FooInterface.passUniValue$Params (arg = \"{\\\\\"i\\\\\":1,\\\\\"s\\\\\":\\\\\"two\\\\\"}\")\r\n2025-02-07T19:59:17.398324Z [unknown] [test/ipc_test.cpp:60] [operator()] LOG0: {IpcPipeTest-24701/58689} IPC server recv request  #3 FooInterface.passUniValue$Params (arg = \"{\\\\\"i\\\\\":1,\\\\\"s\\\\\":\\\\\"two\\\\\"}\")\r\n2025-02-07T19:59:17.398338Z [unknown] [test/ipc_test.cpp:60] [operator()] LOG0: {IpcPipeTest-24701/58689} IPC server send response #3 FooInterface.passUniValue$Results (result = \"{\\\\\"i\\\\\":1,\\\\\"s\\\\\":\\\\\"two\\\\\"}\")\r\n2025-02-07T19:59:17.398354Z [unknown] [test/ipc_test.cpp:60] [operator()] LOG0: {IpcPipeTest-24701/b-test-58682} IPC client recv FooInterface.passUniValue$Results (result = \"{\\\\\"i\\\\\":1,\\\\\"s\\\\\":\\\\\"two\\\\\"}\")\r\n2025-02-07T19:59:17.398384Z [unknown] [test/ipc_test.cpp:60] [operator()] LOG0: {IpcPipeTest-24701/b-test-58682} IPC client send FooInterface.passTransaction$Params (arg = \"\\\\002\\\\000\\\\000\\\\000\\\\001d\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\310\\\\000\\\\000\\\\000\\\\000\\\\377\\\\377\\\\377\\\\377\\\\001\\\\000\\\\341\\\\365\\\\005\\\\000\\\\000\\\\000\\\\000\\\\000\\\\003\\\\000\\\\000\\\\000\")\r\n2025-02-07T19:59:17.398404Z [unknown] [test/ipc_test.cpp:60] [operator()] LOG0: {IpcPipeTest-24701/58689} IPC server recv request  #4 FooInterface.passTransaction$Params (arg = \"\\\\002\\\\000\\\\000\\\\000\\\\001d\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\310\\\\000\\\\000\\\\000\\\\000\\\\377\\\\377\\\\377\\\\377\\\\001\\\\000\\\\341\\\\365\\\\005\\\\000\\\\000\\\\000\\\\000\\\\000\\\\003\\\\000\\\\000\\\\000\")\r\n2025-02-07T19:59:17.398448Z [unknown] [test/ipc_test.cpp:60] [operator()] LOG0: {IpcPipeTest-24701/58689} IPC server send response #4 FooInterface.passTransaction$Results (result = \"\\\\002\\\\000\\\\000\\\\000\\\\001d\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\310\\\\000\\\\000\\\\000\\\\000\\\\377\\\\377\\\\377\\\\377\\\\001\\\\000\\\\341\\\\365\\\\005\\\\000\\\\000\\\\000\\\\000\\\\000\\\\003\\\\000\\\\000\\\\000\")\r\n2025-02-07T19:59:17.398467Z [unknown] [test/ipc_test.cpp:60] [operator()] LOG0: {IpcPipeTest-24701/b-test-58682} IPC client recv FooInterface.passTransaction$Results (result = \"\\\\002\\\\000\\\\000\\\\000\\\\001d\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\310\\\\000\\\\000\\\\000\\\\000\\\\377\\\\377\\\\377\\\\377\\\\001\\\\000\\\\341\\\\365\\\\005\\\\000\\\\000\\\\000\\\\000\\\\000\\\\003\\\\000\\\\000\\\\000\")\r\n2025-02-07T19:59:17.398501Z [unknown] [test/ipc_test.cpp:60] [operator()] LOG0: {IpcPipeTest-24701/b-test-58682} IPC client send FooInterface.passVectorChar$Params (arg = \"Hello\")\r\n2025-02-07T19:59:17.398516Z [unknown] [test/ipc_test.cpp:60] [operator()] LOG0: {IpcPipeTest-24701/58689} IPC server recv request  #5 FooInterface.passVectorChar$Params (arg = \"Hello\")\r\n2025-02-07T19:59:17.398525Z [unknown] [test/ipc_test.cpp:60] [operator()] LOG0: {IpcPipeTest-24701/58689} IPC server send response #5 FooInterface.passVectorChar$Results (result = \"Hello\")\r\n2025-02-07T19:59:17.398538Z [unknown] [test/ipc_test.cpp:60] [operator()] LOG0: {IpcPipeTest-24701/b-test-58682} IPC client recv FooInterface.passVectorChar$Results (result = \"Hello\")\r\n2025-02-07T19:59:17.398663Z [unknown] [test/ipc_test.cpp:60] [operator()] LOG0: {IpcPipeTest-24701/b-test-58682} IPC client send FooInterface.passBlockState$Params (arg = (mode = 1, result = 8, rejectReason = \"reject reason\", debugMessage = \"debug message\"))\r\n2025-02-07T19:59:17.398704Z [unknown] [test/ipc_test.cpp:60] [operator()] LOG0: {IpcPipeTest-24701/58689} IPC server recv request  #6 FooInterface.passBlockState$Params (arg = (mode = 1, result = 8, rejectReason = \"reject reason\", debugMessage = \"debug message\"))\r\n2025-02-07T19:59:17.398725Z [unknown] [test/ipc_test.cpp:60] [operator()] LOG0: {IpcPipeTest-24701/58689} IPC server send response #6 FooInterface.passBlockState$Results (result = (mode = 1, result = 8, rejectReason = \"reject reason\", debugMessage = \"debug message\"))\r\n2025-02-07T19:59:17.398749Z [unknown] [test/ipc_test.cpp:60] [operator()] LOG0: {IpcPipeTest-24701/b-test-58682} IPC client recv FooInterface.passBlockState$Results (result = (mode = 1, result = 8, rejectReason = \"reject reason\", debugMessage = \"debug message\"))\r\n2025-02-07T19:59:17.398772Z [unknown] [test/ipc_test.cpp:60] [operator()] LOG0: {IpcPipeTest-24701/b-test-58682} IPC client send FooInterface.passBlockState$Params (arg = (mode = 0, result = 0, rejectReason = \"\", debugMessage = \"\"))\r\n2025-02-07T19:59:17.398790Z [unknown] [test/ipc_test.cpp:60] [operator()] LOG0: {IpcPipeTest-24701/58689} IPC server recv request  #7 FooInterface.passBlockState$Params (arg = (mode = 0, result = 0, rejectReason = \"\", debugMessage = \"\"))\r\n2025-02-07T19:59:17.398801Z [unknown] [test/ipc_test.cpp:60] [operator()] LOG0: {IpcPipeTest-24701/58689} IPC server send response #7 FooInterface.passBlockState$Results (result = (mode = 0, result = 0, rejectReason = \"\", debugMessage = \"\"))\r\n2025-02-07T19:59:17.398819Z [unknown] [test/ipc_test.cpp:60] [operator()] LOG0: {IpcPipeTest-24701/b-test-58682} IPC client recv FooInterface.passBlockState$Results (result = (mode = 0, result = 0, rejectReason = \"\", debugMessage = \"\"))\r\n2025-02-07T19:59:17.398843Z [unknown] [test/ipc_test.cpp:60] [operator()] LOG0: {IpcPipeTest-24701/b-test-58682} IPC client send FooInterface.passScript$Params (arg = \"[\")\r\n2025-02-07T19:59:17.398858Z [unknown] [test/ipc_test.cpp:60] [operator()] LOG0: {IpcPipeTest-24701/58689} IPC server recv request  #8 FooInterface.passScript$Params (arg = \"[\")\r\n2025-02-07T19:59:17.398868Z [unknown] [test/ipc_test.cpp:60] [operator()] LOG0: {IpcPipeTest-24701/58689} IPC server send response #8 FooInterface.passScript$Results (result = \"[\")\r\n2025-02-07T19:59:17.398883Z [unknown] [test/ipc_test.cpp:60] [operator()] LOG0: {IpcPipeTest-24701/b-test-58682} IPC client recv FooInterface.passScript$Results (result = \"[\")\r\n2025-02-07T19:59:17.399029Z [unknown] [test/ipc_test.cpp:60] [operator()] LOG0: {IpcPipeTest-24701/58689} IPC server destroy N2mp11ProxyServerIN3gen12FooInterfaceEEE\r\n2025-02-07T19:59:17.399089Z [unknown] [test/ipc_test.cpp:60] [operator()] LOG0: {IpcPipeTest-24701/58689} EventLoop::loop done, cancelling event listeners.\r\n2025-02-07T19:59:17.399098Z [unknown] [test/ipc_test.cpp:60] [operator()] LOG0: {IpcPipeTest-24701/58689} EventLoop::loop bye.\r\n```\r\n\r\nhttps://github.com/bitcoin/bitcoin/actions/runs/13206947916/job/36872233303?pr=30975",
          "created_at": "2025-02-07T20:17:27Z"
        },
        {
          "user": "ryanofsky",
          "body": "I reproduced the bug locally (see https://github.com/chaincodelabs/libmultiprocess/issues/154#issuecomment-2646926155) and implemented a different fix in https://github.com/chaincodelabs/libmultiprocess/pull/159, which should make these changes unnecessary, because instead of trying to delay eventloop destruction in Bitcoin code until all locks are released, it just avoids reacquiring a lock unnecessary and pretents eventloop::loop() from returning until all locks are released so it won't be destroyed. Will close this PR since these changes only incompletely fixed the bug and should no longer be needed.",
          "created_at": "2025-02-10T05:07:14Z"
        },
        {
          "user": "Sjors",
          "body": "Thanks. I dropped this from #30975 and rebased on your latest #31741 which contains https://github.com/chaincodelabs/libmultiprocess/pull/159.",
          "created_at": "2025-02-10T08:28:22Z"
        }
      ]
    }
  ],
  "issues": [
    {
      "number": 31824,
      "title": "wallet: wrong balance and crash after reorg and unclean shutdown",
      "body": "The wallet can show a wrong balance¬†and/or hit an assert crash in case of a unclean shutdown after a reorg:\n\nInitial state: Wallet and Node are synced to disk (e.g. a Flush just happened), the coinbase of the tip is a wallet tx.\n1.) Tip is disconnected due to a reorg. This will change the status of affected wallet txns to Inactive (which will be synced with the wallet db immediately) - but neither the chainstate nor the wallet locator will be flushed.\n2.) The node has an unclean shutdown for an unrelated reason (e.g. power goes off). \n3.) The node restarts: The node will be back at the original tip, the wallet locator too (so no rescan is triggered), but the wallet tx state is Inactive (and abandoned for coinbase txns) \n4.) The node reorgs once more to the better chain, and then the assert crash happens.\n\nSee https://github.com/mzumsande/bitcoin/commit/c6b201d1a3cb6cf8b8a3dd0390c48b894c617a82 for a functional test that reproduces the above events.\n\n\nThere are two problems:\n- The wallet will hit an assert if it has a wallet coinbase tx, and the block in question is disconnected again - this should be fixed by #31757\n- The wallet balance is wrong - this also affects non-coinbase txns. This is worse if the the tip disconnect from step 4) does **not** happen again (maybe the initial chain was extended while the node was offline) because then the transactions from the block will be missing indefinitely until the user performs a manual rescan.\n\nI think the root of the problems is that changes to the wallet db are synced immediately, but the best block locator isn't. The solution could be #30221 - but even there, one would have to be very careful with the order of operations. Ideally, the `SyncTransaction()` updates and locator updates due to block connection / disconnection should be done atomically, in one batch, if possible.\n\nFYI @furszy @achow101¬†@ryanofsky\n\n\n",
      "state": "closed",
      "user": "mzumsande",
      "created_at": "2025-02-07T19:13:02Z",
      "updated_at": "2025-05-19T19:51:00Z",
      "comments": 5,
      "url": "https://github.com/bitcoin/bitcoin/issues/31824",
      "labels": [
        "Wallet"
      ],
      "comment_list": [
        {
          "user": "furszy",
          "body": "Nice finding! Cool functional test. Glad to see #31757 fixing the crash.\n\n> Ideally, the SyncTransaction() updates and locator updates due to block connection / disconnection should be done atomically, in one batch, if possible.\n\nI actually implemented this in #25297, three years ago :). Will see how much work is needed to revive it next week.",
          "created_at": "2025-02-07T19:45:22Z"
        },
        {
          "user": "ryanofsky",
          "body": "> I actually implemented this in [#25297](https://github.com/bitcoin/bitcoin/pull/25297), three years ago :). Will see how much work is needed to revive it next week.\n\n@furszy since I mentioned it the other day, this is a link to the [`PtrOrValue`](https://github.com/ryanofsky/libmultiprocess/blob/ce4814f46d3c38d0bdd08df2253bc69b084f22ee/include/mp/util.h#L136-L148) utility I used in libmultiprocess to allow functions to lock internally or optionally accept an external lock, without requiring two versions of each function.\n\nA similar mechanism could be used for wallet methods to allow them to use an external batch object or create one internally if not provided, e.g.\n\n```c++\nResult UpdateSomething(WalletBatch* optional_batch, Params params)\n{\n    PtrOrValue batch{optional_batch, GetDataBase()};\n    batch->Write(params...);\n   ...\n}\n```\n\nThe `batch` variable there is a wrapper around `std::variant<WalletBatch*, WalletBatch>` that is set to the `optional_batch` pointer if it was non-null, or to a newly constructed `WalletBatch` object if it was null. It has `*`  and `->` operators giving access to whatever it was set to.\n\nThis might not be applicable to #25297, but in general an approach like this could allow more functions to accept and use batches, incrementally, without needing big code changes.\n",
          "created_at": "2025-02-11T15:53:45Z"
        },
        {
          "user": "rkrux",
          "body": "> I think the root of the problems is that changes to the wallet db are synced immediately, but the best block locator isn't.\n\nIs this not where the chainstate related changes are flushed to disk? https://github.com/bitcoin/bitcoin/blob/28.x/src/validation.cpp#L3069\n\nAnd here block disconnected notification fired that is listened to by the wallet: https://github.com/bitcoin/bitcoin/blob/28.x/src/validation.cpp#L3087",
          "created_at": "2025-02-19T13:53:12Z"
        },
        {
          "user": "mzumsande",
          "body": "> Is this not where the chainstate related changes are flushed to disk?\n> https://github.com/bitcoin/bitcoin/blob/28.x/src/validation.cpp#L3069\n\nThe call uses `FlushStateMode::IF_NEEDED`, which means it usually won't do anything - it will only flush if it's necessary because the cache has grown to a critical size.",
          "created_at": "2025-02-19T15:36:48Z"
        },
        {
          "user": "fanquake",
          "body": "Marking this as closed-by #30221 given the comments there.",
          "created_at": "2025-03-05T11:36:10Z"
        }
      ]
    },
    {
      "number": 31817,
      "title": "GetRandBytes() Hangs on Samsung Galaxy S25 and OnePlus 13",
      "body": "### Is there an existing issue for this?\n\n- [x] I have searched the existing issues\n\n### Current behaviour\n\nWe have been using Bitcoin Core natively in the Nunchuk Bitcoin wallet, available on both desktop and mobile. On Samsung Galaxy S25 and OnePlus 13 (both running Android 15 with the SM8750-AB Snapdragon 8 Elite 3nm processor), the app fails to initialize due to an issue in `GetRandBytes()`.\n\nThe problem occurs when `GetRandBytes()` calls `GetRNDRRS()`, resulting in an infinite loop without retrieving entropy from the hardware.\n\n```\nuint64_t GetRNDRRS() noexcept\n{\n    uint8_t ok;\n    uint64_t r1;\n    do {\n        // https://developer.arm.com/documentation/ddi0601/2022-12/AArch64-Registers/RNDRRS--Reseeded-Random-Number\n        __asm__ volatile(\"mrs %0, s3_3_c2_c4_1; cset %w1, ne;\"\n                         : \"=r\"(r1), \"=r\"(ok)::\"cc\");\n        if (ok) break;\n        __asm__ volatile(\"yield\");\n    } while (true);\n    return r1;\n}\n```\n\nBuild with: Android NDK 25.1.8937393 & 27.2.12479018\n\nRelated PR: https://github.com/bitcoin/bitcoin/pull/26839\n\nTested on commit: `57b47c47ef0bd36e1c32d709c62998c51dc76f34`\n\n### Expected behaviour\n\n`GetRandBytes()` should return entropy without hanging.\n\n### Steps to reproduce\n\n- Build Bitcoin Core for Android on master or 57b47c47ef0bd36e1c32d709c62998c51dc76f34\n- Call `GetRandBytes`\n- Function gets stuck\n\n### Relevant log output\n\n_No response_\n\n### How did you obtain Bitcoin Core\n\nCompiled from source\n\n### What version of Bitcoin Core are you using?\n\nmaster@57b47c47ef0bd36e1c32d709c62998c51dc76f34\n\n### Operating system and version\n\nAndroid 15\n\n### Machine specifications\n\n_No response_",
      "state": "closed",
      "user": "giahuy98",
      "created_at": "2025-02-07T13:56:42Z",
      "updated_at": "2025-04-16T18:57:22Z",
      "comments": 16,
      "url": "https://github.com/bitcoin/bitcoin/issues/31817",
      "labels": [
        "Build system",
        "Upstream",
        "Utils/log/libs",
        "Android"
      ],
      "comment_list": [
        {
          "user": "eval-exec",
          "body": "I have Samsung Galaxy S23 Ultra:\n\n![Image](https://github.com/user-attachments/assets/26d0c0cd-54fd-45fd-9f15-82ad34c3e52b)\n\n![Image](https://github.com/user-attachments/assets/c5c9c148-9f05-4023-8253-f94a10699f91)",
          "created_at": "2025-02-08T11:57:03Z"
        },
        {
          "user": "laanwj",
          "body": "> Build with: Android NDK 25.1.8937393 & 27.2.12479018\n\nWe've had some problems building on android (including NDK 25, see #29360), and are curious how you do the builds for that platform, for testing, can you list more specific build instructions please?",
          "created_at": "2025-02-13T22:25:47Z"
        },
        {
          "user": "hugohn",
          "body": "Hey @laanwj ! Our Nunchuk Android app is open source at https://github.com/nunchuk-io/nunchuk-android. You can take a look at the build instructions included in the repo. Let us know if you have any questions!",
          "created_at": "2025-02-13T22:37:35Z"
        },
        {
          "user": "laanwj",
          "body": "Thanks! i'd looked there but couldn't find anything that compiles Bitcoin Core, or any C++ code for that matter.",
          "created_at": "2025-02-13T23:04:00Z"
        },
        {
          "user": "hugohn",
          "body": "You need to first compile the SDK, which is a wrapper for libnunchuk (written in C++ and reuses Core code). @laanwj \n\nhttps://github.com/nunchuk-io/nunchuk-android-nativesdk",
          "created_at": "2025-02-13T23:33:25Z"
        },
        {
          "user": "glozow",
          "body": "Has not been fixed since #31908 reverted #31826, but also out of scope - see https://github.com/bitcoin/bitcoin/pull/31908#issuecomment-2669309907.  I believe this should stay closed.",
          "created_at": "2025-02-19T18:44:06Z"
        },
        {
          "user": "hugohn",
          "body": "This should be re-opened as per latest discussion in https://github.com/bitcoin/bitcoin/pull/31908 @glozow \n\nTL;DR: Either test and merge the updated fix (https://github.com/bitcoin/bitcoin/pull/31912), or revert the RNDR/RNDRRS feature entirely.",
          "created_at": "2025-04-10T07:16:25Z"
        },
        {
          "user": "maflcko",
          "body": "> TL;DR: Either test and merge the updated fix ([#31912](https://github.com/bitcoin/bitcoin/pull/31912)), or revert the RNDR/RNDRRS feature entirely.\n\n31912 is currently a draft, so before further review and testing (and merge), it would be good to get something non-draft ready first.",
          "created_at": "2025-04-10T08:39:11Z"
        },
        {
          "user": "laanwj",
          "body": "Reflecting on this after a while, i'm still not convinced that a hardware feature not working to spec needs to be handled in user space. IMO this needs to be fixed (or worked around otherwise) in the kernel, as per https://github.com/bitcoin/bitcoin/pull/31908#issuecomment-2669309907.\n\nEdit: If you can point ot another project (such as OpenSSL) merging code to handle this edge case i'd be more easily convinced we need this.",
          "created_at": "2025-04-10T11:06:04Z"
        },
        {
          "user": "glozow",
          "body": "> This should be re-opened as per latest discussion in https://github.com/bitcoin/bitcoin/pull/31908 @glozow \n\nI don't see any recent discussion on that thread? I'm not trying to die on this hill or say this problem isn't bad, but there are 414 issues open and imo we should only keep the ones that fall within the scope of what this project supports.",
          "created_at": "2025-04-10T15:07:10Z"
        },
        {
          "user": "hugohn",
          "body": "@laanwj Reposting my earlier comment here:\n\n‚ÄúI think one could argue that the fix should be made both in the kernel and in Core.\n\nThe design of GetRandBytes() and GetStrongRandBytes() is about being robust and sourcing entropy from multiple sources, so that even if one or some of those sources fail, Core can still obtain sufficiently good entropy. There could be multiple reasons hardware entropy fails to return lower down in the stack.‚Äù\n\nSince NOT getting entropy from RNDR/RNDRRS is not a dealbreaker, Core shouldn‚Äôt freeze if the RNDR/RNDRRS stack fails for any reason (hardware or otherwise), and there should exist a sensible timeout. The question is about the robustness of the feature design itself.",
          "created_at": "2025-04-11T00:11:56Z"
        },
        {
          "user": "sipa",
          "body": "@hugohn The reason it was reverted wasn't because the patch didn't work - it could have been fixed instead. It was reverted because merging it broke the build for more platforms than ones suffering just this issue, and this went undetected by all processes we have in place (both manual review and CI infrastructure). It's one thing to accept a patch to improve compatibility with an unsupported platform if it doesn't affect others, but this event clearly showed we weren't equipped to properly assess that. My view is that we shouldn't try to fix this again until/unless there is infrastructure in place that would help us detect build failures like this going forward.",
          "created_at": "2025-04-11T00:22:29Z"
        },
        {
          "user": "hugohn",
          "body": "@sipa What would it take to add the CI infrastructure needed? From @maflcko's comments it sounds like it‚Äôs possible?\n\nIn the meantime, given that RNDR/RNDRRS is only supported on a small subset of hardware, it might be prudent to temporarily revert the feature until CI support or hardware adoption is more robust. This would align with a conservative approach.",
          "created_at": "2025-04-11T02:38:34Z"
        },
        {
          "user": "maflcko",
          "body": "The discussion is a bit spread out, but when I looked in https://github.com/bitcoin/bitcoin/pull/31908#issuecomment-2687917758, the feature wasn't compiled into the release binaries. This raises two questions:\n\n* Why? My understanding is that the kernel headers in guix should provide the `HWCAP2_RNG` macro?\n* What is the target audience? Currently it only seems to be self-compiled executables.\n\nAbout the CI: It is possible, but testing compilation or the path on a \"happy\" device doesn't help with the issue here on \"sad\" devices. See https://github.com/bitcoin/bitcoin/pull/31908#issuecomment-2676190482",
          "created_at": "2025-04-11T05:41:40Z"
        },
        {
          "user": "laanwj",
          "body": "Agree, let's just drop the support for now, it's rarely supported (broken on like half of the chips that support it in the first place), apparently not compiled into the release binary anyway, hard to test, and there are plenty of other sources of entropy. \n\nIt's not worth so much discussion, or CI work.",
          "created_at": "2025-04-11T06:06:45Z"
        }
      ]
    },
    {
      "number": 31816,
      "title": "Memory-only wallet (for faucets)",
      "body": "### Please describe the feature you'd like to see added.\n\nCurrently I do following regularly every couple of days in order to refresh faucet wallets and reclaim megabytes of disk space:\n\n```sh\ncd ~/.bitcoin/signet/wallets\nbitcoin-cli -signet createwallet name false true\n# blank with private-keys enabled\ncd name\ndt=../listdescriptors-true.txt\nA=$(sed 's/\"timestamp\".*$/\"timestamp\":\"now\",/' $dt | jq -rc .descriptors)\nbitcoin-cli importdescriptors $A\n```\n\nIt works well for [me](https://alt.signetfaucet.com/) (in connection with another `readlink` [hack](https://www.catb.org/jargon/html/) allowing me to use symlinks for wallet entry path) but I am wondering about a feature, a new option to `createwallet` RPC that would create a wallet which does not keep track of spent transacrions, only what is now in blocks (chainstate) and mempool.\n\n### Is your feature related to a problem, if so please describe it.\n\nWhen writing a faucet I first realized there is no point in playing privacy here since the amount of wallet data tracking all the new addresses (incl. random new \"change\" addresses) can grow huge and soon make the faucet unusable.\n\n### Describe the solution you'd like\n\nI would like `wallet.dat` sqlite in this mode to not track the historical transactions other thatn confirmed unspent ones, everything else would stay as normal wallet with or without private keys.\n\n### Describe any alternatives you've considered\n\nBefore I was doing also `scantxoutset` without any wallet. It actually provided me with unspent outputs that were confirmed in blocks and then I could just `signrawtransactionwithkey`. But using a wallet has many advantages, I just imagine this new memory-only (\"light mode\") would be helpful.\n\n### Please leave any additional context\n\nCurrently there are following HTTP-served faucets I know of:\n\nIgnoring the dying Testnet3 now.\n\nOn Signet:\n\n- https://signetfaucet.com/\n- https://alt.signetfaucet.com/\n\nOn [Testnet4](https://testnet4.com/):\n\n- https://mempool.space/testnet4/faucet\n- https://coinfaucet.eu/en/btc-testnet4/\n- https://testnet4.anyone.eu.org/ \\*\n- https://faucet.testnet4.dev/\n\n\\* Testnet4 faucet on anyone.eu.org is generally the same as alt.signetfaucet.com but not kept in a lockstep so it does not do Cloudflare Turnstile or TRUC replacements yet.",
      "state": "closed",
      "user": "jsarenik",
      "created_at": "2025-02-07T12:21:31Z",
      "updated_at": "2025-02-18T13:09:52Z",
      "comments": 4,
      "url": "https://github.com/bitcoin/bitcoin/issues/31816",
      "labels": [
        "Feature",
        "Wallet"
      ],
      "comment_list": [
        {
          "user": "maflcko",
          "body": "> Before I was doing also `scantxoutset` without any wallet. It actually provided me with unspent outputs that were confirmed in blocks and then I could just `signrawtransactionwithkey`. But using a wallet has many advantages\n\nThis would have been my suggestion as a workaround. Is there something that would be missing? I haven't tried, but `removeprunedfunds` could be another alternative to reduce the wallet file size?",
          "created_at": "2025-02-13T07:32:07Z"
        },
        {
          "user": "jsarenik",
          "body": "@maflcko thanks for the idea with  `removeprunedfunds` but I just tried it and it did not change the size of the dat file even after removing almost all of the already-mined transactions (the list I got from listtransactions RPC with some postprocessing).\n\nI think the database file would need to be vacuumed.",
          "created_at": "2025-02-13T14:55:35Z"
        },
        {
          "user": "jsarenik",
          "body": "Yes, @maflcko , it works well, I just need to unload the wallet, `echo 'VACUUM;' | sqlite3 wallet.dat` and load it back.\n\nI think the feature suggestion in this issue still makes sense though.",
          "created_at": "2025-02-13T15:04:58Z"
        },
        {
          "user": "jsarenik",
          "body": "@maflcko just for the record, the current wallet of alt.signetfaucet.com is running in Linux' `tmpfs` (i.e. in RAM) and is being atomically refreshed by `cron` every hour. No leftovers. Actually I think there is no need for the proposed feature.\n\nThank you! I like Bitcoin Core!",
          "created_at": "2025-02-18T13:08:49Z"
        }
      ]
    }
  ],
  "summary": {
    "pull_requests": 6,
    "issues": 3
  }
}