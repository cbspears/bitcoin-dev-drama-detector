{
  "source": "github",
  "repository": "bitcoin/bitcoin",
  "fetched_at": "2026-01-15T20:35:28.559827+00:00",
  "date": "2025-11-28",
  "pull_requests": [
    {
      "number": 33966,
      "title": "refactor: disentangle miner startup defaults from runtime options",
      "body": "The interaction between node startup options like `-blockreservedweight` and runtime options, especially those passed via IPC, is confusing.\r\n\r\nThey're combined in `BlockAssembler::Options`, which this PR gets rid of in favour of two distinct structs:\r\n\r\n1. `BlockCreateOptions`: used by interface clients. As before, IPC clients have access to a safe / sane subset, whereas RPC and test code can use all fields.\r\n2. `MiningArgs`: these are set once during node startup\r\n\r\nBoth structs have a member for the maximum block height, which is not a problem since they're different structs. The one on `MiningArgs` (`block_max_weight`) matches `-maxblockheight` and is left alone. The one on `BlockCreateOptions` (`block_max_weight`) is an optional, it's set by `ApplyMiningDefaults` only if empty. \r\n\r\nThis all happens in the last commit and requires some preparation to keep things easy to review.\r\n\r\nWe get rid of `BlockAssembler::Options` but this is used in many tests. Since large churn is inevitable, we might as well switch all tests, bench and fuzzers over to the Mining interface. The first (non-base) commit does that, dramatically reducing direct use of `BlockAssembler`. Two exceptions are documented in the commit message. Because `test_block_validity` wasn't available via the interface and the block_assemble benchmark needs it, it's moved from `BlockAssembler::Options` to `BlockCreateOptions` (still not exposed via IPC).\r\n\r\nWe need access to mining related defaults and structs from both the miner and node initialization code. To avoid having to pull in all of `BlockAssembler` for the latter, the second commit introduces `node/mining.h` and moves constants and structs there from `src/node/types.h` (`BlockCreateOptions`, `BlockWaitOptions`, `BlockCheckOptions`) and `src/node/miner.h` (`DEFAULT_PRINT_MODIFIED_FEE`).\r\n\r\nI considered also moving `DEFAULT_BLOCK_MAX_WEIGHT`, `DEFAULT_BLOCK_RESERVED_WEIGHT`, `MINIMUM_BLOCK_RESERVED_WEIGHT` and `DEFAULT_BLOCK_MIN_TX_FEE` there from `policy.h`, since they are distinct from relay policy and not needed by the kernel. But this seems more appropriate for a follow-up and requires additional discussion.\r\n\r\nThe meat and potatoes of this PR is split between the three last commits for easier review:\r\n\r\n1. Adds `node/mining_args.{h,cpp}` and move the options checking out of `init.cpp`, without adding storage\r\n2. Add `block_max_weight` to `BlockCreateOptions` as explained above\r\n3. Introduce the `MiningArgs` struct, add it to the `NodeContext`, expand `mining_args.cpp` to store it, pass it to `BlockAssembler`, etc.\r\n\r\nI kept variable renaming and other formatting changes to a minimum to ease review with `--color-moved=dimmed-zebra`.\r\n\r\nThis PR builds on the bug fix in:\r\n- [ ] #33965\r\n\r\nOnce that is merged, this PR should not change behaviour.",
      "state": "open",
      "user": "Sjors",
      "created_at": "2025-11-28T15:42:31Z",
      "updated_at": "2026-01-14T11:17:27Z",
      "comments": 8,
      "url": "https://github.com/bitcoin/bitcoin/pull/33966",
      "labels": [
        "Refactoring"
      ],
      "comment_list": [
        {
          "user": "DrahtBot",
          "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/33966.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Concept ACK | [ryanofsky](https://github.com/bitcoin/bitcoin/pull/33966#issuecomment-3598781679) |\n\nIf your review is incorrectly listed, please copy-paste <code>&lt;!--meta-tag:bot-skip--&gt;</code> into the comment that the bot should ignore.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#34184](https://github.com/bitcoin/bitcoin/pull/34184) (mining: add cooldown to createNewBlock() immediately after IBD by Sjors)\n* [#33965](https://github.com/bitcoin/bitcoin/pull/33965) (mining: fix -blockreservedweight shadows IPC option by Sjors)\n* [#33936](https://github.com/bitcoin/bitcoin/pull/33936) (mining: pass missing context to createNewBlock() and checkBlock() by Sjors)\n* [#33922](https://github.com/bitcoin/bitcoin/pull/33922) (mining: add getMemoryLoad() and track template non-mempool memory footprint by Sjors)\n* [#33819](https://github.com/bitcoin/bitcoin/pull/33819) (mining: getCoinbase() returns struct instead of raw tx by Sjors)\n* [#33795](https://github.com/bitcoin/bitcoin/pull/33795) (test: Ignore error message give from python because of PYTHON_GIL by kevkevinpal)\n* [#33421](https://github.com/bitcoin/bitcoin/pull/33421) (node: add  `BlockTemplateCache` by ismaelsadeeq)\n* [#32420](https://github.com/bitcoin/bitcoin/pull/32420) (miner: drop dummy extraNonce in coinbase scriptSig for templates requested via IPC by Sjors)\n* [#28792](https://github.com/bitcoin/bitcoin/pull/28792) (build: Embedded ASMap [3/3]: Build binary dump header file by fjahr)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n<!--5faf32d7da4f0f540f40219e4f7537a3-->",
          "created_at": "2025-11-28T15:42:41Z"
        },
        {
          "user": "DrahtBot",
          "body": "<!--85328a0da195eb286784d51f73fa0af9-->\nüöß At least one of the CI tasks failed.\n<sub>Task `ASan + LSan + UBSan + integer`: https://github.com/bitcoin/bitcoin/actions/runs/19768365687/job/56646627852</sub>\n<sub>LLM reason (‚ú® experimental): Compilation failed due to incorrect initialization order (designated initializers) in setup_common.cpp, causing test_util build to fail.</sub>\n\n<details><summary>Hints</summary>\n\nTry to run the tests locally, according to the documentation. However, a CI failure may still\nhappen due to a number of reasons, for example:\n\n* Possibly due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\n* A sanitizer issue, which can only be found by compiling with the sanitizer and running the\n  affected test.\n\n* An intermittent issue.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n</details>\n\n",
          "created_at": "2025-11-28T16:00:17Z"
        },
        {
          "user": "ryanofsky",
          "body": "Concept ACK 517a9b23283fee0a861578b2686a71c48a4b67b4, but I had some questions on #33965 which this builds on, and this PR will be affected by what happens to that.\r\n\r\nOverall most changes here seem very good: it's nice to introduce a MiningArgs struct and move handling of mining options out of `init.cpp`. Also nice to port more code to use `interfaces::Mining`. Other changes seem less positive. Before, there was a clear separation of which options were controllable by `interfaces/mining.h` and which options were internal and not part of the public interface. But now all options are mixed together in `node/mining.h`. For example the `BlockCreateOptions` struct passed to `createNewBlock` has a `block_max_weight` member, but setting that member will not do anything, because it will always be overridden by the `MiningArgs::nBlockMaxWeight` in `ClampOptions`. Also, as long as the `-blockreservedweight` option exists, maybe it would be nice if miners could use this value instead of having to provide their own value, so it could be nice to use std::optional for settings that can come from 2 places instead of the more ad-hoc approach here.\r\n\r\n",
          "created_at": "2025-12-01T20:52:51Z"
        },
        {
          "user": "Sjors",
          "body": "Rebased on the latest #33965 which allowed for some simplifications:\r\n- `ClampOptions` no longer takes a `MiningArgs` argument\r\n- no modifications to RPC code\r\n- the new `block_max_weight` option on `BlockCreateOptions` will no longer be ignored if a caller sets it, only the tx_pool fuzzer does.\r\n\r\nWe could trivially make the new `block_max_weight` option available to IPC clients, but I don't think we should encourage its use.\r\n\r\nNote that I brought back `ApplyArgsManOptions` in `miner.cpp`, but it's been renamed to `ApplyMiningDefaults` and it now only deals with the two optionals.\r\n\r\nI haven't addressed this yet:\r\n\r\n> Before, there was a clear separation of which options were controllable by `interfaces/mining.h` and which options were internal and not part of the public interface. But now all options are mixed together in `node/mining.h`.\r\n\r\nWhat would be a good way to organize these things? E.g. having `BlockCreateOptions`, `BlockWaitOptions` and `BlockCheckOptions` defined in `node/types.h` wasn't great either, because Mining interface clients don't care the other structs in that file.",
          "created_at": "2025-12-02T14:14:11Z"
        },
        {
          "user": "ryanofsky",
          "body": "> > Before, there was a clear separation of which options were controllable by `interfaces/mining.h` and which options were internal and not part of the public interface. But now all options are mixed together in `node/mining.h`.\r\n> \r\n> What would be a good way to organize these things? E.g. having `BlockCreateOptions`, `BlockWaitOptions` and `BlockCheckOptions` defined in `node/types.h` wasn't great either, because Mining interface clients don't care the other structs in that file.\r\n\r\nOh I see. You mean you want the mining interface options separate from the `TransactionError` `TxBroadcast` enum types? I guess I put all these types in the same category because they are all used by `src/interfaces/` code and by cap'n proto interfaces in later multiprocess PRs. But it is does seem reasonable to move these to a separate header like `mining.h`. I would just want to the structs not to have any fields that get ignored, and would want to move `MiningArgs` to different file, since it's an internal type.\r\n",
          "created_at": "2025-12-02T17:43:01Z"
        },
        {
          "user": "Sjors",
          "body": "I moved `MiningArgs` and `DEFAULT_PRINT_MODIFIED_FEE` from `node/mining.h` to `node/mining_args.h`.\r\n\r\n> You mean you want the mining interface options separate from the `TransactionError` `TxBroadcast` enum types?\r\n\r\nYes, I think it's easier for Mining IPC client developers to understand how things work that way.",
          "created_at": "2025-12-04T13:28:16Z"
        },
        {
          "user": "Sjors",
          "body": "Holding off on trivial #29641 rebase until #33965 is merged or needs changes.",
          "created_at": "2025-12-08T10:17:31Z"
        },
        {
          "user": "Sjors",
          "body": "Rebased and added a commit to move the minimum `block_reserved_weight` check from interface to mining code, as suggested here: https://github.com/bitcoin/bitcoin/pull/33965#discussion_r2669916481",
          "created_at": "2026-01-08T03:55:01Z"
        }
      ]
    },
    {
      "number": 33965,
      "title": "mining: fix -blockreservedweight shadows IPC option",
      "body": "Also enforce `MINIMUM_BLOCK_RESERVED_WEIGHT` for IPC clients.\r\n\r\nThe `-blockreservedweight` startup option should only affect RPC code, because IPC clients (currently) do not have a way to signal their intent to use the node default (the `BlockCreateOptions` struct defaults merely document a recommendation for client software).\r\n\r\nBefore this PR however, if the user set `-blockreservedweight` then `ApplyArgsManOptions` would cause the `block_reserved_weight` option passed by IPC clients to be ignored. _Users who don't set this value were not affected._\r\n\r\nFix this by making BlockCreateOptions::block_reserved_weight an\r\nstd::optional.\r\n\r\nInternal interface users, such as the RPC call sites, don't set a\r\nvalue so -blockreservedweight is used. Whereas IPC clients do set\r\na value which is no longer ignored.\r\n\r\nTest coverage is added, with a preliminary commit that refactors the `create_block_template` and `wait_next_template` helpers.\r\n\r\n`mining_basic.py` already ensured `-blockreservedweight` is enforced by mining RPC methods. The second commit adds coverage for Mining interface IPC clients. It also verifies that `-blockreservedweight` has no effect on them.\r\n\r\nThe third commit enforces `MINIMUM_BLOCK_RESERVED_WEIGHT` for IPC clients. Previously lower values were quietly clamped.",
      "state": "open",
      "user": "Sjors",
      "created_at": "2025-11-28T13:38:33Z",
      "updated_at": "2026-01-15T12:58:16Z",
      "comments": 13,
      "url": "https://github.com/bitcoin/bitcoin/pull/33965",
      "labels": [
        "Mining"
      ],
      "comment_list": [
        {
          "user": "DrahtBot",
          "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/33965.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [ryanofsky](https://github.com/bitcoin/bitcoin/pull/33965#pullrequestreview-3661188841) |\n\nIf your review is incorrectly listed, please copy-paste <code>&lt;!--meta-tag:bot-skip--&gt;</code> into the comment that the bot should ignore.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#34184](https://github.com/bitcoin/bitcoin/pull/34184) (mining: add cooldown to createNewBlock() immediately after IBD by Sjors)\n* [#33966](https://github.com/bitcoin/bitcoin/pull/33966) (refactor: disentangle miner startup defaults from runtime options by Sjors)\n* [#33936](https://github.com/bitcoin/bitcoin/pull/33936) (mining: pass missing context to createNewBlock() and checkBlock() by Sjors)\n* [#33922](https://github.com/bitcoin/bitcoin/pull/33922) (mining: add getMemoryLoad() and track template non-mempool memory footprint by Sjors)\n* [#33819](https://github.com/bitcoin/bitcoin/pull/33819) (mining: getCoinbase() returns struct instead of raw tx by Sjors)\n* [#33795](https://github.com/bitcoin/bitcoin/pull/33795) (test: Ignore error message give from python because of PYTHON_GIL by kevkevinpal)\n* [#32420](https://github.com/bitcoin/bitcoin/pull/32420) (miner: drop dummy extraNonce in coinbase scriptSig for templates requested via IPC by Sjors)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n<!--5faf32d7da4f0f540f40219e4f7537a3-->",
          "created_at": "2025-11-28T13:38:41Z"
        },
        {
          "user": "DrahtBot",
          "body": "<!--85328a0da195eb286784d51f73fa0af9-->\nüöß At least one of the CI tasks failed.\n<sub>Task `i686, no IPC`: https://github.com/bitcoin/bitcoin/actions/runs/19765451883/job/56637015664</sub>\n<sub>LLM reason (‚ú® experimental): Compile error: ISO C++ reorder-init-list warnings promoted to errors in src/rpc/mining.cpp, causing CI failure.</sub>\n\n<details><summary>Hints</summary>\n\nTry to run the tests locally, according to the documentation. However, a CI failure may still\nhappen due to a number of reasons, for example:\n\n* Possibly due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\n* A sanitizer issue, which can only be found by compiling with the sanitizer and running the\n  affected test.\n\n* An intermittent issue.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n</details>\n\n",
          "created_at": "2025-11-28T13:49:37Z"
        },
        {
          "user": "ryanofsky",
          "body": "Concept ACK. Would suggest updating `-blockreservedweight` documentation to say it only affects RPC mining clients, not IPC clients.\r\n\r\nI think implementation of this could be improved a bit, depending on if you think it would be useful for IPC clients to \"have a way to signal their intent to use the node default\"?\r\n\r\nIf yes, would suggest just making the field `std::optional`:\r\n\r\n<details><summary>diff</summary>\r\n<p>\r\n\r\n```diff\r\n--- a/src/node/miner.cpp\r\n+++ b/src/node/miner.cpp\r\n@@ -78,11 +78,11 @@ void RegenerateCommitments(CBlock& block, ChainstateManager& chainman)\r\n \r\n static BlockAssembler::Options ClampOptions(BlockAssembler::Options options)\r\n {\r\n-    options.block_reserved_weight = std::clamp<size_t>(options.block_reserved_weight, MINIMUM_BLOCK_RESERVED_WEIGHT, MAX_BLOCK_WEIGHT);\r\n+    options.block_reserved_weight = std::clamp<size_t>(options.block_reserved_weight.value_or(DEFAULT_BLOCK_RESERVED_WEIGHT), MINIMUM_BLOCK_RESERVED_WEIGHT, MAX_BLOCK_WEIGHT);\r\n     options.coinbase_output_max_additional_sigops = std::clamp<size_t>(options.coinbase_output_max_additional_sigops, 0, MAX_BLOCK_SIGOPS_COST);\r\n     // Limit weight to between block_reserved_weight and MAX_BLOCK_WEIGHT for sanity:\r\n     // block_reserved_weight can safely exceed -blockmaxweight, but the rest of the block template will be empty.\r\n-    options.nBlockMaxWeight = std::clamp<size_t>(options.nBlockMaxWeight, options.block_reserved_weight, MAX_BLOCK_WEIGHT);\r\n+    options.nBlockMaxWeight = std::clamp<size_t>(options.nBlockMaxWeight, *options.block_reserved_weight, MAX_BLOCK_WEIGHT);\r\n     return options;\r\n }\r\n \r\n@@ -102,13 +102,15 @@ void ApplyArgsManOptions(const ArgsManager& args, BlockAssembler::Options& optio\r\n         if (const auto parsed{ParseMoney(*blockmintxfee)}) options.blockMinFeeRate = CFeeRate{*parsed};\r\n     }\r\n     options.print_modified_fee = args.GetBoolArg(\"-printpriority\", options.print_modified_fee);\r\n-    options.block_reserved_weight = args.GetIntArg(\"-blockreservedweight\", options.block_reserved_weight);\r\n+    if (!options.block_reserved_weight) {\r\n+        options.block_reserved_weight = args.GetIntArg(\"-blockreservedweight\");\r\n+    }\r\n }\r\n \r\n void BlockAssembler::resetBlock()\r\n {\r\n     // Reserve space for fixed-size block header, txs count, and coinbase tx.\r\n-    nBlockWeight = m_options.block_reserved_weight;\r\n+    nBlockWeight = *m_options.block_reserved_weight;\r\n     nBlockSigOpsCost = m_options.coinbase_output_max_additional_sigops;\r\n \r\n     // These counters do not include coinbase tx\r\n--- a/src/node/types.h\r\n+++ b/src/node/types.h\r\n@@ -42,7 +42,7 @@ struct BlockCreateOptions {\r\n      * The default reserved weight for the fixed-size block header,\r\n      * transaction count and coinbase transaction.\r\n      */\r\n-    size_t block_reserved_weight{DEFAULT_BLOCK_RESERVED_WEIGHT};\r\n+    std::optional<size_t> block_reserved_weight{};\r\n     /**\r\n      * The maximum additional sigops which the pool will add in coinbase\r\n      * transaction outputs.\r\n```\r\n</p>\r\n</details>\r\n\r\nIf no, would suggest having separate functions to read options which IPC clients can and can't control:\r\n\r\n<details><summary>diff</summary>\r\n<p>\r\n\r\n```diff\r\n--- a/src/node/interfaces.cpp\r\n+++ b/src/node/interfaces.cpp\r\n@@ -963,8 +963,12 @@ public:\r\n         // Ensure m_tip_block is set so consumers of BlockTemplate can rely on that.\r\n         if (!waitTipChanged(uint256::ZERO, MillisecondsDouble::max())) return {};\r\n \r\n+        // Construct block assembler options from block create options and\r\n+        // ArgsManager preferences. Intentionally do not call\r\n+        // ReadBlockCreateArgs, so IPC create options will take precedence over\r\n+        // ArgsManager values.\r\n         BlockAssembler::Options assemble_options{options};\r\n-        ApplyArgsManOptions(*Assert(m_node.args), assemble_options);\r\n+        ReadBlockAssemblerArgs(*Assert(m_node.args), assemble_options);\r\n         return std::make_unique<BlockTemplateImpl>(assemble_options, BlockAssembler{chainman().ActiveChainstate(), context()->mempool.get(), assemble_options}.CreateNewBlock(), m_node);\r\n     }\r\n \r\n--- a/src/node/miner.cpp\r\n+++ b/src/node/miner.cpp\r\n@@ -94,7 +94,7 @@ BlockAssembler::BlockAssembler(Chainstate& chainstate, const CTxMemPool* mempool\r\n {\r\n }\r\n \r\n-void ApplyArgsManOptions(const ArgsManager& args, BlockAssembler::Options& options)\r\n+void ReadBlockAssemblerArgs(const ArgsManager& args, BlockAssembler::Options& options)\r\n {\r\n     // Block resource limits\r\n     options.nBlockMaxWeight = args.GetIntArg(\"-blockmaxweight\", options.nBlockMaxWeight);\r\n@@ -102,6 +102,10 @@ void ApplyArgsManOptions(const ArgsManager& args, BlockAssembler::Options& optio\r\n         if (const auto parsed{ParseMoney(*blockmintxfee)}) options.blockMinFeeRate = CFeeRate{*parsed};\r\n     }\r\n     options.print_modified_fee = args.GetBoolArg(\"-printpriority\", options.print_modified_fee);\r\n+}\r\n+\r\n+void ReadBlockCreateArgs(const ArgsManager& args, BlockCreateOptions& options)\r\n+{\r\n     options.block_reserved_weight = args.GetIntArg(\"-blockreservedweight\", options.block_reserved_weight);\r\n }\r\n \r\n--- a/src/node/miner.h\r\n+++ b/src/node/miner.h\r\n@@ -131,8 +131,11 @@ int64_t UpdateTime(CBlockHeader* pblock, const Consensus::Params& consensusParam\r\n /** Update an old GenerateCoinbaseCommitment from CreateNewBlock after the block txs have changed */\r\n void RegenerateCommitments(CBlock& block, ChainstateManager& chainman);\r\n \r\n+/** Apply -blockreservedweight options from ArgsManager to BlockCreateOptions. */\r\n+void ReadBlockCreateArgs(const ArgsManager& args, BlockCreateOptions& options);\r\n+\r\n /** Apply -blockmintxfee and -blockmaxweight options from ArgsManager to BlockAssembler options. */\r\n-void ApplyArgsManOptions(const ArgsManager& gArgs, BlockAssembler::Options& options);\r\n+void ReadBlockAssemblerArgs(const ArgsManager& args, BlockAssembler::Options& options);\r\n \r\n /* Compute the block's merkle root, insert or replace the coinbase transaction and the merkle root into the block */\r\n void AddMerkleRootAndCoinbase(CBlock& block, CTransactionRef coinbase, uint32_t version, uint32_t timestamp, uint32_t nonce);\r\n--- a/src/rpc/mining.cpp\r\n+++ b/src/rpc/mining.cpp\r\n@@ -161,11 +161,13 @@ static bool GenerateBlock(ChainstateManager& chainman, CBlock&& block, uint64_t&\r\n     return true;\r\n }\r\n \r\n-static UniValue generateBlocks(ChainstateManager& chainman, Mining& miner, const CScript& coinbase_output_script, int nGenerate, uint64_t nMaxTries)\r\n+static UniValue generateBlocks(ChainstateManager& chainman, ArgsManager& args, Mining& miner, const CScript& coinbase_output_script, int nGenerate, uint64_t nMaxTries)\r\n {\r\n     UniValue blockHashes(UniValue::VARR);\r\n+    node::BlockCreateOptions options{ .coinbase_output_script = coinbase_output_script };\r\n+    ReadBlockCreateArgs(args, options);\r\n     while (nGenerate > 0 && !chainman.m_interrupt) {\r\n-        std::unique_ptr<BlockTemplate> block_template(miner.createNewBlock({ .coinbase_output_script = coinbase_output_script }));\r\n+        std::unique_ptr<BlockTemplate> block_template(miner.createNewBlock(options));\r\n         CHECK_NONFATAL(block_template);\r\n \r\n         std::shared_ptr<const CBlock> block_out;\r\n@@ -247,9 +249,10 @@ static RPCHelpMan generatetodescriptor()\r\n \r\n     NodeContext& node = EnsureAnyNodeContext(request.context);\r\n     Mining& miner = EnsureMining(node);\r\n+    ArgsManager& args = EnsureArgsman(node);\r\n     ChainstateManager& chainman = EnsureChainman(node);\r\n \r\n-    return generateBlocks(chainman, miner, coinbase_output_script, num_blocks, max_tries);\r\n+    return generateBlocks(chainman, args, miner, coinbase_output_script, num_blocks, max_tries);\r\n },\r\n     };\r\n }\r\n@@ -293,11 +296,12 @@ static RPCHelpMan generatetoaddress()\r\n \r\n     NodeContext& node = EnsureAnyNodeContext(request.context);\r\n     Mining& miner = EnsureMining(node);\r\n+    ArgsManager& args = EnsureArgsman(node);\r\n     ChainstateManager& chainman = EnsureChainman(node);\r\n \r\n     CScript coinbase_output_script = GetScriptForDestination(destination);\r\n \r\n-    return generateBlocks(chainman, miner, coinbase_output_script, num_blocks, max_tries);\r\n+    return generateBlocks(chainman, args, miner, coinbase_output_script, num_blocks, max_tries);\r\n },\r\n     };\r\n }\r\n@@ -345,6 +349,7 @@ static RPCHelpMan generateblock()\r\n \r\n     NodeContext& node = EnsureAnyNodeContext(request.context);\r\n     Mining& miner = EnsureMining(node);\r\n+    ArgsManager& args = EnsureArgsman(node);\r\n     const CTxMemPool& mempool = EnsureMemPool(node);\r\n \r\n     std::vector<CTransactionRef> txs;\r\n@@ -374,9 +379,11 @@ static RPCHelpMan generateblock()\r\n \r\n     ChainstateManager& chainman = EnsureChainman(node);\r\n     {\r\n+        node::BlockCreateOptions options{.use_mempool = false, .coinbase_output_script = coinbase_output_script};\r\n+        ReadBlockCreateArgs(args, options);\r\n         LOCK(chainman.GetMutex());\r\n         {\r\n-            std::unique_ptr<BlockTemplate> block_template{miner.createNewBlock({.use_mempool = false, .coinbase_output_script = coinbase_output_script})};\r\n+            std::unique_ptr<BlockTemplate> block_template{miner.createNewBlock(options)};\r\n             CHECK_NONFATAL(block_template);\r\n \r\n             block = block_template->getBlock();\r\n@@ -471,7 +478,8 @@ static RPCHelpMan getmininginfo()\r\n     obj.pushKV(\"networkhashps\",    getnetworkhashps().HandleRequest(request));\r\n     obj.pushKV(\"pooledtx\",         (uint64_t)mempool.size());\r\n     BlockAssembler::Options assembler_options;\r\n-    ApplyArgsManOptions(*node.args, assembler_options);\r\n+    ReadBlockCreateArgs(*node.args, assembler_options);\r\n+    ReadBlockAssemblerArgs(*node.args, assembler_options);\r\n     obj.pushKV(\"blockmintxfee\", ValueFromAmount(assembler_options.blockMinFeeRate.GetFeePerK()));\r\n     obj.pushKV(\"chain\", chainman.GetParams().GetChainTypeString());\r\n \r\n@@ -871,7 +879,10 @@ static RPCHelpMan getblocktemplate()\r\n         time_start = GetTime();\r\n \r\n         // Create new block\r\n-        block_template = miner.createNewBlock();\r\n+        ArgsManager& args = EnsureArgsman(node);\r\n+        node::BlockCreateOptions options;\r\n+        ReadBlockCreateArgs(args, options);\r\n+        block_template = miner.createNewBlock(options);\r\n         CHECK_NONFATAL(block_template);\r\n \r\n \r\n--- a/src/test/util/mining.cpp\r\n+++ b/src/test/util/mining.cpp\r\n@@ -138,6 +138,7 @@ std::shared_ptr<CBlock> PrepareBlock(const NodeContext& node, const CScript& coi\r\n {\r\n     BlockAssembler::Options assembler_options;\r\n     assembler_options.coinbase_output_script = coinbase_scriptPubKey;\r\n-    ApplyArgsManOptions(*node.args, assembler_options);\r\n+    ReadBlockCreateArgs(*node.args, assembler_options);\r\n+    ReadBlockAssemblerArgs(*node.args, assembler_options);\r\n     return PrepareBlock(node, assembler_options);\r\n }\r\n```\r\n</p>\r\n</details>\r\n\r\nThe current implementation 46d901c253107ffba14ddce6c3154b46bd471fc2 seems a little less ideal using repeated GetIntArg calls instead a function to read the options.",
          "created_at": "2025-12-01T20:22:26Z"
        },
        {
          "user": "Sjors",
          "body": "> if you think it would be useful for IPC clients to \"have a way to signal their intent to use the node default\"\r\n\r\nsv2-tp always sets the value (based on `coinbase_output_max_additional_size` in  `CoinbaseOutputConstraints`), so it wouldn't benefit. But it does seem better to allow clients to omit this value.\r\n\r\nFor that to work however, we'd also need to change mining.capnp, e.g.:\r\n\r\n```capnp\r\nblockReservedWeight @1 :UInt64 $Proxy.name(\"block_reserved_weight\");\r\nhasBlockReservedWeight @3 :Bool = true $Proxy.skip;\r\n```\r\n\r\nAdding the `has` field and having it default to `true` means it's not a breaking change. But this doesn't actually work :-)\r\n\r\nAlso, if we really wanted to make this optional for IPC clients, I would prefer to add direct support for optionals to capnp files, as a breaking change.\r\n\r\n\r\nHowever, I did take your patch because it allows this PR to simplified:\r\n- internal callers will see `coinbase_output_max_additional_size` as optional and can omit it. That lets me avoid the four `GetIntArg` calls (and leave `rpc/mining.cpp` alone).\r\n- IPC callers don't see it as optional and always provide a value (which we can change later)\r\n\r\nI added documentation to make this behavior clear.",
          "created_at": "2025-12-02T10:41:57Z"
        },
        {
          "user": "Sjors",
          "body": "Rebased after #33591 because #33966 has a trivial merge conflict with it and I want to keep that cleanly based on this PR.",
          "created_at": "2025-12-02T14:25:27Z"
        },
        {
          "user": "Sjors",
          "body": "Rebased after #34003. I added an initial test refactor commit to have the `{create_block,wait_next}_template` helpers introduced in that PR to return `None` if there's a timeout or failure.\r\n\r\nI also added a commit to enforce (rather than clamp) the minimum reserved block value, as noticed by @plebhash in https://github.com/stratum-mining/sv2-tp/pull/51#issuecomment-3670613634. I could make that it's own PR but it's rather trivial.",
          "created_at": "2025-12-19T07:49:10Z"
        },
        {
          "user": "Sjors",
          "body": "@plebhash maybe you can you give this a quick test against the SRI integration? Without this PR, if you set `-blockreservedweigh` it will ignore the corresponding IPC argument.",
          "created_at": "2025-12-30T02:53:53Z"
        },
        {
          "user": "plebhash",
          "body": "> @plebhash maybe you can you give this a quick test against the SRI integration? Without this PR, if you set `-blockreservedweigh` it will ignore the corresponding IPC argument.\r\n\r\nwhat methodology would you suggest for this?\r\n\r\nI assume we want to mine a block that's filled up to its capacity, and then check the consumed weight to see how far it is from the consensus limit, right?\r\n\r\nI'm trying to leverage `integration_tests_sv2` crate, which allows us to write some Rust code to interact with a regtest node\r\n\r\nbut I'm having a really hard time to reliably populate the mempool with enough transactions to fill an entire block (at least in a test that wouldn't take hours to execute)",
          "created_at": "2025-12-30T23:10:09Z"
        },
        {
          "user": "Sjors",
          "body": "@plebhash in the functional test for this PR I simply set `-blockreservedweight=4000000`. That should result in empty blocks. Then just use a normal value in the IPC calls and the blocks will still be empty (before this PR).",
          "created_at": "2025-12-31T02:39:10Z"
        },
        {
          "user": "plebhash",
          "body": "ok I wrote an Integration Test with the following methodology:\r\n\r\n- Bitcoin Core in `regtest` mode with the following variations\r\n  - v30 vs this PR\r\n  - with vs without `-blockreservedweight=4000000`\r\n- Pool (which connects to Bitcoin Core via IPC)\r\n- Sniffer (between Pool and tProxy)\r\n- tProxy\r\n- Sv1 CPU miner\r\n\r\nwe loop while creating mempool transactions and monitoring the Extended Jobs sent by Pool\r\n\r\nthe test only exits once we see an Extended Job with `merkle_path.len() > 0` (‚úÖ)... if the test never returns (‚ùå), we conclude that all templates sent by Bitcoin Core are empty\r\n\r\nnote: Pool originally generates  `CoinbaseOutputConstraints.coinbase_output_max_additional_size = 31`\r\n\r\nbut internally, its `BitcoinCoreSv2` abstraction multiplies it by 4 and then clamps the result to `2000` while crafting the `CreateNewBlock` IPC request... so I also added a variation on the tests with and without clamping this to 2000\r\n\r\n---\r\n\r\nhere are the results:\r\n\r\nWITH clamping `4 * CoinbaseOutputConstraints.coinbase_output_max_additional_size` to `2000` while sending `CreateNewBlock`:\r\n\r\n|                                        | v30                        | #33965                   |\r\n|----------------------------------------|----------------------------|--------------------------|\r\n| WITH `-blockreservedweight=4000000`    | only sends EMPTY templates ‚ùå | sends NON-EMPTY template ‚úÖ |\r\n| WITHOUT `-blockreservedweight=4000000` | sends NON-EMPTY template ‚úÖ  | sends NON-EMPTY template ‚úÖ |\r\n\r\nWITHOUT clamping `4 * CoinbaseOutputConstraints.coinbase_output_max_additional_size` to `2000` while sending `CreateNewBlock`:\r\n\r\n|                                        | v30                        | #33965                  |\r\n|----------------------------------------|----------------------------|-------------------------|\r\n| with `-blockreservedweight=4000000`    | only sends EMPTY templates ‚ùå | `CreateNewBlock`  fails  üí• |\r\n| without `-blockreservedweight=4000000` | sends NON-EMPTY template  ‚úÖ | `CreateNewBlock`  fails  üí•|\r\n\r\nboth errors for `CreateNewBlock`  were:\r\n```\r\n2025-12-31T16:42:09.307986Z ERROR bitcoin_core_sv2: Failed to get template IPC client result: Message contains null capability pointer.\r\n2025-12-31T16:42:09.308014Z ERROR bitcoin_core_sv2: Failed to create new template IPC client: CapnpError(Error { kind: MessageContainsNullCapabilityPointer, extra: \"\" })\r\n```\r\n\r\nthis makes me conclude that Bitcoin Core will not accept a `CreateNewBlock` with `set_block_reserved_weight < 2000`, which feels aligned with the rationale behind https://github.com/stratum-mining/sv2-tp/pull/79\r\n\r\n---\r\n\r\nthe test was saved on [branch `2025-12-31-test-bitcoin-core-33965` of my fork](https://github.com/plebhash/sv2-apps/tree/2025-12-31-test-bitcoin-core-33965), with the following commits:\r\n- [7b343fba4ad506dba179b1f5fbcb99598617dafe](https://github.com/plebhash/sv2-apps/commit/7b343fba4ad506dba179b1f5fbcb99598617dafe) which disables clamping `4 * CoinbaseOutputConstraints.coinbase_output_max_additional_size` to `2000`\r\n- [951d5d14456fa861eb6b765cd65f05a94b3c3dfa](https://github.com/plebhash/sv2-apps/commit/951d5d14456fa861eb6b765cd65f05a94b3c3dfa) which adds the modifications to `integration_tests_sv2` code needed for this test (originally commented out and hardcoded with a path from my setup, but can be easily enabled/modified)\r\n- [5cb733fc169fcd39293222fb1e600f543308a39d](https://github.com/plebhash/sv2-apps/commit/5cb733fc169fcd39293222fb1e600f543308a39d) which adds the `test_33965` Integration Test\r\n\r\nthe integration test can be executed with:\r\n```\r\ngit clone https://github.com/plebhash/sv2-apps -b 2025-12-31-test-bitcoin-core-33965\r\ncd sv2-apps/integration-tests\r\ncargo t test_33965 -- --nocapture\r\n```\r\n\r\n(I actually recommend `cargo nextest run test_33965 --nocapture` because it makes it easier to kill the tests without leaving zombie processes behind, but it's optional)",
          "created_at": "2025-12-31T17:00:24Z"
        },
        {
          "user": "Sjors",
          "body": "@plebhash thanks for testing! So it looks like this PR works.\r\n\r\n> this makes me conclude that Bitcoin Core will not accept a `CreateNewBlock` with `set_block_reserved_weight < 2000`, which feels aligned with the rationale behind [stratum-mining/sv2-tp#79](https://github.com/stratum-mining/sv2-tp/pull/79)\r\n\r\nGood to know that it's not quietly increasing the value, but rather just fails. Even though the error could be better.",
          "created_at": "2026-01-01T03:21:42Z"
        },
        {
          "user": "Sjors",
          "body": "Addressed comments and also rebased (needed for #33966).\r\n\r\n> Even though the error could be better.\r\n\r\n@plebhash it should throw a more useful error now",
          "created_at": "2026-01-08T03:19:11Z"
        },
        {
          "user": "Sjors",
          "body": "Rebased after:\r\n- #33819\r\n- just some include / import conflicts",
          "created_at": "2026-01-14T09:27:36Z"
        }
      ]
    }
  ],
  "issues": [],
  "summary": {
    "pull_requests": 2,
    "issues": 0
  }
}