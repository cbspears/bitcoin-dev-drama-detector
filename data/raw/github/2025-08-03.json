{
  "source": "github",
  "repository": "bitcoin/bitcoin",
  "fetched_at": "2026-01-15T20:03:44.175570+00:00",
  "date": "2025-08-03",
  "pull_requests": [
    {
      "number": 33131,
      "title": "tests: cover abortrescan() in-flight True path with dynamic-tail retry",
      "body": "This PR adds a test in wallet_transactiontime_rescan.py. Previously we only tested that abortrescan() returns False when no rescan was running. This change verifies that it returns True and actually interrupts a running scan.\r\n\r\nHow it works:\r\n1. spawn a daemon background thread that rescans a tail of the wallet‚Äôs chain.\r\n2. aggressively poll every 10 ms (for up to 5 s) until we see the node start scanning\r\n3. Call 'abortrescan()' and assert to True\r\n4. Threads are joined with short timeouts so they can't hang teardown\r\n\r\nDynamic tail:\r\nIf the tail of the wallets chain is too small, by the time we see \"scanning=True\", the scan might already be finished (so no scan is active, and abortrescan() will be 'False'. A fixed sized tail caused issues in ~10% of test runs (the dynamic tail was tested 200 times without an error).\r\nBy starting with 10 blocks and doubling for up to 5 times, we can ensure that a suitable tail length is found so that:\r\n1. The node sets scanning=true long enough for our tight (10 ms) polls to catch it\r\n2. But still finishes in a few seconds so the test stays fast.\r\n\r\nI‚Äôd love feedback if you have ideas for a simpler or more reliable way design this test, or if you spot any edge cases this might miss. ",
      "state": "closed",
      "user": "cedwies",
      "created_at": "2025-08-03T15:01:26Z",
      "updated_at": "2025-10-05T23:03:31Z",
      "comments": 3,
      "url": "https://github.com/bitcoin/bitcoin/pull/33131",
      "labels": [
        "Tests"
      ],
      "comment_list": [
        {
          "user": "DrahtBot",
          "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/33131.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\nA summary of reviews will appear here.\n<!--5faf32d7da4f0f540f40219e4f7537a3-->",
          "created_at": "2025-08-03T15:01:31Z"
        },
        {
          "user": "cedwies",
          "body": "Also, I will block the test on t.join(). (no timeout), so the\r\nbackground rescan thread is guaranteed to exit before the test returns (which I think causes the CI\r\ncleanup step from failing with ‚ÄúOSError: directory not empty‚Äù). ",
          "created_at": "2025-08-04T11:33:26Z"
        },
        {
          "user": "cedwies",
          "body": "Closing: asserting the ‚Äú`abortrescan()` returns `True` while a rescan is in flight‚Äù path is inherently racy in a functional test. The rescan runs in a separate thread and, on slow CI machines, can finish before the abort is observed, causing intermittent failures. Even with long rescans and retries there‚Äôs a non-zero flake window. Thanks @maflcko for the review and feedback.",
          "created_at": "2025-10-05T23:03:31Z"
        }
      ]
    },
    {
      "number": 33130,
      "title": "validation: Keep chain tip in candidate set",
      "body": "After `PruneBlockIndexCandidates()` is called, the candidate set must include the current chain tip or a successor of it.\r\n\r\n`PruneBlockIndexCandidates()` removes candidates with less work than the active tip. However, because the tip itself is never added to `setBlockIndexCandidates` via `TryAddBlockIndexCandidate()`, it may be absent from the set. Prior to this patch, if all lower-work candidates were pruned and the tip was not present, `setBlockIndexCandidates` could become empty‚Äîviolating an invariant relied upon by `FindMostWorkChain()`.\r\n\r\nThis patch ensures that `PruneBlockIndexCandidates()` explicitly reinserts the current tip after pruning, preserving that invariant.\r\n\r\nFixes #33129",
      "state": "closed",
      "user": "nervana21",
      "created_at": "2025-08-03T14:15:35Z",
      "updated_at": "2025-09-06T10:50:42Z",
      "comments": 4,
      "url": "https://github.com/bitcoin/bitcoin/pull/33130",
      "labels": [
        "Validation"
      ],
      "comment_list": [
        {
          "user": "DrahtBot",
          "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/33130.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\nA summary of reviews will appear here.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#33127](https://github.com/bitcoin/bitcoin/pull/33127) (Adding alert for failure to prevent dead-end user crash by Ataraxia009)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n<!--5faf32d7da4f0f540f40219e4f7537a3-->",
          "created_at": "2025-08-03T14:15:39Z"
        },
        {
          "user": "DrahtBot",
          "body": "<!--85328a0da195eb286784d51f73fa0af9-->\nüöß At least one of the CI tasks failed.\n<sub>Task `lint`: https://github.com/bitcoin/bitcoin/runs/47284029602</sub>\n<sub>LLM reason (‚ú® experimental): The CI failure is caused by a trailing whitespace error detected during the lint check.</sub>\n\n<details><summary>Hints</summary>\n\nTry to run the tests locally, according to the documentation. However, a CI failure may still\nhappen due to a number of reasons, for example:\n\n* Possibly due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\n* A sanitizer issue, which can only be found by compiling with the sanitizer and running the\n  affected test.\n\n* An intermittent issue.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n</details>\n\n",
          "created_at": "2025-08-03T14:20:13Z"
        },
        {
          "user": "nervana21",
          "body": "cc: @Ataraxia009",
          "created_at": "2025-08-03T14:22:10Z"
        },
        {
          "user": "nervana21",
          "body": "Hi mzumsande,\r\nThanks for the thorough feedback.\r\n\r\nYou're right, it is preferable to crash a node that is out of consensus. I believe that I did have a chain sequence construction that led to `setBlockIndexCandidates` without chain tip (now I'm less confident), but even so, I'm certain the chain construction would be out of consensus and therefore not worth salvaging. I wish I had considered before and I will try to consider in the future.\r\n\r\nThanks again!",
          "created_at": "2025-08-04T00:36:26Z"
        }
      ]
    }
  ],
  "issues": [
    {
      "number": 33129,
      "title": "Crash on launch in PruneBlockIndexCandidates",
      "body": "### Is there an existing issue for this?\n\n- [x] I have searched the existing issues\n\n### Current behaviour\n\n`setBlockIndexCandidates` can become empty if the chain tip is not included in the set, which violates an internal invariant and leads to a crash during `FindMostWorkChain()`. This issue and potential solutions were originally surfaced by ataraxia009 in #33127.\n\n### Expected behaviour\n\nAfter pruning, the active tip must be present in the candidate set. No crash should occur in `FindMostWorkChain()`. \n\n### Steps to reproduce\n\nMine a chain\nManually remove the tip from `setBlockIndexCandidates`\nCall `PruneBlockIndexCandidates()`\nObserve that `setBlockIndexCandidates` no longer contains the tip -> This violates an invariant relied upon by FindMostWorkChain()\n\n### Relevant log output\n\n_No response_\n\n### How did you obtain Bitcoin Core\n\nCompiled from source\n\n### What version of Bitcoin Core are you using?\n\nv29.99.0-75ed673\n\n### Operating system and version\n\nMac\n\n### Machine specifications\n\n_No response_",
      "state": "closed",
      "user": "nervana21",
      "created_at": "2025-08-03T14:09:39Z",
      "updated_at": "2025-08-21T04:03:01Z",
      "comments": 7,
      "url": "https://github.com/bitcoin/bitcoin/issues/33129",
      "labels": [],
      "comment_list": [
        {
          "user": "Ataraxia009",
          "body": "The issue I was addressing has nothing to do with `FindMostWorkChain` or a crash in it.\n\nThe root issue that I witnessed was a crash on launch in `PruneBlockIndexCandidates` which is caused by the data dir reaching a bad state.\n\nIn this state, the block validity of the block indexes in the `setBlockIndexCandidates` was correct, i.e.: `BLOCK_VALID_TRANSACTIONS`, \nbut the block validity for the blocks that were used to to build the `CoinsView` and therefore the `M_Chain` did not have their required block validity, i.e `BLOCK_VALID_SCRIPTS`, the blocks with neither `BLOCK_VALID_SCRIPTS` nor `BLOCK_VALID_TRANSACTIONS` were being used as the `m_chain.tip`. Which should not be the case.\n\nThis caused all the `setBlockIndexCandidates` to have lesser work than the `m_chain.Tip`. Leaving the `setBlockIndexCandidates` empty after the `PruneBlockIndexCandidates` call during launch.\n\nI cannot figure out how the data got to that state because it seems like this state should never happen.\n\n",
          "created_at": "2025-08-03T16:03:17Z"
        },
        {
          "user": "furszy",
          "body": "Which version of Bitcoin-Core are you running?",
          "created_at": "2025-08-03T16:09:38Z"
        },
        {
          "user": "maflcko",
          "body": "> I cannot figure out how the data got to that state because it seems like this state should never happen.\n\nBitcoin Core makes heavy use of CPU, RAM and storage IO. Hardware defects might only become visible when running Bitcoin Core. You might want to check your hardware for defects.\n\n* Use software such as memtest86 to check your RAM.\n* Use software such as linpack, or Prime95 to check the CPU behaviour under load.\n* Use software such as smartctl, fsck, badblocks, or CrystalDiskInfo to test your storage device use.\n\nSource: https://bitcoin.stackexchange.com/a/12206",
          "created_at": "2025-08-04T08:23:57Z"
        },
        {
          "user": "nervana21",
          "body": "Ahh, okay, my understanding of the problem that [Ataraxia009](https://github.com/Ataraxia009) is having is a bit better now, but I still don't understand the problem well enough to adequately characterize it better than I've done in this issue. I've updated the title to more accurately describe what's believed to be the source of the error",
          "created_at": "2025-08-05T00:40:31Z"
        },
        {
          "user": "Ataraxia009",
          "body": "> Which version of Bitcoin-Core are you running?\n\n28",
          "created_at": "2025-08-05T04:43:06Z"
        },
        {
          "user": "Ataraxia009",
          "body": "\n> > I cannot figure out how the data got to that state because it seems like this state should never happen.\n> \n> Bitcoin Core makes heavy use of CPU, RAM and storage IO. Hardware defects might only become visible when running Bitcoin Core. You might want to check your hardware for defects.\n> \n> * Use software such as memtest86 to check your RAM.\n> * Use software such as linpack, or Prime95 to check the CPU behaviour under load.\n> * Use software such as smartctl, fsck, badblocks, or CrystalDiskInfo to test your storage device use.\n> \n> Source: https://bitcoin.stackexchange.com/a/12206\n\n\nPossible, but highly doubt it. Ill run some tests anyways.\n\nIm on a mac with CPU: Apple M2 Max\n\nIll find alternatives to the above but if you have suggested ones lmk\n",
          "created_at": "2025-08-05T04:44:34Z"
        },
        {
          "user": "maflcko",
          "body": "With the datadir deleted (https://github.com/bitcoin/bitcoin/pull/33127#issuecomment-3177718602), this makes it harder to debug without any debug log or state to investigate. Maybe this can be closed for now?",
          "created_at": "2025-08-20T15:02:13Z"
        }
      ]
    }
  ],
  "summary": {
    "pull_requests": 2,
    "issues": 1
  }
}