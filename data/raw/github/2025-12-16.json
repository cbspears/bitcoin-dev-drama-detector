{
  "source": "github",
  "repository": "bitcoin/bitcoin",
  "fetched_at": "2026-01-15T20:40:10.586049+00:00",
  "date": "2025-12-16",
  "pull_requests": [
    {
      "number": 34085,
      "title": "cluster mempool: exploit SFL properties in txgraph",
      "body": "Part of #30289, follow-up to #32545.\r\n\r\nThis gets rid of `FixLinearization()` by integrating the functionality into `Linearize()`, and makes txgraph exploit that (by delaying fixing of clusters until their first re-linearization). It also reduces (but does not eliminate) the number of calls to `PostLinearize`, as the SFL linearization effectively performs something very similar to postlinearization when loading in an existing linearization already.",
      "state": "closed",
      "user": "sipa",
      "created_at": "2025-12-16T21:21:15Z",
      "updated_at": "2026-01-06T15:51:51Z",
      "comments": 4,
      "url": "https://github.com/bitcoin/bitcoin/pull/34085",
      "labels": [],
      "comment_list": [
        {
          "user": "DrahtBot",
          "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/34085.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [marcofleon](https://github.com/bitcoin/bitcoin/pull/34085#pullrequestreview-3631060645), [instagibbs](https://github.com/bitcoin/bitcoin/pull/34085#issuecomment-3715029691) |\n\nIf your review is incorrectly listed, please copy-paste <code>&lt;!--meta-tag:bot-skip--&gt;</code> into the comment that the bot should ignore.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#34138](https://github.com/bitcoin/bitcoin/pull/34138) (Cluster mempool: more accurate cost model for SFL by sipa)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n<!--5faf32d7da4f0f540f40219e4f7537a3-->\n### LLM Linter (âœ¨ experimental)\n\n\n\nPossible places where named args for integral literals may be used (e.g. `func(x, /*named_arg=*/0)` in C++, and `func(x, named_arg=0)` in Python):\n\n- graph.SetClusterQuality(level, m_quality, m_setindex, QualityLevel::NEEDS_FIX) in src/txgraph.cpp\n- graph.SetClusterQuality(level, m_quality, m_setindex, QualityLevel::NEEDS_RELINEARIZE) in src/txgraph.cpp\n\n(No other added lines contain function calls where a third-or-later positional argument is a literal)\n\n\n\n<sup>2026-01-05</sup>\n",
          "created_at": "2025-12-16T21:21:21Z"
        },
        {
          "user": "sipa",
          "body": "Rebased after merge of #32545, and marked as ready for review.",
          "created_at": "2025-12-19T15:21:01Z"
        },
        {
          "user": "instagibbs",
          "body": "reACK d9fd076f027f95b6ba12d8bd4d3d7ca13e031d29",
          "created_at": "2025-12-30T13:29:51Z"
        },
        {
          "user": "instagibbs",
          "body": "reACK 1808b5aaf7c4910122fcd088e03d790189907438\r\n\r\nClean rebase + one comment typo fixed only",
          "created_at": "2026-01-06T14:59:39Z"
        }
      ]
    },
    {
      "number": 34084,
      "title": "scripted-diff: [doc] Unify stale copyright headers",
      "body": "Historically, the upper year range in file headers was bumped manually\r\nor with a script.\r\n\r\nThis has many issues:\r\n\r\n* The script is causing churn. See for example commit 306ccd4, or\r\n  drive-by first-time contributions bumping them one-by-one. (A few from\r\n  this year: https://github.com/bitcoin/bitcoin/pull/32008,\r\n  https://github.com/bitcoin/bitcoin/pull/31642,\r\n  https://github.com/bitcoin/bitcoin/pull/32963, ...)\r\n* Some, or likely most, upper year values were wrong. Reasons for \r\n  incorrect dates could be code moves, cherry-picks, or simply bugs in\r\n  the script.\r\n* The upper range is not needed for anything.\r\n* Anyone who wants to find the initial file creation date, or file\r\n  history, can use `git log` or `git blame` to get more accurate\r\n  results.\r\n* Many places are already using the `-present` suffix, with the meaning\r\n  that the upper range is omitted.\r\n\r\nTo fix all issues, this bumps the upper range of the copyright headers\r\nto `-present`.\r\n\r\nFurther notes:\r\n\r\n* Obviously, the yearly 4-line bump commit for the build system (c.f.\r\n  b537a2c02a9921235d1ecf8c3c7dc1836ec68131) is fine and will remain.\r\n* For new code, the date range can be fully omitted, as it is done\r\n  already by some developers. Obviously, developers are free to pick\r\n  whatever style they want. One can list the commits for each style.\r\n* For example, to list all commits that use `-present`:\r\n  `git log --format='%an (%ae) [%h: %s]' -S 'present The Bitcoin'`.\r\n* Alternatively, to list all commits that use no range at all:\r\n  `git log --format='%an (%ae) [%h: %s]' -S '(c) The Bitcoin'`.\r\n\r\n<!--\r\n* The lower range can be wrong as well, so it could be omitted as well,\r\n  but this is left for a follow-up. A previous attempt was in\r\n  https://github.com/bitcoin/bitcoin/pull/26817.\r\n",
      "state": "closed",
      "user": "maflcko",
      "created_at": "2025-12-16T21:13:54Z",
      "updated_at": "2025-12-22T08:57:50Z",
      "comments": 6,
      "url": "https://github.com/bitcoin/bitcoin/pull/34084",
      "labels": [
        "Refactoring"
      ],
      "comment_list": [
        {
          "user": "DrahtBot",
          "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/34084.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [l0rinc](https://github.com/bitcoin/bitcoin/pull/34084#issuecomment-3670703429), [rkrux](https://github.com/bitcoin/bitcoin/pull/34084#pullrequestreview-3597905511), [janb84](https://github.com/bitcoin/bitcoin/pull/34084#pullrequestreview-3598648450) |\n| Approach ACK | [stickies-v](https://github.com/bitcoin/bitcoin/pull/34084#pullrequestreview-3587528249) |\n\nIf your review is incorrectly listed, please copy-paste <code>&lt;!--meta-tag:bot-skip--&gt;</code> into the comment that the bot should ignore.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nNo conflicts as of last run.\n<!--5faf32d7da4f0f540f40219e4f7537a3-->",
          "created_at": "2025-12-16T21:14:14Z"
        },
        {
          "user": "DrahtBot",
          "body": "<!--85328a0da195eb286784d51f73fa0af9-->\nðŸš§ At least one of the CI tasks failed.\n<sub>Task `lint`: https://github.com/bitcoin/bitcoin/actions/runs/20282910432/job/58249415928</sub>\n<sub>LLM reason (âœ¨ experimental): Lint failure: a subtree was touched without a proper subtree merge.</sub>\n\n<details><summary>Hints</summary>\n\nTry to run the tests locally, according to the documentation. However, a CI failure may still\nhappen due to a number of reasons, for example:\n\n* Possibly due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\n* A sanitizer issue, which can only be found by compiling with the sanitizer and running the\n  affected test.\n\n* An intermittent issue.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n</details>\n\n",
          "created_at": "2025-12-16T21:22:50Z"
        },
        {
          "user": "l0rinc",
          "body": "This is tangentially related to https://github.com/bitcoin/bitcoin/issues/29445 - I don't really mind either way, I just want to stop the stupid headers distracting code review.\r\n\r\nI have reviewed the change by:\r\n* validating the regex ðŸ‘ \r\n* scrolling mindlessly through https://github.com/bitcoin/bitcoin/pull/34084/files?diff=unified ðŸ‘\r\n* Manually checking https://patch-diff.githubusercontent.com/raw/bitcoin/bitcoin/pull/34084.patch and asking LLMs to proofread it as well ðŸ‘\r\n\r\nThis is officially the most boring PR ever! Looking forward to never having to touch or review the headers again :D\r\n\r\nNit: if you need to touch again, please consider:\r\n* making the regex case insensitive https://github.com/bitcoin/bitcoin/blob/01cc20f3307c532f402cdf5dc17f2f14920b725b/test/functional/mining_template_verification.py#L2\r\n* match empty end date: https://github.com/bitcoin/bitcoin/blob/01cc20f3307c532f402cdf5dc17f2f14920b725b/test/functional/p2p_ibd_stalling.py#L2\r\n* Do we need to add or update end dates to concrete ones like https://github.com/bitcoin/bitcoin/blob/01cc20f3307c532f402cdf5dc17f2f14920b725b/contrib/asmap/asmap.py#L1 or https://github.com/bitcoin/bitcoin/blob/01cc20f3307c532f402cdf5dc17f2f14920b725b/src/cuckoocache.h#L1 or https://github.com/bitcoin/bitcoin/blob/01cc20f3307c532f402cdf5dc17f2f14920b725b/test/functional/test_framework/key.py#L1?\r\n* Do we need to add one to https://github.com/bitcoin/bitcoin/blob/ad80abc73df38f94d887a905773c4500ca0c2961/src/test/kernel/block_data.h#L1 or https://github.com/bitcoin/bitcoin/blob/ad80abc73df38f94d887a905773c4500ca0c2961/src/test/caches_tests.cpp#L1  or https://github.com/bitcoin/bitcoin/commit/7990463b1059ba5fc4ebe37fd1105a9e168ae20d#diff-04e685224f1ac5bfd91d47d8d7528a2e44f94fab5535d4b6b5af79b5a13aeb93L1-L19 (was explicitly removed here)  or https://github.com/bitcoin/bitcoin/blob/ad80abc73df38f94d887a905773c4500ca0c2961/src/chainparamsseeds.h#L1 ?\r\n* if we're already doing this we could also update `http://www.opensource.org/licenses/mit-license.php` to `https://opensource.org/license/mit` (where it redirects), to have even less difference. But I don't really care, if others also don't care.\r\n\r\nACK fa5f29774872d18febc0df38831a6e45f3de69cc",
          "created_at": "2025-12-18T13:53:58Z"
        },
        {
          "user": "maflcko",
          "body": "> Nit: if you need to touch again, please consider:\r\n\r\nThanks, addressed those that are in scope for the issues listed in the pull request description. The others seem unrelated and can be addressed in a different pull request either now or later, if there is need to.",
          "created_at": "2025-12-18T14:38:02Z"
        },
        {
          "user": "l0rinc",
          "body": "ACK fa4cb13b52030c2e55c6bea170649ab69d75f758",
          "created_at": "2025-12-18T14:54:22Z"
        },
        {
          "user": "fanquake",
          "body": "Opened a followup to fix the 1 file difference, and remove the management script in #34119.",
          "created_at": "2025-12-19T16:52:44Z"
        }
      ]
    },
    {
      "number": 34083,
      "title": "Add initial vectorized chacha20 implementation for 2-3x speedup",
      "body": "Exploit modern simd to calculate 2/4/6/8/16 states at a time depending on the size of the input.\r\n\r\nThis demonstrates a 2x speedup on x86-64 and 3x for arm+neon. Platforms which require runtime detection (avx2/avx512) improve performance even further, and will come as a follow-up.\r\n\r\nRather than hand-writing assembly or using arch-specific intrinsics, this is written using compiler built-ins understood by gcc and clang.\r\n\r\nIn practice (at least on x86_64 and armv8), the compilers are able to produce assembly that's not much worse than hand-written.\r\n\r\nThis means that every architecture can benefit from its own vectorized instructions without having to write/maintain an implementation for each one. But because each will vary in ability to exploit the parallelism, we allow (via ifdefs) each architecture to opt-out of some or all multi-state calculation at compile-time..\r\n\r\nHere, as a starting point, x86-64 and arm+neon have been defined based on local benchmarks.\r\n\r\nLocal profiling revealed that chacha20 accounts for a substantial amount of the network thread's time. It's not clear to me if speeding up chacha20 will improve network performance/latency, but it will definitely make it more efficient.\r\n\r\nThis is part 1 of a series of PR's for chacha20. I think it makes sense to take a look at the generic implementation and tune the architecture-specific defines for parallel blocks before adding the runtime-dependent platforms.\r\n\r\nMy WIP branch which includes avx2/avx512 can be seen here: https://github.com/theuni/bitcoin/commits/chacha20-vectorized/\r\n\r\nI've been hacking on this for quite a while, trying every imaginable tweak and comparing lots of resulting asm/ir. I'm happy to answer any questions about any choices made which aren't immediately obvious.\r\n\r\nEdit: some more impl details:\r\n\r\nI wrestled with gcc/clang a good bit, tweaking something and comparing the generated code output. A few things I found, which may explain some of the decisions I made:\r\n\r\n- gcc really wanted to inline some of the helpers, which comes at a very substantial performance cost due to register clobbering (and with avx2, `vzeroupper`). Hence, all helpers are decorated with `ALWAYS_INLINE`.\r\n- gcc/clang do well with the vec256 loads/stores with minimal fussing. Though loading each element with `[]` is clumsy and verbose, it avoids compiler-specific layout assumptions. Other things I tried (which produced the same asm):\r\n  - casting directly to `using unaligned_vec256 __attribute__((aligned (1))) = vec256`\r\n  - memcpy into ^^\r\n  - clang's `__builtin_masked_load`\r\n- Loop unrolling was hit-or-miss without `#pragma GCC unroll n`, and I tried to avoid macros for loops, hence the awkward recursive inline template loops. But in practice, I see those unrolled 100% of the time.\r\n- I used `std::get` in the helpers for some extra compile-time safety (this actually pointed out some off-by-one's that would've been annoying to track down)\r\n- I avoided using any lambdas or classes for fear of compilers missing obvious optimizations\r\n- All `vec256` are passed by reference to avoid an annoying clang warning about returning a vector changing the abi (this is specific to x86 when not compiling with `-avx`). Even though our functions are all inlined, I didn't see any harm in making that adjustment.",
      "state": "open",
      "user": "theuni",
      "created_at": "2025-12-16T20:42:37Z",
      "updated_at": "2026-01-13T19:34:47Z",
      "comments": 12,
      "url": "https://github.com/bitcoin/bitcoin/pull/34083",
      "labels": [],
      "comment_list": [
        {
          "user": "DrahtBot",
          "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/34083.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\nA summary of reviews will appear here.\n<!--5faf32d7da4f0f540f40219e4f7537a3-->\n### LLM Linter (âœ¨ experimental)\n\n\n\nPossible typos and grammar issues:\n\n- \"32bytes\" -> \"32 bytes\" [missing space between number and unit]\n- \"which used to increment the states\" -> \"which are used to increment the states\" [missing auxiliary verb \"are\"]\n- \"256bit registers\" -> \"256â€‘bit registers\" [missing hyphen for the compound adjective; can be written as \"256-bit\" or \"256 bit\" for clarity]\n\n\n\n<sup>2026-01-13</sup>\n",
          "created_at": "2025-12-16T20:42:44Z"
        },
        {
          "user": "theuni",
          "body": "Adding pings for a few people I've discussed this with: @sipa @ajtowns @l0rinc ",
          "created_at": "2025-12-16T20:49:14Z"
        },
        {
          "user": "l0rinc",
          "body": "Looking forward to reviewing it - quick question before I do: was it tested on any big-endian systems which don't revert to non-vectorized run?",
          "created_at": "2025-12-17T08:11:01Z"
        },
        {
          "user": "theuni",
          "body": "An additional note about the actual vectorizing algorithm itself...\r\n\r\nThere's a different (and arguably more obvious) algorithm that's possible when calculating exactly 8 states. Rather than loading each `vec256` with partial info from 2 states, it's possible to use 16 `vec256` where each vector contains 1 element for each of the 8 states. It looks like:\r\n\r\n```c++\r\nvec256 x0, x1, x2, x3, x4, x5, x6, x7, x8, x9, x10, x11, x12, x13, x14, x15;\r\n\r\nbroadcast(x0, 0x61707865);\r\nbroadcast(x1, 0x3320646e);\r\nbroadcast(x2, 0x79622d32);\r\nbroadcast(x3, 0x6b206574);\r\nbroadcast(x4, input[0]);\r\n...\r\nbroadcast(x15, input[11]);\r\n\r\nQUARTERROUND( x0, x4, x8,x12);\r\nQUARTERROUND( x1, x5, x9,x13);\r\n...\r\n\r\nvec256 j0, j1, j2, j3, ... j31;\r\nextract_column(x0, x1, x2, x3, x4, x5, x6, x7, x8, x9, x10, x11, x12, x13, x14, x15, 0, j0, j1);\r\nextract_column(x0, x1, x2, x3, x4, x5, x6, x7, x8, x9, x10, x11, x12, x13, x14, x15, 1, j2, j3);\r\n...\r\nextract_column(x0, x1, x2, x3, x4, x5, x6, x7, x8, x9, x10, x11, x12, x13, x14, x15, 15, j30, j31);\r\n\r\nvec_read_xor_write(in_bytes, out_bytes, j0);\r\nvec_read_xor_write(in_bytes, out_bytes, j1);\r\n...\r\n\r\n```\r\n\r\nThe problem with this is the overhead of the transpose at the end. My experiments showed (on x86_64+avx2, at least) that this was actually slower than what's currently implemented. It's possible that this approach is better for other architectures, but I left it out of this PR to reduce the initial complexity.\r\n\r\nEdit: This is what the linux kernel does for x86_64+avx2. I grabbed their .S and hacked it into Core to benchmark, only to find that the impl here actually outperformed their hand-written asm. That was neat :)",
          "created_at": "2025-12-17T17:48:28Z"
        },
        {
          "user": "theuni",
          "body": "Ok, after some experimenting, I am very hesitant to add the helpers as suggested above. For example, consider @ajtowns's seemingly innocuous Repeat function:\r\n```c++\r\ntemplate <size_t REPS, typename Fn>\r\nALWAYS_INLINE void Repeat(Fn&& fn)\r\n{\r\n    if constexpr (REPS > 0) {\r\n        fn();\r\n        Repeat<REPS-1>(std::forward<Fn>(fn));\r\n    }\r\n}\r\n```\r\n\r\nThis causes a 10% slowdown on this branch, but with avx2 the performance is abysmal:\r\n\r\nBaseline(master):\r\n```\r\n|                1.38 |      723,275,584.44 | `CHACHA20_1MB`\r\n```\r\nThis PR:\r\n```\r\n|                0.71 |    1,408,751,284.34 | `CHACHA20_1MB`\r\n```\r\n[202512-pr34083-templates](https://github.com/ajtowns/bitcoin/commits/202512-pr34083-templates/)\r\n```\r\n|                0.79 |    1,258,748,451.87 | `CHACHA20_1MB`\r\n```\r\n\r\nThis PR + [avx2 commits](https://github.com/theuni/bitcoin/commits/chacha20-vectorized/):\r\n```\r\n|                0.50 |    1,988,653,922.83 |  `CHACHA20_1MB`\r\n```\r\n\r\n[202512-pr34083-templates](https://github.com/ajtowns/bitcoin/commits/202512-pr34083-templates/) + [avx2 commits](https://github.com/theuni/bitcoin/commits/chacha20-vectorized/):\r\n```\r\n|                1.34 |      748,148,324.75 | `CHACHA20_1MB`\r\n```\r\n\r\nThe problem in AJ's branch that some functions end up un-inlined. For clang, it's `doubleround`. For gcc it's `arr_read_xor_write` and `doubleround`.\r\n\r\nBoth are fixed with:\r\n```diff\r\ndiff --git a/src/crypto/chacha20_vec.ipp b/src/crypto/chacha20_vec.ipp\r\nindex 344c68259a5..16d7da45633 100644\r\n--- a/src/crypto/chacha20_vec.ipp\r\n+++ b/src/crypto/chacha20_vec.ipp\r\n@@ -164 +164 @@ public:\r\n-        Repeat<10>([&]() {\r\n+        Repeat<10>([&]() __attribute__ ((always_inline)) {\r\n```\r\n\r\nThat means, to be safe, every lambda would need that attribute, which is pretty ugly and easy to forget. So I think my aversion to lambdas in this code was somewhat justified.\r\n\r\nFurther, clang's [inlining docs](https://clang.llvm.org/docs/analyzer/developer-docs/IPA.html) state that variadic functions aren't inlined. Experimenting now, that's obviously not true as of v21-git. But clearly it was in the recent past.\r\n\r\nSo.. I'd _really_ prefer to keep things as simple here as possible. I know the recursive template functions aren't exactly pretty, but I don't think they're _THAT_ bad? Plus, with c++26, it all goes away in favor of `template for` :)",
          "created_at": "2025-12-17T21:46:10Z"
        },
        {
          "user": "ajtowns",
          "body": "> So.. I'd _really_ prefer to keep things as simple here as possible. I know the recursive template functions aren't exactly pretty, but I don't think they're _THAT_ bad? Plus, with c++26, it all goes away in favor of `template for` :)\r\n\r\nCould we get some comments in the code as to compiler versions (and architecture) that failed to be efficient enough with lambdas, to hopefully avoid future people modernizing the code without checking that these problems have gone away? Presumably will be a long time before we can modernize to `template for` (which doesn't even seem to be on [cppref's compiler support page](https://en.cppreference.com/w/cpp/compiler_support.html) yet?)...\r\n\r\n(Only thing that I do think is \"that bad\" about the recursive templates is using `ITER` and `I` -- `i` should be the loop variable, not the size!)",
          "created_at": "2025-12-18T01:38:13Z"
        },
        {
          "user": "theuni",
          "body": "> Could we get some comments in the code as to compiler versions (and architecture) that failed to be efficient enough with lambdas, to hopefully avoid future people modernizing the code without checking that these problems have gone away? Presumably will be a long time before we can modernize to `template for` (which doesn't even seem to be on [cppref's compiler support page](https://en.cppreference.com/w/cpp/compiler_support.html) yet?)...\r\n> \r\n> (Only thing that I do think is \"that bad\" about the recursive templates is using `ITER` and `I` -- `i` should be the loop variable, not the size!)\r\n\r\nSure, I can definitely add some more context and clean up the wonky variable names.\r\n\r\nAnother brain dump after thinking about all this some more last night:\r\n\r\n1. I don't think lambdas specifically are the problem, more specifically, the issue is: can the compiler infer enough about the \"callback\" function to inline it?\r\n\r\nThere are a few considerations there. @sipa's `make_index_sequence` suggestion is executed immediately, so I imagine that's more likely to be inlined than AJ's `Repeat`. But still, from a compiler's POV, if it's evaluating: \"here's a function call without `ALWAYS_INLINE` and my function is already huge, should I exclude it from inlining?\", imo it'd be reasonable for it to conclude \"yes\".\r\n\r\nSo to be safe, whatever we do, I think we should strive to annotate all functions. And imo, annotating a bunch of lambdas with an inline attribute feels weird.\r\n\r\n(as an aside: There's also the `flatten` attribute, which could be added to `multi_block_crypt` as a belt-and-suspenders)\r\n\r\nThe `index_sequence` trick is neat. If that ends up looking cleaner/more obvious than the recursive iteration, that works for me. I'll play around with it.\r\n\r\n2. Not all loops have to be unrolled.\r\n\r\nIn my testing, loop unrolling always showed slightly better performance (presumably because calculating multiple blocks is otherwise branch-free), but it's not nearly as performance-critical as the inlining. For example, skipping unrolling of `doubleround` leads to _much_ smaller code, which I imagine could end up being faster on some architectures.\r\n\r\n> Is there any way we could help that would make you reconsider? I don't mind running the benchmarks on a few platforms, as long as we can have simpler code. The current template magic is not something I would like to see more of - modern C++20 should be able to handle the situations we have here.\r\n\r\nMy primary goal with this code (and hopefully setting a precedent for other multi-arch simd code... poly1305 is next ;) is to be as explicit to the compiler about what we want as possible. Ideally as portably as possible. So if we want our functions inlined or loops unrolled, we should attempt to communicate those things opposed to leaving them implicit. Unfortunately, modern c++ doesn't have ways to express either of those yet, but we can make our intentions clear enough.",
          "created_at": "2025-12-18T15:52:48Z"
        },
        {
          "user": "ajtowns",
          "body": "> And imo, annotating a bunch of lambdas with an inline attribute feels weird.\r\n\r\nYou could `#define AI __attribute__((always_inline))`, then you'd just be adding `AI` to all the lambdas, which, if nothing else, would be very modern?\r\n\r\n> My primary goal with this code (and hopefully setting a precedent for other multi-arch simd code... poly1305 is next ;) is to be as explicit to the compiler about what we want as possible. Ideally as portably as possible. \r\n\r\nThe above was kind-of a joke, but, perhaps you could combine it with a clang-tidy plugin that lets CI check that all lambdas in a particular namespace are annotated in that way? That might be both clear to compilers and reasonably friendly to human authors/reviewers?\r\n\r\n(Explicit recursive templates and prohibiting lambdas are fine by me though; that's still a big step up from inline asm)",
          "created_at": "2025-12-19T09:38:43Z"
        },
        {
          "user": "l0rinc",
          "body": "I have measured its effect on IBD and happy to say it produces a measurable speedup.\r\n\r\n<img width=\"1474\" height=\"846\" alt=\"image\" src=\"https://github.com/user-attachments/assets/a660986e-c752-4670-8dcf-595f6742520d\" />\r\n\r\n<details>\r\n<summary>IBD | 926619 blocks | dbcache 450 | i7-hdd | x86_64 | Intel(R) Core(TM) i7-7700 CPU @ 3.60GHz | 8 cores | 62Gi RAM | ext4 | HDD</summary>\r\n\r\n```\r\nCOMMITS=\"938d7aacabd0bb3784bb3e529b1ed06bb2891864 3bddf59cd3f201ecf8d65bb1f6c0cde5c39595e9\"; \\\r\nSTOP=926619; DBCACHE=450; \\\r\nCC=gcc; CXX=g++; \\\r\nBASE_DIR=\"/mnt/my_storage\"; DATA_DIR=\"$BASE_DIR/BitcoinData\"; LOG_DIR=\"$BASE_DIR/logs\"; \\\r\n(echo \"\"; for c in $COMMITS; do git fetch -q origin $c && git log -1 --pretty='%h %s' $c || exit 1; done) && \\\r\n(echo \"\" && echo \"IBD | ${STOP} blocks | dbcache ${DBCACHE} | $(hostname) | $(uname -m) | $(lscpu | grep 'Model name' | head -1 | cut -d: -f2 | xargs) | $(nproc) cores | $(free -h | awk '/^Mem:/{print $2}') RAM | $(df -T $BASE_DIR | awk 'NR==2{print $2}') | $(lsblk -no ROTA $(df --output=source $BASE_DIR | tail -1) | grep -q 0 && echo SSD || echo HDD)\"; echo \"\") &&\\\r\nhyperfine \\\r\n  --sort command \\\r\n  --runs 2 \\\r\n  --export-json \"$BASE_DIR/ibd-$(sed -E 's/(\\w{8})\\w+ ?/\\1-/g;s/-$//'<<<\"$COMMITS\")-$STOP-$DBCACHE-$CC.json\" \\\r\n  --parameter-list COMMIT ${COMMITS// /,} \\\r\n  --prepare \"killall -9 bitcoind 2>/dev/null; rm -rf $DATA_DIR/*; git checkout {COMMIT}; git clean -fxd; git reset --hard && \\\r\n    cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo && ninja -C build bitcoind -j2 && \\\r\n    ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=1 -printtoconsole=0; sleep 20\" \\\r\n  --conclude \"cp $DATA_DIR/debug.log $LOG_DIR/debug-{COMMIT}-$(date +%s).log && \\\r\n             grep -q 'height=0' $DATA_DIR/debug.log && grep -q 'Disabling script verification at block #1' $DATA_DIR/debug.log && grep -q 'height=$STOP' $DATA_DIR/debug.log\" \\\r\n  \"COMPILER=$CC ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=$DBCACHE -blocksonly -printtoconsole=0\"\r\n```\r\n\r\n> 938d7aacab Merge bitcoin/bitcoin#33657: rest: allow reading partial block data from storage\r\n> 3bddf59cd3 chacha20: Add generic vectorized chacha20 implementation\r\n\r\n```\r\nBenchmark 1: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=926619 -dbcache=450 -blocksonly -printtoconsole=0 (COMMIT = 938d7aacabd0bb3784bb3e529b1ed06bb2891864)\r\n  Time (mean Â± Ïƒ):     45198.232 s Â± 539.231 s    [User: 57185.689 s, System: 4367.881 s]\r\n  Range (min â€¦ max):   44816.939 s â€¦ 45579.526 s    2 runs\r\n \r\nBenchmark 2: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=926619 -dbcache=450 -blocksonly -printtoconsole=0 (COMMIT = 3bddf59cd3f201ecf8d65bb1f6c0cde5c39595e9)\r\n  Time (mean Â± Ïƒ):     43699.641 s Â± 25.532 s    [User: 57610.736 s, System: 4058.824 s]\r\n  Range (min â€¦ max):   43681.587 s â€¦ 43717.695 s    2 runs\r\n \r\nRelative speed comparison\r\n        1.03 Â±  0.01  COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=926619 -dbcache=450 -blocksonly -printtoconsole=0 (COMMIT = 938d7aacabd0bb3784bb3e529b1ed06bb2891864)\r\n        1.00          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=926619 -dbcache=450 -blocksonly -printtoconsole=0 (COMMIT = 3bddf59cd3f201ecf8d65bb1f6c0cde5c39595e9)\r\n```\r\n\r\n</details>\r\n\r\n",
          "created_at": "2025-12-22T08:18:17Z"
        },
        {
          "user": "ajtowns",
          "body": "> I have measured its effect on IBD and happy to say it produces a measurable speedup.\r\n\r\nPresumably that indicates this IBD run is compute bound (vs disk or network), and that ChaCha20 is using up maybe 7% of CPU time (or 7% of a core when we're bottlenecked on something single-threaded) prior to this PR. That seems like a lot? Is this due to FastRandomContext, or something else? Or is it just that obfuscating all the block data is a large component of IBD CPU currently? This seems a bit surprising to me.",
          "created_at": "2025-12-24T07:50:01Z"
        },
        {
          "user": "theuni",
          "body": "> Presumably that indicates this IBD run is compute bound (vs disk or network), and that ChaCha20 is using up maybe 7% of CPU time (or 7% of a core when we're bottlenecked on something single-threaded) prior to this PR. That seems like a lot? Is this due to FastRandomContext, or something else? Or is it just that obfuscating all the block data is a large component of IBD CPU currently? This seems a bit surprising to me.\r\n\r\nNot sure if you missed this in the description, but that's exactly what this is trying to improve:\r\n> Local profiling revealed that chacha20 accounts for a substantial amount of the network thread's time. It's not clear to me if speeding up chacha20 will improve network performance/latency, but it will definitely make it more efficient.\r\n\r\nIBD would indeed be slowed by Chacha20 via single-threaded bip324 handling on the network thread. [While profiling my POC multi-process net binary](https://github.com/bitcoin-core/libmultiprocess/issues/215) I observed `ChaCha20Aligned::Crypt()` accounting for 30% of the net thread's cpu time.\r\n\r\nSo it's not surprising to me at all that 3x'ing that function (it's only 2x here, avx2/avx512 improve performance even more) speeds up IBD.",
          "created_at": "2026-01-06T21:18:08Z"
        },
        {
          "user": "theuni",
          "body": "I finally managed to track down the gcc slowdown that @l0rinc mentioned during last week's IRC meeting. The culprit was [this gcc bug](https://gcc.gnu.org/bugzilla/show_bug.cgi?id=107563#c14). Thankfully, it's easily worked around by simply not calling the guilty builtin.\r\n\r\nAlso pushed @l0rinc's fix for big-endian.\r\n\r\nNow that gcc/clang are more on par and the impl seems feasible again, I'll address the other feedback.",
          "created_at": "2026-01-13T19:34:47Z"
        }
      ]
    },
    {
      "number": 34082,
      "title": "doc: clarify description of Bitcoin Core",
      "body": "This PR slightly clarifies the description of Bitcoin Core to better explain\r\nits role in independently validating blocks and transactions.\r\n",
      "state": "closed",
      "user": "gitty-prakhar",
      "created_at": "2025-12-16T19:22:05Z",
      "updated_at": "2025-12-16T19:25:35Z",
      "comments": 2,
      "url": "https://github.com/bitcoin/bitcoin/pull/34082",
      "labels": [
        "Docs"
      ],
      "comment_list": [
        {
          "user": "DrahtBot",
          "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/34082.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\nA summary of reviews will appear here.\n<!--5faf32d7da4f0f540f40219e4f7537a3-->",
          "created_at": "2025-12-16T19:22:12Z"
        },
        {
          "user": "maflcko",
          "body": "thx, but the current wording seems completely fine",
          "created_at": "2025-12-16T19:25:35Z"
        }
      ]
    },
    {
      "number": 34081,
      "title": "build: Fix source paths for debugging in CMake",
      "body": "<!--\r\n*** Please remove the following help text before submitting: ***\r\n\r\nPull requests without a rationale or clear improvement may be closed\r\nimmediately.\r\n\r\nGUI-related pull requests should be opened against\r\nhttps://github.com/bitcoin-core/gui\r\nfirst. See CONTRIBUTING.md\r\n-->\r\n\r\n<!--\r\nPlease provide clear motivation for your patch and explain how it improves\r\nBitcoin Core user experience or Bitcoin Core developer experience\r\nsignificantly:\r\n\r\n* Any test improvements or new tests that improve coverage are always welcome.\r\n* All other changes should have accompanying unit tests (see `src/test/`) or\r\n  functional tests (see `test/`). Contributors should note which tests cover\r\n  modified code. If no tests exist for a region of modified code, new tests\r\n  should accompany the change.\r\n* Bug fixes are most welcome when they come with steps to reproduce or an\r\n  explanation of the potential issue as well as reasoning for the way the bug\r\n  was fixed.\r\n* Features are welcome, but might be rejected due to design or scope issues.\r\n  If a feature is based on a lot of dependencies, contributors should first\r\n  consider building the system outside of Bitcoin Core, if possible.\r\n* Refactoring changes are only accepted if they are required for a feature or\r\n  bug fix or otherwise improve developer experience significantly. For example,\r\n  most \"code style\" refactoring changes require a thorough explanation why they\r\n  are useful, what downsides they have and why they *significantly* improve\r\n  developer experience or avoid serious programming bugs. Note that code style\r\n  is often a subjective matter. Unless they are explicitly mentioned to be\r\n  preferred in the [developer notes](/doc/developer-notes.md), stylistic code\r\n  changes are usually rejected.\r\n-->\r\n\r\n<!--\r\nBitcoin Core has a thorough review process and even the most trivial change\r\nneeds to pass a lot of eyes and requires non-zero or even substantial time\r\neffort to review. There is a huge lack of active reviewers on the project, so\r\npatches often sit for a long time.\r\n-->\r\nWith the build workflow change from Autotools to CMake, the debug information became incorrect due to outdated file path remapping (#31204). This issue comes from a workaround that was needed in the previous build system (#21885 problem, which was addressed in #20353 and later again on #22409. ).\r\n\r\nThis PR attempts to resolve the problem by correcting the file path remapping for the new out-of-source build.\r\n\r\nI have tested the fix both in the terminal using GDB and in VS Code using LLDB\r\n\r\nAfter my changes, I tested by running `gdb`:\r\n```\r\ncmake -DCMAKE_BUILD_TYPE=Debug -B build \r\ncmake --build build -j \"$(($(nproc)/2+1))\"\r\n\r\ngdb  build/bin/bitcoind\r\nbreak init.cpp:1848\r\nrun  -regtest \r\n      Thread 1 \"bitcoind\" hit Breakpoint 1, AppInitMain (node=..., tip_info=0x0) at ./init.cpp:1848\r\n       1848        if (args.GetBoolArg(\"-txindex\", DEFAULT_TXINDEX)) {\r\n```\r\nAnd also with `lldb` and vscode using the following `.vscode/launch.json`:\r\n```\r\n{\r\n\"version\": \"0.2.0\",\r\n\"configurations\": [\r\n\t{\r\n\t\"type\": \"lldb\",\r\n\t\"request\": \"launch\",\r\n\t\"name\": \"Debug\",\r\n\t\"program\": \"${workspaceFolder}/build/bin/bitcoind\",\r\n\t\"args\": [\r\n\t\t\"-regtest\"\r\n\t],\r\n\t\"cwd\": \"${workspaceFolder}\",\r\n\t}\r\n]\r\n}\r\n```\r\n## Alternatives\r\nIf this PR is not considered, I have two alternative proposals:\r\n- Update the doc to remove the text indicating the user must debug from the root of the project\r\n- PR #https://github.com/bitcoin/bitcoin/pull/32205 Update the doc indicating they must use  `set substitute-path path/to/build/src /path/to/project/root/src`\r\n\r\n",
      "state": "closed",
      "user": "arejula27",
      "created_at": "2025-12-16T18:20:47Z",
      "updated_at": "2026-01-02T14:13:13Z",
      "comments": 16,
      "url": "https://github.com/bitcoin/bitcoin/pull/34081",
      "labels": [
        "Build system"
      ],
      "comment_list": [
        {
          "user": "DrahtBot",
          "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/34081.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Concept ACK | [pinheadmz](https://github.com/bitcoin/bitcoin/pull/34081#issuecomment-3684119131), [ismaelsadeeq](https://github.com/bitcoin/bitcoin/pull/34081#issuecomment-3689505073) |\n\nIf your review is incorrectly listed, please copy-paste <code>&lt;!--meta-tag:bot-skip--&gt;</code> into the comment that the bot should ignore.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#34116](https://github.com/bitcoin/bitcoin/pull/34116) (cmake: Fix debugging info by hebasto)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n<!--5faf32d7da4f0f540f40219e4f7537a3-->",
          "created_at": "2025-12-16T18:20:58Z"
        },
        {
          "user": "maflcko",
          "body": "See https://github.com/bitcoin/bitcoin/issues/31204#issuecomment-3548048120",
          "created_at": "2025-12-16T19:41:12Z"
        },
        {
          "user": "arejula27",
          "body": "re: @maflcko \r\n> See [#31204 (comment)](https://github.com/bitcoin/bitcoin/issues/31204#issuecomment-3548048120)\r\n\r\nI didnâ€™t see this, thank you. The issue points exactly to the problem Iâ€™m trying to fix. I see that the proposed solution in #32205 addresses the problem by updating the documentation. While that might work, it doesnâ€™t actually fix the underlying issue and requires updating the paths for each build (some users may run `cmake -B debug-build1` and `cmake -B debug-build2` . My proposal avoids additional user configuration, and it is more dynamic as it uses variables within CMake (`PROJECT_BINARY_DIR`)",
          "created_at": "2025-12-16T19:52:20Z"
        },
        {
          "user": "maflcko",
          "body": "How is your patch different from just removing the prefix-map option?",
          "created_at": "2025-12-16T19:56:25Z"
        },
        {
          "user": "arejula27",
          "body": "As I understand the problem, the solution is not removing the prefix-map option but changing where it points. This can be done either in `.lldbinit`, `.gdbinit`, or in CMake. My proposal simply removes friction for the developer, as it will not require them to put a path in their configuration.\r\n\r\ni propose modifying the cmake: `\"-fdebug-prefix-map=${PROJECT_BINARY_DIR}/src=${PROJECT_SOURCE_DIR}/src\"`\r\n\r\nThe #32205 proposes suggesting users to modify the debugger config: `settings set target.source-map /path/to/bitcoin/build/src /path/to/bitcoin/src`\r\n\r\nIt will have the same outcome, but mine will be automatically done. Also it is more interoperable as I mentioned i it worked with gdb and lldb, while in the other case I would require to configure both debuggers\r\n\r\n\r\n\r\n\r\n\r\n",
          "created_at": "2025-12-16T20:01:07Z"
        },
        {
          "user": "maflcko",
          "body": "> As I understand the problem, the solution is not removing the prefix-map option but changing where it points.\r\n\r\nYes, but I am asking why? What would be the observable difference? It just seems odd to have code that doesn't achieve anything.\r\n\r\nAt least last time I checked, the two seemed to achieve the same: https://github.com/bitcoin/bitcoin/issues/31957#issuecomment-3548048725",
          "created_at": "2025-12-16T20:11:30Z"
        },
        {
          "user": "arejula27",
          "body": "Just tested what you mean, removed:\r\n```\r\n-try_append_cxx_flags(\"-fdebug-prefix-map=A=B\" TARGET core_interface SKIP_LINK\r\n-  IF_CHECK_PASSED \"-fdebug-prefix-map=${PROJECT_SOURCE_DIR}/src=.\"\r\n-)\r\n``` \r\nIt had the same effect, yes, make more sense removing code that makes an incorrect behaviour than adding more above it. I will try to research if it has any advantages, but in other cas,e the correct approach should be to remove the incorrect mapping\r\n\r\nEdit: @hebasto  pointed out that removing it might resurface an issue (https://github.com/bitcoin/bitcoin/issues/30799.)  I will try to look into it https://github.com/bitcoin/bitcoin/issues/31957#issuecomment-3567810672",
          "created_at": "2025-12-16T20:24:51Z"
        },
        {
          "user": "maflcko",
          "body": "> Edit: @hebasto pointed out that removing it might resurface an issue (#30799.) I will try to look into it [#31957 (comment)](https://github.com/bitcoin/bitcoin/issues/31957#issuecomment-3567810672)\r\n\r\nThis may be a macro, and not the debug info, so may be fine, but I haven't checked this.",
          "created_at": "2025-12-16T20:42:29Z"
        },
        {
          "user": "arejula27",
          "body": "I have analysed how the different debug information is stored in the master branch, using my changes and removing the remaps (your proposal ). The observable difference is in how DWARF debug information records source file paths.\r\n\r\nHere are the three scenarios I tested with `objdump` to extract the info:\r\n```bash\r\nobjdump -g ./build/bin/bitcoind | grep -A5 -B5 \"src/\" \r\n```\r\n\r\n## First case (master branch â€“ remap relative path for old project layout)\r\n\r\n```text\r\n<3674904>   DW_AT_name        : (indirect line string, offset: 0x5f8a): ./wallet/interfaces.cpp\r\n<3674908>   DW_AT_comp_dir    : (indirect line string, offset: 0x5f4f): /home/arejula27/workspaces/bitcoin/build-master/src/wallet\r\n<367490c>   DW_AT_ranges      : 0xedf1f\r\n```\r\n\r\n- DW_AT_comp_dir points to a build directory (build-master/src/wallet)\r\n- This indicates an out-of-tree build (build and src folders are not the same)\r\n- The debug info records paths relative to the build tree\r\n\r\n## Second case (with my changes, remap relative path correctly)\r\n\r\n```text\r\n<3674904>   DW_AT_name        : (indirect line string, offset: 0x5f70): ./wallet/interfaces.cpp\r\n<3674908>   DW_AT_comp_dir    : (indirect line string, offset: 0x5f42): /home/arejula27/workspaces/bitcoin/src/wallet\r\n```\r\n\r\n- DW_AT_comp_dir points to the source directory (src/wallet)\r\n- This indicates an in-tree-like behaviour for paths (build and src folders are the same)\r\n- The debug info records paths relative to the source tree \r\n\r\n## Third case (removing the flags entirely, use absolute path)\r\n\r\n```text\r\n<18>   DW_AT_name        : (indirect string, offset: 0x32): /home/arejula27/workspaces/bitcoin/src/bitcoind.cpp\r\n<1c>   DW_AT_comp_dir    : (indirect string, offset: 0): /home/arejula27/workspaces/bitcoin/build-clean/src\r\n```\r\n\r\n- DW_AT_name contains an absolute path to the source file (src/bitcoind.cpp)\r\n- DW_AT_comp_dir points to a build directory (build-clean/src)\r\n- This indicates an out-of-tree build\r\n- The debug info records the full source path directly, not relative to the build or source tree\r\n\r\n## Conclusion\r\nSo replying to:\r\n> What would be the observable difference? It just seems odd to have code that doesn't achieve anything.\r\n\r\nThe difference is in storing absolute paths or relative ones. The current branch is just wrong, it points incorrectly. The decision is whether you prefer a relative or an absolute path. I read on some old related issues/pr that relative paths are better for tools like *ccache*, but I am not an expert on that.",
          "created_at": "2025-12-17T23:19:34Z"
        },
        {
          "user": "maflcko",
          "body": "> Second case (with my changes, remap relative path correctly)\r\n\r\nIt is interesting that this is using relative paths. I had the impression that `  \"-fdebug-prefix-map=${PROJECT_BINARY_DIR}/src=${PROJECT_SOURCE_DIR}/src\"` has absolute paths on both sides of the mapping.\r\n\r\n\r\n\r\n> The difference is in storing absolute paths or relative ones. The current branch is just wrong, it points incorrectly. The decision is whether you prefer a relative or an absolute path. I read on some old related issues/pr that relative paths are better for tools like _ccache_, but I am not an expert on that.\r\n\r\nI think the ccache  behavior is currently broken anyway (https://github.com/bitcoin/bitcoin/pull/30861 was closed), so there is little that can be broken by removing the code.\r\n\r\nOf course, everything will still need to be tested to confirm the fixes and no new breakages.\r\n\r\nYou'll have to include in the pull request descriptions, which bugs are fixed. Also, mentioning autogen and configure doesn't really help, when the project here is using cmake.",
          "created_at": "2025-12-19T08:53:32Z"
        },
        {
          "user": "pinheadmz",
          "body": "concept ACK, this works for source code in `src/` when debugging `bitcoind` but more changes are needed, for example, to debug `test_bitcoin`.\r\n\r\nThis is a much better fix than just updating docs like #32205\r\n\r\n## Example that works: bitcoind, set breakpoint at `BindListenPort`\r\n\r\nmaster:\r\n\r\n```\r\nProcess 92900 stopped\r\n* thread #1, queue = 'com.apple.main-thread', stop reason = breakpoint 1.1\r\n    frame #0: 0x00000001002c9720 bitcoind`CConnman::BindListenPort(this=0x0000000121009a00, addrBind=0x000000016fdfa980, strError=0x000000016fdfa950, permissions=None) at net.cpp:3139:9\r\nTarget 0: (bitcoind) stopped.\r\n```\r\n\r\nPR:\r\n\r\n```\r\nProcess 97697 stopped\r\n* thread #1, queue = 'com.apple.main-thread', stop reason = breakpoint 1.1\r\n    frame #0: 0x00000001002c56f0 bitcoind`CConnman::BindListenPort(this=0x000000012b80e000, addrBind=0x000000016fdfab60, strError=0x000000016fdfab30, permissions=None) at net.cpp:3139:9\r\n   3136 \r\n   3137 bool CConnman::BindListenPort(const CService& addrBind, bilingual_str& strError, NetPermissionFlags permissions)\r\n   3138 {\r\n-> 3139     int nOne = 1;\r\n   3140 \r\n   3141     // Create socket for listening for incoming connections\r\n   3142     struct sockaddr_storage sockaddr;\r\nTarget 0: (bitcoind) stopped.\r\n```\r\n\r\n## Example that doesn't work: `test_bitcoin`, set breakpoint at `GetCheckRatio()` in `addrman_tests`\r\n\r\nboth master and PR:\r\n\r\n```\r\nProcess 97809 stopped\r\n* thread #1, name = 'b-test', queue = 'com.apple.main-thread', stop reason = breakpoint 1.1\r\n    frame #0: 0x0000000100169820 test_bitcoin`GetCheckRatio(node_ctx=0x000000016fdfa9b8) at addrman_tests.cpp:32:32\r\nTarget 0: (test_bitcoin) stopped.\r\n```",
          "created_at": "2025-12-22T20:53:31Z"
        },
        {
          "user": "arejula27",
          "body": "re: @maflcko \r\n> You'll have to include in the pull request descriptions, which bugs are fixed. Also, mentioning autogen and configure doesn't really help, when the project here is using cmake.\r\n\r\nThank you for your feedback. This is my first PR, so any advice is welcome. Iâ€™ve edited the description to better summarize the change and to point directly to the specific bug being addressed.",
          "created_at": "2025-12-24T10:40:35Z"
        },
        {
          "user": "arejula27",
          "body": "re: @pinheadmz \r\n>  this works [...] when  debugging bitcoind but more changes are needed, for example, to debug test_bitcoin\r\n\r\nGood point,  Iâ€™ll try to address this as well. Is there any other binary youâ€™d like me to verify? I donâ€™t think the functional tests are related to this PR, but I might be others I am  missing.",
          "created_at": "2025-12-24T10:43:01Z"
        },
        {
          "user": "ismaelsadeeq",
          "body": "Concept ACK \r\n\r\nThis works for me out of the box\r\n\r\n```python3\r\nProcess 98441 stopped\r\n* thread #36, name = 'b-msghand', stop reason = breakpoint 1.1\r\n    frame #0: 0x00000001002d8a3c bitcoind`(anonymous namespace)::PeerManagerImpl::ProcessMessage(this=0x00000007e703d400, pfrom=0x0000000103b6b430, msg_type=\"version\", vRecv=0x000000017111eb30, time_received=1766574637095060 Âµs, interruptMsgProc=0x00000007e703d240) at net_processing.cpp:3431:5\r\n   3428\t                                     const std::chrono::microseconds time_received,\r\n   3429\t                                     const std::atomic<bool>& interruptMsgProc)\r\n   3430\t{\r\n-> 3431\t    AssertLockHeld(g_msgproc_mutex);\r\n   3432\t\r\n   3433\t    LogDebug(BCLog::NET, \"received: %s (%u bytes) peer=%d\\n\", SanitizeString(msg_type), vRecv.size(), pfrom.GetId());\r\n   3434\t\r\nTarget 0: (bitcoind) stopped.\r\n(lldb) \r\n```\r\n\r\nI also saw the same behaviour as @pinheadmz for test_bitcoin\r\n\r\nYou can see the list of binaries using\r\n```terminal\r\n ls build/bin\r\nbitcoin*        bitcoin-cli*    bitcoin-node*   bitcoin-tx*     bitcoin-util*   bitcoin-wallet* bitcoind*       test_bitcoin*\r\n```",
          "created_at": "2025-12-24T11:12:45Z"
        },
        {
          "user": "arejula27",
          "body": "This PR conflicts with #34116, which solves the same issue. After reviewing it i believe #34116 is a better approach. I would keep this one open to receive other opinions, but this PR should be closed if  #34116 is preferred by the community",
          "created_at": "2025-12-24T13:03:27Z"
        },
        {
          "user": "fanquake",
          "body": "> After reviewing it i believe https://github.com/bitcoin/bitcoin/pull/34116 is a better approach.\r\n\r\nThanks, we'll close this in favour of #34116 for now.",
          "created_at": "2026-01-02T14:13:12Z"
        }
      ]
    },
    {
      "number": 34080,
      "title": "ci: Pin native tests on cross-builds to same commit",
      "body": "After commit 13809b867ad980a12f886316b18bb2d3d2848ac2, the native tests may check out a different commit than the cross-build task that produced the artefacts they run on.\r\n\r\nObviously, this may lead to test failures.\r\n\r\nFix it, by first determining a fixed commit, to be used for both the build and the native tests.\r\n\r\nAn alternative could be to fully or partially revert 13809b867ad980a12f886316b18bb2d3d2848ac2, but that comes again with the downsides making it harder to detect silent merge conflicts by re-running CI, or clearing unrelated and fixed intermittent test issues by re-running CI. Then, the only alternative would be to close and re-open the pull request.",
      "state": "closed",
      "user": "maflcko",
      "created_at": "2025-12-16T08:08:37Z",
      "updated_at": "2025-12-17T15:17:53Z",
      "comments": 7,
      "url": "https://github.com/bitcoin/bitcoin/pull/34080",
      "labels": [
        "Tests"
      ],
      "comment_list": [
        {
          "user": "DrahtBot",
          "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/34080.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [janb84](https://github.com/bitcoin/bitcoin/pull/34080#pullrequestreview-3584509441), [ryanofsky](https://github.com/bitcoin/bitcoin/pull/34080#pullrequestreview-3584713222), [hodlinator](https://github.com/bitcoin/bitcoin/pull/34080#pullrequestreview-3587725439) |\n\nIf your review is incorrectly listed, please copy-paste <code>&lt;!--meta-tag:bot-skip--&gt;</code> into the comment that the bot should ignore.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#33593](https://github.com/bitcoin/bitcoin/pull/33593) (guix: Use UCRT runtime for Windows release binaries by hebasto)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n<!--5faf32d7da4f0f540f40219e4f7537a3-->",
          "created_at": "2025-12-16T08:08:44Z"
        },
        {
          "user": "janb84",
          "body": "I'm not sure why this only applies for the windows builds. I would say this needs to be resolved for everything not only windows.\r\n\r\nAs I see it, in https://github.com/bitcoin/bitcoin/commit/13809b867ad980a12f886316b18bb2d3d2848ac2 we circumvented the standard behavior of determine state of repo once to determine every time. \r\nThis behavior is now excessive, as in the state of repo can change mid run, resulting in the possibility of mid run changes (eg testing and compiling differences).\r\n\r\nIn my mind the checkout step should be changed to first fix the state of the repo and then use that fixed state during the whole run. ",
          "created_at": "2025-12-16T12:06:28Z"
        },
        {
          "user": "maflcko",
          "body": "> I'm not sure why this only applies for the windows builds. I would say this needs to be resolved for everything not only windows.\r\n\r\nWhy? The other tasks do not split the build and tests into two task, each with a different checkout, so how would they run into this class of issue?",
          "created_at": "2025-12-16T12:09:20Z"
        },
        {
          "user": "janb84",
          "body": "> > I'm not sure why this only applies for the windows builds. I would say this needs to be resolved for everything not only windows.\r\n> \r\n> Why? The other tasks do not split the build and tests into two task, each with a different checkout, so how would they run into this class of issue?\r\n\r\nNo, you are correct but I think that you have discovered something more broadly applicable. \r\n \r\nCorrect me I'm wrong, but because we now do not \"fixate\" the state of the repo on creation, we can run into the following:\r\n\r\nThe matrix run checksout and merges 000001 ands starts running.\r\nIn the mean time the master branch changes to 0000002\r\nThe windows build start running and checksout and merges 0000002.\r\n\r\nNow this does not cause any trouble because the matrix tests what it compiles, but the matrix run differs from the windows because of the mid run pr merge. But It only shows in the windows builds because of the change in compile vs testing state. ",
          "created_at": "2025-12-16T12:20:24Z"
        },
        {
          "user": "maflcko",
          "body": "Yeah, I think this is fine for different CI tasks in one check run to run on different commits.\r\n\r\nHowever, it would also be possible to freeze the commit for all CI tasks. This would also mean that on a re-run (for a silent merge conflict check, or to get rid of an intermittent test issue) can only be done for all tasks, or none.\r\n\r\nNot sure which one is preferable, but happy to push either approach.",
          "created_at": "2025-12-16T12:40:17Z"
        },
        {
          "user": "maflcko",
          "body": "> Overall, I don't like how adding a `checkout-commit` job complicates the build graph and doesn't let the windows-cross job use the latest sources on reruns like other jobs,\r\n\r\nActually, it makes it easier to re-run with the latest sources: Previously, it is not possible to re-run only one \"leg\" of the matrix with one click of a button. Also, it is not possible to run the full matrix with one click.\r\n\r\nNow, it is possible to run the full matrix with both \"legs\" in one click, by re-running the new parent job.",
          "created_at": "2025-12-16T16:58:24Z"
        },
        {
          "user": "maflcko",
          "body": "\r\n> I'm surprised the Windows runners are able to find the commit resulting from a merge between PR & master that happened on an Ubuntu runner. But looking at the CI logs that does appear to be the case.\r\n\r\nThe merge happens on the github infra, and anyone can fetch any commit. I have a local function to do that:\r\n\r\n\r\n```sh\r\n$ type gfbb \r\ngfbb is a function\r\ngfbb () \r\n{ \r\n    git fetch https://github.com/bitcoin/bitcoin \"$1\"\r\n}\r\n```\r\n\r\n",
          "created_at": "2025-12-17T14:35:43Z"
        }
      ]
    }
  ],
  "issues": [],
  "summary": {
    "pull_requests": 6,
    "issues": 0
  }
}