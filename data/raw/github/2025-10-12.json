{
  "source": "github",
  "repository": "bitcoin/bitcoin",
  "fetched_at": "2026-01-15T20:22:22.355311+00:00",
  "date": "2025-10-12",
  "pull_requests": [
    {
      "number": 33604,
      "title": "p2p: Allow block downloads from peers without snapshot block after assumeutxo validation",
      "body": "Currently, after assumeutxo background validation finishes, the node continues to skip peers that don't have the snapshot block in their best chain until restart. This unnecessarily excludes peers from block downloads even though the background sync has completed and undo data is available.\r\n\r\nThe restriction persists because `m_chainman.CurrentChainstate().SnapshotBase()` continues to return the snapshot base block until restart, even after validation completes. Added `m_chainman.CurrentChainstate().m_assumeutxo == Assumeutxo::UNVALIDATED` check to only apply the peer restriction while background validation is ongoing. \r\n\r\nAlso added test coverage in `feature_assumeutxo.py` that verifies peers without the snapshot block can be used for block downloads after background validation completes. The test fails without this fix.",
      "state": "open",
      "user": "stringintech",
      "created_at": "2025-10-12T20:36:02Z",
      "updated_at": "2025-12-19T16:11:38Z",
      "comments": 8,
      "url": "https://github.com/bitcoin/bitcoin/pull/33604",
      "labels": [
        "P2P"
      ],
      "comment_list": [
        {
          "user": "DrahtBot",
          "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/33604.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [fjahr](https://github.com/bitcoin/bitcoin/pull/33604#pullrequestreview-3599163567) |\n| Concept ACK | [sedited](https://github.com/bitcoin/bitcoin/pull/33604#issuecomment-3395334349), [Raimo33](https://github.com/bitcoin/bitcoin/pull/33604#issuecomment-3400714807), [mzumsande](https://github.com/bitcoin/bitcoin/pull/33604#pullrequestreview-3342475616) |\n| Stale ACK | [stratospher](https://github.com/bitcoin/bitcoin/pull/33604#pullrequestreview-3336930055) |\n\nIf your review is incorrectly listed, please copy-paste <code>&lt;!--meta-tag:bot-skip--&gt;</code> into the comment that the bot should ignore.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nNo conflicts as of last run.\n<!--5faf32d7da4f0f540f40219e4f7537a3-->",
          "created_at": "2025-10-12T20:36:08Z"
        },
        {
          "user": "sedited",
          "body": "Nice, Concept ACK.",
          "created_at": "2025-10-12T20:41:49Z"
        },
        {
          "user": "fanquake",
          "body": "cc @mzumsande ",
          "created_at": "2025-10-12T20:45:08Z"
        },
        {
          "user": "stringintech",
          "body": "This change allows the snapshot chainstate to reorg to chains that don't include the snapshot block after validation completes (not sure yet if this is the only mechanism that would allow such reorgs), so we must not assume anywhere in the codebase that `SnapshotBase()` is always an ancestor of the active tip. I'll take a closer look to see if any such assumptions exist, but I thought this was worth noting here.",
          "created_at": "2025-10-12T21:47:30Z"
        },
        {
          "user": "Raimo33",
          "body": "Concept ACK\n\napproach seems fine",
          "created_at": "2025-10-14T08:33:08Z"
        },
        {
          "user": "stringintech",
          "body": "Thanks for the links @stratospher! \r\nFYI, calculating `pindexLastCommonBlock` is undergoing some improvements in #32180, and I will probably have to rebase onto that change. But either way, as you mentioned, it shouldn't cause any issues.",
          "created_at": "2025-10-15T10:41:17Z"
        },
        {
          "user": "fjahr",
          "body": "Concept ACK",
          "created_at": "2025-12-17T18:49:14Z"
        },
        {
          "user": "stringintech",
          "body": "9f946a7 to 5cd0968 ([compare](https://github.com/bitcoin/bitcoin/compare/9f946a79ca894741547c5892f9dc60d023ae1508..5cd096803d223166b9aa36e783406a36cdb150bc)) - rebased, resolved conflict with #30214, and addressed https://github.com/bitcoin/bitcoin/pull/33604#discussion_r2628258598. Also PR and first commit descriptions are updated.\r\n\r\n_edit: second force push (6b92a69 to 5cd0968) is to drop an accidentally included iostream header._",
          "created_at": "2025-12-18T09:02:36Z"
        }
      ]
    },
    {
      "number": 33602,
      "title": "[IBD] coins: reduce lookups in dbcache layer propagation",
      "body": "This change is part of [[IBD] - Tracking PR for speeding up Initial Block Download](https://github.com/bitcoin/bitcoin/pull/32043)\r\n\r\n### Summary\r\n\r\nPreviously, when the parent coins cache had no entry and the child did, `BatchWrite` performed a find followed by `try_emplace`, which resulted in multiple `SipHash` computations and bucket traversals on the common insert path.\r\nOn a different path, these caches were recreated needlessly for every block connection.\r\n\r\n### Fix for double fetch \r\n\r\nThis change uses a single leading `try_emplace` and branches on the returned `inserted` flag. In the `FRESH && SPENT` case (not used in production, only exercised by tests), we erase the just-inserted placeholder (which is constant time with no rehash anyway). Semantics are unchanged for all valid parent/child state combinations.\r\n\r\nThis change is a minimal version of [bitcoin/bitcoin@`723c49b` (#32128)](https://github.com/bitcoin/bitcoin/pull/32128/commits/723c49b63bb10da843fbb6efc6928dca415cc47f) and draws simplification ideas [bitcoin/bitcoin@`ae76ec7` (#30673)](https://github.com/bitcoin/bitcoin/pull/30673/commits/ae76ec7bcff0a08a61f294882a71e46d177b009f) and https://github.com/bitcoin/bitcoin/pull/30326.\r\n\r\n### Fix for temporary cache recreation\r\n\r\nRelated to parent cache propagation, the second commit makes it possible to avoid destructuring-recreating-destructuring of these short-live parent caches created for each new block.\r\nA few temporary `CCoinsViewCache`'s are destructed right after the `Flush()`, therefore it is not necessary to call `ReallocateCache` to recreate them right before they're killed anyway.\r\n\r\nThis change was based on a subset of https://github.com/bitcoin/bitcoin/pull/28945, the original authors and relevant commenters were added as coauthors to this version.\r\n\r\n-----\r\n\r\nReindex-chainstate indicates ~1% speedup.\r\n<details>\r\n<summary>Details</summary>\r\n\r\n```python\r\nCOMMITS=\"647cdb4f7e8041affed887e2325ee03a91078bb1 0b0c3293ffd75afb27dadc0b28426b40132a8c6b\"; \\                       \r\nSTOP=909090; DBCACHE=4500; \\                                                                                                                                                     \r\nCC=gcc; CXX=g++; \\                                                                      \r\nBASE_DIR=\"/mnt/my_storage\"; DATA_DIR=\"$BASE_DIR/BitcoinData\"; LOG_DIR=\"$BASE_DIR/logs\"; \\                                                                                        \r\n(echo \"\"; for c in $COMMITS; do git fetch -q origin $c && git log -1 --pretty='%h %s' $c || exit 1; done; echo \"\") && \\\r\nhyperfine \\                                                                             \r\n  --sort command \\                                                                      \r\n  --runs 2 \\                                                                            \r\n  --export-json \"$BASE_DIR/rdx-$(sed -E 's/(\\w{8})\\w+ ?/\\1-/g;s/-$//'<<<\"$COMMITS\")-$STOP-$DBCACHE-$CC.json\" \\\r\n  --parameter-list COMMIT ${COMMITS// /,} \\                                             \r\n  --prepare \"killall bitcoind 2>/dev/null; rm -f $DATA_DIR/debug.log; git checkout {COMMIT}; git clean -fxd; git reset --hard && \\\r\n    cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=Release -DENABLE_IPC=OFF && ninja -C build bitcoind && \\\r\n    ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=1000 -printtoconsole=0; sleep 20\" \\\r\n  --cleanup \"cp $DATA_DIR/debug.log $LOG_DIR/debug-{COMMIT}-$(date +%s).log\" \\                                                                                                   \r\n  \"COMPILER=$CC ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=$DBCACHE -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0\"\r\n\r\n647cdb4f7e Merge bitcoin/bitcoin#33311: net: Quiet down logging when router doesn't support natpmp/pcp\r\n0b0c3293ff validation: don't reallocate cache for short-lived CCoinsViewCache                                                                                                    \r\n\r\nBenchmark 1: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=909090 -dbcache=4500 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 647cdb4f7e8041affed887e2325ee03a91078bb1)\r\n  Time (mean ± σ):     16233.508 s ±  9.501 s    [User: 19064.578 s, System: 951.672 s]                                                                                          \r\n  Range (min … max):   16226.790 s … 16240.226 s    2 runs                                                                                                                       \r\n                                                                                        \r\nBenchmark 2: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=909090 -dbcache=4500 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 0b0c3293ffd75afb27dadc0b28426b40132a8c6b)\r\n  Time (mean ± σ):     16039.626 s ± 17.284 s    [User: 18870.130 s, System: 950.722 s]\r\n  Range (min … max):   16027.405 s … 16051.848 s    2 runs\r\n  \r\nRelative speed comparison\r\n        1.01 ±  0.00  COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=909090 -dbcache=4500 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 647cdb4f7e8041affed887e2325ee03a91078bb1)\r\n        1.00          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=909090 -dbcache=4500 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 0b0c3293ffd75afb27dadc0b28426b40132a8c6b)\r\n```\r\n\r\n</details>\r\n",
      "state": "closed",
      "user": "l0rinc",
      "created_at": "2025-10-12T18:32:08Z",
      "updated_at": "2025-12-10T23:11:40Z",
      "comments": 7,
      "url": "https://github.com/bitcoin/bitcoin/pull/33602",
      "labels": [],
      "comment_list": [
        {
          "user": "DrahtBot",
          "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/33602.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [andrewtoth](https://github.com/bitcoin/bitcoin/pull/33602#pullrequestreview-3409084819), [optout21](https://github.com/bitcoin/bitcoin/pull/33602#issuecomment-3480221357), [sedited](https://github.com/bitcoin/bitcoin/pull/33602#pullrequestreview-3554048589), [achow101](https://github.com/bitcoin/bitcoin/pull/33602#issuecomment-3639270227) |\n\nIf your review is incorrectly listed, please copy-paste <code>&lt;!--meta-tag:bot-skip--&gt;</code> into the comment that the bot should ignore.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#33866](https://github.com/bitcoin/bitcoin/pull/33866) (refactor: Let CCoinsViewCache::BatchWrite return void by sedited)\n* [#33512](https://github.com/bitcoin/bitcoin/pull/33512) (coins: use number of dirty cache entries in flush warnings/logs by l0rinc)\n* [#31132](https://github.com/bitcoin/bitcoin/pull/31132) (validation: fetch block inputs on parallel threads >40% faster IBD by andrewtoth)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n<!--5faf32d7da4f0f540f40219e4f7537a3-->",
          "created_at": "2025-10-12T18:32:13Z"
        },
        {
          "user": "optout21",
          "body": "Concept ACK 195fc2fe102197eae27c33b5e3969a6b15d1253a\r\n\r\nNice optimization",
          "created_at": "2025-10-14T09:38:50Z"
        },
        {
          "user": "sipa",
          "body": "Why is this Draft?",
          "created_at": "2025-10-14T13:51:40Z"
        },
        {
          "user": "l0rinc",
          "body": "Rebased after https://github.com/bitcoin/bitcoin/pull/32313.",
          "created_at": "2025-10-16T00:10:37Z"
        },
        {
          "user": "optout21",
          "body": "utACK 0ac969cddfdba52f7947e9b140ef36e2b19c2c41\r\n\r\nA performance optimization, in a sensitive place but well localized.",
          "created_at": "2025-11-03T12:13:03Z"
        },
        {
          "user": "l0rinc",
          "body": "thanks for the reviews!\r\nrfm?",
          "created_at": "2025-12-08T21:47:23Z"
        },
        {
          "user": "achow101",
          "body": "ACK 0ac969cddfdba52f7947e9b140ef36e2b19c2c41",
          "created_at": "2025-12-10T22:49:44Z"
        }
      ]
    }
  ],
  "issues": [
    {
      "number": 33603,
      "title": "Missing shell completions for the `bitcoin` command",
      "body": "v30 introduced a new `bitcoin` command but there are no shell completions for this command in contrib/completions/{bash,fish}\n\n* https://github.com/bitcoin/bitcoin/tree/master/contrib/completions/bash\n* https://github.com/bitcoin/bitcoin/tree/master/contrib/completions/fish",
      "state": "open",
      "user": "prusnak",
      "created_at": "2025-10-12T19:51:53Z",
      "updated_at": "2025-10-29T01:12:56Z",
      "comments": 2,
      "url": "https://github.com/bitcoin/bitcoin/issues/33603",
      "labels": [
        "Feature"
      ],
      "comment_list": [
        {
          "user": "fanquake",
          "body": "cc @willcl-ark ",
          "created_at": "2025-10-12T19:59:20Z"
        },
        {
          "user": "maflcko",
          "body": "See https://github.com/bitcoin/bitcoin/pull/33385?",
          "created_at": "2025-10-13T06:28:55Z"
        }
      ]
    }
  ],
  "summary": {
    "pull_requests": 2,
    "issues": 1
  }
}