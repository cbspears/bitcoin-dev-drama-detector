{
  "source": "github",
  "repository": "bitcoin/bitcoin",
  "fetched_at": "2026-01-15T19:31:59.145599+00:00",
  "date": "2025-04-11",
  "pull_requests": [
    {
      "number": 32253,
      "title": "test: adds coverage to src/validation for invalid tx coinbase",
      "body": "### Summary\r\nThis PR adds coverage to [`src/validation`](https://github.com/bitcoin/bitcoin/blob/master/src/validation.cpp#L787-L789) in the functional test suite when a transaction that is the coinbase is sent as a tx\r\n\r\nThis adds another tx to `invalid_txs.py`\r\n\r\n### How to check for coverage\r\n\r\nThis is only covered currently in [mempool_accept.py](https://github.com/bitcoin/bitcoin/blob/master/test/functional/mempool_accept.py#L272-L280)\r\n\r\nyou can test this by modifying the `coinbase` message and then running the test suite and observing that only `mempool_accept.py` fails\r\n\r\nYou can also check that it is not covered by doing the following\r\n`grep -nri \"coinbase\" ./test/functional/data/invalid_txs.py`\r\n`grep -nri \"assert_raises.*coinbase\" ./test/functional`\r\n`grep -nr \"\\\"coinbase\" ./test/functional`",
      "state": "closed",
      "user": "kevkevinpal",
      "created_at": "2025-04-11T23:43:39Z",
      "updated_at": "2025-04-21T12:57:12Z",
      "comments": 12,
      "url": "https://github.com/bitcoin/bitcoin/pull/32253",
      "labels": [
        "Tests"
      ],
      "comment_list": [
        {
          "user": "DrahtBot",
          "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/32253.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\nA summary of reviews will appear here.\n",
          "created_at": "2025-04-11T23:43:42Z"
        },
        {
          "user": "maflcko",
          "body": "According to https://maflcko.github.io/b-c-cov/total.coverage/src/validation.cpp.gcov.html it is covered",
          "created_at": "2025-04-12T06:59:15Z"
        },
        {
          "user": "maflcko",
          "body": "> You can check that it is not covered by doing the following (I'm not 100% certain as there are a lot of instances of coinbase in the code)\r\n> `grep -nri \"coinbase\" ./test/functional/data/invalid_txs.py`\r\n> `grep -nri \"assert_raises.*coinbase\" ./test/functional`\r\n> `grep -nr \"\\\"coinbase\" ./test/functional`\r\n\r\nA better way to check that a piece of code is covered is simply adding an `assert(false);`, then run the tests. This will then also surface which exact test is covering it.",
          "created_at": "2025-04-12T07:00:53Z"
        },
        {
          "user": "kevkevinpal",
          "body": "I tried adding `assert(false);` but it seemed to break most tests but when modifying the `coinbase` message I saw errors in\r\n\r\n[mempool_accept.py](https://github.com/bitcoin/bitcoin/blob/master/test/functional/mempool_accept.py#L272-L280)\r\n\r\nbut that seems like the only place, not sure if it makes sense to add this coinbase tx to `invalid_txs.py` or if it is preferable to have it only tested in `mempool_accept.py`\r\n",
          "created_at": "2025-04-12T14:39:27Z"
        },
        {
          "user": "maflcko",
          "body": "> I tried adding `assert(false);` but it seemed to break most tests but when modifying the `coinbase` message I saw errors in\r\n\r\nThat seems odd. According to the coverage report it is covered twice, so at most two tests could fail. What was your diff?",
          "created_at": "2025-04-12T15:12:19Z"
        },
        {
          "user": "arejula27",
          "body": "I'll try to run it and check the difference in the coverage, but as @maflcko  pointed out, the code already appears to be fully covered in the report\r\n\r\nI would like to know where your new IsCoinbase template is used, I am unfamiliar with this file.",
          "created_at": "2025-04-14T09:01:49Z"
        },
        {
          "user": "kevkevinpal",
          "body": "> > I tried adding `assert(false);` but it seemed to break most tests but when modifying the `coinbase` message I saw errors in\r\n> \r\n> That seems odd. According to the coverage report it is covered twice, so at most two tests could fail. What was your diff?\r\n\r\nThis is the diff\r\n```\r\n(master) bitcoin $ git diff\r\ndiff --git a/src/validation.cpp b/src/validation.cpp\r\nindex aa1effb736..c74217ef68 100644\r\n--- a/src/validation.cpp\r\n+++ b/src/validation.cpp\r\n@@ -786,7 +786,7 @@ bool MemPoolAccept::PreChecks(ATMPArgs& args, Workspace& ws)\r\n\r\n     // Coinbase is only valid in a block, not as a loose transaction\r\n     if (tx.IsCoinBase())\r\n-        return state.Invalid(TxValidationResult::TX_CONSENSUS, \"coinbase\");\r\n+        return state.Invalid(TxValidationResult::TX_CONSENSUS, \"test123\");\r\n\r\n     // Rather not work on nonstandard transactions (unless -testnet/-regtest)\r\n     std::string reason;\r\n```\r\n\r\nand this is the only test that fails\r\n\r\n```\r\n223/318 - mempool_accept.py failed, Duration: 4 s\r\n\r\nstdout:\r\n2025-04-14T23:44:58.304000Z TestFramework (INFO): PRNG seed is: 6232609879919670956\r\n2025-04-14T23:44:58.304000Z TestFramework (INFO): Initializing test directory /tmp/test_runner_â‚¿_ðŸƒ_20250414_194238/mempool_accept_101\r\n2025-04-14T23:44:58.606000Z TestFramework (INFO): Start with empty mempool, and 200 blocks\r\n2025-04-14T23:44:58.609000Z TestFramework (INFO): Should not accept garbage to testmempoolaccept\r\n2025-04-14T23:44:58.615000Z TestFramework (INFO): A transaction already in the blockchain\r\n2025-04-14T23:44:58.629000Z TestFramework (INFO): A transaction not in the mempool\r\n2025-04-14T23:44:58.633000Z TestFramework (INFO): A final transaction not in the mempool\r\n2025-04-14T23:44:58.638000Z TestFramework (INFO): A transaction in the mempool\r\n2025-04-14T23:44:58.641000Z TestFramework (INFO): A transaction that replaces a mempool transaction\r\n2025-04-14T23:44:58.646000Z TestFramework (INFO): A transaction with missing inputs, that never existed\r\n2025-04-14T23:44:58.649000Z TestFramework (INFO): A transaction with missing inputs, that existed once in the past\r\n2025-04-14T23:44:58.668000Z TestFramework (INFO): Create a \"reference\" tx for later use\r\n2025-04-14T23:44:58.672000Z TestFramework (INFO): A transaction with no outputs\r\n2025-04-14T23:44:58.674000Z TestFramework (INFO): A really large transaction\r\n2025-04-14T23:45:01.913000Z TestFramework (INFO): A transaction with negative output value\r\n2025-04-14T23:45:01.915000Z TestFramework (INFO): A transaction with too large output value\r\n2025-04-14T23:45:01.916000Z TestFramework (INFO): A transaction with too large sum of output values\r\n2025-04-14T23:45:01.916000Z TestFramework (INFO): A transaction with duplicate inputs\r\n2025-04-14T23:45:01.917000Z TestFramework (INFO): A non-coinbase transaction with coinbase-like outpoint\r\n2025-04-14T23:45:01.917000Z TestFramework (INFO): A coinbase transaction\r\n2025-04-14T23:45:01.918000Z TestFramework (ERROR): Assertion failed\r\nTraceback (most recent call last):\r\n  File \"/mnt/shared_drive/DEVDIR/bitcoin/test/functional/test_framework/test_framework.py\", line 182, in main\r\n    self.run_test()\r\n  File \"/mnt/shared_drive/DEVDIR/bitcoin/build_dir/test/functional/mempool_accept.py\", line 277, in run_test\r\n    self.check_mempool_result(\r\n  File \"/mnt/shared_drive/DEVDIR/bitcoin/build_dir/test/functional/mempool_accept.py\", line 73, in check_mempool_result\r\n    assert_equal(result_expected, result_test)\r\n  File \"/mnt/shared_drive/DEVDIR/bitcoin/test/functional/test_framework/util.py\", line 77, in assert_equal\r\n    raise AssertionError(\"not(%s)\" % \" == \".join(str(arg) for arg in (thing1, thing2) + args))\r\nAssertionError: not([{'txid': 'ff07cc811d2826c6f5a6386dce61cdd3adfcdbacad4de26f3024d68d6dc16d13', 'allowed': False, 'reject-reason': 'coinbase'}] == [{'txid': 'ff07cc811d2826c6f5a6386dce61cdd3adfcdbacad4de26f3024d68d6dc16d13', 'allowed': False, 'reject-reason': 'test123'}])\r\n2025-04-14T23:45:01.972000Z TestFramework (INFO): Not stopping nodes as test failed. The dangling processes will be cleaned up later.\r\n2025-04-14T23:45:01.972000Z TestFramework (WARNING): Not cleaning up dir /tmp/test_runner_â‚¿_ðŸƒ_20250414_194238/mempool_accept_101\r\n2025-04-14T23:45:01.972000Z TestFramework (ERROR): Test failed. Test logging available at /tmp/test_runner_â‚¿_ðŸƒ_20250414_194238/mempool_accept_101/test_framework.log\r\n2025-04-14T23:45:01.972000Z TestFramework (ERROR):\r\n2025-04-14T23:45:01.974000Z TestFramework (ERROR): Hint: Call /mnt/shared_drive/DEVDIR/bitcoin/test/functional/combine_logs.py '/tmp/test_runner_â‚¿_ðŸƒ_20250414_194238/mempool_accept_101' to consolidate all logs\r\n2025-04-14T23:45:01.974000Z TestFramework (ERROR):\r\n2025-04-14T23:45:01.974000Z TestFramework (ERROR): If this failure happened unexpectedly or intermittently, please file a bug and provide a link or upload of the combined log.\r\n2025-04-14T23:45:01.974000Z TestFramework (ERROR): https://github.com/bitcoin/bitcoin/issues\r\n2025-04-14T23:45:01.974000Z TestFramework (ERROR):\r\n\r\n\r\nstderr:\r\n[node 0] Cleaning up leftover process\r\n```",
          "created_at": "2025-04-14T23:47:39Z"
        },
        {
          "user": "kevkevinpal",
          "body": "> I'll try to run it and check the difference in the coverage, but as @maflcko pointed out, the code already appears to be fully covered in the report\r\n> \r\n> I would like to know where your new IsCoinbase template is used, I am unfamiliar with this file.\r\n\r\nThank you for the review!\r\n\r\nThe `IsCoinbase` template is defined in `./test/functional/data/invalid_txs.py` and that file is used in [./test/functional/p2p_invalid_tx.py](https://github.com/bitcoin/bitcoin/blob/master/test/functional/p2p_invalid_tx.py#L21).\r\n\r\nThe way p2p_invalid_tx.py uses the templates is that it loops through an asserts the reject-reason is correct in the logs",
          "created_at": "2025-04-14T23:51:17Z"
        },
        {
          "user": "kevkevinpal",
          "body": "I do have some tests that are being skipped due to --legacy-wallet being used let me see if any of those maybe are also covering",
          "created_at": "2025-04-14T23:57:16Z"
        },
        {
          "user": "maflcko",
          "body": "> I tried adding `assert(false);` but it seemed to break most tests\r\n\r\nThe line is covered twice, and at least for me it breaks exactly only two tests (one unit and one functional test).\r\n\r\n\r\n```diff\r\ndiff --git a/src/validation.cpp b/src/validation.cpp\r\nindex aa1effb736..39744c0516 100644\r\n--- a/src/validation.cpp\r\n+++ b/src/validation.cpp\r\n@@ -785,8 +785,9 @@ bool MemPoolAccept::PreChecks(ATMPArgs& args, Workspace& ws)\r\n     }\r\n \r\n     // Coinbase is only valid in a block, not as a loose transaction\r\n-    if (tx.IsCoinBase())\r\n+    if (tx.IsCoinBase())     {assert(false);\r\n         return state.Invalid(TxValidationResult::TX_CONSENSUS, \"coinbase\");\r\n+        }\r\n \r\n     // Rather not work on nonstandard transactions (unless -testnet/-regtest)\r\n     std::string reason;\r\n",
          "created_at": "2025-04-15T06:43:47Z"
        },
        {
          "user": "darosior",
          "body": "I don't think there is any use in keeping this open? The test is strictly redundant, as Marco demonstrated it's already covered both in unit and functional tests.",
          "created_at": "2025-04-21T12:53:52Z"
        },
        {
          "user": "kevkevinpal",
          "body": "> I don't think there is any use in keeping this open? The test is strictly redundant, as Marco demonstrated it's already covered both in unit and functional tests.\n\nSounds I can go ahead and close it",
          "created_at": "2025-04-21T12:57:04Z"
        }
      ]
    },
    {
      "number": 32252,
      "title": "[29.x] doc: minor rel notes changes",
      "body": "Remove two unused headers.\r\nRemove the empty-template, as point releases will modify `release-notes.md`.",
      "state": "closed",
      "user": "fanquake",
      "created_at": "2025-04-11T15:04:58Z",
      "updated_at": "2025-08-05T17:44:18Z",
      "comments": 2,
      "url": "https://github.com/bitcoin/bitcoin/pull/32252",
      "labels": [
        "Backport"
      ],
      "comment_list": [
        {
          "user": "DrahtBot",
          "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/32252.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [jonatack](https://github.com/bitcoin/bitcoin/pull/32252#pullrequestreview-2760677249), [janb84](https://github.com/bitcoin/bitcoin/pull/32252#pullrequestreview-2760686650) |\n\nIf your review is incorrectly listed, please react with ðŸ‘Ž to this comment and the bot will ignore it on the next update.\n",
          "created_at": "2025-04-11T15:05:01Z"
        },
        {
          "user": "laanwj",
          "body": "Post-merge ACK 87e53781f7d54d0582b9d14bc458ee474a5e5c80",
          "created_at": "2025-04-11T17:27:00Z"
        }
      ]
    },
    {
      "number": 32251,
      "title": "ci: Bump lint imagefile FROM base",
      "body": "According to https://wiki.debian.org/DebianReleases#Production_Releases, the current image will be EOL in about one year, so it seems fine to slowly bump it to something more recent.\r\n\r\n(As a side-effect, this should also fix the erroneous lint CI failures on Cirrus that can be seen since today, by triggering a fresh build from the ground up.)",
      "state": "closed",
      "user": "maflcko",
      "created_at": "2025-04-11T14:45:08Z",
      "updated_at": "2025-04-11T16:54:27Z",
      "comments": 2,
      "url": "https://github.com/bitcoin/bitcoin/pull/32251",
      "labels": [
        "Tests"
      ],
      "comment_list": [
        {
          "user": "DrahtBot",
          "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/32251.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\nA summary of reviews will appear here.\n",
          "created_at": "2025-04-11T14:45:10Z"
        },
        {
          "user": "maflcko",
          "body": "Looks like CI \"fixed itself\", so I'll close this for now, and bundle this trivial change with other changes.",
          "created_at": "2025-04-11T16:54:22Z"
        }
      ]
    },
    {
      "number": 32250,
      "title": "ci: Slim down lint image",
      "body": "Currently, the lint_test_runner is built and installed into the lint CI image. This is problematic, because it triggers a full image build on every change to its source code. Doing a build of the lint test_runner on every run is easier and faster.",
      "state": "closed",
      "user": "maflcko",
      "created_at": "2025-04-11T14:36:16Z",
      "updated_at": "2025-04-17T11:17:41Z",
      "comments": 8,
      "url": "https://github.com/bitcoin/bitcoin/pull/32250",
      "labels": [
        "Tests"
      ],
      "comment_list": [
        {
          "user": "DrahtBot",
          "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/32250.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [janb84](https://github.com/bitcoin/bitcoin/pull/32250#pullrequestreview-2767216473), [l0rinc](https://github.com/bitcoin/bitcoin/pull/32250#issuecomment-2804152555) |\n| Stale ACK | [kevkevinpal](https://github.com/bitcoin/bitcoin/pull/32250#issuecomment-2798005202) |\n\nIf your review is incorrectly listed, please react with ðŸ‘Ž to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nNo conflicts as of last run.\n",
          "created_at": "2025-04-11T14:36:20Z"
        },
        {
          "user": "kevkevinpal",
          "body": "utACK [fae322a](https://github.com/bitcoin/bitcoin/pull/32250/commits/fae322a43a4b71b95b68f0674a5d2bd597fee68b)\r\n\r\nThis change makes sense, it is more efficient. \r\nNot sure if you have run times from the build and how much faster this change makes it?\r\n\r\n---\r\n\r\n- Google provides a table for what is the appropriate path to upgrade and `Debian 12 \"Bookworm\"` -> `Ubuntu 24.04` looks right\r\nhttps://cloud.google.com/software-supply-chain-security/docs/base-images#google-provided_base_images\r\n\r\n- I also did `grep -nri \"LINT_RUNNER_PATH\" ./ -I` and found no results",
          "created_at": "2025-04-11T21:02:23Z"
        },
        {
          "user": "maflcko",
          "body": "> Not sure if you have run times from the build and how much faster this change makes it?\r\n\r\nIt should skip the whole build completely of the image when the test_runner code is modified. Thus, the savings are how long it takes to build. (A few minutes)\r\n\r\nYou can try it via https://github.com/bitcoin/bitcoin/blob/master/test/lint/README.md#running-locally (using the docker commands). And something like `echo >> ./test/lint/test_runner/src/main.rs` to  modify the code.\r\n\r\nPreviously, on master, it should trigger a full image re-build every time (including a full python build). Now, it should skip the re-build completely, because it is not needed.\r\n\r\n\r\n\r\n\r\n> * Google provides a table for what is the appropriate path to upgrade and `Debian 12 \"Bookworm\"` -> `Ubuntu 24.04` looks right\r\n>       https://cloud.google.com/software-supply-chain-security/docs/base-images#google-provided_base_images\r\n\r\nI don't think this is related. The google mirror is used, but not the google base images. Also, all packages, except for those installed via `apt` are hard-coded anyway, so the base image shouldn't matter much, as long as it is not EOL.\r\n\r\n",
          "created_at": "2025-04-12T06:35:09Z"
        },
        {
          "user": "l0rinc",
          "body": "Checked that we don't rebuild anymore (I trust that we did before):\r\n```bash\r\nDOCKER_BUILDKIT=1 docker build --file \"./ci/lint_imagefile\" ./ && \\\r\necho >> ./test/lint/test_runner/src/main.rs && \\\r\nDOCKER_BUILDKIT=1 docker build -t bitcoin-linter --file \"./ci/lint_imagefile\" ./ && docker run --rm -v $(pwd):/bitcoin -it bitcoin-linter\r\n```\r\n\r\n<details>\r\n<summary>Result</summary>\r\n\r\n```bash\r\n => [1/7] FROM mirror.gcr.io/ubuntu:24.04@sha256:1e622c5f073b4f6bfad6632f2616c7f59ef256e96fe78bf6a595d1dc4376ac02                                                          0.0s\r\n => [internal] load build context                                                                                                                                          0.0s\r\n => => transferring context: 239B                                                                                                                                          0.0s\r\n => CACHED [2/7] COPY ./ci/retry/retry /ci_retry                                                                                                                           0.0s\r\n => CACHED [3/7] COPY ./.python-version /.python-version                                                                                                                   0.0s\r\n => CACHED [4/7] COPY --chmod=755 ./ci/lint/container-entrypoint.sh /entrypoint.sh                                                                                         0.0s\r\n => CACHED [5/7] COPY ./ci/lint/04_install.sh /install.sh                                                                                                                  0.0s\r\n => CACHED [6/7] RUN /install.sh                                                                                                                                           0.0s\r\n => CACHED [7/7] WORKDIR /bitcoin \r\n```\r\n\r\n</details>\r\n\r\nLeft a few cleanup nits, but LGTM otherwise, ACK fae322a43a4b71b95b68f0674a5d2bd597fee68b",
          "created_at": "2025-04-13T15:46:41Z"
        },
        {
          "user": "l0rinc",
          "body": "reACK fac97092975e75f074505c77429b57ba9bb62b3e\r\n\r\nThe [new links](https://github.com/bitcoin/bitcoin/compare/fae322a43a4b71b95b68f0674a5d2bd597fee68b..fac97092975e75f074505c77429b57ba9bb62b3e) also seem to point to the correct locations - though the first comment states version 13.3, while the link seems to point to version 13.2.",
          "created_at": "2025-04-14T18:06:30Z"
        },
        {
          "user": "maflcko",
          "body": "\r\n\r\n> The [new links](https://github.com/bitcoin/bitcoin/compare/fae322a43a4b71b95b68f0674a5d2bd597fee68b..fac97092975e75f074505c77429b57ba9bb62b3e) also seem to point to the correct locations - though the first comment states version 13.3, while the link seems to point to version 13.2.\r\n\r\nPushed a doc-only comment fixup, should be trivial to re-ack without testing again.",
          "created_at": "2025-04-15T07:47:37Z"
        },
        {
          "user": "l0rinc",
          "body": "ACK faeb1babe283d8d61d830ce78310ce23984543e2",
          "created_at": "2025-04-15T07:52:20Z"
        },
        {
          "user": "maflcko",
          "body": "rfm with two tested acks, or does it need more review?",
          "created_at": "2025-04-17T08:50:13Z"
        }
      ]
    },
    {
      "number": 32248,
      "title": "Remove support for RNDR/RNDRRS for aarch64",
      "body": "This hardware feature is\r\n\r\n- Rarely supported on SoCs (and broken on like half of the chips that support it in the first place) (#31817). It is not clear if, or how, the brokenness will be worked around in the kernel, but working around it in user space seems the wrong thing to do, this is not the place to maintain special workarounds for specific hardware (which despite that, was attempted in #31826, but had to be reverted in #31908 due to other problems).\r\n- Apparently not compiled into the release binary anymore (https://github.com/bitcoin/bitcoin/issues/31817#issuecomment-2795885962). Did check this at the time, but a build system change must have caused this, and went undetected.\r\n- Hard to test in CI (as well as manually), due to unavailability of hardware.\r\n\r\nBetter to remove it.\r\n\r\nThis reverts commit aee5404e02e203a256c1a97b629b9b107cc8bb07 from #26839.\r\n\r\nCloses #31817.\r\n\r\n",
      "state": "closed",
      "user": "laanwj",
      "created_at": "2025-04-11T06:17:44Z",
      "updated_at": "2025-06-18T18:21:13Z",
      "comments": 11,
      "url": "https://github.com/bitcoin/bitcoin/pull/32248",
      "labels": [
        "Linux/Unix",
        "Utils/log/libs"
      ],
      "comment_list": [
        {
          "user": "DrahtBot",
          "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/32248.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [sipa](https://github.com/bitcoin/bitcoin/pull/32248#issuecomment-2796684956), [davidgumberg](https://github.com/bitcoin/bitcoin/pull/32248#issuecomment-2807896889), [achow101](https://github.com/bitcoin/bitcoin/pull/32248#issuecomment-2810417691), [w0xlt](https://github.com/bitcoin/bitcoin/pull/32248#issuecomment-2810456977) |\n| Concept ACK | [hugohn](https://github.com/bitcoin/bitcoin/pull/32248#issuecomment-2796047104), [theStack](https://github.com/bitcoin/bitcoin/pull/32248#issuecomment-2807235718) |\n\nIf your review is incorrectly listed, please react with ðŸ‘Ž to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#29641](https://github.com/bitcoin/bitcoin/pull/29641) (scripted-diff: Use LogInfo over LogPrintf [WIP, NOMERGE, DRAFT] by maflcko)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
          "created_at": "2025-04-11T06:17:47Z"
        },
        {
          "user": "hugohn",
          "body": "ACK",
          "created_at": "2025-04-11T07:10:44Z"
        },
        {
          "user": "sipa",
          "body": "utACK 7749d929a0d9dfe71541a22e557ea41e01df28ce",
          "created_at": "2025-04-11T11:47:02Z"
        },
        {
          "user": "theStack",
          "body": "Concept ACK",
          "created_at": "2025-04-15T19:15:59Z"
        },
        {
          "user": "davidgumberg",
          "body": "utACK https://github.com/bitcoin/bitcoin/commit/7749d929a0d9dfe71541a22e557ea41e01df28ce\r\n\r\nThere are [other sources](https://github.com/bitcoin/bitcoin/blob/cdc32994feadf3f15df3cfac5baae36b4b011462/src/random.cpp#L559C1-L578C2) of entropy in [`SeedStartup`](https://github.com/bitcoin/bitcoin/blob/cdc32994feadf3f15df3cfac5baae36b4b011462/src/random.cpp#L611C1-L611C58) which is `SeedHardwareSlow`'s only caller.\r\n\r\nWithout `SeedHardwareFast()` doing anything, the only remaining source of entropy in [`SeedFast`](https://github.com/bitcoin/bitcoin/blob/cdc32994feadf3f15df3cfac5baae36b4b011462/src/random.cpp#L544-L557) is the timestamp, but this seems okay to me, since two of `SeedFast`'s users, [`SeedSlow`](https://github.com/bitcoin/bitcoin/blob/cdc32994feadf3f15df3cfac5baae36b4b011462/src/random.cpp#L564) and [`SeedPeriodic`](https://github.com/bitcoin/bitcoin/blob/cdc32994feadf3f15df3cfac5baae36b4b011462/src/random.cpp#L594),  have other entropy sources.\r\n\r\nThe other place `SeedFast()` gets called is when `ProcRand()` is invoked with `RNGLevel::Fast`, the two places I see where that happens is in [`RandomInit()`](https://github.com/bitcoin/bitcoin/blob/cdc32994feadf3f15df3cfac5baae36b4b011462/src/random.cpp#L774)(only used by kernel and the wallet tool)  and [`GetRandBytes()`](https://github.com/bitcoin/bitcoin/blob/cdc32994feadf3f15df3cfac5baae36b4b011462/src/random.cpp#L679). `GetRandBytes()` is a little bit more all over the code base, but from what I can tell, nothing that uses it needs more entropy than the timestamp. ",
          "created_at": "2025-04-16T00:57:19Z"
        },
        {
          "user": "laanwj",
          "body": "> but from what I can tell, nothing that uses it needs more entropy than the timestamp.\r\n\r\ni wouldn't say this is the ideal situation, clearly adding hardware randomness when available (and safe to use) is preferable, it's just that it's not, here.",
          "created_at": "2025-04-16T03:03:15Z"
        },
        {
          "user": "achow101",
          "body": "ACK 7749d929a0d9dfe71541a22e557ea41e01df28ce",
          "created_at": "2025-04-16T18:41:49Z"
        },
        {
          "user": "w0xlt",
          "body": "utACK https://github.com/bitcoin/bitcoin/pull/32248/commits/7749d929a0d9dfe71541a22e557ea41e01df28ce",
          "created_at": "2025-04-16T18:54:47Z"
        },
        {
          "user": "fanquake",
          "body": "Backported in #32292.",
          "created_at": "2025-04-17T10:55:50Z"
        },
        {
          "user": "achow101",
          "body": "Is there any interest in having this working? It appears that the Qualcomm Snapdragon X line of CPUs (currently available in both laptops and mini PCs) both have this capability, and also have the broken implementation. With WSL, I was able to verify that the reverted implementation did not work on Snapdragon X, and test the various fix PRs.",
          "created_at": "2025-06-17T22:03:29Z"
        },
        {
          "user": "laanwj",
          "body": "Not sure. It's good that one of us can test it now. And i'm not opposed to re-adding support when it makes sense, but we still can't test it in CI. And still standing by that working around hardware issues in user-space is questionable, makes it seem it's just not taken seriously by the vendor.\r\n",
          "created_at": "2025-06-18T18:21:13Z"
        }
      ]
    }
  ],
  "issues": [
    {
      "number": 32249,
      "title": "Mistake in `feature_pruning.py` functional test?",
      "body": "Reported on IRC yesterday:\n\n```\n17:24:04 < PiRK_> Good evening. I was looking through a functional test and i'm wondering if this isn't a typo:Â \n                  https://github.com/bitcoin/bitcoin/blob/master/test/functional/feature_pruning.py#L44\n17:24:04 < PiRK_> \"nTimes\" vs `nTime`\n17:27:08 < sipa> PiRK_: looks like it\n```\n\nThe code is definitely not doing what the comment says, as it's *always* resetting `mine_large_blocks.nTime` to 0, rather than only on the first run. However, if I fix it, the test does not pass anymore.\n\nFiling this as an issue so someone who is more familiar with the test or feels like digging in can have a look.",
      "state": "closed",
      "user": "sipa",
      "created_at": "2025-04-11T12:03:44Z",
      "updated_at": "2025-05-14T09:03:20Z",
      "comments": 6,
      "url": "https://github.com/bitcoin/bitcoin/issues/32249",
      "labels": [
        "Tests"
      ],
      "comment_list": [
        {
          "user": "sipa",
          "body": "For anyone wanting to fix this, note that `feature_pruning.py` is not run by default. Please verify locally that your changes don't break the test.",
          "created_at": "2025-04-15T15:58:49Z"
        },
        {
          "user": "maflcko",
          "body": "For reference, the \"failing\" test that relies on the typo was added in commit 4a1975008b602aeacdad9a74d1837a7455148074. That is, the following diff passes for me:\n\n<details><summary>test diff</summary>\n\n```diff\ndiff --git a/test/functional/feature_pruning.py b/test/functional/feature_pruning.py\nindex 8d924282cf..5e8a388ec6 100755\n--- a/test/functional/feature_pruning.py\n+++ b/test/functional/feature_pruning.py\n@@ -25,7 +25,6 @@ from test_framework.util import (\n     assert_equal,\n     assert_greater_than,\n     assert_raises_rpc_error,\n-    try_rpc,\n )\n \n # Rescans start at the earliest block up to 2 hours before a key timestamp, so\n@@ -41,7 +40,7 @@ def mine_large_blocks(node, n):\n     # Set the nTime if this is the first time this function has been called.\n     # A static variable ensures that time is monotonicly increasing and is therefore\n     # different for each block created => blockhash is unique.\n-    if \"nTimes\" not in mine_large_blocks.__dict__:\n+    if \"nTime\" not in mine_large_blocks.__dict__:\n         mine_large_blocks.nTime = 0\n \n     # Get the block parameters for the first block\n@@ -480,12 +479,8 @@ class PruneTest(BitcoinTestFramework):\n         self.log.info(\"Test invalid pruning command line options\")\n         self.test_invalid_command_line_options()\n \n-        self.log.info(\"Test scanblocks can not return pruned data\")\n         self.test_scanblocks_pruned()\n \n-        self.log.info(\"Test pruneheight reflects the presence of block and undo data\")\n-        self.test_pruneheight_undo_presence()\n-\n         self.log.info(\"Done\")\n \n     def test_scanblocks_pruned(self):\n@@ -499,18 +494,5 @@ class PruneTest(BitcoinTestFramework):\n         assert_raises_rpc_error(-1, \"Block not available (pruned data)\", node.scanblocks,\n             \"start\", [{\"desc\": f\"raw({false_positive_spk.hex()})\"}], 0, 0, \"basic\", {\"filter_false_positives\": True})\n \n-    def test_pruneheight_undo_presence(self):\n-        node = self.nodes[2]\n-        pruneheight = node.getblockchaininfo()[\"pruneheight\"]\n-        fetch_block = node.getblockhash(pruneheight - 1)\n-\n-        self.connect_nodes(1, 2)\n-        peers = node.getpeerinfo()\n-        node.getblockfrompeer(fetch_block, peers[0][\"id\"])\n-        self.wait_until(lambda: not try_rpc(-1, \"Block not available (pruned data)\", node.getblock, fetch_block), timeout=5)\n-\n-        new_pruneheight = node.getblockchaininfo()[\"pruneheight\"]\n-        assert_equal(pruneheight, new_pruneheight)\n-\n if __name__ == '__main__':\n     PruneTest(__file__).main()\n```\n</details>",
          "created_at": "2025-04-16T15:56:01Z"
        },
        {
          "user": "enirox001",
          "body": "Iâ€™ll investigate this further and determine the best way to implement a fix.",
          "created_at": "2025-04-17T18:28:11Z"
        },
        {
          "user": "fjahr",
          "body": "> Iâ€™ll investigate this further and determine the best way to implement a fix.\n\n@EniRox001 I think we spoke on IRC but you went offline and I couldn't send you this last message. I took a brief look at the failure and it seems to me that the problem is that node 2 is being used in the reorg test previously. That's why it's on a different chain than the other nodes and can't fetch the last pruned block from the other nodes because these other nodes don't know this block. Fixing the typo surfaces this problem because previously all the blocks were deterministic so all nodes were on the same chain. There is still node 5 in the test that is also pruning and not involved in the reorg test, so the undo test should work again if you just use node 5 where node 2 is used currently.",
          "created_at": "2025-04-19T21:31:30Z"
        },
        {
          "user": "fjahr",
          "body": "@EniRox001 If you want to you could also introduce a new node that is not involved in any other test, some might prefer this as cleaner since it avoids such issues. But that's up to you.",
          "created_at": "2025-04-19T21:33:00Z"
        },
        {
          "user": "fanquake",
          "body": "Closed via #32312.",
          "created_at": "2025-05-14T09:03:19Z"
        }
      ]
    }
  ],
  "summary": {
    "pull_requests": 5,
    "issues": 1
  }
}