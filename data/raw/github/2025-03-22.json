{
  "source": "github",
  "repository": "bitcoin/bitcoin",
  "fetched_at": "2026-01-15T19:26:51.166366+00:00",
  "date": "2025-03-22",
  "pull_requests": [
    {
      "number": 32123,
      "title": "wallet: make coinbase that will mature on the next block available for selection",
      "body": "Closes #32098.\r\n\r\nCurrently, only coinbase UTXOs that are mature at height **_h_** are available for coin selection. This PR makes UTXOs that mature at height **_h+1_** available for selection.\r\n\r\nSince a transaction spending this output will be accepted by the mempool, it should be available for selection.\r\n\r\nBDK implements this logic<sup>[1]</sup>, which I believe to be the correct one.\r\n\r\n\r\n```diff\r\n$ bitcoin-cli -regtest createwallet wallet\r\n{\r\n  \"name\": \"wallet\"\r\n}\r\n\r\n$ export ADDRESS=$(bitcoin-cli -regtest -rpcwallet=wallet getnewaddress)\r\n\r\n$ bitcoin-cli -regtest generatetoaddress 101 $ADDRESS\r\n[\r\n  \"467fd440d0ed89d0cad64fa64d0320968b33a32c681b6c3f5a5ed1d1c016f45a\",\r\n  \"1b2246eaa35689710acc5d1bb2923197993233fb9186f0bd561cb546c7667ca7\",\r\n  ...\r\n  \"5d5ee44ada395ab1d978a77596ed3893be750840229e7234a85a01984057798a\",\r\n  \"7f8a573a6824edc5342cf86e5e7c0a6ea5664305ef21808456fc98b2621b41cf\"\r\n]\r\n\r\n$ bitcoin-cli -regtest -rpcwallet=wallet getbalance\r\n- 50.00000000\r\n+ 100.00000000\r\n```\r\n\r\n[1]: https://github.com/bitcoindevkit/bdk/issues/1878\r\n",
      "state": "closed",
      "user": "luisschwab",
      "created_at": "2025-03-22T21:31:52Z",
      "updated_at": "2025-07-23T01:53:30Z",
      "comments": 11,
      "url": "https://github.com/bitcoin/bitcoin/pull/32123",
      "labels": [
        "Wallet",
        "Needs rebase"
      ],
      "comment_list": [
        {
          "user": "DrahtBot",
          "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/32123.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Concept ACK | [shahsb](https://github.com/bitcoin/bitcoin/pull/32123#issuecomment-2816518575) |\n\nIf your review is incorrectly listed, please react with üëé to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#32349](https://github.com/bitcoin/bitcoin/pull/32349) (test: Increase stack size for \"Debug\" builds with MSVC by hebasto)\n* [#28710](https://github.com/bitcoin/bitcoin/pull/28710) (Remove the legacy wallet and BDB dependency by achow101)\n* [#27865](https://github.com/bitcoin/bitcoin/pull/27865) (wallet: Track no-longer-spendable TXOs separately by achow101)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
          "created_at": "2025-03-22T21:31:56Z"
        },
        {
          "user": "fjahr",
          "body": "I understand what you are saying about correctness but @sipa 's concerns with propagation issues are also hard to ignore. Bitcoin Core just tends to be on the more conservative side when it comes to protecting users and BDK might leave protections like this to be handled by the actual wallet implemeters that use BDK.\r\n\r\nA potential middle ground could be that current behavior is maintained but users get a useful hint in return why they can't spend their funds yet. Then there could be a flag added that allows to spend the funds (`-f` for force or so). Still not sure if this would achieve enough conceptual agreement but I think the chances are higher than with the current change.",
          "created_at": "2025-03-23T12:03:52Z"
        },
        {
          "user": "sipa",
          "body": "@luisschwab There are other examples of coins which the Bitcoin Core wallet won't let users spend, for example, unconfirmed coins (unless they are self-created/change). Just like here, that's not a protocol rule, but it's a bad idea, and it's perfectly possible to bypass by using raw transactions.\n\nNow, given how unlikely it is in 2025 for any user to use the Bitcoin Core wallet directly for mining payouts, the odds that this is still actually protecting anyone are probably negligible. So @fjahr , I think offering a way to disable this behavior would be huge overkill. It probably doesn't matter either way in practice.\n\nBut on the other hand, I just see no reason to change this. If direct user mining payouts were common, this would be a useful rule. There is nothing incorrect about the current behavior, and I categorically disagree that the wallet should just allow anything that's legal in the protocol without question. If someone really wants to bypass this, they can always use raw transactions.",
          "created_at": "2025-03-23T12:17:10Z"
        },
        {
          "user": "luisschwab",
          "body": "What do you think @murchandamus?",
          "created_at": "2025-03-25T16:19:28Z"
        },
        {
          "user": "maflcko",
          "body": "https://github.com/bitcoin/bitcoin/issues/32098#issuecomment-2751840310 could be a reason that this is fine to change, but the CI is failing on this pull",
          "created_at": "2025-04-01T14:20:43Z"
        },
        {
          "user": "luisschwab",
          "body": "> but the CI is failing on this pull\r\n\r\nNot sure what is going on with CI, other PRs are failing on Windows as well.\r\n\r\nedit: https://github.com/bitcoin/bitcoin/pull/32184/ fixes it",
          "created_at": "2025-04-01T18:40:27Z"
        },
        {
          "user": "achow101",
          "body": "-0\r\n\r\nI agree with the rationale given by the others to not make this change.",
          "created_at": "2025-04-10T19:40:02Z"
        },
        {
          "user": "shahsb",
          "body": "Concept ACK",
          "created_at": "2025-04-19T04:22:01Z"
        },
        {
          "user": "DrahtBot",
          "body": "<!--cf906140f33d8803c4a75a2196329ecb-->\nüêô This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
          "created_at": "2025-04-25T13:04:08Z"
        },
        {
          "user": "DrahtBot",
          "body": "<!--13523179cfe9479db18ec6c5d236f789-->\n‚åõ There hasn't been much activity lately and the patch still needs rebase. What is the status here?\n\n* Is it still relevant? ‚û°Ô∏è Please solve the conflicts to make it ready for review and to ensure the CI passes.\n* Is it no longer relevant? ‚û°Ô∏è Please close.\n* Did the author lose interest or time to work on this? ‚û°Ô∏è Please close it and mark it 'Up for grabs' with the label, so that it can be picked up in the future.\n",
          "created_at": "2025-07-23T01:43:04Z"
        },
        {
          "user": "luisschwab",
          "body": "Closing as it failed to reach consensus.",
          "created_at": "2025-07-23T01:53:30Z"
        }
      ]
    },
    {
      "number": 32122,
      "title": "fuzz: Fix off-by-one in package_rbf target",
      "body": "Running the while loop up to `NUM_ITERS` times may set `iter` to `g_outpoints.size()`, which will then lead to an out-of-bounds read.\r\n\r\nThere was an assert, which I guess tried to catch this, but the condition in the assert was wrong as well.\r\n\r\nFix all issues by replacing the broken assert with the internal and correct check inside `std::vector::at` and by limiting `iter` to `NUM_ITERS` in the while loop.\r\n\r\nFixes https://github.com/bitcoin/bitcoin/issues/32121",
      "state": "closed",
      "user": "maflcko",
      "created_at": "2025-03-22T06:41:21Z",
      "updated_at": "2025-10-30T13:59:51Z",
      "comments": 8,
      "url": "https://github.com/bitcoin/bitcoin/pull/32122",
      "labels": [
        "Tests",
        "Fuzzing"
      ],
      "comment_list": [
        {
          "user": "DrahtBot",
          "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/32122.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [glozow](https://github.com/bitcoin/bitcoin/pull/32122#pullrequestreview-2713587920), [brunoerg](https://github.com/bitcoin/bitcoin/pull/32122#pullrequestreview-2714981577) |\n| Concept ACK | [kevkevinpal](https://github.com/bitcoin/bitcoin/pull/32122#issuecomment-2745995758) |\n| Stale ACK | [dergoegge](https://github.com/bitcoin/bitcoin/pull/32122#pullrequestreview-2709789287), [instagibbs](https://github.com/bitcoin/bitcoin/pull/32122#issuecomment-2748077309) |\n\nIf your review is incorrectly listed, please react with üëé to this comment and the bot will ignore it on the next update.\n",
          "created_at": "2025-03-22T06:41:23Z"
        },
        {
          "user": "maflcko",
          "body": "Can be tested with the input and steps from https://github.com/bitcoin/bitcoin/issues/32121",
          "created_at": "2025-03-22T06:42:43Z"
        },
        {
          "user": "kevkevinpal",
          "body": "Concept ACK\r\n\r\nI was able to reproduce the error using the input in https://github.com/bitcoin/bitcoin/issues/32121\r\n\r\n---\r\nI think your approach works but I was wondering\r\nwhy not just modify `initialize_package_rbf` to use this statement \r\n\r\n`for (int i = 0; i <= NUM_ITERS; ++i)`\r\ninstead of\r\n`for (int i = 0; i < NUM_ITERS; ++i)`",
          "created_at": "2025-03-23T03:19:56Z"
        },
        {
          "user": "maflcko",
          "body": "> why not just modify `initialize_package_rbf` to use this statement\r\n\r\nWhy would that be better? Once an off-by-two is added in a future patch, the fuzz target once again will crash, whereas with the patch in this pull, it will work fine?",
          "created_at": "2025-03-24T07:49:46Z"
        },
        {
          "user": "maflcko",
          "body": "> This was caught in the qa-assets CI because we're using a hardened libc++ build? Trying to understand why I haven't seen this in my fuzzing.\r\n\r\nYes. This particular one doesn't require an ABI breaking build, so I think you should be able to find it with any of (fast, extensive, debug) from https://libcxx.llvm.org/Hardening.html#mapping-between-the-hardening-modes-and-the-assertion-categories. Same for GCC: It should be found by any of (ASSERTIONS, DEBUG, DEBUG_PEDANTIC). However, I haven't tried any of this.",
          "created_at": "2025-03-24T10:13:27Z"
        },
        {
          "user": "instagibbs",
          "body": "utACK fa9d9a33420c2db35e9ee7eebe5d6e475e26a8e8\r\n\r\nchange looks right",
          "created_at": "2025-03-24T13:07:55Z"
        },
        {
          "user": "kevkevinpal",
          "body": "> > why not just modify `initialize_package_rbf` to use this statement\r\n> \r\n> Why would that be better? Once an off-by-two is added in a future patch, the fuzz target once again will crash, whereas with the patch in this pull, it will work fine?\r\n\r\nahh ok I see now that makes sense to me",
          "created_at": "2025-03-24T17:47:50Z"
        },
        {
          "user": "glozow",
          "body": "backported in #32136",
          "created_at": "2025-03-25T20:59:28Z"
        }
      ]
    }
  ],
  "issues": [
    {
      "number": 32121,
      "title": "fuzz: package_rbf crashes after out-of-range memory read",
      "body": "Diff to reproduce (turns UB into a runtime exception):\n\n```diff\ndiff --git a/src/test/fuzz/rbf.cpp b/src/test/fuzz/rbf.cpp\nindex 3e5b361186..74099f770d 100644\n--- a/src/test/fuzz/rbf.cpp\n+++ b/src/test/fuzz/rbf.cpp\n@@ -118,7 +118,7 @@ FUZZ_TARGET(package_rbf, .init = initialize_package_rbf)\n     }\n     assert(iter <= g_outpoints.size());\n     replacement_tx->vin.resize(1);\n-    replacement_tx->vin[0].prevout = g_outpoints[iter++];\n+    replacement_tx->vin[0].prevout = g_outpoints.at(iter++);\n     CTransaction replacement_tx_final{*replacement_tx};\n     auto replacement_entry = ConsumeTxMemPoolEntry(fuzzed_data_provider, replacement_tx_final);\n     int32_t replacement_vsize = replacement_entry.GetTxSize();\n@@ -132,7 +132,7 @@ FUZZ_TARGET(package_rbf, .init = initialize_package_rbf)\n         CMutableTransaction parent;\n         assert(iter <= g_outpoints.size());\n         parent.vin.resize(1);\n-        parent.vin[0].prevout = g_outpoints[iter++];\n+        parent.vin[0].prevout = g_outpoints.at(iter++);\n         parent.vout.emplace_back(0, CScript());\n \n         mempool_txs.emplace_back(parent);\n```\n\nInput to reproduce:\n\n* https://github.com/user-attachments/files/19401119/package_rbf.crash.not.txt\n\nCommand to reproduce:\n\n```\n$ FUZZ=package_rbf ./bld-cmake/bin/fuzz ./package_rbf.crash.not.txt \n\nterminate called after throwing an instance of 'std::out_of_range'\n  what():  vector::_M_range_check: __n (which is 10000) >= this->size() (which is 10000)\n",
      "state": "closed",
      "user": "maflcko",
      "created_at": "2025-03-22T06:24:03Z",
      "updated_at": "2025-03-25T20:57:49Z",
      "comments": 0,
      "url": "https://github.com/bitcoin/bitcoin/issues/32121",
      "labels": [
        "Tests"
      ]
    },
    {
      "number": 32120,
      "title": ".",
      "body": ".",
      "state": "closed",
      "user": "farrelA",
      "created_at": "2025-03-22T04:42:04Z",
      "updated_at": "2025-03-22T04:59:55Z",
      "comments": 0,
      "url": "https://github.com/bitcoin/bitcoin/issues/32120",
      "labels": []
    },
    {
      "number": 32119,
      "title": ".",
      "body": ".",
      "state": "closed",
      "user": "Dan9470000",
      "created_at": "2025-03-22T03:50:32Z",
      "updated_at": "2025-03-22T07:39:46Z",
      "comments": 0,
      "url": "https://github.com/bitcoin/bitcoin/issues/32119",
      "labels": []
    }
  ],
  "summary": {
    "pull_requests": 2,
    "issues": 3
  }
}