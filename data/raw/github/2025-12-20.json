{
  "source": "github",
  "repository": "bitcoin/bitcoin",
  "fetched_at": "2026-01-15T20:41:50.565878+00:00",
  "date": "2025-12-20",
  "pull_requests": [
    {
      "number": 34132,
      "title": "refactor: inline `CCoinsViewErrorCatcher` into `CCoinsViewDB`",
      "body": "### Problem\r\n\r\nThe current coins database read-error handling adds unnecessary complexity to the critical path:\r\n\r\n- `CCoinsViewErrorCatcher` sits between the cache and database views, wrapping every read operation with a generic error handler\r\n- `ExecuteBackedWrapper` adds another function call layer with lambda captures on each database read\r\n-  Uses `std::vector<std::function<void()>>` for callbacks when there's only ever one callback registered\r\n-  The error callback is set after database initialization rather than during construction (requiring a `cs_main` lock)\r\n\r\nThis adds unnecessary stack depth and bookkeeping overhead on every coins database read operation (`GetCoin`). Also note that `CCoinsViewDB::HaveCoin` isn't even called from production code as far as I can tell.\r\n\r\n### Context\r\n\r\nThis is part of ongoing coins caching cleanup efforts like #34124, #33866, #33018, and #33512.\r\n\r\n### Fix\r\n\r\nThis PR collapses the `CCoinsViewErrorCatcher` layer entirely and moves error handling directly into `CCoinsViewDB`:\r\n\r\n- Remove `ExecuteBackedWrapper` and `CCoinsViewErrorCatcher`, placing try-catch blocks directly in `CCoinsViewDB::GetCoin` and `CCoinsViewDB::HaveCoin`\r\n- Replace `std::vector<std::function<void()>>` with a single `std::function<void()>` member, initialized in the constructor\r\n- The read error callback is now passed to `Chainstate::InitCoinsDB` and forwarded to `CCoinsViewDB` constructor\r\n\r\nA new test is also added to reproduce the behavior in case of database corruption. It's added as a first commit to demonstrate that the behavior stays unchanged.",
      "state": "open",
      "user": "l0rinc",
      "created_at": "2025-12-20T22:56:45Z",
      "updated_at": "2026-01-14T22:34:49Z",
      "comments": 4,
      "url": "https://github.com/bitcoin/bitcoin/pull/34132",
      "labels": [
        "Refactoring"
      ],
      "comment_list": [
        {
          "user": "DrahtBot",
          "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/34132.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Concept ACK | [sedited](https://github.com/bitcoin/bitcoin/pull/34132#issuecomment-3709594872) |\n| Stale ACK | [andrewtoth](https://github.com/bitcoin/bitcoin/pull/34132#pullrequestreview-3648378551) |\n\nIf your review is incorrectly listed, please copy-paste <code>&lt;!--meta-tag:bot-skip--&gt;</code> into the comment that the bot should ignore.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#34276](https://github.com/bitcoin/bitcoin/pull/34276) (Remove empty caption from user interface (noui, gui) by maflcko)\n* [#34207](https://github.com/bitcoin/bitcoin/pull/34207) (coins/refactor: enforce `GetCoin()` returns only unspent coins by l0rinc)\n* [#34164](https://github.com/bitcoin/bitcoin/pull/34164) (validation: add reusable coins view for ConnectBlock by andrewtoth)\n* [#34124](https://github.com/bitcoin/bitcoin/pull/34124) (refactor: make `CCoinsView` a purely virtual abstract base class by l0rinc)\n* [#31382](https://github.com/bitcoin/bitcoin/pull/31382) (kernel: Flush in ChainstateManager destructor by sedited)\n* [#31132](https://github.com/bitcoin/bitcoin/pull/31132) (validation: fetch block inputs on parallel threads 3x faster IBD by andrewtoth)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n<!--5faf32d7da4f0f540f40219e4f7537a3-->",
          "created_at": "2025-12-20T22:56:54Z"
        },
        {
          "user": "l0rinc",
          "body": "close/open dance to retrigger CI - likely caused by [GitHub outage](https://www.githubstatus.com/history) ",
          "created_at": "2025-12-23T08:04:46Z"
        },
        {
          "user": "sedited",
          "body": "Concept ACK",
          "created_at": "2026-01-05T09:26:47Z"
        },
        {
          "user": "l0rinc",
          "body": "Rebased and updated the added test to work on [32 bit systems](https://github.com/bitcoin/bitcoin/pull/34132#discussion_r2679121949) as well. Ready for review again! ",
          "created_at": "2026-01-11T00:45:21Z"
        }
      ]
    },
    {
      "number": 34127,
      "title": "iwyu: Add `pragma: always_keep` to `bitcoin-build-config.h`",
      "body": "Rather than use `// IWYU pragma: keep` with every `#include <bitcoin-build-config.h>`, apply a dedicated [`always_keep`](https://github.com/include-what-you-use/include-what-you-use/blob/clang_21/docs/IWYUPragmas.md#iwyu-pragma-always_keep) pragma to the `bitcoin-build-config.h` header itself.",
      "state": "closed",
      "user": "hebasto",
      "created_at": "2025-12-20T17:25:39Z",
      "updated_at": "2025-12-21T17:36:50Z",
      "comments": 1,
      "url": "https://github.com/bitcoin/bitcoin/pull/34127",
      "labels": [
        "Refactoring"
      ],
      "comment_list": [
        {
          "user": "DrahtBot",
          "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/34127.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\nA summary of reviews will appear here.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#34098](https://github.com/bitcoin/bitcoin/pull/34098) (test: [move-only] Move lint functions into modules by maflcko)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n<!--5faf32d7da4f0f540f40219e4f7537a3-->",
          "created_at": "2025-12-20T17:25:46Z"
        }
      ]
    },
    {
      "number": 34126,
      "title": "index: Add ScriptTypeIndex to track script type statistics per block",
      "body": "This PR adds a new optional index (`ScriptTypeIndex`) that traks statistics about script types for each block. The index maintains both the count and total value (in satoshis) of outputs for each script type per block.\r\n\r\nTracking script type statistics enables analysis of Bitcoin's UTXO set composition over time, (for example we can see addoption trends for: P2PKH, P2SH, SegWit, Taproot) and value distribution across script types.\r\n\r\n## Implementation\r\n\r\n- New `ScriptTypeIndex` class extending `BaseIndex`\r\n- Tracks all standard script types: NONSTANDARD, P2PK, P2PKH, P2SH, MULTISIG, NULL_DATA, P2WPKH, P2WSH, P2TR\r\n- For each script type, tracks both output count and total sats locked\r\n- Disabled by default, enabled with `-scripttypeindex` flag\r\n\r\n## RPC Interface\r\n\r\nAdds new RPC method `getscripttypestats <blockhash>` that returns nested objects with `count` and `value` for each script type:\r\n```\r\n{\r\n  \"nonstandard\": {\"count\": 0, \"value\": 0},\r\n  \"p2pk\": {\"count\": 1, \"value\": 5000000000},\r\n  \"p2pkh\": {\"count\": 5, \"value\": 25000000000},\r\n  ...\r\n}\r\n```\r\n\r\n## Testing\r\n\r\nUnit tests included in `src/test/scripttypeindex_tests.cpp`:\r\n- Basic initial sync test\r\n- Test with multiple script types (P2PKH, P2SH, MULTISIG, NULL_DATA, P2WPKH, P2WSH, P2TR)\r\n\r\n\r\n### Example output:\r\n<img width=\"1305\" height=\"677\" alt=\"image\" src=\"https://github.com/user-attachments/assets/bc7df617-50e0-4f47-a394-127a8370c231\" />\r\n",
      "state": "closed",
      "user": "zkokelj",
      "created_at": "2025-12-20T14:09:46Z",
      "updated_at": "2025-12-20T14:11:15Z",
      "comments": 1,
      "url": "https://github.com/bitcoin/bitcoin/pull/34126",
      "labels": [
        "UTXO Db and Indexes"
      ],
      "comment_list": [
        {
          "user": "DrahtBot",
          "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/34126.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\nA summary of reviews will appear here.\n<!--5faf32d7da4f0f540f40219e4f7537a3-->\n### LLM Linter (âœ¨ experimental)\n\n\n\nPossible places where equality-specific test macros should replace generic comparisons:\n\n- src/test/scripttypeindex_tests.cpp snippet: BOOST_CHECK(block_index != new_block_index); -> recommendation: use the inequality-specific Boost.Test macro BOOST_CHECK_NE(block_index, new_block_index) (or BOOST_REQUIRE_NE if this should be a fatal requirement) for clearer diagnostics.\n\n\n\n<sup>2025-12-20</sup>\n",
          "created_at": "2025-12-20T14:09:52Z"
        }
      ]
    },
    {
      "number": 34125,
      "title": "validation: reuse `should_empty` check for chainstate flush",
      "body": "Minor follow-up to https://github.com/bitcoin/bitcoin/pull/33866\r\n\r\nReuse the `should_empty` predicate for both the write decision and for selecting `CoinsTip().Flush()` vs `CoinsTip().Sync()`.\r\nThis is a pure refactor, no behavior is changed.",
      "state": "open",
      "user": "l0rinc",
      "created_at": "2025-12-20T12:14:47Z",
      "updated_at": "2026-01-03T20:15:23Z",
      "comments": 2,
      "url": "https://github.com/bitcoin/bitcoin/pull/34125",
      "labels": [
        "Refactoring"
      ],
      "comment_list": [
        {
          "user": "DrahtBot",
          "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/34125.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\nA summary of reviews will appear here.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#33680](https://github.com/bitcoin/bitcoin/pull/33680) (validation: do not wipe utxo cache for stats/scans/snapshots by l0rinc)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n<!--5faf32d7da4f0f540f40219e4f7537a3-->",
          "created_at": "2025-12-20T12:14:54Z"
        },
        {
          "user": "l0rinc",
          "body": "https://github.com/bitcoin/bitcoin/pull/33866 was just merged, this PR is ready for review.",
          "created_at": "2026-01-03T10:59:47Z"
        }
      ]
    },
    {
      "number": 34124,
      "title": "refactor: make `CCoinsView` a purely virtual abstract base class",
      "body": "### Problem\r\n`CCoinsView` serves as the interface for the coins database layer, but historically had a dual nature that caused confusion:\r\n\r\n* It provided default noop implementations (returning `std::nullopt`, `uint256()`, `false`, `nullptr`) instead of being pure virtual\r\n* Callers could instantiate a bare `CCoinsView` and get silent no-op behavior\r\n* Mixing the interface definition with a built-in dummy implementation blurred the abstraction boundary\r\n\r\n### Context\r\n\r\nThis is part of ongoing coins caching cleanup efforts such as #34132, #33866, #33018, and #33512.\r\n\r\n### Fix\r\n\r\nThis PR makes `CCoinsView` a pure abstract interface and introduces an explicit noop implementation, in tiny incremental steps to ease review:\r\n\r\n* Add `CCoinsViewEmpty` as an explicit noop coins view for tests, benchmarks, and dummy backends\r\n* Replace all direct `CCoinsView` instantiations with `CCoinsViewEmpty`\r\n* Incrementally make all `CCoinsView` methods pure virtual (`GetCoin`, `GetBestBlock`, `BatchWrite`, `EstimateSize`, `Cursor`, `GetHeadBlocks`, `HaveCoin`)\r\n* Remove the legacy default implementations from `coins.cpp`\r\n* Update the coins view fuzzer to switch between a real database-backed view and `CCoinsViewEmpty`\r\n",
      "state": "open",
      "user": "l0rinc",
      "created_at": "2025-12-20T08:47:33Z",
      "updated_at": "2026-01-13T01:14:27Z",
      "comments": 5,
      "url": "https://github.com/bitcoin/bitcoin/pull/34124",
      "labels": [
        "Refactoring"
      ],
      "comment_list": [
        {
          "user": "DrahtBot",
          "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/34124.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Concept ACK | [andrewtoth](https://github.com/bitcoin/bitcoin/pull/34124#issuecomment-3678038276), [ajtowns](https://github.com/bitcoin/bitcoin/pull/34124#pullrequestreview-3602578034), [sipa](https://github.com/bitcoin/bitcoin/pull/34124#pullrequestreview-3618585105) |\n\nIf your review is incorrectly listed, please copy-paste <code>&lt;!--meta-tag:bot-skip--&gt;</code> into the comment that the bot should ignore.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#34165](https://github.com/bitcoin/bitcoin/pull/34165) (coins: don't mutate main cache when connecting block by andrewtoth)\n* [#34164](https://github.com/bitcoin/bitcoin/pull/34164) (validation: add reusable coins view for ConnectBlock by andrewtoth)\n* [#34132](https://github.com/bitcoin/bitcoin/pull/34132) (refactor: inline `CCoinsViewErrorCatcher` into `CCoinsViewDB` by l0rinc)\n* [#33512](https://github.com/bitcoin/bitcoin/pull/33512) (coins: use number of dirty cache entries in flush warnings/logs by l0rinc)\n* [#31132](https://github.com/bitcoin/bitcoin/pull/31132) (validation: fetch block inputs on parallel threads 3x faster IBD by andrewtoth)\n* [#29060](https://github.com/bitcoin/bitcoin/pull/29060) (Policy: Report debug message why inputs are non standard by ismaelsadeeq)\n* [#27865](https://github.com/bitcoin/bitcoin/pull/27865) (wallet: Track no-longer-spendable TXOs separately by achow101)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n<!--5faf32d7da4f0f540f40219e4f7537a3-->",
          "created_at": "2025-12-20T08:47:41Z"
        },
        {
          "user": "andrewtoth",
          "body": "Concept ACK\n\nMakes sense to make an empty view explicit, and having the base class be purely virtual.",
          "created_at": "2025-12-20T19:02:06Z"
        },
        {
          "user": "l0rinc",
          "body": "This change also revealed a potential UB in `MemPoolAccept` member init order. Since class members are constructed in [declaration order](https://en.cppreference.com/w/cpp/language/initializer_list.html#Initialization_order) (not initializer-list order), calls to a virtual method (having `m_view` depend on `m_dummy` but declared before it) can result in a virtual call through an uninitialized vptr and crash.\r\nSince the constructor didn't dereference `m_dummy` during `m_view` construction, the latent ordering hazard stayed dormant. This cleanup accidentally fixed it, but to make it explicit, I have extracted it to the first commit as a temporary fix.",
          "created_at": "2025-12-28T11:04:11Z"
        },
        {
          "user": "l0rinc",
          "body": "A slightly more involved rebase after https://github.com/bitcoin/bitcoin/pull/33866.\r\nMost of the conflicts were around moving `BatchWrite` around.\r\nI have also separated the second commit into 3, to address reviewer feedback regarding cleaning up naming and formatting of affected methods. This way - after a boring refactor commit - the non-trivial follow-up commits are easier to review.\r\nCan be reviewed via `git range-diff -w -U0 master e3d4435 3b800c9`.",
          "created_at": "2026-01-03T13:21:29Z"
        },
        {
          "user": "DrahtBot",
          "body": "<!--85328a0da195eb286784d51f73fa0af9-->\nðŸš§ At least one of the CI tasks failed.\n<sub>Task `ASan + LSan + UBSan + integer`: https://github.com/bitcoin/bitcoin/actions/runs/20677817262/job/59367841784</sub>\n<sub>LLM reason (âœ¨ experimental): Compiler error in fuzz/coins_view.cpp: attempted assignment with no viable overloaded operator=, causing the build to fail.</sub>\n\n<details><summary>Hints</summary>\n\nTry to run the tests locally, according to the documentation. However, a CI failure may still\nhappen due to a number of reasons, for example:\n\n* Possibly due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\n* A sanitizer issue, which can only be found by compiling with the sanitizer and running the\n  affected test.\n\n* An intermittent issue.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n</details>\n\n",
          "created_at": "2026-01-03T13:31:25Z"
        }
      ]
    },
    {
      "number": 34123,
      "title": "doc: Clarify CMake test runner workflow in README",
      "body": "This PR updates `test/README.md` to recommend running `test_runner.py` from the `build/` directory when using CMake.\r\n\r\nRunning from the source directory (e.g., `./test/functional/test_runner.py`) fails on fresh builds because `config.ini` is located in the build directory. Using the build directory path leverages the symlinks correctly and ensures the configuration is found without needing manual flags.\r\n\r\nContext: Supersedes #34073 based on feedback from @maflcko.",
      "state": "closed",
      "user": "YG01110",
      "created_at": "2025-12-20T02:47:05Z",
      "updated_at": "2025-12-20T11:47:11Z",
      "comments": 2,
      "url": "https://github.com/bitcoin/bitcoin/pull/34123",
      "labels": [
        "Docs"
      ],
      "comment_list": [
        {
          "user": "DrahtBot",
          "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/34123.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\nA summary of reviews will appear here.\n<!--5faf32d7da4f0f540f40219e4f7537a3-->",
          "created_at": "2025-12-20T02:47:12Z"
        },
        {
          "user": "YG01110",
          "body": "Closing this.",
          "created_at": "2025-12-20T11:46:55Z"
        }
      ]
    }
  ],
  "issues": [
    {
      "number": 34128,
      "title": "migrating legacy wallet \"completes\", then removes bitcoin/wallets",
      "body": "### Is there an existing issue for this?\n\n- [x] I have searched the existing issues\n\n### Current behaviour\n\nWhen I start bitcoin-qt, it says I have a legacy wallet and tells me to migrate it. When I do, a message says that the migration is starting and after a time bitcoin-qt abruptly ends. When I start bitcoin-qt again it says that it cannot find the wallet. On investigating, I see that not only is bitcoin/wallet/wallet.dat gone, but so is the directory bitcoin/wallet.\n\nLooking at the log, it appears that the migration is successful, then ... something happens.\n\n### Expected behaviour\n\ncomplete the migration and don't destroy the wallet.\n\n### Steps to reproduce\n\nWith my legacy wallet.dat, use bitcoin-qt to migrate the legacy wallet.\n\n### Relevant log output\n\n2025-12-20T16:59:02Z [default wallet] Last client version = 80500\n2025-12-20T16:59:02Z [default wallet] Legacy Wallet Keys: 104 plaintext, 0 encrypted, 0 w/ metadata, 104 total.\n2025-12-20T16:59:02Z [default wallet] Descriptors: 0, Descriptor Keys: 0 plaintext, 0 encrypted, 0 total.\n2025-12-20T16:59:02Z [default wallet] Wallet completed loading in              17ms\n2025-12-20T16:59:02Z [default wallet] setKeyPool.size() = 0\n2025-12-20T16:59:02Z [default wallet] mapWallet.size() = 14\n2025-12-20T16:59:02Z [default wallet] m_address_book.size() = 4\n2025-12-20T16:59:02Z copied /mnt/bitcoin/wallets/wallet.dat to /mnt/bitcoin/wallets/default_wallet_1766249942.legacy.bak\n2025-12-20T16:59:02Z [default wallet] Migrating wallet storage database from BerkeleyDB to SQLite.\n2025-12-20T16:59:02Z Using SQLite Version 3.50.2\n2025-12-20T16:59:02Z Using wallet /mnt/bitcoin/wallets\n2025-12-20T16:59:02Z [default wallet] Setting spkMan to active: id = 374182aed2e22c1ef37dd8e5b9fd631242f647ae57f05d8b9556d18db013ee47, type = legacy, internal = false\n2025-12-20T16:59:02Z [default wallet] Setting spkMan to active: id = ceff5344334331f96f356b6e01c5271441aef08d6e4ee1581cc21c652f42bc86, type = p2sh-segwit, internal = false\n2025-12-20T16:59:02Z [default wallet] Setting spkMan to active: id = 155bbeb7f9c67d2d69329fb2a3762c295de656cb81ecda752985e51e8c3c6c79, type = bech32, internal = false\n2025-12-20T16:59:02Z [default wallet] Setting spkMan to active: id = 1bd0bae9fcd655a7eefabfa486a4aac06d378caaea4fb18fd3ff82e267f33a5c, type = bech32m, internal = false\n2025-12-20T16:59:02Z [default wallet] Setting spkMan to active: id = 7ecccb708fa526705eae8095ab93eb2818c2046f7bc0f16991ce7290ea359751, type = legacy, internal = true\n2025-12-20T16:59:02Z [default wallet] Setting spkMan to active: id = 504be46550019ff607ead9e999e4fd08f4c302f7c64275eecadd31189a08d53d, type = p2sh-segwit, internal = true\n2025-12-20T16:59:02Z [default wallet] Setting spkMan to active: id = ee394eb8b5666dc08b1ba7d763045043101fead2bf3d2f374a8dceb15efc676c, type = bech32, internal = true\n2025-12-20T16:59:02Z [default wallet] Setting spkMan to active: id = 295830f0bdf428f220030af634792d5c40ded7d2b129fc2d185d31d21992bf77, type = bech32m, internal = true\n2025-12-20T16:59:02Z [default wallet] Wallet migration complete.\n2025-12-20T16:59:02Z [default wallet] Releasing wallet ..\n2025-12-20T16:59:02Z Using SQLite Version 3.50.2\n2025-12-20T16:59:02Z Using wallet /mnt/bitcoin/wallets\n2025-12-20T16:59:02Z init message: Loading walletâ€¦\n2025-12-20T16:59:02Z [default wallet] Last client version = 80500\n2025-12-20T16:59:03Z [default wallet] Descriptors: 112, Descriptor Keys: 1 plaintext, 0 encrypted, 1 total.\n2025-12-20T16:59:03Z [default wallet] Setting spkMan to active: id = 374182aed2e22c1ef37dd8e5b9fd631242f647ae57f05d8b9556d18db013ee47, type = legacy, internal = false\n2025-12-20T16:59:03Z [default wallet] Setting spkMan to active: id = ceff5344334331f96f356b6e01c5271441aef08d6e4ee1581cc21c652f42bc86, type = p2sh-segwit, internal = false\n2025-12-20T16:59:03Z [default wallet] Setting spkMan to active: id = 155bbeb7f9c67d2d69329fb2a3762c295de656cb81ecda752985e51e8c3c6c79, type = bech32, internal = false\n2025-12-20T16:59:03Z [default wallet] Setting spkMan to active: id = 1bd0bae9fcd655a7eefabfa486a4aac06d378caaea4fb18fd3ff82e267f33a5c, type = bech32m, internal = false\n2025-12-20T16:59:03Z [default wallet] Setting spkMan to active: id = 7ecccb708fa526705eae8095ab93eb2818c2046f7bc0f16991ce7290ea359751, type = legacy, internal = true\n2025-12-20T16:59:03Z [default wallet] Setting spkMan to active: id = 504be46550019ff607ead9e999e4fd08f4c302f7c64275eecadd31189a08d53d, type = p2sh-segwit, internal = true\n2025-12-20T16:59:03Z [default wallet] Setting spkMan to active: id = ee394eb8b5666dc08b1ba7d763045043101fead2bf3d2f374a8dceb15efc676c, type = bech32, internal = true\n2025-12-20T16:59:03Z [default wallet] Setting spkMan to active: id = 295830f0bdf428f220030af634792d5c40ded7d2b129fc2d185d31d21992bf77, type = bech32m, internal = true\n2025-12-20T16:59:03Z [default wallet] Wallet completed loading in             509ms\n2025-12-20T16:59:03Z [default wallet] Releasing wallet ..\n\n\n\n\n\n2025-12-20T17:07:16Z Bitcoin Core version v30.0.0 (release build)\n2025-12-20T17:07:16Z Qt 6.10.1 (dynamic), plugin=xcb\n2025-12-20T17:07:16Z No static plugins.\n2025-12-20T17:07:16Z Style: fusion / QFusionStyle\n2025-12-20T17:07:16Z System: Fedora Linux 43 (Workstation Edition), x86_64-little_endian-lp64\n2025-12-20T17:07:16Z Screen: HDMI-0 1920x1080, pixel ratio=1.0\n2025-12-20T17:07:16Z GUI: QFSFileEngine::open: No file name specified\n2025-12-20T17:07:16Z GUI: QFSFileEngine::open: No file name specified\n2025-12-20T17:07:16Z GUI: QFSFileEngine::open: No file name specified\n2025-12-20T17:07:16Z GUI: QFSFileEngine::open: No file name specified\n2025-12-20T17:07:16Z GUI: QFSFileEngine::open: No file name specified\n2025-12-20T17:07:16Z Using the 'sse4(1way);sse41(4way);avx2(8way)' SHA256 implementation\n2025-12-20T17:07:16Z Using RdSeed as an additional entropy source\n2025-12-20T17:07:16Z Using RdRand as an additional entropy source\n2025-12-20T17:07:16Z Default data directory /home/jonathans/.bitcoin\n2025-12-20T17:07:16Z Using data directory /mnt/bitcoin\n2025-12-20T17:07:16Z Config file: /home/jonathans/.bitcoin/bitcoin.conf\n2025-12-20T17:07:16Z Config file arg: datadir=\"/mnt/bitcoin\"\n2025-12-20T17:07:16Z Config file arg: dbcache=\"1024\"\n2025-12-20T17:07:16Z Config file arg: listen=\"1\"\n2025-12-20T17:07:16Z Config file arg: maxconnections=\"40\"\n2025-12-20T17:07:16Z Config file arg: maxmempool=\"300\"\n2025-12-20T17:07:16Z Config file arg: prune=\"550\"\n2025-12-20T17:07:16Z Config file arg: walletdir=\"/mnt/bitcoin/wallets\"\n2025-12-20T17:07:16Z Setting file arg: prune = \"3814\"\n2025-12-20T17:07:16Z Setting file arg: wallet = [\"\"]\n2025-12-20T17:07:16Z Using at most 40 automatic connections (1024 file descriptors available)\n2025-12-20T17:07:16Z scheduler thread start\n2025-12-20T17:07:16Z [error] Specified -walletdir \"/mnt/bitcoin/wallets\" does not exist\n2025-12-20T17:07:29Z Shutdown in progress...\n2025-12-20T17:07:29Z scheduler thread exit\n2025-12-20T17:07:29Z Shutdown done\n2025-12-20T17:07:29Z GUI: QFontDatabase: Must construct a QGuiApplication before accessing QFontDatabase\n\n\n### How did you obtain Bitcoin Core\n\nCompiled from source\n\n### What version of Bitcoin Core are you using?\n\nBitcoin Core version v30.0.0 (release build)\n\n### Operating system and version\n\nFedora Linux 43\n\n### Machine specifications\n\nKernel: 6.17.12-300.fc43.x86_64\nWindowing system: X11\nCPU: Intel i5-10400F CPU @ 2.90 GHz\nMemory: 62.7 GiB\nbroadband Internet",
      "state": "closed",
      "user": "jestory",
      "created_at": "2025-12-20T17:26:58Z",
      "updated_at": "2026-01-07T18:40:26Z",
      "comments": 9,
      "url": "https://github.com/bitcoin/bitcoin/issues/34128",
      "labels": [
        "Wallet"
      ],
      "comment_list": [
        {
          "user": "achow101",
          "body": "Are you able to reliably reproduce this issue? I am unable to reproduce the issue both with self compiled and the release binaries.",
          "created_at": "2025-12-20T22:47:35Z"
        },
        {
          "user": "jestory",
          "body": "It is very reliable. I copy my backup wallet.dat to wallets, and when I restart bitcoin-qt, the cycle continues again:\nI select migrate, the migration appears to complete, based on the log information, then bitcoin-qt quits without any error message, and when I look the wallets directory is gone, with everything in it.\n\nI have not been able to migrate the legacy wallet.",
          "created_at": "2025-12-21T02:38:37Z"
        },
        {
          "user": "achow101",
          "body": "Does it happen if you use the release binaries? What about with 29.2?",
          "created_at": "2025-12-21T04:03:10Z"
        },
        {
          "user": "furszy",
          "body": "As it seems you compiled it yourself, could you attach the debugger and tell us where it crashed?\nThat would speed up the bug-hunting process.",
          "created_at": "2025-12-21T15:14:06Z"
        },
        {
          "user": "maflcko",
          "body": "I also can't reproduce this. Do the functional tests pass for you?\n\nI've also written a sketch of a functional test to check this:\n\n```diff\ndiff --git a/test/functional/wallet_migration.py b/test/functional/wallet_migration.py\nindex 89989fbf81..1e9bc18bde 100755\n--- a/test/functional/wallet_migration.py\n+++ b/test/functional/wallet_migration.py\n@@ -698,6 +698,47 @@ class WalletMigrationTest(BitcoinTestFramework):\n         assert (self.master_node.wallets_path / \"plainfile\").is_dir()\n         assert (self.master_node.wallets_path / \"plainfile\" / \"wallet.dat\").is_file()\n \n+    def test_walletdir_direct_file(self):\n+        self.log.info(\"Test migrating a legacy wallet stored as a direct file inside a custom walletdir\")\n+        wallet_name = \"walletdir_direct\"\n+        wallet = self.create_legacy_wallet(wallet_name)\n+        wallet.unloadwallet()\n+\n+        wallets_direct = self.master_node.datadir_path / \"wallets_direct\"\n+        wallets_direct.mkdir(parents=True, exist_ok=True)\n+        shutil.copyfile(\n+            self.old_node.wallets_path / wallet_name / \"wallet.dat\",\n+            wallets_direct / wallet_name,\n+        )\n+        assert (wallets_direct / wallet_name).is_file()\n+\n+        self.restart_node(0, extra_args=[f\"-walletdir={wallets_direct}\"])\n+        self.connect_nodes(0, 1)\n+\n+        mocked_time = int(time.time())\n+        self.master_node.setmocktime(mocked_time)\n+        migrate_res = self.master_node.migratewallet(wallet_name)\n+        self.master_node.setmocktime(0)\n+\n+        assert_equal(migrate_res[\"wallet_name\"], wallet_name)\n+        migrated_wallet = self.master_node.get_wallet_rpc(wallet_name)\n+        info = migrated_wallet.getwalletinfo()\n+        assert_equal(info[\"descriptors\"], True)\n+        assert_equal(info[\"format\"], \"sqlite\")\n+\n+        assert (wallets_direct / wallet_name).is_dir()\n+        assert (wallets_direct / wallet_name / \"wallet.dat\").is_file()\n+\n+        self.master_node.unloadwallet(wallet_name, load_on_startup=False)\n+\n+        assert False  # passed until now\n+\n+        self.restart_node(0, extra_args=self.extra_args[0])\n+        self.connect_nodes(0, 1)\n+        if self.default_wallet_name not in self.master_node.listwallets():\n+            self.master_node.loadwallet(self.default_wallet_name)\n+        self.sync_all()\n+\n     def test_addressbook(self):\n         df_wallet = self.master_node.get_wallet_rpc(self.default_wallet_name)\n \n@@ -1562,6 +1603,7 @@ class WalletMigrationTest(BitcoinTestFramework):\n         self.test_wallet_with_path(\"path/that/ends/in/..\")\n         self.test_default_wallet()\n         self.test_direct_file()\n+        self.test_walletdir_direct_file()\n         self.test_addressbook()\n         self.test_migrate_raw_p2sh()\n         self.test_conflict_txs()\n```\n\nIt doesn't fully integrate and pass yet, but the relevant part does pass locally for me.",
          "created_at": "2025-12-22T12:16:48Z"
        },
        {
          "user": "navneettsinghh",
          "body": "Yes â€” I can reproduce the issue 100% of the time.\n\nSteps I follow:\n\nCopy my known-good legacy wallet.dat into the wallet directory:\n\n/mnt/bitcoin/wallets/\n\n\nLaunch bitcoin-qt.\n\nBitcoin Core prompts for migration.\n\nI click Migrate.\n\nMigration completes according to the log, the new descriptor wallet loads once, and then bitcoin-qt exits abruptly with no GUI error.\n\nWhen restarting bitcoin-qt, the entire wallet directory is gone, not just wallet.dat.\n\nThis cycle repeats consistently.\n\nKey Details Suggesting a Bug\n\nThe log always shows:\n\nWallet migration complete.\nWallet completed loading...\nReleasing wallet ..\n\n\nImmediately followed by multiple Qt errors:\n\nGUI: QFSFileEngine::open: No file name specified\n\n\nAnd on the next startup:\n\n[error] Specified -walletdir \"/mnt/bitcoin/wallets\" does not exist\n\n\nThis confirms the directory was deleted after migration, not before.\n\nEnvironment Information\n\nBitcoin Core: v30.0.0 (compiled from source)\n\nQt version: 6.10.1 (dynamic)\n\nOS: Fedora Linux 43 (X11)\n\nKernel: 6.17.12-300.fc43.x86_64\n\nwalletdir: /mnt/bitcoin/wallets mounted on a secondary disk\n\nHardware: Intel i5-10400F, 62.7 GiB RAM\n\nFilesystem: (same as underlying /mnt/bitcoin mount)\n\nThe migration only fails when the wallet directory is on this mounted path. I have not been able to produce a successful migration under any configuration when using this folder.\n\nWhat Actually Gets Deleted\n\nAfter migration succeeds and the wallet is released, the entire directory /mnt/bitcoin/wallets is missing.\n\nInside Bitcoin Coreâ€™s log, earlier I can see the backup is made successfully:\n\ncopied wallet.dat to default_wallet_*.legacy.bak\n\n\nThat backup file also disappears because the directory itself gets removed.",
          "created_at": "2025-12-24T15:12:53Z"
        },
        {
          "user": "mdance",
          "body": "I am experiencing the same issue with a recently source compiled tags/v30.0, upon attempting the migratewallet it blows away everything... wtf\n\nbitcoin-cli -testnet migratewallet ~/.bitcoin/testnet3\nerror code: -4\nerror message:\nWallet loading failed. Prune: last wallet synchronisation goes beyond pruned data. You need to -reindex (download the whole blockchain again in case of a pruned node)Backup file does not exist\nUnable to restore backup of wallet.",
          "created_at": "2026-01-04T03:41:29Z"
        },
        {
          "user": "achow101",
          "body": " #34156 has a fix for the deletion issue.",
          "created_at": "2026-01-04T03:55:58Z"
        },
        {
          "user": "furszy",
          "body": "#34156 got merged, this can be closed.",
          "created_at": "2026-01-07T18:37:30Z"
        }
      ]
    }
  ],
  "summary": {
    "pull_requests": 6,
    "issues": 1
  }
}