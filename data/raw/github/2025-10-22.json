{
  "source": "github",
  "repository": "bitcoin/bitcoin",
  "fetched_at": "2026-01-15T21:18:16.684329+00:00",
  "date": "2025-10-22",
  "pull_requests": [
    {
      "number": 33683,
      "title": "refactor/doc: Add blockman param to GetTransaction doc comment",
      "body": "Follow-up to [#27125](https://github.com/bitcoin/bitcoin/pull/27125#discussion_r1190350876)\r\n\r\nThis PR addresses a minor documentation and style nit mentioned during review:\r\n\r\n- Adds the missing `@param[in] blockman` line to the `GetTransaction()` doc comment.\r\n- Moves the output parameter `hashBlock` to the end of both the function\r\n  declaration and definition, as suggested in the comment.",
      "state": "closed",
      "user": "musaHaruna",
      "created_at": "2025-10-22T21:17:05Z",
      "updated_at": "2025-10-31T18:56:58Z",
      "comments": 7,
      "url": "https://github.com/bitcoin/bitcoin/pull/33683",
      "labels": [
        "Docs"
      ],
      "comment_list": [
        {
          "user": "DrahtBot",
          "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/33683.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [l0rinc](https://github.com/bitcoin/bitcoin/pull/33683#issuecomment-3444074180), [maflcko](https://github.com/bitcoin/bitcoin/pull/33683#issuecomment-3446088430), [kevkevinpal](https://github.com/bitcoin/bitcoin/pull/33683#issuecomment-3458778733) |\n\nIf your review is incorrectly listed, please react with ðŸ‘Ž to this comment and the bot will ignore it on the next update.\n<!--5faf32d7da4f0f540f40219e4f7537a3-->",
          "created_at": "2025-10-22T21:17:11Z"
        },
        {
          "user": "kevkevinpal",
          "body": "Since this is just a doc change and not a refactor I'd just move the comment down a line and only make a change there.",
          "created_at": "2025-10-23T00:06:11Z"
        },
        {
          "user": "maflcko",
          "body": "lgtm ACK c5a0abb270f37ec391ce6e3ea5219584816adc54",
          "created_at": "2025-10-23T06:44:53Z"
        },
        {
          "user": "musaHaruna",
          "body": "Friendly ping @TheCharlatan and @mzumsande ",
          "created_at": "2025-10-23T07:41:54Z"
        },
        {
          "user": "l0rinc",
          "body": "Recreated the change locally, matches the version in the PR.\r\n\r\nACK 1a1f46c2285994908df9c11991c1f363c9733087",
          "created_at": "2025-10-24T16:53:59Z"
        },
        {
          "user": "maflcko",
          "body": "re-lgtm-ut-cr-rfm-ACK 1a1f46c2285994908df9c11991c1f363c9733087",
          "created_at": "2025-10-25T07:40:10Z"
        },
        {
          "user": "kevkevinpal",
          "body": "reACK [1a1f46c](https://github.com/bitcoin/bitcoin/pull/33683/commits/1a1f46c2285994908df9c11991c1f363c9733087)",
          "created_at": "2025-10-28T22:17:38Z"
        }
      ]
    },
    {
      "number": 33682,
      "title": "More comprehensive datacarrier configuration",
      "body": "This PR expands the control and testing of datacarrier transactions by decoupling the total bytes limit from the policy configuration.\r\n\r\n---\r\n\r\nWhile doing this, the historical **money-first** defaults for OP_RETURN outputs were reverted.\r\n\r\nThe [motivation](https://github.com/bitcoin/bitcoin/issues/33595) for this PR is to continue allowing each node to decide/signal their mempool relay (and mining) policy. However, the open-data relaying capacity of v30.0 is acknowledged and build upon.\r\n\r\nThe unlimited datacarrier policy is possible with the following configuration:\r\n\r\n```conf\r\n# open-data policy\r\ndatacarrier=1 # not required\r\ndatacarriersize=0\r\ndatacarriercount=0\r\n```\r\n\r\n---\r\n\r\n**But even without the reversion of defaults, the main scope of this PR still applies.**\r\n\r\nFirst, for more robust and complete testing. And second, to allow full backwards compatibility of datacarrier policy. Specifically, to allow limiting the amount of OP_RETURN outputs to just 1.\r\n\r\n```conf\r\n# money-first policy\r\ndatacarriersize=83\r\ndatacarriercount=1 # used to be hardcoded\r\n```\r\n\r\nThis configuration mimics the exact historical (default) datacarrier policy, which is **not possible in v30.0**.\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/52ede28a8adb2c2d44d7f800bbfbef8aed86070e/src/policy/policy.cpp#L140-L166\r\n\r\nNote that `nDataOut`, which counted the number of OP_RETURN outputs, was removed in [#32406](https://github.com/bitcoin/bitcoin/pull/32406/files#diff-ea6d307faa4ec9dfa5abcf6858bc19603079f2b8e110e1d62da4df98f4bdb9c0L162). Without a count check, v30.0 nodes with `-datacarriersize=83` are still relaying transactions with multiple OP_RETURN outputs, transactions which all nodes prior to v30.0 will reject...",
      "state": "closed",
      "user": "jotapea",
      "created_at": "2025-10-22T17:41:49Z",
      "updated_at": "2025-10-24T17:55:42Z",
      "comments": 6,
      "url": "https://github.com/bitcoin/bitcoin/pull/33682",
      "labels": [
        "Backport"
      ],
      "comment_list": [
        {
          "user": "DrahtBot",
          "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/33682.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Concept NACK | [cedwies](https://github.com/bitcoin/bitcoin/pull/33682#issuecomment-3434048783), [waketraindev](https://github.com/bitcoin/bitcoin/pull/33682#issuecomment-3434185716) |\n\nIf your review is incorrectly listed, please react with ðŸ‘Ž to this comment and the bot will ignore it on the next update.\n<!--5faf32d7da4f0f540f40219e4f7537a3-->\n### LLM Linter (âœ¨ experimental)\n\nPossible typos and grammar issues:\n\n- whose any data-carrying raw scriptPubKey output is of this size or less. -> for which any data-carrying raw scriptPubKey output is of this size or less. [â€œwhose anyâ€ is ungrammatical; â€œfor which anyâ€ makes the relationship between transaction and its outputs clear]\n- // null is datacarrier=0, 0 is unlimited datacarriersize=0 -> // null means datacarrier disabled; 0 means datacarriersize is unlimited. [â€œnull is datacarrier=0â€ is unclear/inaccurate English; expand to explain meaning of null vs 0]\n- // null is datacarrier=0, 0 is unlimited datacarriercount=0 -> // null means datacarrier disabled; 0 means datacarriercount is unlimited. [same issue as above; clarify the meanings of null and 0]\n\n<sup>drahtbot_id_5_m</sup>\n",
          "created_at": "2025-10-22T17:41:55Z"
        },
        {
          "user": "cedwies",
          "body": "Concept NACK \r\n\r\nAdding a new startup option (`-datacarriercount`) increases policy heterogeneity across the network. As discussed in the [motivation](https://github.com/bitcoin/bitcoin/issues/33595), more heterogeneity â†’ less mempool overlap â†’ more missing transactions during compact block reconstruction â†’ slower propagation on the critical path.\r\nv30 moved in the opposite direction to improve relay quality. Reintroducing another dimension of variance cuts against that goal.\r\n\r\nv30 deliberately changed the meaning of `-datacarriersize` (aggregated budget). This PR changes the semantics again (back to budget/output) **and** adds a new flag. Even if each change is defensible on its own (needs discussion), I do not support flipping meanings across consecutive releases, as I think it is a recipe for misconfiguration and surprises for operators and tooling.\r\n\r\nIf it _would_ be reasonable to change defaults so soon after v30, I think we have to see concrete evidence that the new defaults measurably improve the network (e.g., better compact-block hit rates, fewer round trips, fewer time-to-first-seen outliers), rather than just restoring historical behavior.\r\n\r\nFrom your [motivation](https://github.com/bitcoin/bitcoin/issues/33595):\r\n> The usefulness is control of the number of outputs separated from the size per output. Having both be one is sloppy. Multiple nulldata outputs is a new feature, which should be configurable.\r\n\r\n\"Sloppy\" does not quantify any harm from the aggregate approach (DoS, CPU, bandwidth, propagation, ...?). Without measurements, weâ€™re trading a known-uniform policy for a more fragmented one on intuition.\r\n\r\nSumming up: The change which was brought with v30 was broadly discussed and deliberately chosen. I think that reverting the defaults now would be a bad idea. And even if, the path to do this should not be this PR and changing defaults should not be bundled with introducing a new knob.\r\n",
          "created_at": "2025-10-22T20:11:40Z"
        },
        {
          "user": "jotapea",
          "body": "Much appreciated feedback @cedwies . As mentioned, the main features of the PR are:\r\n\r\n> First, for more robust and complete testing. And second, to allow full backwards compatibility of datacarrier policy. Specifically, to allow limiting the amount of OP_RETURN outputs to just 1.\r\n\r\nSo, I can easily do a separate PR keeping v30.0 defaults. But will not for now, in order to not fragment the conversation.\r\n\r\n*(I truly believe reverting the defaults asap is a net positive (some damage can't be undone) for the bitcoin-core team.)*\r\n\r\nThank you for being clear and up front about the deliberate changes in v30.0. Changes to defaults. That, should be a separate convesation.",
          "created_at": "2025-10-22T20:25:42Z"
        },
        {
          "user": "waketraindev",
          "body": "Concept NACK\r\n\r\nUnhealthy for the network and peers.\r\nRelies on other peers to deliver already seen and rejected transactions upon confirmation and rebroadcast.\r\nDefault extra pool sizes are too small to retain arbitrary rejected transactions, whether they use datacarrier=0 or otherwise.\r\n",
          "created_at": "2025-10-22T20:59:41Z"
        },
        {
          "user": "achow101",
          "body": "Concept NACK\r\n\r\nI don't think any contributors are interested in re-litigating this. Please see all of the commentary that has already been made on this topic.",
          "created_at": "2025-10-22T21:13:25Z"
        },
        {
          "user": "jotapea",
          "body": "> more heterogeneity â†’ less mempool overlap â†’ more missing transactions during compact block reconstruction â†’ slower propagation on the critical path\r\n\r\n@cedwies (hopefully with @achow101 's permission), didn't v30.0 **increase** this heterogeneity? i.e:\r\n\r\n> v30.0 nodes with -datacarriersize=83 are still relaying transactions with multiple OP_RETURN outputs, transactions which all nodes prior to v30.0 will reject..\r\n\r\nFixing [#33690](https://github.com/bitcoin/bitcoin/pull/33690) would improve it for all users that don't want to change their policies.\r\n\r\nAnyway, it is clear that the \"Current Core Contributors\" are way too invested to be individual thinkers, you are all repeating the same non-sense while actually being culpable of precisely what you are preaching: **v30 has increased the heterogeneity** in all ways it can be evaluated. Making next order considerations like *compact block reconstruction* and *slower propagation on the critical path* are practically irrelevant until the desired *heterogeneity* is achieved. AND this by itself doesn't sound very decentralized, so not sure why it has become a \"goal\".\r\n\r\nIf you were intellectually sincere, you would AT LEAST rephrase it like: \"v30 **HOPES** to achieve heterogeneity by taking a definite stand on open-data policy, while increasing this heterogeneity it in the meantime\".\r\n\r\nFirst principles people, you are becoming shitcoin-heads that just repeat buzzwords to appear smarter.",
          "created_at": "2025-10-24T17:54:57Z"
        }
      ]
    },
    {
      "number": 33681,
      "title": "More comprehensive datacarrier configuration",
      "body": "This PR expands the control and testing of datacarrier transactions by decoupling the total bytes limit from the policy configuration.\r\n\r\n---\r\n\r\nWhile doing this, the historical **money-first** defaults for OP_RETURN outputs were reverted.\r\n\r\nThe [motivation](https://github.com/bitcoin/bitcoin/issues/33595) for this PR is to continue allowing each node to decide/signal their mempool relay (and mining) policy. However, the open-data relaying capacity of v30.0 is acknowledged and build upon.\r\n\r\nThe unlimited datacarrier policy is possible with the following configuration:\r\n\r\n```conf\r\n# open-data policy\r\ndatacarrier=1 # not required\r\ndatacarriersize=0\r\ndatacarriercount=0\r\n```\r\n\r\n---\r\n\r\n**But even without the reversion of defaults, the main scope of this PR still applies.**\r\n\r\nFirst, for more robust and complete testing. And second, to allow full backwards compatibility of datacarrier policy. Specifically, to allow limiting the amount of OP_RETURN outputs to just 1.\r\n\r\n```conf\r\n# money-first policy\r\ndatacarriersize=83\r\ndatacarriercount=1 # used to be hardcoded\r\n```\r\n\r\nThis configuration mimics the exact historical (default) datacarrier policy, which is **not possible in v30.0**.\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/52ede28a8adb2c2d44d7f800bbfbef8aed86070e/src/policy/policy.cpp#L140-L166\r\n\r\nNote that `nDataOut`, which counted the number of OP_RETURN outputs, was removed in [#32406](https://github.com/bitcoin/bitcoin/pull/32406/files#diff-ea6d307faa4ec9dfa5abcf6858bc19603079f2b8e110e1d62da4df98f4bdb9c0L162). Without a count check, v30.0 nodes with `-datacarriersize=83` are still relaying transactions with multiple OP_RETURN outputs, transactions which all nodes prior to v30.0 will reject...",
      "state": "closed",
      "user": "jotapea",
      "created_at": "2025-10-22T17:35:04Z",
      "updated_at": "2025-10-22T17:37:14Z",
      "comments": 2,
      "url": "https://github.com/bitcoin/bitcoin/pull/33681",
      "labels": [],
      "comment_list": [
        {
          "user": "DrahtBot",
          "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/33681.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\nA summary of reviews will appear here.\n<!--5faf32d7da4f0f540f40219e4f7537a3-->",
          "created_at": "2025-10-22T17:35:10Z"
        },
        {
          "user": "jotapea",
          "body": "Hmmm... something got messed up. Seeing unrelated code changes. Will close and try again.",
          "created_at": "2025-10-22T17:37:14Z"
        }
      ]
    },
    {
      "number": 33680,
      "title": "validation: do not wipe utxo cache for stats/scans/snapshots",
      "body": "Revival of https://github.com/bitcoin/bitcoin/pull/30610#issuecomment-3432564955 with the remaining comments applied on top\r\n\r\n> Since #28280, the cost of a non-wiping sync of the UTXO cache is only proportional to the number of dirty entries, rather than proportional to the size of the entire cache. Because of that, there is no reason to perform a wiping flush in case the contents of the cache is still useful.\r\n> \r\n> Split the `FlushStateMode::ALWAYS` mode into a FORCE_SYNC (non-wiping) and a FORCE_FLUSH (wiping), and then use the former in `scantxoutset`, `gettxoutsetinfo`, snapshot creation.\r\n\r\n(slightly updated after #30214)",
      "state": "open",
      "user": "l0rinc",
      "created_at": "2025-10-22T14:46:09Z",
      "updated_at": "2026-01-05T09:18:26Z",
      "comments": 12,
      "url": "https://github.com/bitcoin/bitcoin/pull/33680",
      "labels": [
        "Validation"
      ],
      "comment_list": [
        {
          "user": "DrahtBot",
          "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/33680.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [cedwies](https://github.com/bitcoin/bitcoin/pull/33680#issuecomment-3707120193), [optout21](https://github.com/bitcoin/bitcoin/pull/33680#issuecomment-3479931118) |\n\nIf your review is incorrectly listed, please copy-paste <code>&lt;!--meta-tag:bot-skip--&gt;</code> into the comment that the bot should ignore.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#34125](https://github.com/bitcoin/bitcoin/pull/34125) (validation: reuse `should_empty` check for chainstate flush by l0rinc)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n<!--5faf32d7da4f0f540f40219e4f7537a3-->",
          "created_at": "2025-10-22T14:46:14Z"
        },
        {
          "user": "optout21",
          "body": "I suggest splitting into two commits:\r\n- Preparatory rename & new parameter(s) but without behavior change, to minimize diff in 2nd commit (rename ALWAYS to FORCE_FLUSH I suppose)\r\n- Change in behavior in the respective places (`scantxoutset`, `gettxoutsetinfo`, etc.)\r\n",
          "created_at": "2025-11-01T05:52:31Z"
        },
        {
          "user": "l0rinc",
          "body": "Thanks @optout21 & @cedwies, [split](https://github.com/bitcoin/bitcoin/compare/b92ee755109d9eec70e25eb366f133d102687a6f..a59aacefd1a0cdb448c8f847665a5809f9897605) the change to 2 commits, one just renames the old value and adjusts the docs and scripts, the second introduces the new value.\r\nI'm not sure about the locking, let's investigate that as a follow-up.",
          "created_at": "2025-11-01T21:26:09Z"
        },
        {
          "user": "optout21",
          "body": "reACK c6ca2b85a3e6e73674e210aee4ed69c4af2848e4\r\nRe-reviewed after two rebases.\r\n\r\n(prev:\r\nreACK 14abac10f2ebd93367c91dde7586a35456ef9d45\r\nre utACK d4425982ca4aff9b856a26f1d83d1419252f10a2\r\nutACK a59aacefd1a0cdb448c8f847665a5809f9897605)",
          "created_at": "2025-11-03T10:53:41Z"
        },
        {
          "user": "l0rinc",
          "body": "rebased after #30595",
          "created_at": "2025-11-04T17:49:41Z"
        },
        {
          "user": "cedwies",
          "body": "utACK d442598",
          "created_at": "2025-11-17T09:27:06Z"
        },
        {
          "user": "0xB10C",
          "body": "Looked at the flush tracing changes a bit (d4425982ca4aff9b856a26f1d83d1419252f10a2). They seem fine to me. I can't really comment on the other changes, as I'm not too familiar with the utxo cache in general.\r\n\r\nfrom https://github.com/bitcoin/bitcoin/pull/33680#discussion_r2486109704:\r\n> I was wondering how tracing is affected by this change. The trace includes the mode, and it should display it fine, so the trace should be OK.\r\n> It would be nice to check how the trace looks for a FORCE_SYNC case as well; I guess that can be triggered by an RPC call to the running node.\r\n\r\nTested this against a signet node. `gettxoutsetinfo` produces `FORCE_SYNC` (and the cache remains filled) and shutting down produces `FORCE_FLUSH`. As I would have expected.\r\n\r\n```bash\r\n$ python3 contrib/tracing/log_utxocache_flush.py 1234\r\nHooking into bitcoind with pid 1234\r\nLogging utxocache flushes. Ctrl-C to end...\r\nDuration (Âµs)   Mode         Coins Count     Memory Usage    Flush for Prune\r\n3911            FORCE_SYNC   3               262.34 kB       False\r\n12439           FORCE_SYNC   3               262.34 kB       False\r\n4652            FORCE_SYNC   3               262.34 kB       False\r\n1331            FORCE_FLUSH  16              262.46 kB       False\r\n939             FORCE_FLUSH  0               262.24 kB       False\r\n```\r\n",
          "created_at": "2025-11-19T16:12:49Z"
        },
        {
          "user": "l0rinc",
          "body": "Rebased with trivial conflicts, ready for re-review.",
          "created_at": "2025-12-02T17:53:52Z"
        },
        {
          "user": "l0rinc",
          "body": "Non-trivial rebase after https://github.com/bitcoin/bitcoin/pull/30214\r\n\r\nChanges: \r\n* The new `chainstate_write_tests.cpp` also needed renaming in the first commit;\r\n* `ForceFlushStateToDisk(bool wipe_cache = true)` is default-true now to minimize the diff.",
          "created_at": "2025-12-16T18:22:55Z"
        },
        {
          "user": "cedwies",
          "body": "checked the changes, ACK [11fe88a](https://github.com/bitcoin/bitcoin/commit/11fe88a327d8f8bd03b752686edb985ff2473ceb)",
          "created_at": "2025-12-25T09:14:45Z"
        },
        {
          "user": "l0rinc",
          "body": "Trivial rebase after https://github.com/bitcoin/bitcoin/pull/33866, you can check it with `git range-diff -w -U0 master 11fe88a c6ca2b8`.\r\nReady for review again!",
          "created_at": "2026-01-03T11:50:50Z"
        },
        {
          "user": "cedwies",
          "body": "reACK c6ca2b8 (trivial)",
          "created_at": "2026-01-03T15:09:47Z"
        }
      ]
    },
    {
      "number": 33679,
      "title": "test: set number of RPC server threads to 2",
      "body": "The default `-rpcthreads` value spawns 16 HTTP server threads for each node.\r\nRunning the functional test suite with default `rpcthreads` can exhaust file\r\ndescriptors or hit other resource limits very easily (more when tests are run\r\nin parallel).\r\nFurthermore, having 16 threads is unnecessary since they are mostly idle. We\r\nrun RPC calls on a single RPC connection and wait for it result synchronously.\r\nThere is (almost) never two RPC calls occurring concurrently.\r\nBecause of this, the threads are mostly idle, so we can safely limit the number\r\nof them to two.\r\n\r\nNote for reviewers:\r\nI checked this does not introduce any timing regression but would be good\r\nto double-check it on your end too. We could add another thread if needed.\r\nJust the 16 threads default value is too high and unnecessary.",
      "state": "closed",
      "user": "furszy",
      "created_at": "2025-10-22T13:33:53Z",
      "updated_at": "2025-10-23T11:14:47Z",
      "comments": 4,
      "url": "https://github.com/bitcoin/bitcoin/pull/33679",
      "labels": [
        "Tests"
      ],
      "comment_list": [
        {
          "user": "DrahtBot",
          "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/33679.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [maflcko](https://github.com/bitcoin/bitcoin/pull/33679#issuecomment-3432447263), [andrewtoth](https://github.com/bitcoin/bitcoin/pull/33679#pullrequestreview-3366198055), [l0rinc](https://github.com/bitcoin/bitcoin/pull/33679#issuecomment-3433021242), [kevkevinpal](https://github.com/bitcoin/bitcoin/pull/33679#issuecomment-3433459825) |\n\nIf your review is incorrectly listed, please react with ðŸ‘Ž to this comment and the bot will ignore it on the next update.\n<!--5faf32d7da4f0f540f40219e4f7537a3-->",
          "created_at": "2025-10-22T13:33:58Z"
        },
        {
          "user": "maflcko",
          "body": "lgtm ACK e9cd45e3d3c7592265ebf67387090b3df1501df4\r\n\r\nAny number larger than `1` should be fine, so that it is still possible to accidentally or intentionally cause races when several test threads call the rpc threads.",
          "created_at": "2025-10-22T13:45:32Z"
        },
        {
          "user": "l0rinc",
          "body": "Similar to https://github.com/bitcoin/bitcoin/pull/33485, ran the tests locally, seems fine, change makes sense.\r\nACK e9cd45e3d3c7592265ebf67387090b3df1501df4",
          "created_at": "2025-10-22T15:30:19Z"
        },
        {
          "user": "kevkevinpal",
          "body": "ACK [e9cd45e](https://github.com/bitcoin/bitcoin/pull/33679/commits/e9cd45e3d3c7592265ebf67387090b3df1501df4)\r\n\r\nas mentioned it is similar to https://github.com/bitcoin/bitcoin/pull/33485.",
          "created_at": "2025-10-22T17:34:00Z"
        }
      ]
    },
    {
      "number": 33678,
      "title": "http: limit RPC server threads to available cores",
      "body": "The HTTP server currently spawns 16 threads by default, regardless of the systemâ€™s available ones.\r\nThis change limits the number of threads in the RPC server to the number of available CPUs,\r\npreventing excessive context switching and improving overall responsiveness on systems with\r\nfewer cores. If `-rpcthreads` exceeds that limit, it is adjusted to num_cores - 1 and a warning is\r\nlogged.",
      "state": "closed",
      "user": "furszy",
      "created_at": "2025-10-22T13:33:42Z",
      "updated_at": "2025-10-22T15:00:26Z",
      "comments": 6,
      "url": "https://github.com/bitcoin/bitcoin/pull/33678",
      "labels": [
        "RPC/REST/ZMQ"
      ],
      "comment_list": [
        {
          "user": "DrahtBot",
          "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/33678.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\nA summary of reviews will appear here.\n<!--5faf32d7da4f0f540f40219e4f7537a3-->",
          "created_at": "2025-10-22T13:33:48Z"
        },
        {
          "user": "maflcko",
          "body": "Not sure. This seems to be partially reverting e56fc7ce6a92eae7e80657d9f57a148cc002358d. See also https://github.com/bitcoin/bitcoin/pull/31215#discussion_r1828025349",
          "created_at": "2025-10-22T13:41:47Z"
        },
        {
          "user": "furszy",
          "body": "> Not sure. This seems to be partially reverting [e56fc7c](https://github.com/bitcoin/bitcoin/commit/e56fc7ce6a92eae7e80657d9f57a148cc002358d). See also [#31215 (comment)](https://github.com/bitcoin/bitcoin/pull/31215#discussion_r1828025349)\r\n\r\nThe default value is kept unless the system has fewer cores. I think it makes sense to not exceed that number, as having more threads than cores doesnâ€™t really help.",
          "created_at": "2025-10-22T14:32:39Z"
        },
        {
          "user": "furszy",
          "body": "Answered without reading https://github.com/bitcoin/bitcoin/pull/31215#discussion_r1828025349, interesting. Maybe having more is good but probably not 16 fixed? Like a factor of 2 of the number of cores seems better to me.\r\n\r\nOr well.. that is ok for small end device but that would spawn way more threads in bigger ones. I'm not sure anymore either.",
          "created_at": "2025-10-22T14:35:55Z"
        },
        {
          "user": "andrewtoth",
          "body": "> I think it makes sense to not exceed that number, as having more threads than cores doesnâ€™t really help.\r\n\r\nThis would make sense if RPCs are purely CPU bound. Many RPCs are mainly IO bound, and the OS can suspend a thread while it waits on IO. Absent coroutines that can suspend execution on the same thread for IO, more threads than cores will be a benefit.",
          "created_at": "2025-10-22T14:51:13Z"
        },
        {
          "user": "andrewtoth",
          "body": "Would it make sense to lower the default only on 32-bit systems? We have lower maximum settings for dbcache and maxmempool on these systems as well, since they are more memory constrained.\r\n\r\nThis concern was raised here as well https://github.com/bitcoin/bitcoin/pull/31215#issuecomment-2476206670.\r\n",
          "created_at": "2025-10-22T14:58:11Z"
        }
      ]
    },
    {
      "number": 33677,
      "title": "ci: Retry image building once on failure",
      "body": "This should fix https://github.com/bitcoin/bitcoin/issues/33640.\r\n\r\nIt also contains a few refactor cleanups, which are explained in the corresponding commits.",
      "state": "closed",
      "user": "maflcko",
      "created_at": "2025-10-22T12:21:51Z",
      "updated_at": "2025-10-29T12:25:41Z",
      "comments": 8,
      "url": "https://github.com/bitcoin/bitcoin/pull/33677",
      "labels": [
        "Tests"
      ],
      "comment_list": [
        {
          "user": "DrahtBot",
          "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/33677.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [l0rinc](https://github.com/bitcoin/bitcoin/pull/33677#issuecomment-3442591502), [kevkevinpal](https://github.com/bitcoin/bitcoin/pull/33677#issuecomment-3443144320) |\n| Concept ACK | [davidgumberg](https://github.com/bitcoin/bitcoin/pull/33677#issuecomment-3458345585) |\n\nIf your review is incorrectly listed, please react with ðŸ‘Ž to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#33362](https://github.com/bitcoin/bitcoin/pull/33362) (Run feature_bind_port_(discover|externalip).py in CI by vasild)\n* [#31349](https://github.com/bitcoin/bitcoin/pull/31349) (ci: detect outbound internet traffic generated while running tests by vasild)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n<!--5faf32d7da4f0f540f40219e4f7537a3-->",
          "created_at": "2025-10-22T12:21:57Z"
        },
        {
          "user": "l0rinc",
          "body": "Code review ACK fa586e86c4aa20c07f37488c13b2b797b35fdbd9\r\n\r\nThe small focused commits with detailed messages made the review very easy.\r\nI left a few suggestions for cases that could be made more pythonic (i.e. partial bash migration), but I don't mind keeping it as is, seems correct to me.",
          "created_at": "2025-10-24T10:32:55Z"
        },
        {
          "user": "l0rinc",
          "body": "Code review reACK 5555bce994b648f836c35a02570f22ae9ad36da3\r\n(only suggested nits applied since last review)",
          "created_at": "2025-10-24T11:18:35Z"
        },
        {
          "user": "kevkevinpal",
          "body": "ACK [5555bce](https://github.com/bitcoin/bitcoin/pull/33677/commits/5555bce994b648f836c35a02570f22ae9ad36da3)\r\n\r\nRetrying building image on failure makes sense to me, and the refactor looks good",
          "created_at": "2025-10-24T13:23:35Z"
        },
        {
          "user": "fanquake",
          "body": "cc @willcl-ark ",
          "created_at": "2025-10-24T13:39:37Z"
        },
        {
          "user": "davidgumberg",
          "body": "crACK https://github.com/bitcoin/bitcoin/pull/33677/commits/5555bce994b648f836c35a02570f22ae9ad36da3\r\n\r\nConcept ACK on moving the CI script from bash to python and crACK  https://github.com/bitcoin/bitcoin/pull/33677/commits/fabe516440c96bb7a6a6902195684d3802d64139 and https://github.com/bitcoin/bitcoin/pull/33677/commits/5555bce994b648f836c35a02570f22ae9ad36da3 as refactors with no behavior change, but those changes seem orthogonal to the PR title and linked issue and I think they would ideally be in a separate PR.",
          "created_at": "2025-10-28T20:25:38Z"
        },
        {
          "user": "maflcko",
          "body": "> refactors with no behavior change, but those changes seem orthogonal to the PR title and linked issue and I think they would ideally be in a separate PR.\r\n\r\nthx, i'll open a dedicated follow-up for the remaining refactors. Though, I'll leave this one as-is for now, as it already has 3 acks and seems rfm.",
          "created_at": "2025-10-28T21:07:47Z"
        },
        {
          "user": "maflcko",
          "body": "Done in https://github.com/bitcoin/bitcoin/pull/33732",
          "created_at": "2025-10-29T12:25:41Z"
        }
      ]
    },
    {
      "number": 33676,
      "title": "interfaces: enable cancelling running `waitNext` calls",
      "body": "This is an attempt to fix #33575 see the issue for background and the usefulness of this feature.\r\n\r\nThis PR uses one of the suggested approaches: adding a new `interruptWaitNext()` method to the mining interface.\r\n\r\nIt introduces a new boolean variable, `m_interrupt_wait`, which is set to `false` when the thread starts waiting. The `interruptWaitNext()` method wakes the thread and sets `m_interrupt_wait` to `true`.\r\nWhenever the thread wakes up, it checks whether the wait was aborted; if so, it simply set ` m_interrupt_wait ` to false and return`nullptr`.\r\n\r\nThis PR also adds a functional test for the new method. The test uses `asyncio` to spawn two tasks and attempts to ensure that the wait is executed before the interrupt by using an event monitor. It adds a 0.1-second buffer to ensure the wait has started executing.\r\nIf that buffer elapses without `waitNext` executing, the test will fail because a transaction is created after the buffer.\r\n\r\n",
      "state": "closed",
      "user": "ismaelsadeeq",
      "created_at": "2025-10-22T10:14:51Z",
      "updated_at": "2025-11-26T16:50:42Z",
      "comments": 16,
      "url": "https://github.com/bitcoin/bitcoin/pull/33676",
      "labels": [
        "interfaces"
      ],
      "comment_list": [
        {
          "user": "DrahtBot",
          "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/33676.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [ryanofsky](https://github.com/bitcoin/bitcoin/pull/33676#pullrequestreview-3388413169), [furszy](https://github.com/bitcoin/bitcoin/pull/33676#issuecomment-3456619672), [Sjors](https://github.com/bitcoin/bitcoin/pull/33676#pullrequestreview-3404815806), [TheCharlatan](https://github.com/bitcoin/bitcoin/pull/33676#pullrequestreview-3440065494) |\n| Concept ACK | [Eunovo](https://github.com/bitcoin/bitcoin/pull/33676#pullrequestreview-3384019091) |\n\nIf your review is incorrectly listed, please react with ðŸ‘Ž to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#33421](https://github.com/bitcoin/bitcoin/pull/33421) (node: add  `BlockTemplateCache` by ismaelsadeeq)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n<!--5faf32d7da4f0f540f40219e4f7537a3-->",
          "created_at": "2025-10-22T10:14:57Z"
        },
        {
          "user": "ismaelsadeeq",
          "body": "I took your suggestion, make the test robust by generating a transaction after interrupting, and took @furszy suggestion by initializing the waiting inside the lock.\r\n\r\ncc @Eunovo ",
          "created_at": "2025-10-23T09:58:48Z"
        },
        {
          "user": "ismaelsadeeq",
          "body": "Thanks @Eunovo and @ryanofsky \r\n\r\nI've fixed the comments in latest push [diff](https://github.com/bitcoin/bitcoin/compare/f4e63cc807f8c34a780604bd3802739c37209b75..dcb56fd4cb59e6857c110dd87019459989dc1ec3)",
          "created_at": "2025-10-27T18:23:18Z"
        },
        {
          "user": "furszy",
          "body": "> nit:\r\n> is there any way you could verify that there is someone waiting before setting interrupt_wait? It seems fragile to be able to interrupt a procedure that hasn't started.\r\n\r\nQuick idea; could provide an optional flag. So the value exists whenever someone is waiting on it and is destroyed (`nullopt`) when there is no one doing it.\r\n\r\n```diff\r\nIndex: src/node/interfaces.cpp\r\n===================================================================\r\ndiff --git a/src/node/interfaces.cpp b/src/node/interfaces.cpp\r\n--- a/src/node/interfaces.cpp\t(revision dcb56fd4cb59e6857c110dd87019459989dc1ec3)\r\n+++ b/src/node/interfaces.cpp\t(date 1761593941511)\r\n@@ -932,7 +932,7 @@\r\n \r\n     const std::unique_ptr<CBlockTemplate> m_block_template;\r\n \r\n-    bool m_interrupt_wait{false};\r\n+    std::optional<bool> m_interrupt_wait{std::nullopt};\r\n     ChainstateManager& chainman() { return *Assert(m_node.chainman); }\r\n     KernelNotifications& notifications() { return *Assert(m_node.notifications); }\r\n     NodeContext& m_node;\r\nIndex: src/node/miner.cpp\r\n===================================================================\r\ndiff --git a/src/node/miner.cpp b/src/node/miner.cpp\r\n--- a/src/node/miner.cpp\t(revision dcb56fd4cb59e6857c110dd87019459989dc1ec3)\r\n+++ b/src/node/miner.cpp\t(date 1761594250147)\r\n@@ -453,9 +453,10 @@\r\n     block.hashMerkleRoot = BlockMerkleRoot(block);\r\n }\r\n \r\n-void InterruptWait(KernelNotifications& kernel_notifications, bool& interrupt_wait)\r\n+void InterruptWait(KernelNotifications& kernel_notifications, std::optional<bool>& interrupt_wait)\r\n {\r\n     LOCK(kernel_notifications.m_tip_block_mutex);\r\n+    if (!interrupt_wait) throw std::runtime_error(\"Interrupt requested while no wait operation is active\");\r\n     interrupt_wait = true;\r\n     kernel_notifications.m_tip_block_cv.notify_all();\r\n }\r\n@@ -466,7 +467,7 @@\r\n                                                       const std::unique_ptr<CBlockTemplate>& block_template,\r\n                                                       const BlockWaitOptions& options,\r\n                                                       const BlockAssembler::Options& assemble_options,\r\n-                                                      bool& interrupt_wait)\r\n+                                                      std::optional<bool>& interrupt_wait)\r\n {\r\n     // Delay calculating the current template fees, just in case a new block\r\n     // comes in before the next tick.\r\n@@ -483,6 +484,7 @@\r\n         bool tip_changed{false};\r\n         {\r\n             WAIT_LOCK(kernel_notifications.m_tip_block_mutex, lock);\r\n+            interrupt_wait = false;\r\n             // Note that wait_until() checks the predicate before waiting\r\n             kernel_notifications.m_tip_block_cv.wait_until(lock, std::min(now + tick, deadline), [&]() EXCLUSIVE_LOCKS_REQUIRED(kernel_notifications.m_tip_block_mutex) {\r\n                 AssertLockHeld(kernel_notifications.m_tip_block_mutex);\r\n@@ -491,10 +493,10 @@\r\n                 // method on BlockTemplate and no template could have been\r\n                 // generated before a tip exists.\r\n                 tip_changed = Assume(tip_block) && tip_block != block_template->block.hashPrevBlock;\r\n-                return tip_changed || chainman.m_interrupt || interrupt_wait;\r\n+                return tip_changed || chainman.m_interrupt || (!interrupt_wait || interrupt_wait.value());\r\n             });\r\n             if (interrupt_wait) {\r\n-                interrupt_wait = false;\r\n+                interrupt_wait.reset();\r\n                 return nullptr;\r\n             }\r\n         }\r\nIndex: src/node/miner.h\r\n===================================================================\r\ndiff --git a/src/node/miner.h b/src/node/miner.h\r\n--- a/src/node/miner.h\t(revision dcb56fd4cb59e6857c110dd87019459989dc1ec3)\r\n+++ b/src/node/miner.h\t(date 1761594137149)\r\n@@ -240,7 +240,7 @@\r\n \r\n \r\n /* Interrupt the current wait for the next block template. */\r\n-void InterruptWait(KernelNotifications& kernel_notifications, bool& interrupt_wait);\r\n+void InterruptWait(KernelNotifications& kernel_notifications, std::optional<bool>& interrupt_wait);\r\n /**\r\n  * Return a new block template when fees rise to a certain threshold or after a\r\n  * new tip; return nullopt if timeout is reached.\r\n@@ -251,7 +251,7 @@\r\n                                                       const std::unique_ptr<CBlockTemplate>& block_template,\r\n                                                       const BlockWaitOptions& options,\r\n                                                       const BlockAssembler::Options& assemble_options,\r\n-                                                      bool& interrupt_wait);\r\n+                                                      std::optional<bool>& interrupt_wait);\r\n \r\n /* Locks cs_main and returns the block hash and block height of the active chain if it exists; otherwise, returns nullopt.*/\r\n std::optional<BlockRef> GetTip(ChainstateManager& chainman);\r\n```\r\n\r\nNote:\r\nHaven't thought much about what would happen with multiple waiters. But it shouldn't be a problem.\r\n\r\nStill, I might have gone too far and this might not be needed. Could enforce this rule at the API doc level too.",
          "created_at": "2025-10-27T19:48:54Z"
        },
        {
          "user": "ryanofsky",
          "body": "re: https://github.com/bitcoin/bitcoin/pull/33676#pullrequestreview-3384985314, https://github.com/bitcoin/bitcoin/pull/33676#issuecomment-3453042451\r\n\r\n> ```diff\r\n> +    if (!interrupt_wait) throw std::runtime_error(\"Interrupt requested while no wait operation is active\");\r\n> ```\r\n\r\nI think this would just re-introduce the race condition we were trying to get rid of. The waitNext call is asynchronous and there's no way for a client to know if a waitNext is active or not. They can only know if they've made a call, not whether the IPC request has been sent to the socket, or whether server has received the request, or whether the server has started to execute the call after receiving it.\r\n\r\nIn theory, the server could send notifications to the client as execution progresses, or let the client query the current state, or throw exceptions in certain states, but these approaches would add complexity and expose clients to information they couldn't use reliably and probably shouldn't have. It should be simpler to just decide `interruptWait` calls will take precedence over `waitNext` calls and not care about the order of the calls like the current implementation in dcb56fd4cb59e6857c110dd87019459989dc1ec3.\r\n\r\nI will say that current implementation will not work well if clients make multiple `waitNext` calls on the same block simultaneously, because clients will need to make separate `interuptWait` calls to cancel each `waitNext`, but the cancellations will be lost each time a `waitNext` call returns. A reasonable solution to this could be to change `m_interrupt_wait` from a `bool` to an `int` and increment it when `interruptWait` is called (instead of setting it to true) and decrement it when a `waitNext` call is interrupted (instead of setting it it to false). I think in practice though we are not expecting multiple waitNext calls on the same block, and could even potentially return an error if simultaneous calls are attempted.",
          "created_at": "2025-10-27T20:41:16Z"
        },
        {
          "user": "furszy",
          "body": "Code review ACK https://github.com/bitcoin/bitcoin/commit/dcb56fd4cb59e6857c110dd87019459989dc1ec3",
          "created_at": "2025-10-28T13:59:14Z"
        },
        {
          "user": "Sjors",
          "body": "Concept ACK\r\n\r\nCan there ever only be one `waitNext()` call on per `BlockTemplate`? If not, does `interruptWait()` just stop all of them?",
          "created_at": "2025-10-31T11:28:12Z"
        },
        {
          "user": "ryanofsky",
          "body": "re: https://github.com/bitcoin/bitcoin/pull/33676#issuecomment-3472631221\r\n> Can there ever only be one `waitNext()` call on per `BlockTemplate`? If not, does `interruptWait()` just stop all of them?\r\n\r\nThere can be multiple waitNext() calls and the current implementation of interruptWait() will interrupt exactly one of them arbitrarily. I speculated on how this could be improved in https://github.com/bitcoin/bitcoin/pull/33676#issuecomment-3453225085, if there is a use-case for multiple waitNext calls. But I don't think there is a good use-case, so it might be a good if the current interruptWait implemention is a soft discouragment for trying to use multiple simultaneous wait calls with the same block creation options from the same client.",
          "created_at": "2025-10-31T14:05:13Z"
        },
        {
          "user": "Sjors",
          "body": "I also can't think of a use case, but maybe we should fail if a client (accidentally) tries?",
          "created_at": "2025-10-31T14:09:38Z"
        },
        {
          "user": "ismaelsadeeq",
          "body": "Yes, I think itâ€™s a good idea to prevent multiple calls to waitNext if there is no explicit use case, or have interruptWait identify and cancel a targeted wait?",
          "created_at": "2025-10-31T14:36:48Z"
        },
        {
          "user": "ryanofsky",
          "body": "> Yes, I think itâ€™s a good idea to prevent multiple calls to waitNext if there is no explicit use case, or have interruptWait identify and cancel a targeted wait?\r\n\r\nI think I like the current implementation more than either of these two ideas, because they both seem like they would bring unneeded complexity. It seems ok to allow multiple wait calls, since they should work perfectly well, even if there is not a very convenient way to cancel them. If it ever becomes important for interruptWait to provide other ways of cancelling it could be added when that becomes apparent.",
          "created_at": "2025-10-31T14:53:15Z"
        },
        {
          "user": "Sjors",
          "body": "I successfully tested this PR against my Template Provider implementation, see https://github.com/Sjors/sv2-tp/pull/57.",
          "created_at": "2025-10-31T14:56:03Z"
        },
        {
          "user": "plebhash",
          "body": "any chance this could get backported?",
          "created_at": "2025-11-24T17:51:51Z"
        },
        {
          "user": "Sjors",
          "body": "No strong opinion on whether this should be backported. In `sv2-tp` I found it easy to work around by calling `waitNext()` in a loop with a reasonable timeout: https://github.com/stratum-mining/sv2-tp/blob/fbe0984ca21e2b6ae0f554bbc5b2819332e59afc/src/sv2/template_provider.cpp#L131-L144",
          "created_at": "2025-11-24T18:15:39Z"
        },
        {
          "user": "plebhash",
          "body": "we also have workarounds on https://github.com/stratum-mining/sv2-apps/pull/59 but they're substantially increasing code complexity, which will likely have a negative impact on maintainability on the mid-long term\r\n\r\nwe have https://github.com/stratum-mining/sv2-apps/issues/81 to keep track of this but we'd really appreciate if this got backported instead of landing on v31+",
          "created_at": "2025-11-24T18:57:00Z"
        },
        {
          "user": "fanquake",
          "body": "Backported to `30.x` in #33609.",
          "created_at": "2025-11-26T16:50:42Z"
        }
      ]
    },
    {
      "number": 33675,
      "title": "randomenv: drop self define of 'environ'",
      "body": "This variable/symbol/macro ought to be defined by the system includes, not us.\r\n\r\nAlternative to #33570.",
      "state": "closed",
      "user": "sipa",
      "created_at": "2025-10-22T08:59:57Z",
      "updated_at": "2025-10-27T16:38:58Z",
      "comments": 5,
      "url": "https://github.com/bitcoin/bitcoin/pull/33675",
      "labels": [
        "Utils/log/libs"
      ],
      "comment_list": [
        {
          "user": "DrahtBot",
          "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/33675.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Concept ACK | [hebasto](https://github.com/bitcoin/bitcoin/pull/33675#pullrequestreview-3364479135), [laanwj](https://github.com/bitcoin/bitcoin/pull/33675#issuecomment-3431220853) |\n\nIf your review is incorrectly listed, please react with ðŸ‘Ž to this comment and the bot will ignore it on the next update.\n<!--5faf32d7da4f0f540f40219e4f7537a3-->",
          "created_at": "2025-10-22T09:00:02Z"
        },
        {
          "user": "laanwj",
          "body": "Concept ACK",
          "created_at": "2025-10-22T09:01:52Z"
        },
        {
          "user": "maflcko",
          "body": "(mimicking drahtbot, bleeb blop)\r\n\r\nhttps://github.com/bitcoin/bitcoin/actions/runs/18710961104/job/53359113198?pr=33675#step:9:1582: \r\n\r\n```\r\n[ 13%] Building CXX object src/util/CMakeFiles/bitcoin_util.dir/__/randomenv.cpp.o\r\ncd /home/admin/actions-runner/_work/_temp/build/src/util && /bin/ccache /usr/bin/clang++ --target=arm64-apple-darwin -isysroot/home/admin/actions-runner/_work/_temp/depends/SDKs/Xcode-15.0-15A240d-extracted-SDK-with-libcxx-headers -nostdlibinc -iwithsysroot/usr/include/c++/v1 -iwithsysroot/usr/include -iframeworkwithsysroot/System/Library/Frameworks --target=arm64-apple-darwin -DOBJC_OLD_DISPATCH_PROTOTYPES=0 -I/home/admin/actions-runner/_work/_temp/build/src -I/home/admin/actions-runner/_work/_temp/src -mmacos-version-min=14.0 -mlinker-version=711 -O2 -O2 -g -std=c++20 -fPIC -fvisibility=hidden -fdebug-prefix-map=/home/admin/actions-runner/_work/_temp/src=. -fmacro-prefix-map=/home/admin/actions-runner/_work/_temp/src=. -U_FORTIFY_SOURCE -D_FORTIFY_SOURCE=3 -Wstack-protector -fstack-protector-all -mbranch-protection=bti -Werror -Wall -Wextra -Wgnu -Wformat -Wformat-security -Wvla -Wshadow-field -Wthread-safety -Wloop-analysis -Wredundant-decls -Wunused-member-function -Wdate-time -Wconditional-uninitialized -Woverloaded-virtual -Wsuggest-override -Wimplicit-fallthrough -Wunreachable-code -Wdocumentation -Wself-assign -Wundef -Wno-unused-parameter -MD -MT src/util/CMakeFiles/bitcoin_util.dir/__/randomenv.cpp.o -MF CMakeFiles/bitcoin_util.dir/__/randomenv.cpp.o.d -o CMakeFiles/bitcoin_util.dir/__/randomenv.cpp.o -c /home/admin/actions-runner/_work/_temp/src/randomenv.cpp  \r\n/home/admin/actions-runner/_work/_temp/src/randomenv.cpp:312:69: error: use of undeclared identifier 'environ'\r\n  312 |     hasher << &hasher << &RandAddStaticEnv << &malloc << &errno << &environ;\r\n      |                                                                     ^\r\n/home/admin/actions-runner/_work/_temp/src/randomenv.cpp:452:9: error: use of undeclared identifier 'environ'\r\n  452 |     if (environ) {\r\n      |         ^\r\n/home/admin/actions-runner/_work/_temp/src/randomenv.cpp:453:28: error: use of undeclared identifier 'environ'\r\n  453 |         for (size_t i = 0; environ[i]; ++i) {\r\n      |                            ^\r\n/home/admin/actions-runner/_work/_temp/src/randomenv.cpp:454:48: error: use of undeclared identifier 'environ'; did you mean 'union'?\r\n  454 |             hasher.Write((const unsigned char*)environ[i], strlen(environ[i]));\r\n      |                                                ^~~~~~~\r\n      |                                                union\r\n/home/admin/actions-runner/_work/_temp/src/randomenv.cpp:454:48: error: expected expression\r\n/home/admin/actions-runner/_work/_temp/src/randomenv.cpp:454:67: error: use of undeclared identifier 'environ'\r\n  454 |             hasher.Write((const unsigned char*)environ[i], strlen(environ[i]));\r\n      |                                                                   ^\r\n6 errors generated.",
          "created_at": "2025-10-22T09:06:14Z"
        },
        {
          "user": "sipa",
          "body": "It appears that mac OS actually requires defining it manually.",
          "created_at": "2025-10-22T09:12:39Z"
        },
        {
          "user": "fanquake",
          "body": "Documented this in #33714.",
          "created_at": "2025-10-27T16:38:58Z"
        }
      ]
    },
    {
      "number": 33674,
      "title": "ci: Doc ASLR workaround for sanitizer tasks",
      "body": "Fixes https://github.com/bitcoin/bitcoin/issues/30674",
      "state": "closed",
      "user": "maflcko",
      "created_at": "2025-10-22T07:15:37Z",
      "updated_at": "2025-10-24T12:54:00Z",
      "comments": 3,
      "url": "https://github.com/bitcoin/bitcoin/pull/33674",
      "labels": [
        "Tests"
      ],
      "comment_list": [
        {
          "user": "DrahtBot",
          "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/33674.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [fanquake](https://github.com/bitcoin/bitcoin/pull/33674#issuecomment-3435494398) |\n\nIf your review is incorrectly listed, please react with ðŸ‘Ž to this comment and the bot will ignore it on the next update.\n<!--5faf32d7da4f0f540f40219e4f7537a3-->",
          "created_at": "2025-10-22T07:15:42Z"
        },
        {
          "user": "fanquake",
          "body": "ACK fa0e36156cba535846ae2ecfaaa554d7f14fcdfd",
          "created_at": "2025-10-23T07:18:30Z"
        },
        {
          "user": "Sjors",
          "body": "Post merge ACK",
          "created_at": "2025-10-24T10:41:07Z"
        }
      ]
    }
  ],
  "issues": [
    {
      "number": 33684,
      "title": "Async Payjoin",
      "body": "This issue is for the tracking and brainstorming of the implementation of [BIP 77 Async Payjoin](https://github.com/bitcoin/bips) into the wallet.\n\n***\n\n- [ ] HPKE #32617 \n- [ ] The rest :)\n\n***\n\nAsync Payjoin utilizes an external Directory server to allow the Sender and Receiver to communicate with each other without needing to operate any infrastructure. The servers are reached using [RFC 9458 Oblivious HTTP (OHTTP)](https://www.ietf.org/rfc/rfc9458.html) relays to avoid revealing the IPs of the Sender and Receiver to the Directory. All communication between the Sender or Recevier to the OHTTP Relay is encrypted, as described in the OHTTP RFC. Additionally, the payload data itself is encrypted with methodology similar to OHTTP to prevent the Directory from being able to read the transaction data.\n\nThe cryptography uses things that we already have in the project. Specifically, all keys used are EC keys on secp256k1, keys are exchanged using DH, and encryption is done with ChaCha20Poly1305. Pubkeys included directly in the payload (ephemeral keys used to do additional key exchanges for responses) are encoded with ElligatorSwift. All of these algorithms are already included in the project to support BIP 324, so it should not be difficult to reuse them for Async Payjoin.\n\nOHTTP itself is encrypted using the aforementioned cryptography. It uses plain HTTP, not HTTPS, so there is no need to include anything related to TLS.\n\n***\n\nThe general operation of Async Payjoin is:\n1. The Receiver produces a Bitcoin URI containing a parameter which includes the URL of a mailbox endpoint on a Directory server (i.e. some URL for the Sender to POST to). The URL additionally contains the public key of the Directory itself, and an ephemeral(ish)public key of the Receiver.\n2. The Receiver provides the URI to the Sender out of band.\n3. The Sender generates an ephemeral public key, performs a key exchange with the Receiver's ephemeral key to compute a shared secret. This shared secret is used with ChaCha20-Poly1305 to encrypt:\n   * A new ephemeral pubkey for the key exchange for the reply (Reply Key)\n   * The Original PSBT which pays the receiver\n4. The Sender connects to the specified Directory server via a OHTTP Relay, performing a DH key exchange with the Directory public key, and encrypting the ElligatorSwift encoding of their Reply Key and the encrypted payload produced in the previous step. The payload is POSTed to the specified mailbox endpoint.\n5. The Receiver polls the Directory server at the mailbox endpoint until it receives the Sender's payload.\n6. The Receiver performs DHKE with the Sender's ephemeral key, then decrypts the encrypted payload.\n7. The Receiver produces a Proposal PSBT which is the Sender's Original PSBT modified with the Receiver's inputs and outputs, as well as any necessary signatures and witnesses.\n8. The Receiver generates a new ephemeral key to perform DHKE with the Sender's Reply Key, and uses the shared secret to encrypt their Proposal PSBT\n9. The Receiver connects to the previously specified Directory via a OHTTP Relay, and provides an encapsulated payload of the ElligatorSwift encoding of their ephemeral key. The payload is POSTed to a new mailbox endpoint derived from the Sender's Reply Key.\n10. The Sender polls the Directory server at the mailbox endpoint derived from their Reply Key until it receives the Receiver's payload.\n11. The Sender performs DHKE with the Receiver's new ephemeral key, decrypts the Proposal PSBT, validates and signs it. The Sender broadcasts the final transaction.\n\nAdditionally, the original Bitcoin URI contains an expiration time. This is used by both the Sender and Receiver to have a timeout on polling the Directory. The Receiver can also broadcast the Original PSBT and the Sender should stop polling if it sees that be broadcast.\n\n***\n\nThere are a few questions that need to be answered for implementing Async Payjoin\n\n* If we are the Receiver, how do we get the pubkey of the Directory. Some suggestions are:\n  * The user gets it out of band somehow\n  * OHTTP specifies a way to do key discovery by querying the server directly without OHTTP. But this both requires TLS, and reveals our IP unless some other IP hiding method is used.\n  * A set of keys are hard coded into the software. (ew)\n* How do we choose which OHTTP relay to use?\n* What is the polling interval?\n* What shows in the GUI when we are waiting for and polling the Directory, for both Receivers and Senders?\n* We should not be automatically signing transactions for our users:\n  * How will Senders using the GUI be notified and prompted when a reply is received so that the PSBT can be signed?\n  * How will Senders using the CLI know when a reply was received and that a PSBT needs to be signed?",
      "state": "open",
      "user": "achow101",
      "created_at": "2025-10-22T23:06:58Z",
      "updated_at": "2025-11-04T06:57:27Z",
      "comments": 5,
      "url": "https://github.com/bitcoin/bitcoin/issues/33684",
      "labels": [
        "Feature",
        "Wallet",
        "Tracking Issue"
      ],
      "comment_list": [
        {
          "user": "DanGould",
          "body": "There are a few questions that need to be answered for implementing Async Payjoin\n\n> - If we are the Receiver, how do we get the pubkey of the Directory. Some suggestions are:\n>   -  The user gets it out of band somehow\n\nI think getting the keys from another receiver's URI was the simple out of band bootstrap mechanism @nothingmuch and I had in mind. The Payjoin URI shared by a receiver contains the OHTTP Key Config (\"pubkey of the directory.\") Cache that key and allow receiving to that directory from then on until the expiration. Before expiration, attempt to fetch updated keys close to the expiration period using OHTTP requests to the `.well-known/ohttp-gateway` endpoint after that first fetch.\n\n> - How do we choose which OHTTP relay to use?\n\nProbably hard code some options like is done for DNS seeds, and then allow configuration. You can see how this is done as of today in our reference implementation's [`RelayManager`](https://github.com/payjoin/rust-payjoin/commit/48712bd15f6cb42794435f0706de7966174a318c).\n\n> - What is the polling interval?\n\nThe reference uses long polling, so the directory won't return a result for the timeout and polling does not wait at all. The default is 30 seconds (https://github.com/payjoin/rust-payjoin/blob/3e30f4ed37d91daa2add446bf8b7eaeadbb71d3f/payjoin-directory/src/config.rs#L83). I can make an edit to BIP 77 to include this recommendation since a typical forced timeout for http requests with many clients is 1 minute.\n\n> -  What shows in the GUI when we are waiting for and polling the Directory, for both Receivers and Senders?\n\n\"Pending\" + The expiration time +  the ability to unilaterally broadcast the fallback.  our reference [payjoin-cli `history`](https://github.com/payjoin/rust-payjoin/blob/3e30f4ed37d91daa2add446bf8b7eaeadbb71d3f/payjoin-cli/src/app/v2/mod.rs#L329) subcommand shows these as well as historic error states.\n\n> - We should not be automatically signing transactions for our users:\n\nMy thinking here is that authorization for a given transaction within a timeframe with fee rate is what's done on the first signing for a sender, and another prompt is not strictly necessary as long as appropriate checks pass, but otherwise perhaps a prompt to action does need to be shown.\n\n>   - How will Senders using the GUI be notified and prompted when a reply is received so that the PSBT can be signed?\n\nTBD\n\n>   - How will Senders using the CLI know when a reply was received and that a PSBT needs to be signed?\n\nOther than looking at [payjoin-cli `history`](https://github.com/payjoin/rust-payjoin/blob/3e30f4ed37d91daa2add446bf8b7eaeadbb71d3f/payjoin-cli/src/app/v2/mod.rs#L329) for inspiration TBD. Perhaps then a `resume` command could be issued from the CLI.\n\n\n",
          "created_at": "2025-10-22T23:51:23Z"
        },
        {
          "user": "fanquake",
          "body": "Given that this is adding new features to the GUI. Is the plan to add them to the \"legacy\" GUI, the new QML GUI, or implement Payjoin into both? cc @hebasto ",
          "created_at": "2025-10-30T10:04:23Z"
        },
        {
          "user": "hebasto",
          "body": "> Given that this is adding new features to the GUI. Is the plan to add them to the \"legacy\" GUI, the new QML GUI, or implement Payjoin into both? cc [@hebasto](https://github.com/hebasto)\n\ncc @GBKS @johnny9 ",
          "created_at": "2025-11-03T17:21:28Z"
        },
        {
          "user": "johnny9",
          "body": "> > Given that this is adding new features to the GUI. Is the plan to add them to the \"legacy\" GUI, the new QML GUI, or implement Payjoin into both? cc [@hebasto](https://github.com/hebasto)\n> \n> cc [@GBKS](https://github.com/GBKS) [@johnny9](https://github.com/johnny9)\n\nMy vote would be to continue to add features to the Qt Widgets gui. There might be differing opinions but I see the two as potentially serving different target platforms as well as different target users. ",
          "created_at": "2025-11-03T17:29:27Z"
        },
        {
          "user": "GBKS",
          "body": "> > Given that this is adding new features to the GUI. Is the plan to add them to the \"legacy\" GUI, the new QML GUI, or implement Payjoin into both? cc [@hebasto](https://github.com/hebasto)\n> \n> cc [@GBKS](https://github.com/GBKS) [@johnny9](https://github.com/johnny9)\n\nI am not aware of any plans, so this is probably something to be decided. Considering the limited resources that go into the QT and QML GUIs and how hard it is to just make one piece of software extremely good, I don't see it as realistic to continue both. During a transition period possibly, if that is deemed important. Or maybe if more people step up and chip in. Just my 2 cents.",
          "created_at": "2025-11-04T06:57:26Z"
        }
      ]
    }
  ],
  "summary": {
    "pull_requests": 10,
    "issues": 1
  }
}